<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Requirements Dashboard</title>
    <!-- Google Fonts - Inter (Modern, Clean, Highly Readable) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ==================== CSS VARIABLES ==================== */
        :root {
            /* Dark Theme Colors (Default) */
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-secondary: #1e293b;
            --bg-card: rgba(255,255,255,0.05);
            --bg-card-hover: rgba(255,255,255,0.08);
            --bg-input: rgba(0,0,0,0.3);
            --border-color: rgba(255,255,255,0.1);
            --border-color-strong: rgba(255,255,255,0.2);
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --doughnut-bg: #1e293b;
            --table-header-bg: #0f172a;
            --table-row-hover: rgba(255,255,255,0.05);
            --link-color: #60a5fa;
            --shadow-color: rgba(0,0,0,0.3);
        }

        /* Light Theme Colors */
        body.light-theme {
            --bg-primary: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f8fafc;
            --bg-input: #ffffff;
            --border-color: #cbd5e1;
            --border-color-strong: #94a3b8;
            --text-primary: #0f172a;
            --text-secondary: #1e293b;
            --text-muted: #475569;
            --accent-primary: #4f46e5;
            --accent-secondary: #7c3aed;
            --accent-gradient: linear-gradient(135deg, #4f46e5, #7c3aed);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #0891b2;
            --doughnut-bg: #ffffff;
            --table-header-bg: #f1f5f9;
            --table-row-hover: rgba(0,0,0,0.04);
            --link-color: #2563eb;
            --shadow-color: rgba(0,0,0,0.15);
        }

        /* Light theme specific overrides */
        body.light-theme .config-panel,
        body.light-theme .filter-panel,
        body.light-theme .dashboard-card,
        body.light-theme .table-section,
        body.light-theme .req-lookup-card {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        body.light-theme .config-field input,
        body.light-theme .filter-field select {
            background: #ffffff;
            border: 1px solid #94a3b8;
            color: #0f172a;
        }
        body.light-theme .config-field label,
        body.light-theme .filter-field label {
            color: #334155;
        }
        body.light-theme h1, 
        body.light-theme h2, 
        body.light-theme h3, 
        body.light-theme h4 {
            color: #0f172a;
        }
        body.light-theme th {
            background: #e2e8f0;
            color: #1e293b;
        }
        body.light-theme td {
            color: #1e293b;
            border-bottom-color: #e2e8f0;
        }
        body.light-theme tr:hover {
            background: rgba(99,102,241,0.08);
        }
        body.light-theme .mini-table th {
            background: #e2e8f0;
            color: #1e293b;
        }
        body.light-theme .mini-table td {
            color: #1e293b;
            border-bottom-color: #e2e8f0;
        }
        body.light-theme .wi-link {
            color: #4f46e5;
            font-weight: 500;
        }
        body.light-theme .card-loading {
            background: rgba(255,255,255,0.92);
        }
        body.light-theme .mini-spinner {
            border-color: #e2e8f0;
            border-top-color: #3b82f6;
        }
        body.light-theme #weeklyIterationFilter {
            background: #ffffff;
            color: #0f172a;
            border-color: #94a3b8;
        }
        body.light-theme #reqFilterState,
        body.light-theme #reqFilterAssigned,
        body.light-theme #reqFilterIteration {
            background: #ffffff;
            color: #0f172a;
            border-color: #94a3b8;
        }
        body.light-theme #flIterFilter {
            background: #ffffff !important;
            color: #0f172a !important;
            border-color: #94a3b8 !important;
        }
        .fl-card th[onclick]:hover { opacity: 0.75; }
        #featureProgressTable thead,
        #featureProgressTable tfoot {
            background: #1e293b;
        }
        #featureProgressTable .fp-th {
            padding: 5px 3px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            color: #e2e8f0;
            font-size: 0.58rem;
            font-weight: 600;
            vertical-align: bottom;
        }
        .fp-sortable { cursor: pointer; position: relative; }
        .fp-sortable:hover { background: rgba(255,255,255,0.08); }
        .fp-sort-icon { font-size: 0.5rem; opacity: 0.3; margin-left: 1px; }
        .fp-sort-icon.asc::after { content: '▲'; opacity: 1; }
        .fp-sort-icon.desc::after { content: '▼'; opacity: 1; }
        body.light-theme .fp-sortable:hover { background: rgba(0,0,0,0.05); }
        /* Feature Progress Multi-Select Dropdown */
        .fp-multiselect { position: relative; display: inline-block; min-width: 140px; }
        .fp-multiselect-btn {
            padding: 4px 24px 4px 8px; font-size: 0.65rem; border-radius: 6px; cursor: pointer;
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2);
            color: #e2e8f0; font-weight: 500; white-space: nowrap; width: 100%; text-align: left;
            position: relative; overflow: hidden; text-overflow: ellipsis;
        }
        .fp-multiselect-btn::after { content: '▾'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.6rem; opacity: 0.6; }
        .fp-multiselect-btn.open::after { content: '▴'; }
        .fp-multiselect-dropdown {
            display: none; position: absolute; top: 100%; left: 0; z-index: 999; min-width: 180px; max-height: 220px;
            overflow-y: auto; background: #1e293b; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5); margin-top: 2px; padding: 4px 0;
        }
        .fp-multiselect-dropdown.open { display: block; }
        .fp-multiselect-item {
            display: flex; align-items: center; gap: 6px; padding: 4px 10px; font-size: 0.65rem;
            cursor: pointer; color: #cbd5e1; transition: background 0.15s;
        }
        .fp-multiselect-item:hover { background: rgba(255,255,255,0.08); }
        .fp-multiselect-item.select-all { border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 2px; font-weight: 600; color: #93c5fd; }
        .fp-multiselect-item input[type="checkbox"] { accent-color: #3b82f6; width: 13px; height: 13px; cursor: pointer; }
        .fp-multiselect-badge {
            display: inline-block; padding: 1px 6px; border-radius: 8px; font-size: 0.55rem;
            background: #3b82f6; color: #fff; font-weight: 600; margin-left: 4px; min-width: 16px; text-align: center;
        }
        /* Light theme overrides */
        body.light-theme .fp-multiselect-btn { background: #f1f5f9; border-color: #cbd5e1; color: #1e293b; }
        body.light-theme .fp-multiselect-dropdown { background: #ffffff; border-color: #cbd5e1; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        body.light-theme .fp-multiselect-item { color: #334155; }
        body.light-theme .fp-multiselect-item:hover { background: rgba(0,0,0,0.04); }
        body.light-theme .fp-multiselect-item.select-all { border-bottom-color: #e2e8f0; color: #2563eb; }
        /* Feature Progress cell color classes - Dark theme */
        #featureProgressTable .fp-title { color: #e2e8f0; }
        #featureProgressTable .fp-est-inhrs { color: #22d3ee; }
        #featureProgressTable .fp-est-disc { color: #22d3ee; }
        #featureProgressTable .fp-dev-delivery { color: #22d3ee; }
        #featureProgressTable .fp-comp-disc { color: #34d399; }
        #featureProgressTable .fp-planned { color: #c084fc; }
        #featureProgressTable .fp-comp-eff { color: #c084fc; }
        #featureProgressTable .fp-actual-comp { color: #c084fc; }
        #featureProgressTable .fp-task-plan { color: #f97316; }
        #featureProgressTable .fp-task-cdev { color: #f97316; }
        #featureProgressTable .fp-task-acomp { color: #f97316; }
        #featureProgressTable .fp-hl-red {
            background: rgba(239, 68, 68, 0.2) !important;
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 3px;
        }
        #featureProgressTable .fp-hl-orange {
            background: rgba(251, 146, 60, 0.2) !important;
            border: 1px solid rgba(251, 146, 60, 0.4);
            border-radius: 3px;
        }
        #featureProgressTable .fp-totals-lbl { color: #93c5fd; }
        #featureProgressTable tbody tr { border-bottom: 1px solid rgba(255,255,255,0.06); }
        #featureProgressTable tfoot tr { border-top: 2px solid rgba(255,255,255,0.15); }
        /* State pill badges */
        .fp-state-pill {
            display: inline-block; padding: 2px 7px; border-radius: 10px;
            font-size: 0.55rem; font-weight: 600; white-space: nowrap; line-height: 1.4;
        }
        .fp-state-proposed { background: rgba(148,163,184,0.25); color: #cbd5e1; border: 1px solid rgba(148,163,184,0.4); }
        .fp-state-active { background: rgba(59,130,246,0.25); color: #93c5fd; border: 1px solid rgba(59,130,246,0.45); }
        .fp-state-resolved { background: rgba(45,212,191,0.2); color: #5eead4; border: 1px solid rgba(45,212,191,0.4); }
        .fp-state-closed { background: rgba(52,211,153,0.2); color: #6ee7b7; border: 1px solid rgba(52,211,153,0.4); }
        /* Status pill badges */
        .fp-status-pill {
            display: inline-block; padding: 2px 6px; border-radius: 10px;
            font-size: 0.52rem; font-weight: 600; white-space: nowrap; line-height: 1.4;
            max-width: 100%; overflow: hidden; text-overflow: ellipsis;
        }
        .fp-status-discovery { background: rgba(251,146,60,0.2); color: #fdba74; border: 1px solid rgba(251,146,60,0.4); }
        .fp-status-dev { background: rgba(59,130,246,0.2); color: #93c5fd; border: 1px solid rgba(59,130,246,0.4); }
        .fp-status-qa { background: rgba(168,85,247,0.2); color: #d8b4fe; border: 1px solid rgba(168,85,247,0.4); }
        .fp-status-ship { background: rgba(52,211,153,0.2); color: #6ee7b7; border: 1px solid rgba(52,211,153,0.4); }
        .fp-status-hold { background: rgba(148,163,184,0.2); color: #cbd5e1; border: 1px solid rgba(148,163,184,0.35); }
        .fp-status-doc { background: rgba(56,189,248,0.2); color: #7dd3fc; border: 1px solid rgba(56,189,248,0.4); }
        .fp-status-default { background: rgba(139,92,246,0.18); color: #d8b4fe; border: 1px solid rgba(139,92,246,0.35); }

        /* Light theme overrides */
        body.light-theme #featureProgressTable thead { background: #f1f5f9 !important; }
        body.light-theme #featureProgressTable .fp-th { color: #1e293b; border-bottom-color: #cbd5e1; }
        body.light-theme #featureProgressTable tfoot { background: #eef2ff !important; }
        body.light-theme #featureProgressTable tbody tr { border-bottom-color: #e2e8f0; }
        body.light-theme #featureProgressTable tfoot tr { border-top-color: #cbd5e1; }
        body.light-theme #featureProgressTable .fp-title { color: #1e293b; }
        body.light-theme #featureProgressTable .fp-est-inhrs { color: #0e7490; }
        body.light-theme #featureProgressTable .fp-est-disc { color: #0e7490; }
        body.light-theme #featureProgressTable .fp-dev-delivery { color: #0e7490; }
        body.light-theme #featureProgressTable .fp-comp-disc { color: #059669; }
        body.light-theme #featureProgressTable .fp-planned { color: #7c3aed; }
        body.light-theme #featureProgressTable .fp-comp-eff { color: #7c3aed; }
        body.light-theme #featureProgressTable .fp-actual-comp { color: #7c3aed; }
        body.light-theme #featureProgressTable .fp-task-plan { color: #c2410c; }
        body.light-theme #featureProgressTable .fp-task-cdev { color: #c2410c; }
        body.light-theme #featureProgressTable .fp-task-acomp { color: #c2410c; }
        body.light-theme #featureProgressTable .fp-hl-red {
            background: rgba(239, 68, 68, 0.1) !important;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        body.light-theme #featureProgressTable .fp-hl-orange {
            background: rgba(251, 146, 60, 0.1) !important;
            border: 1px solid rgba(234, 88, 12, 0.3);
        }
        body.light-theme #featureProgressTable .fp-totals-lbl { color: #2563eb; }
        /* Light theme state pills */
        body.light-theme .fp-state-proposed { background: #f1f5f9; color: #64748b; border-color: #cbd5e1; }
        body.light-theme .fp-state-active { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        body.light-theme .fp-state-resolved { background: #ccfbf1; color: #0f766e; border-color: #5eead4; }
        body.light-theme .fp-state-closed { background: #d1fae5; color: #047857; border-color: #6ee7b7; }
        /* Light theme status pills */
        body.light-theme .fp-status-discovery { background: #fff7ed; color: #c2410c; border-color: #fdba74; }
        body.light-theme .fp-status-dev { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        body.light-theme .fp-status-qa { background: #f3e8ff; color: #7c3aed; border-color: #c4b5fd; }
        body.light-theme .fp-status-ship { background: #d1fae5; color: #047857; border-color: #6ee7b7; }
        body.light-theme .fp-status-hold { background: #f1f5f9; color: #64748b; border-color: #cbd5e1; }
        body.light-theme .fp-status-doc { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
        body.light-theme .fp-status-default { background: #ede9fe; color: #6d28d9; border-color: #c4b5fd; }
        /* Light theme - Feature Progress card inline color overrides */
        body.light-theme #featureProgressCard [style*="color:#e2e8f0"] { color: #334155 !important; }
        body.light-theme #featureProgressCard [style*="color:#cbd5e1"] { color: #475569 !important; }
        body.light-theme #featureProgressCard [style*="color:#93c5fd"] { color: #2563eb !important; }
        body.light-theme #featureProgressCard [style*="color:#60a5fa"] { color: #1d4ed8 !important; }
        body.light-theme #featureProgressCard [style*="color:#34d399"] { color: #047857 !important; }
        body.light-theme #featureProgressCard [style*="color:#fb923c"] { color: #c2410c !important; }
        body.light-theme #featureProgressCard [style*="color:#c084fc"] { color: #7c3aed !important; }
        body.light-theme #featureProgressCard [style*="background:rgba(255,255,255,0.05)"] { background: rgba(0,0,0,0.03) !important; }
        body.light-theme #featureProgressCard [style*="background:rgba(255,255,255,0.1)"] { background: rgba(0,0,0,0.08) !important; }
        body.light-theme #featureProgressCard { background: linear-gradient(135deg,rgba(59,130,246,0.08),rgba(99,102,241,0.05)) !important; border-color: rgba(59,130,246,0.2) !important; }
        body.light-theme #affectedAreaCard { background: linear-gradient(135deg,rgba(16,185,129,0.08),rgba(5,150,105,0.05)) !important; border-color: rgba(16,185,129,0.2) !important; }
        body.light-theme #affectedAreaCard [style*="color:#e2e8f0"] { color: #334155 !important; }
        body.light-theme #affectedAreaCard [style*="color:#6ee7b7"] { color: #047857 !important; }
        body.light-theme #affectedAreaCard [style*="color:#94a3b8"] { color: #64748b !important; }
        body.light-theme #affectedAreaCard [style*="background:rgba(255,255,255,0.05)"] { background: rgba(0,0,0,0.03) !important; }
        body.light-theme #affectedAreaIterFilter {
            background: #ffffff !important;
            color: #0f172a !important;
            border-color: #94a3b8 !important;
        }
        #affectedAreaTable thead, #affectedAreaTable tfoot { position: sticky; z-index: 1; }
        #affectedAreaTable thead { top: 0; }
        #affectedAreaTable tbody tr { border-bottom: 1px solid rgba(255,255,255,0.06); }
        #affectedAreaTable tfoot tr { border-top: 2px solid rgba(255,255,255,0.15); }
        body.light-theme #affectedAreaTable thead { background: #f1f5f9 !important; }
        body.light-theme #affectedAreaTable tbody tr { border-bottom-color: #e2e8f0; }
        body.light-theme #affectedAreaTable tfoot tr { border-top-color: #cbd5e1; }
        body.light-theme #featureLookupSection input[type="text"] { background: #ffffff !important; color: #0f172a !important; border-color: #94a3b8 !important; }
        body.light-theme #featureLookupSection .tasks-table th { background: #e2e8f0; color: #1e293b; }
        body.light-theme #featureLookupSection .tasks-table td { color: #334155; border-color: #e2e8f0; }

        /* Data Lookup Tab - Light theme for both sections */
        body.light-theme #reqTaskLookupSection input[type="text"] { background: #ffffff !important; color: #0f172a !important; border-color: #94a3b8 !important; }
        body.light-theme #tabContent6 .table-section h3 { color: #0f172a; }
        body.light-theme #tabContent6 select { background: #ffffff; color: #1e293b; border-color: #cbd5e1; }
        body.light-theme #tabContent6 .fl-card th { background: #e2e8f0; color: #1e293b; }
        body.light-theme #tabContent6 .fl-card td { color: #334155; border-bottom-color: #e2e8f0; }

        /* Tab 7: Weekly Task Breakdown - Light theme */
        body.light-theme #tabContent7 .dashboard-card { background: #ffffff !important; border-color: #cbd5e1 !important; }
        body.light-theme #tabContent7 h3 { color: #1e293b !important; }
        body.light-theme #tabContent7 h4 { color: #1e293b !important; }
        body.light-theme #tabContent7 th { background: #e2e8f0 !important; color: #1e293b !important; }
        body.light-theme #tabContent7 td { color: #334155; border-bottom-color: #e2e8f0 !important; }
        body.light-theme #tabContent7 .summary-stat { background: #f1f5f9 !important; border-color: #cbd5e1 !important; }
        body.light-theme #tabContent7 .summary-stat .value { filter: brightness(0.7) saturate(1.3); }
        body.light-theme #tabContent7 .summary-stat .label { color: #475569 !important; }
        body.light-theme #tabContent7 button { color: #334155 !important; }
        body.light-theme #loadWeeklyBreakdownBtn { color: #1e40af !important; border-color: rgba(59,130,246,0.4) !important; background: rgba(59,130,246,0.1) !important; }
        body.light-theme #tabContent7 #wbWeekFilterBar,
        body.light-theme #tabContent7 #wbAiDiscBar,
        body.light-theme #tabContent7 #wbManualDiscBar { background: #f1f5f9 !important; }
        body.light-theme #tabContent7 #wbWeekFilterBar span,
        body.light-theme #tabContent7 #wbAiDiscBar span,
        body.light-theme #tabContent7 #wbManualDiscBar span { color: #475569 !important; }
        body.light-theme #tabContent7 a.wi-link { color: #2563eb !important; }
        body.light-theme #tabContent7 div[style*="rgba(0,0,0,0.2)"],
        body.light-theme #tabContent7 div[style*="rgba(0,0,0,0.15)"] { background: #f1f5f9 !important; }
        body.light-theme #tabContent7 div[style*="rgba(16,185,129,0.08)"] { background: rgba(16,185,129,0.06) !important; border-color: rgba(16,185,129,0.2) !important; }
        body.light-theme #tabContent7 div[style*="rgba(245,158,11,0.08)"] { background: rgba(245,158,11,0.06) !important; border-color: rgba(245,158,11,0.2) !important; }
        body.light-theme #tabContent7 span.c-muted, body.light-theme #tabContent7 span.c-dim { color: #475569 !important; }
        body.light-theme #tabContent7 .fp-state-pill { filter: brightness(0.85) saturate(1.2); }
        body.light-theme #tabContent7 span[style*="border-radius:4px"] { filter: brightness(0.75) saturate(1.4); }

        /* Tab 4: AI Analytics - light theme */
        body.light-theme #tabContent4 .dashboard-card { background: #ffffff !important; border-color: #cbd5e1 !important; }
        body.light-theme #tabContent4 h3 { color: #1e293b !important; }
        body.light-theme #tabContent4 h4 { color: #1e293b !important; }
        body.light-theme #tabContent4 table thead { background: #e2e8f0 !important; }
        body.light-theme #tabContent4 table th { color: #1e293b !important; background: #e2e8f0 !important; }
        body.light-theme #tabContent4 table td { color: #334155 !important; }
        body.light-theme #tabContent4 table tfoot td,
        body.light-theme #tabContent4 table tfoot th { color: #1e293b !important; background: #dbeafe !important; }
        body.light-theme #tabContent4 .summary-stat { background: #f1f5f9 !important; border-color: #cbd5e1 !important; }
        body.light-theme #tabContent4 .summary-stat .value { filter: brightness(0.7) saturate(1.3); }
        body.light-theme #tabContent4 .summary-stat .label { color: #475569 !important; }
        body.light-theme #tabContent4 > div[style*="border:2px"] { background: rgba(245,158,11,0.03) !important; border-color: rgba(245,158,11,0.2) !important; }
        body.light-theme #tabContent4 div[style*="border-left:3px solid #f59e0b"] { background: rgba(245,158,11,0.06) !important; }
        body.light-theme #tabContent4 div[style*="border-left:3px solid #f59e0b"] span { color: #92400e !important; }
        body.light-theme #tabContent4 > div > .dashboard-card,
        body.light-theme #tabContent4 > div > div > .dashboard-card { background: linear-gradient(135deg, rgba(59,130,246,0.06), rgba(99,102,241,0.04)) !important; border-color: rgba(99,102,241,0.2) !important; }
        body.light-theme #tabContent4 .dashboard-card h3 { color: #1e40af !important; }
        body.light-theme #tabContent4 .dashboard-card h4 { color: #1e40af !important; }

        /* Tab 2: Work Progress - Light theme */
        body.light-theme #tabContent2 > .dashboard-card { background: linear-gradient(135deg, rgba(59,130,246,0.06), rgba(99,102,241,0.04)) !important; border-color: rgba(99,102,241,0.2) !important; }
        body.light-theme #tabContent2 > .dashboard-card h3 { color: #1e40af !important; }
        body.light-theme #tabContent2 #bugsTable th { background: #e2e8f0 !important; color: #1e293b !important; }
        body.light-theme #tabContent2 #bugsTable td { color: #334155 !important; }
        body.light-theme #tabContent2 #mismatchTable th { background: #e2e8f0 !important; color: #1e293b !important; }
        body.light-theme #tabContent2 #mismatchTable td { color: #334155 !important; }

        /* Tab 3: AI Usage - Light theme */
        body.light-theme #tabContent3 > div[style*="border:2px"] { background: rgba(59,130,246,0.03) !important; border-color: rgba(59,130,246,0.2) !important; }
        body.light-theme #tabContent3 div[style*="border-left:3px solid #3b82f6"] { background: rgba(59,130,246,0.06) !important; }
        body.light-theme #tabContent3 div[style*="border-left:3px solid #3b82f6"] span { color: #1e40af !important; }
        body.light-theme #tabContent3 div[style*="border-left:3px solid #f59e0b"] { background: rgba(245,158,11,0.06) !important; }
        body.light-theme #tabContent3 div[style*="border-left:3px solid #f59e0b"] span { color: #92400e !important; }
        body.light-theme #tabContent3 > div > .dashboard-card,
        body.light-theme #tabContent3 > div > div > .dashboard-card { background: linear-gradient(135deg, rgba(59,130,246,0.06), rgba(99,102,241,0.04)) !important; border-color: rgba(99,102,241,0.2) !important; }
        body.light-theme #tabContent3 .dashboard-card h3 { color: #1e40af !important; }
        body.light-theme #tabContent3 .dashboard-card h4 { color: #1e40af !important; }
        body.light-theme .ratio-bar {
            background: #cbd5e1;
        }
        body.light-theme .loading {
            background: rgba(255,255,255,0.95);
        }
        body.light-theme .loading-text {
            color: #1e293b;
        }
        body.light-theme .btn-secondary {
            background: #ffffff;
            border: 1px solid #94a3b8;
            color: #1e293b;
        }
        body.light-theme .btn-secondary:hover {
            background: #f1f5f9;
        }
        body.light-theme .table-tab {
            background: #e2e8f0;
            color: #1e293b;
        }
        body.light-theme .table-tab:hover {
            background: #cbd5e1;
        }
        body.light-theme .table-tab.active {
            background: #4f46e5;
            color: #ffffff;
        }
        body.light-theme .api-stats {
            color: #475569;
        }
        body.light-theme .header-info span {
            color: #334155;
        }
        body.light-theme .highlight {
            color: #4f46e5;
        }
        body.light-theme .summary-stat {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        body.light-theme .summary-stat .label {
            color: #475569;
        }
        body.light-theme .dashboard-section {
            color: #1e293b;
        }
        body.light-theme .tab-btn {
            color: #475569;
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        body.light-theme .tab-btn.active {
            background: rgba(79,70,229,0.2);
            color: #4f46e5;
            border-color: #4f46e5;
        }
        body.light-theme .badge {
            font-weight: 600;
        }
        body.light-theme .badge-deliverable {
            background: rgba(5,150,105,0.15);
            color: #047857;
        }
        body.light-theme .badge-non-deliverable {
            background: rgba(217,119,6,0.15);
            color: #b45309;
        }
        body.light-theme p,
        body.light-theme span,
        body.light-theme div {
            color: inherit;
        }
        body.light-theme .content {
            color: #1e293b;
        }
        /* Override inline backgrounds for light theme */
        body.light-theme [style*="background: rgba"],
        body.light-theme [style*="background: linear-gradient"] {
            color: #1e293b !important;
        }
        body.light-theme [style*="background: rgba"] h3,
        body.light-theme [style*="background: rgba"] h4,
        body.light-theme [style*="background: rgba"] p,
        body.light-theme [style*="background: rgba"] span,
        body.light-theme [style*="background: rgba"] td,
        body.light-theme [style*="background: linear-gradient"] h3,
        body.light-theme [style*="background: linear-gradient"] h4,
        body.light-theme [style*="background: linear-gradient"] p,
        body.light-theme [style*="background: linear-gradient"] span,
        body.light-theme [style*="background: linear-gradient"] td {
            color: #1e293b !important;
        }
        /* Stronger card backgrounds for light theme */
        body.light-theme .dashboard-card[style*="background"] {
            background: #ffffff !important;
            border: 1px solid #cbd5e1 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        body.light-theme .dashboard-card[style*="background"] h3 {
            color: #1e293b !important;
        }
        /* Dev AI Adoption - Blue theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(59,130,246"] {
            background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(37,99,235,0.08)) !important;
            border: 1px solid rgba(59,130,246,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(59,130,246"] h3 {
            color: #2563eb !important;
        }
        /* QA AI Adoption - Green theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(16,185,129"] {
            background: linear-gradient(135deg, rgba(16,185,129,0.12), rgba(5,150,105,0.08)) !important;
            border: 1px solid rgba(16,185,129,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(16,185,129"] h3 {
            color: #059669 !important;
        }
        /* Overall Discipline AI Adoption - Orange/Amber theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(245,158,11"] {
            background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(217,119,6,0.08)) !important;
            border: 1px solid rgba(245,158,11,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(245,158,11"] h3 {
            color: #d97706 !important;
        }
        /* TaskExecutionType AI Adoption - Purple theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(139,92,246"] {
            background: linear-gradient(135deg, rgba(139,92,246,0.12), rgba(168,85,247,0.08)) !important;
            border: 1px solid rgba(139,92,246,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(139,92,246"] h3 {
            color: #7c3aed !important;
        }
        /* Project-wise AI Adoption - Cyan theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(6,182,212"] {
            background: linear-gradient(135deg, rgba(6,182,212,0.12), rgba(34,211,238,0.08)) !important;
            border: 1px solid rgba(6,182,212,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(6,182,212"] h3 {
            color: #0891b2 !important;
        }
        /* Fix checkbox containers */
        body.light-theme [id*="CheckboxContainer"] {
            background: #f8fafc !important;
            border-color: #cbd5e1 !important;
        }
        body.light-theme [id*="CheckboxContainer"] label {
            color: #1e293b !important;
        }
        /* Fix summary stats in light theme */
        body.light-theme .summary-stat[style*="background"] {
            background: #f1f5f9 !important;
            border: 1px solid #e2e8f0 !important;
        }
        body.light-theme .summary-stat .value {
            filter: brightness(0.8) saturate(1.2);
        }
        /* Fix doughnut chart labels */
        body.light-theme [style*="color: #94a3b8"],
        body.light-theme [style*="color:#94a3b8"] {
            color: #475569 !important;
        }
        body.light-theme [style*="color: #fca5a5"],
        body.light-theme [style*="color:#fca5a5"] {
            color: #dc2626 !important;
        }
        body.light-theme [style*="color: #fcd34d"],
        body.light-theme [style*="color:#fcd34d"] {
            color: #d97706 !important;
        }
        body.light-theme [style*="color: #a5b4fc"],
        body.light-theme [style*="color:#a5b4fc"] {
            color: #4f46e5 !important;
        }
        body.light-theme [style*="color: #c4b5fd"],
        body.light-theme [style*="color:#c4b5fd"] {
            color: #7c3aed !important;
        }
        body.light-theme [style*="color: #67e8f9"],
        body.light-theme [style*="color:#67e8f9"] {
            color: #0891b2 !important;
        }
        /* Fix table headers in cards */
        body.light-theme thead[style*="background: #0f172a"],
        body.light-theme thead[style*="background: #1a1f2e"],
        body.light-theme thead[style*="background: #2d1a1a"],
        body.light-theme thead[style*="background:#0f172a"],
        body.light-theme thead[style*="background:#1a1f2e"] {
            background: #e2e8f0 !important;
        }
        body.light-theme thead th {
            color: #1e293b !important;
        }
        body.light-theme #tabContent3 table thead { background: #e2e8f0 !important; }
        body.light-theme #tabContent3 table th { color: #1e293b !important; background: #e2e8f0 !important; }
        body.light-theme #tabContent3 table td { color: #334155 !important; }
        body.light-theme #tabContent3 table tfoot td,
        body.light-theme #tabContent3 table tfoot th { color: #1e293b !important; background: #dbeafe !important; }
        /* Fix detail items */
        body.light-theme .detail-item,
        body.light-theme [style*="background: rgba(0,0,0,0.2)"],
        body.light-theme [style*="background: rgba(0,0,0,0.3)"] {
            background: #f1f5f9 !important;
        }
        body.light-theme .detail-item .detail-label,
        body.light-theme .detail-item .detail-value {
            color: #1e293b !important;
        }

        /* Light theme: Update Feature Popup */
        body.light-theme #updateFeaturePopup { background: rgba(0,0,0,0.4) !important; }
        body.light-theme #aiTaskPopupOverlay { background: rgba(0,0,0,0.4) !important; }
        body.light-theme .fp-update-popup { background: #ffffff !important; border-color: rgba(59,130,246,0.3) !important; box-shadow: 0 25px 50px rgba(0,0,0,0.2) !important; }
        body.light-theme .fp-update-popup h3 { color: #1e40af !important; }
        body.light-theme .fp-update-subtitle { color: #64748b !important; }
        body.light-theme .fp-update-header { border-bottom-color: #e2e8f0 !important; }
        body.light-theme .fp-update-summary { background: #f8fafc !important; border-bottom-color: #e2e8f0 !important; }
        body.light-theme .fp-update-footer { border-top-color: #e2e8f0 !important; }
        body.light-theme .fp-update-popup table { color: #1e293b; }
        body.light-theme .fp-update-popup th { color: #475569 !important; }
        body.light-theme .fp-update-popup td { color: #1e293b !important; }
        body.light-theme .fp-update-popup td a.wi-link { color: #2563eb !important; }
        body.light-theme .fp-update-popup select { background: #f1f5f9 !important; color: #1e293b !important; border-color: #cbd5e1 !important; }
        body.light-theme .fp-update-popup thead tr { background: #f1f5f9 !important; }
        body.light-theme .fp-update-popup tbody tr { border-bottom-color: #e2e8f0 !important; }
        body.light-theme .fp-update-popup tbody tr:nth-child(odd) { background: #ffffff !important; }
        body.light-theme .fp-update-popup tbody tr:nth-child(even) { background: #f8fafc !important; }

        /* Light theme: Capacity total row */
        body.light-theme #membersCapacityTotalTable { background: rgba(59,130,246,0.08); border-top-color: rgba(59,130,246,0.3); }
        body.light-theme #membersCapacityTotalTable td { color: #1e293b; }
        body.light-theme #membersCapacityTableHead { background: #e2e8f0 !important; }
        body.light-theme #membersCapacityTableHead th { color: #1e293b; border-bottom-color: #cbd5e1; }
        body.light-theme #membersCapacityTableBody td { color: #334155; border-bottom-color: #e2e8f0; }

        /* Light theme: DQ card sticky headers */
        body.light-theme .dq-card thead { background: #e2e8f0 !important; }
        body.light-theme .dq-card th { color: #1e293b !important; border-bottom-color: #cbd5e1 !important; }
        body.light-theme .dq-card td { color: #334155; border-bottom-color: #e2e8f0; }

        /* Utility classes for repeated inline styles */
        .c-dim { color: #64748b; }
        .c-muted { color: #94a3b8; }
        .fs-sm-bold { font-size: 0.7rem; font-weight: 600; }
        .btn-compact { padding: 4px 12px; font-size: 0.75rem; }
        .bg-overlay { background: rgba(0,0,0,0.3); }
        body.light-theme .bg-overlay { background: #e2e8f0 !important; }
        body.light-theme .bg-overlay th { color: #1e293b !important; border-bottom-color: #cbd5e1 !important; }
        body.light-theme .c-muted { color: #64748b; }

        /* Requirements List filter dropdowns */
        .req-filter-select {
            background: rgba(15,23,42,0.6);
            color: #e2e8f0;
            border: 1px solid rgba(99,102,241,0.35);
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            outline: none;
            min-width: 100px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .req-filter-select:hover { border-color: rgba(99,102,241,0.6); }
        .req-filter-select:focus { border-color: rgba(99,102,241,0.7); box-shadow: 0 0 0 2px rgba(99,102,241,0.15); }
        body.light-theme .req-filter-select {
            background: #ffffff;
            color: #1e293b;
            border-color: #cbd5e1;
        }
        body.light-theme .req-filter-select:hover { border-color: #6366f1; }
        body.light-theme .req-filter-select:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.12); }
        body.light-theme #reqListFilters { background: rgba(241,245,249,0.7); border-color: #e2e8f0; }

        /* ==================== BASE STYLES ==================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: var(--bg-primary); min-height: 100vh; color: var(--text-primary); padding: 20px; transition: background 0.3s ease, color 0.3s ease; font-size: 14px; line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .config-panel { background: var(--bg-card-hover); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid var(--border-color); max-width: 500px; margin-left: auto; margin-right: auto; }
        .config-panel h2 { margin-bottom: 16px; font-size: 1.2rem; color: var(--text-primary); }
        .config-field { margin-bottom: 16px; }
        .config-field label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
        .config-field input { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color-strong); border-radius: 8px; background: var(--bg-input); color: var(--text-primary); font-size: 0.95rem; }
        .config-field input:focus { outline: none; border-color: var(--accent-primary); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; margin-right: 10px; margin-top: 8px; }
        .btn-primary { background: var(--accent-gradient); color: #fff; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color-strong); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: #fff; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .filter-panel { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--border-color); display: none; max-width: 900px; margin-left: auto; margin-right: auto; }
        .filter-panel.visible { display: block; }
        .filter-panel h3 { margin-bottom: 16px; font-size: 1rem; color: var(--text-secondary); }
        .filter-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
        .filter-field { flex: 1; min-width: 200px; }
        .filter-field label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        .filter-field select { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color-strong); border-radius: 8px; background: var(--bg-input); color: var(--text-primary); }
        .filter-field select option { background: var(--bg-secondary); }
        .content { display: none; max-width: 1520px; margin: 0 auto; }
        .content.visible { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .header h1 { font-size: 1.5rem; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header-info { color: var(--text-muted); font-size: 0.9rem; }
        .header-info span { margin-right: 20px; }
        .header-info .highlight { color: var(--accent-primary); font-weight: 600; }
        .summary-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .summary-stat { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); text-align: center; }
        .summary-stat .value { font-size: 1.6rem; font-weight: 700; }
        .summary-stat .label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .summary-stat.blue .value { color: #3b82f6; }
        .summary-stat.green .value { color: var(--success); }
        .summary-stat.orange .value { color: var(--warning); }
        .summary-stat.purple .value { color: #a78bfa; }
        .summary-stat.red .value { color: var(--danger); }
        .summary-stat.cyan .value { color: var(--info); }
        .summary-stat.pink .value { color: #ec4899; }
        .summary-stat.gray .value { color: var(--text-muted); }
        .dashboard-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .dashboard-card { background: var(--bg-card); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color); transition: background 0.3s ease; }
        .dashboard-card h3 { font-size: 0.95rem; margin-bottom: 16px; color: var(--text-secondary); }
        .chart-container { position: relative; height: 180px; display: flex; justify-content: center; align-items: center; }
        /* CSS Doughnut Chart - No external library */
        .css-doughnut { width: 100px; height: 100px; border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; background: conic-gradient(var(--text-muted) 0deg 360deg); }
        .css-doughnut::before { content: ''; position: absolute; width: 50px; height: 50px; background: var(--doughnut-bg); border-radius: 50%; z-index: 1; }
        .css-doughnut .center-text { position: absolute; z-index: 2; text-align: center; }
        .css-doughnut .center-text .pct { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
        .css-doughnut .center-text .lbl { font-size: 0.5rem; color: var(--text-muted); }
        .chart-legend { display: flex; justify-content: center; gap: 16px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--text-muted); }
        
        .legend-color { width: 10px; height: 10px; border-radius: 2px; }
        .size-summary { display: flex; justify-content: space-around; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
        .size-item { text-align: center; }
        .size-item .size-value { font-size: 1.3rem; font-weight: 700; }
        .size-item .size-label { font-size: 0.7rem; color: #94a3b8; margin-top: 4px; }
        .size-item.green .size-value { color: #10b981; }
        .size-item.orange .size-value { color: #f59e0b; }
        .size-item.cyan .size-value { color: #06b6d4; }
        .size-item.pink .size-value { color: #ec4899; }
        .size-item.blue .size-value { color: #3b82f6; }
        .size-item.purple .size-value { color: #a855f7; }
        .size-item.gray .size-value { color: #94a3b8; }
        .ratio-bar-container { margin-top: 16px; }
        .ratio-bar-labels { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 8px; color: #94a3b8; flex-wrap: wrap; gap: 8px; }
        .ratio-bar { height: 28px; border-radius: 14px; overflow: hidden; display: flex; background: rgba(0,0,0,0.3); }
        .ratio-bar .segment { display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #fff; transition: width 0.5s ease; }
        .ratio-bar .deliverable-seg { background: linear-gradient(90deg, #10b981, #34d399); }
        .ratio-bar .non-deliverable-seg { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .alert-card { background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); }
        .alert-card h3 { color: #a5b4fc; }
        .warning-card { background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); }
        .warning-card h3 { color: #a5b4fc; }
        body.light-theme .alert-card { background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05)) !important; border-color: rgba(99,102,241,0.25) !important; }
        body.light-theme .alert-card h3 { color: #4338ca !important; }
        body.light-theme .warning-card { background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05)) !important; border-color: rgba(99,102,241,0.25) !important; }
        body.light-theme .warning-card h3 { color: #4338ca !important; }
        .mini-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .mini-table th, .mini-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }
        .mini-table th { background: rgba(0,0,0,0.3); color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; }
        .mini-table tr:hover { background: rgba(255,255,255,0.05); }
        .table-section { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 24px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; margin-bottom: 24px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .table-header h3 { font-size: 1.1rem; }
        .table-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .table-tab { padding: 8px 16px; border-radius: 8px; background: rgba(255,255,255,0.1); border: none; color: #94a3b8; cursor: pointer; font-size: 0.8rem; }
        .table-tab:hover { background: rgba(255,255,255,0.15); }
        .table-tab.active { background: #6366f1; color: #fff; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0,0,0,0.2); color: #94a3b8; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 500; }
        .badge-deliverable { background: rgba(16,185,129,0.2); color: #34d399; }
        .badge-non-deliverable { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .badge-urn-in { background: rgba(6,182,212,0.2); color: #22d3ee; }
        .badge-urn-cf { background: rgba(236,72,153,0.2); color: #f472b6; }
        .wi-link { color: #6366f1; text-decoration: none; }
        .wi-link:hover { text-decoration: underline; }
        .card-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.92); border-radius: 8px; display: none; justify-content: center; align-items: center; z-index: 10; }
        .card-loading.visible { display: flex; }
        .mini-spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #60a5fa; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .loading.visible { display: flex; }
        .loading .spinner { width: 50px; height: 50px; border: 4px solid rgba(99,102,241,0.3); border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .error { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); border-radius: 8px; padding: 12px 16px; color: #fca5a5; margin-top: 12px; }
        .req-lookup-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); margin-top: 16px; }
        .req-lookup-card h4 { font-size: 1rem; margin-bottom: 16px; color: #e2e8f0; }
        .req-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .detail-item { background: rgba(0,0,0,0.2); padding: 10px 14px; border-radius: 8px; }
        .detail-item .label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        .detail-item .value { font-size: 0.9rem; color: #e2e8f0; }
        .tasks-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .tasks-table th, .tasks-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tasks-table th { background: rgba(0,0,0,0.3); color: #94a3b8; font-size: 0.75rem; }
        .no-tasks { color: #94a3b8; text-align: center; padding: 20px; }
        .api-stats { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 8px 12px; border-radius: 8px; font-size: 0.7rem; color: #94a3b8; z-index: 100; }

        /* ===== TABLE COLUMN SIZING ===== */
        /* Small card tables - ID narrow, Title expands, third col narrow */
        #blankSizeTable, #blankReleaseNoteTable, #blankParentTable,
        #lastSprintTable, #tagMissingTable2, #blankDisciplineTable,
        #blankDescTable { table-layout: fixed; width: 100%; }

        #blankSizeTable th:first-child, #blankSizeTable td:first-child,
        #blankReleaseNoteTable th:first-child, #blankReleaseNoteTable td:first-child,
        #blankParentTable th:first-child, #blankParentTable td:first-child,
        #lastSprintTable th:first-child, #lastSprintTable td:first-child,
        #tagMissingTable2 th:first-child, #tagMissingTable2 td:first-child,
        #blankDisciplineTable th:first-child, #blankDisciplineTable td:first-child,
        #blankDescTable th:first-child, #blankDescTable td:first-child { width: 60px; }

        #blankReleaseNoteTable th:nth-child(3), #blankReleaseNoteTable td:nth-child(3),
        #lastSprintTable th:nth-child(3), #lastSprintTable td:nth-child(3),
        #blankDescTable th:nth-child(3), #blankDescTable td:nth-child(3) { width: 52px; }

        #blankParentTable th:nth-child(3), #blankParentTable td:nth-child(3) { width: 42px; }

        #tagMissingTable2 th:nth-child(3), #tagMissingTable2 td:nth-child(3),
        #blankDisciplineTable th:nth-child(3), #blankDisciplineTable td:nth-child(3) { width: 72px; overflow: hidden; text-overflow: ellipsis; }

        /* Card table Title column wraps naturally */
        #blankSizeTable td:nth-child(2), #blankReleaseNoteTable td:nth-child(2),
        #blankParentTable td:nth-child(2), #lastSprintTable td:nth-child(2),
        #tagMissingTable2 td:nth-child(2), #blankDisciplineTable td:nth-child(2),
        #blankDescTable td:nth-child(2) { overflow-wrap: anywhere; }

        /* Compact card tables (No Desc, Over 40h) */
        #blankDescTable th, #blankDescTable td,
        #overEstTasksTable th, #overEstTasksTable td { padding: 4px 6px; font-size: 0.68rem; }
        #blankDescTable { margin-top: 4px; }
        #overEstTasksTable { margin-top: 4px; }

        /* Consistent data quality card sizing */
        .dq-card { min-height: 220px; display: flex; flex-direction: column; }
        .dq-card > div:last-of-type { flex: 1; }

        /* Large tables - non-title columns stay compact */
        #reqListTable, #weekFocusTable, #bugsTable, #sprintGoalReqTable,
        #teamBReqTable { table-layout: auto; }

        #reqListTable th, #reqListTable td,
        #weekFocusTable th, #weekFocusTable td,
        #bugsTable th, #bugsTable td,
        #sprintGoalReqTable th, #sprintGoalReqTable td,
        #teamBReqTable th, #teamBReqTable td { white-space: nowrap; }

        /* Title columns wrap for readable text */
        #reqListTable td:nth-child(2), #weekFocusTable td:nth-child(2),
        #bugsTable td:nth-child(2), #sprintGoalReqTable td:nth-child(2),
        #teamBReqTable td:nth-child(2),
        #reqListTable th:nth-child(2), #weekFocusTable th:nth-child(2),
        #bugsTable th:nth-child(2), #sprintGoalReqTable th:nth-child(2),
        #teamBReqTable th:nth-child(2) { white-space: normal; overflow-wrap: break-word; }

        /* Mismatch table (Tab 1) - Title gets remaining space */
        #mismatchTable, #dvMismatchTable { table-layout: fixed; }
    </style>
    <script src="allowed_users.json"></script>
</head>
<body data-theme="dark">
    <!-- Warning for sandboxed/no-script environments -->
    <noscript>
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#1e293b;z-index:99999;display:flex;align-items:center;justify-content:center;">
            <div style="background:#334155;padding:40px;border-radius:12px;max-text-align:center;color:#e2e8f0;font-family:'Inter',system-ui,sans-serif;">
                <div style="font-size:48px;margin-bottom:20px;">⚠️</div>
                <h2 style="color:#f87171;margin:0 0 16px 0;">JavaScript Required</h2>
                <p style="margin:0 0 20px 0;color:#94a3b8;line-height:1.6;">
                    This dashboard requires JavaScript to fetch data from TFS and display reports.
                </p>
                <p style="margin:0 0 20px 0;color:#fbbf24;font-weight:600;">
                    Please download this file and open it directly in your browser.
                </p>
                <div style="background:#1e293b;padding:16px;border-radius:8px;margin-top:20px;">
                    <p style="margin:0;color:#94a3b8;font-size:14px;">
                        <strong style="color:#60a5fa;">How to:</strong><br>
                        1. Right-click → Save As / Download<br>
                        2. Open the downloaded .html file in Chrome/Edge
                    </p>
                </div>
            </div>
        </div>
    </noscript>

    <!-- API Stats Display -->
    <div class="api-stats" id="apiStats">API Calls: <span id="apiCallCount">0</span></div>

    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="loadingText" style="margin-top: 16px; color: #94a3b8;">Loading...</div>
    </div>

    <!-- Config Panel -->
    <div class="config-panel" id="configPanel">
        <h2>🔗 Connect to TFS</h2>
        <div class="config-field">
            <label>TFS Server URL</label>
            <input type="text" id="tfsUrl" value="https://tfs.casepoint.in/tfs/Casepoint">
        </div>
        <div class="config-field">
            <label>Personal Access Token</label>
            <input type="password" id="pat" placeholder="Enter your PAT" onblur="autoFetchProjects()">
            <div id="patUserInfo" style="display:none; margin-top:6px; padding:8px 10px; background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); border-radius:6px; font-size:0.75rem;">
                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <span style="color:#34d399; font-weight:600;">✅ Authenticated as:</span>
                    <span id="patUserName" style="color:#e2e8f0;"></span>
                    <span id="patUserEmail" style="color:#94a3b8; font-size:0.7rem;"></span>
                    <span id="patUserId" style="color:#64748b; font-size:0.65rem;"></span>
                </div>
            </div>
        </div>
        <div class="config-field">
            <label>Projects <span style="font-size: 0.7rem; color: #94a3b8;">(Select multiple projects)</span></label>
            <div id="projectCheckboxContainer" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;">
                <div style="color: #94a3b8; font-size: 0.85rem;">-- Enter PAT to load projects --</div>
            </div>
            <div id="projectStatus" style="font-size: 0.75rem; margin-top: 6px; color: #94a3b8;"></div>
            <div id="selectedProjects" style="font-size: 0.75rem; margin-top: 6px; color: #60a5fa;"></div>
        </div>
        <button class="btn btn-primary" onclick="connectTFS()">🚀 Connect</button>
        <div id="errorMsg"></div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel" style="max-width: 1100px;">
        <h3>📁 Select Area & Sprint</h3>
        <div class="filter-row" style="align-items: flex-start;">
            <div class="filter-field" style="flex: 1.2; min-width: 280px;">
                <label>Area Path <span style="font-size: 0.7rem; color: #94a3b8;">(Select up to 3 areas)</span> <a href="#" onclick="toggleAllAreas(event)" style="font-size: 0.7rem; color: #34d399; margin-left: 8px;">Select All</a></label>
                <div id="areaCheckboxContainer" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; max-height: 400px; overflow-y: auto;">
                    <div style="color: #94a3b8; font-size: 0.85rem;">-- Loading areas --</div>
                </div>
                <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="exactAreaMatch" Checked style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="exactAreaMatch" style="font-size: 0.75rem; color: #fbbf24; cursor: pointer;" title="When checked, only fetch items with exact area path match. Useful to exclude child areas like 'eCase Platform' when selecting 'eCase'.">
                        ⚡ Exact Area Match <span class="c-muted">(excludes child areas)</span>
                    </label>
                </div>
                <div id="selectedAreas" style="font-size: 0.75rem; margin-top: 6px; color: #60a5fa;"></div>
            </div>
            <div class="filter-field" style="flex: 1.5; min-width: 400px;">
                <label>Sprint / Iteration <span style="font-size: 0.7rem; color: #94a3b8;">(Select one or more sprints)</span></label>
                <div id="iterationCheckboxContainer" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; max-height: 400px; overflow-y: auto;">
                    <div style="color: #94a3b8; font-size: 0.85rem;">-- Loading iterations --</div>
                </div>
                <div id="selectedIterations" style="font-size: 0.75rem; margin-top: 6px; color: #60a5fa;"></div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; padding-top: 20px;">
                <button class="btn btn-success" onclick="loadData()">📊 Load Data</button>
                <button class="btn btn-secondary" onclick="resetConnection()">🔙 Back</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content" id="content">
        <div class="header">
            <div>
                <h1>📊 Sprint Requirements Dashboard</h1>
                <div class="header-info">
                    <span>Area: <span class="highlight" id="hdrArea">-</span></span>
                    <span>Sprint: <span class="highlight" id="hdrSprint">-</span></span>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="themeToggleBtn" onclick="toggleTheme()" style="padding: 8px 12px; font-size: 0.85rem;" title="Toggle Light/Dark Theme">🌙</button>
                <button class="btn btn-secondary" id="refreshBtn" onclick="refreshData()">🔄 Refresh</button>
                <button class="btn btn-secondary" onclick="showFilters()">🔧 Change Filters</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" style="display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 8px;">
            <button class="tab-btn active" id="tabBtn1" onclick="switchTab(1)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(59,130,246,0.3); border: 1px solid rgba(59,130,246,0.5); border-radius: 6px 6px 0 0; color: #93c5fd; cursor: pointer; transition: all 0.2s;">📋 Sprint Planning</button>
            <button class="tab-btn" id="tabBtn2" onclick="switchTab(2)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">📈 Work Progress</button>
            <button class="tab-btn" id="tabBtn3" onclick="switchTab(3)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">🤖 AI Usage</button>
            <button class="tab-btn" id="tabBtn4" onclick="switchTab(4)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">📊 AI Analytics</button>
            <button class="tab-btn" id="tabBtn5" onclick="switchTab(5)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">🚀 Feature Progress</button>
            <button class="tab-btn" id="tabBtn6" onclick="switchTab(6)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">🔍 Data Lookup</button>
            <button class="tab-btn" id="tabBtn7" onclick="switchTab(7)" style="display:none;padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">📅 Weekly Tasks</button>
        </div>

        <!-- Tab 1: Sprint Planning Check -->
        <div class="tab-content" id="tabContent1">

        <!-- Summary Stats -->
        <div class="summary-row">
            <div class="summary-stat blue"><div class="value" id="statTotalReq">0</div><div class="label">Total Req/CR</div></div>
            <div class="summary-stat green"><div class="value" id="statDeliverable">0</div><div class="label">Deliverable</div></div>
            <div class="summary-stat orange"><div class="value" id="statNonDeliverable">0</div><div class="label">Non-Deliverable</div></div>
            <div class="summary-stat red"><div class="value" id="statBugs">0</div><div class="label">Bugs</div></div>
            <div class="summary-stat cyan"><div class="value" id="statUrnIn">0</div><div class="label">URN-IN</div></div>
            <div class="summary-stat pink"><div class="value" id="statUrnCf">0</div><div class="label">URN-CF</div></div>
            <div class="summary-stat gray"><div class="value" id="statBlankDesc">0</div><div class="label">Blank Desc</div></div>
        </div>

        <!-- Charts Row - Compact Layout -->
        <div class="dashboard-section" style="grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div class="dashboard-card" style="padding: 14px;">
                <h3 style="font-size: 0.85rem; margin-bottom: 10px;">📈 Deliverable vs Non-Deliverable (Size)</h3>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="chart-container" style="height: 100px; width: 100px; flex-shrink: 0;">
                        <div class="css-doughnut" id="sizeChart" style="width: 100px; height: 100px;"></div>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(59,130,246,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">🟢 Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #3b82f6;" id="chartDelSize">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(168,85,247,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">🟠 Non-Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #a855f7;" id="chartNonDelSize">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(148,163,184,0.1); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">📊 Total</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #94a3b8;" id="chartTotalSize">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ratio-bar-container" style="margin-top: 10px;">
                    <div class="ratio-bar-labels" style="font-size: 0.65rem;">
                        <span>Del: <strong id="lblDelSize">0</strong> (<span id="lblDelPct">0%</span>)</span>
                        <span>Non-Del: <strong id="lblNonDelSize">0</strong> (<span id="lblNonDelPct">0%</span>)</span>
                    </div>
                    <div class="ratio-bar" style="height: 20px; border-radius: 10px;">
                        <div class="segment deliverable-seg" id="barDel" style="width:0%"></div>
                        <div class="segment non-deliverable-seg" id="barNonDel" style="width:0%"></div>
                    </div>
                </div>
            </div>
            <div class="dashboard-card" style="padding: 14px;">
                <h3 style="font-size: 0.85rem; margin-bottom: 10px;">📊 Deliverable vs Non-Deliverable (Task Est) <span style="color: #64748b; font-size: 0.55rem;">Discipline: Development & Test only</span></h3>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="chart-container" style="height: 100px; width: 100px; flex-shrink: 0;">
                        <div class="css-doughnut" id="taskEstChart" style="width: 100px; height: 100px;"></div>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(6,182,212,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">🟢 Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #06b6d4;" id="chartDelTaskEst">0h</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(236,72,153,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">🟠 Non-Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #ec4899;" id="chartNonDelTaskEst">0h</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(148,163,184,0.1); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">📊 Total</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #94a3b8;" id="chartTotalTaskEst">0h</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ratio-bar-container" style="margin-top: 10px;">
                    <div class="ratio-bar-labels" style="font-size: 0.65rem;">
                        <span>Del: <strong id="lblDelTaskEst">0h</strong> (<span id="lblDelTaskEstPct">0%</span>)</span>
                        <span>Non-Del: <strong id="lblNonDelTaskEst">0h</strong> (<span id="lblNonDelTaskEstPct">0%</span>)</span>
                    </div>
                    <div class="ratio-bar" style="height: 20px; border-radius: 10px;">
                        <div class="segment deliverable-seg" id="barDelTaskEst" style="width:0%"></div>
                        <div class="segment non-deliverable-seg" id="barNonDelTaskEst" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Planned Sprint Data Estimate Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1)); border: 1px solid rgba(239,68,68,0.3);">
            <h3 style="color: #fca5a5; font-size: 1.1rem;">📊 Overall Planned Sprint Data Estimate</h3>
            <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 16px;">Team capacity vs planned work</p>
            
            <!-- Working Days Calculation - Compact -->
            <div style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(99,102,241,0.15)); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 10px 14px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 6px; font-size: 0.85rem; color: #e2e8f0;">
                    <span style="color: #93c5fd; font-weight: 600;">📅</span>
                    <span style="background: rgba(59,130,246,0.3); padding: 4px 10px; border-radius: 6px;">
                        <strong id="sprintCalendarDays">0</strong> Cal Days
                    </span>
                    <span class="c-dim">−</span>
                    <span style="background: rgba(239,68,68,0.3); padding: 4px 10px; border-radius: 6px;">
                        <strong id="teamDaysOff">0</strong> Off
                    </span>
                    <span class="c-dim">=</span>
                    <span style="background: rgba(16,185,129,0.3); padding: 4px 10px; border-radius: 6px;">
                        <strong id="sprintWorkDays" style="color: #34d399;">0</strong> Work Days
                    </span>
                    <span id="teamDaysOffDetails" style="display: none; margin-left: 8px; font-size: 0.75rem; color: #94a3b8;">
                        (Off: <span id="teamDaysOffDatesList" style="color: #fbbf24;"></span>)
                    </span>
                </div>
            </div>
            
            <!-- Team Members Capacity -->
            <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h4 style="color: #93c5fd; font-size: 0.9rem; margin: 0;">👥 Team Members Capacity (<span id="memberCount">0</span>)</h4>
                    <button class="btn btn-primary btn-compact" id="loadMembersCapBtn" onclick="toggleMembersCapacity()" >📋 Show</button>
                </div>
                <div id="membersCapacityContent" style="display: none;">
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table id="membersCapacityTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <colgroup>
                                <col style="width:22%"><col style="width:14%"><col style="width:14%"><col style="width:13%">
                                <col style="width:10%"><col style="width:7%"><col style="width:8%"><col style="width:12%">
                            </colgroup>
                            <thead id="membersCapacityTableHead" style="background: #0f172a; position: sticky; top: 0; z-index: 1;"></thead>
                            <tbody id="membersCapacityTableBody"></tbody>
                        </table>
                    </div>
                    <table id="membersCapacityTotalTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed; background: rgba(0,0,0,0.3); font-weight: 600; border-top: 2px solid rgba(52,211,153,0.4);">
                        <colgroup>
                            <col style="width:22%"><col style="width:14%"><col style="width:14%"><col style="width:13%">
                            <col style="width:10%"><col style="width:7%"><col style="width:8%"><col style="width:12%">
                        </colgroup>
                        <tr>
                            <td style="padding:8px;color:#e2e8f0;">TOTAL</td>
                            <td style="padding:8px;color:#64748b;">-</td>
                            <td style="padding:8px;color:#64748b;">-</td>
                            <td style="padding:8px;color:#64748b;">-</td>
                            <td style="padding:8px;text-align:center;" id="totalCapPerDay">0h</td>
                            <td style="padding:8px;text-align:center;" id="totalDaysOff">0</td>
                            <td style="padding:8px;text-align:center;color:#64748b;">-</td>
                            <td style="padding:8px;text-align:center;color:#34d399;" id="totalTeamCapacity">0h</td>
                        </tr>
                    </table>
                    <div id="noMembersData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.7rem;">No capacity data</div>
                </div>
            </div>
            
            <div class="summary-row" style="margin-bottom: 16px;">
                <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3);">
                    <div class="value" id="teamCapacity" style="color: #60a5fa;">0h</div>
                    <div class="label">Team Capacity</div>
                </div>
                <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3);">
                    <div class="value" id="totalPlannedCapacity" style="color: #fbbf24;">0h</div>
                    <div class="label">Total Planned</div>
                </div>
                <div class="summary-stat" style="background: rgba(148,163,184,0.2); border-color: rgba(148,163,184,0.3);">
                    <div class="value c-muted" id="almEngExtraHours" >0h</div>
                    <div class="label">ALM/TeamB/etc</div>
                </div>
                <div class="summary-stat" style="background: rgba(236,72,153,0.2); border-color: rgba(236,72,153,0.3);">
                    <div class="value" id="uiUxUdHours" style="color: #f472b6;">0h</div>
                    <div class="label">UI/UX & UD</div>
                </div>
                <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3);">
                    <div class="value" id="availableCapacity" style="color: #22d3ee;">0h</div>
                    <div class="label">Available</div>
                </div>
                <div class="summary-stat" id="overPlanStat" style="background: rgba(168,85,247,0.2); border-color: rgba(168,85,247,0.3);">
                    <div class="value" id="overPlannedCapacity" style="color: #c4b5fd;">0h</div>
                    <div class="label">Planned Capacity</div>
                </div>
                <div class="summary-stat" id="overPlanPctStat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3);">
                    <div class="value" id="overPlanPct" style="color: #f87171;">0%</div>
                    <div class="label">Over Plan %</div>
                </div>
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.85rem; color: #94a3b8;">
                <strong>Formulas:</strong><br>
                • Available Capacity = Team Capacity (<span id="formulaTeamCap">0</span>h) - ALM/TeamB/etc (<span id="formulaAlmEng">0</span>h) - UI/UX&UD (<span id="formulaUiUxUd">0</span>h) = <span id="formulaAvailable" style="color: #22d3ee;">0</span>h<br>
                • Over Planned = Total Planned (<span id="formulaTotalPlanned">0</span>h) - ALM/TeamB/etc (<span id="formulaAlmEng2">0</span>h) - UI/UX&UD (<span id="formulaUiUxUd2">0</span>h) = <span id="formulaOverPlanned" style="color: #f87171;">0</span>h<br>
                • Over Plan % = (Over Planned - Available) / Available × 100
            </div>
            <div id="overPlanAlert" style="display:none; background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(99,102,241,0.15)); border: 1px solid rgba(139,92,246,0.4); border-radius: 8px; padding: 12px; margin-top: 12px;">
                <p style="color: #c4b5fd; font-size: 0.9rem; margin: 0;">🤖 <strong>AI Opportunity:</strong> Extended work by <span id="overPlanAlertPct">0%</span> - Use AI tools (Co-Pilot, Claude) to accelerate!</p>
            </div>
            <div id="underPlanAlert" style="display:none; background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); border-radius: 8px; padding: 12px; margin-top: 12px;">
                <p style="color: #6ee7b7; font-size: 0.9rem; margin: 0;">✅ <strong>Well Planned:</strong> Sprint capacity is balanced.</p>
            </div>
            
            <!-- Development Only Section -->
            <div style="background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.4); border-radius: 10px; padding: 12px; margin-top: 12px;">
                <h4 style="color: #6ee7b7; font-size: 0.95rem; margin-bottom: 8px;">💻 Development Only <span style="font-size: 0.7rem; color: #94a3b8; font-weight: normal;">(Discipline = Development)</span></h4>
                <div class="summary-row" style="margin-bottom: 0; flex-wrap: wrap; gap: 6px;">
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devTeamCapacity" style="color: #60a5fa; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Team Capacity</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devTotalPlanned" style="color: #fbbf24; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Total Planned</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devAvailableCapacity" style="color: #22d3ee; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Available</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(168,85,247,0.2); border-color: rgba(168,85,247,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devPlannedCapacity" style="color: #c4b5fd; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Planned</div>
                    </div>
                    <div class="summary-stat" id="devOverPlanPctStat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devOverPlanPct" style="color: #f87171; font-size: 0.95rem;">0%</div>
                        <div class="label" style="font-size: 0.55rem;">Over Plan %</div>
                    </div>
                </div>
                
                <!-- Unclassified Category Blocks (by first word) + Adhoc Support -->
                <div style="margin-top: 10px;">
                    <p style="color: #94a3b8; font-size: 0.65rem; margin-bottom: 6px;">📊 Breakdown by Requirement Category:</p>
                    <div style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 6px 8px; margin-bottom: 8px; font-size: 0.58rem; color: #64748b; line-height: 1.5;">
                        <span style="color: #94a3b8; font-weight: 600;">ℹ️ Considered:</span>
                        <span style="color: #6ee7b7;">Deliverable</span> or <span style="color: #60a5fa;">Non-Deliverable</span> Requirements only with child tasks where <span style="color: #c4b5fd;">Discipline = Development</span>.
                        <br><span style="color: #94a3b8; font-weight: 600;">Grouped by:</span> <span style="color: #fbbf24;">Adhoc Support</span> tag → "Adhoc Support", otherwise by <span style="color: #22d3ee;">first word</span> of requirement title.
                        <br><span style="color: #94a3b8; font-weight: 600;">Example:</span> <span style="color: #e2e8f0;">ALM Activities → "<span style="color: #22d3ee;">ALM</span>" block | Ticket Handling / Ticket Support → "<span style="color: #22d3ee;">Ticket</span>" | Engineering Operations &amp; Support → "<span style="color: #22d3ee;">Engineering</span>" | rest → Unclassified</span>
                    </div>
                    <div id="devCategoryBlocks" class="summary-row" style="margin-bottom: 0; flex-wrap: wrap; gap: 6px;">
                        <!-- Dynamic blocks will be inserted here -->
                    </div>
                    <div style="margin-top: 6px; font-size: 0.65rem; color: #94a3b8;">
                        <span>Total Unclassified: <strong id="devUnclassifiedTotal" style="color: #6ee7b7;">0h</strong></span>
                    </div>
                </div>
                
                <div style="margin-top: 8px; font-size: 0.7rem; color: #94a3b8;">
                    <span style="margin-right: 12px;">👥 Dev Members: <strong id="devMemberCount" style="color: #60a5fa;">0</strong></span>
                    <span>📋 Dev Tasks: <strong id="devTaskCount" style="color: #6ee7b7;">0</strong></span>
                </div>
                <!-- Hidden formula spans for JS updates -->
                <div style="display:none;">
                    <span id="devFormulaTeamCap">0</span>
                    <span id="devFormulaAlmEng">0</span>
                    <span id="devFormulaAvailable">0</span>
                    <span id="devFormulaTotalPlanned">0</span>
                    <span id="devFormulaAlmEng2">0</span>
                    <span id="devFormulaPlanned">0</span>
                    <span id="devFormulaOverPlanPct">0%</span>
                </div>
            </div>
        </div>

        <!-- Sprint Goal Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3); padding: 12px;">
            <h3 style="color: #6ee7b7; font-size: 1rem; margin-bottom: 8px;">🎯 Sprint Goal Requirements</h3>
            <div class="summary-row" style="margin-bottom: 10px; gap: 6px;">
                <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 6px;"><div class="value" id="sprintGoalReqCount" style="color: #34d399; font-size: 1.1rem;">0</div><div class="label" style="font-size: 0.55rem;">Requirements</div></div>
                <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 6px;"><div class="value" id="sprintGoalTaskCount" style="color: #60a5fa; font-size: 1.1rem;">0</div><div class="label" style="font-size: 0.55rem;">Total Tasks</div></div>
                <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 6px;"><div class="value" id="sprintGoalOriginalEst" style="color: #fbbf24; font-size: 1.1rem;">0h</div><div class="label" style="font-size: 0.55rem;">Original Est</div></div>
                <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); padding: 6px;"><div class="value" id="sprintGoalRemainingWork" style="color: #22d3ee; font-size: 1.1rem;">0h</div><div class="label" style="font-size: 0.55rem;">Remaining</div></div>
                <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 6px;"><div class="value" id="sprintGoalCompletedWork" style="color: #34d399; font-size: 1.1rem;">0h</div><div class="label" style="font-size: 0.55rem;">Completed</div></div>
            </div>
            <div class="ratio-bar-container" style="margin-bottom: 12px;">
                <div class="ratio-bar-labels" style="font-size: 0.85rem; margin-bottom: 4px;"><span>✅ Completed: <strong id="sprintGoalCompPct" style="color: #34d399;">0%</strong></span><span>⏳ Remaining: <strong id="sprintGoalRemPct" style="color: #fbbf24;">0%</strong></span></div>
                <div class="ratio-bar" style="height: 16px; border-radius: 8px;">
                    <div class="segment" id="sprintGoalBarComp" style="width:0%; background: linear-gradient(90deg, #10b981, #34d399);"></div>
                    <div class="segment" id="sprintGoalBarRem" style="width:0%; background: linear-gradient(90deg, #f59e0b, #fbbf24);"></div>
                </div>
            </div>
            <table id="sprintGoalReqTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;"><thead class="bg-overlay"><tr><th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Tasks</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Orig Est</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Remaining</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Completed</th></tr></thead><tbody></tbody></table>
            <div id="noSprintGoalData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No Sprint Goal requirements</div>
        </div>
        <!-- TEAM B Dashboard -->
        <div class="dashboard-card" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); padding: 10px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">🎫 TEAM B (<span id="teamBReqCount">0</span>)</h3>
                <button id="refreshTeamBBtn" onclick="refreshTeamBCard()" style="background: rgba(99,102,241,0.3); border: 1px solid rgba(99,102,241,0.5); color: #a5b4fc; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
            </div>
            <div class="summary-row" style="margin-bottom: 8px; gap: 6px; justify-content: flex-start;">
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTaskCount" style="font-size: 0.9rem; color: #34d399;">0</div><div class="label" style="font-size: 0.45rem;">Tasks</div></div>
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTotalSize" style="font-size: 0.9rem; color: #c084fc;">0</div><div class="label" style="font-size: 0.45rem;">Size</div></div>
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTotalOrigEst" style="font-size: 0.9rem; color: #fbbf24;">0h</div><div class="label" style="font-size: 0.45rem;">Orig Est</div></div>
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTotalRemWork" style="font-size: 0.9rem; color: #22d3ee;">0h</div><div class="label" style="font-size: 0.45rem;">Remaining</div></div>
            </div>
            <div style="max-height: 200px; overflow-y: auto;">
                <table id="teamBReqTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                    <thead style="background: #1a1f2e; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Tasks</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Size</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Est</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Rem</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="noTeamBData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">No TEAM B requirements</div>
        </div>

        <!-- Alert Dashboards Grid - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px;">
            <!-- Over 40h Tasks -->
            <div class="dashboard-card alert-card" style="padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="font-size: 0.85rem; margin: 0;">⚠️ Tasks >40h (<span id="overEstTaskCount">0</span>)</h3>
                    <button id="refreshOverEstBtn" onclick="refreshOverEstTasksCard()" style="background: rgba(239,68,68,0.3); border: 1px solid rgba(239,68,68,0.5); color: #fca5a5; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table class="mini-table" id="overEstTasksTable" style="font-size: 0.7rem;">
                        <thead style="position: sticky; top: 0; background: #1e293b; z-index: 1;"><tr><th>ID</th><th>Title</th><th>Est</th><th>Assigned</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="noOverEstTasks" style="text-align:center;color:#94a3b8;padding:8px;font-size:0.7rem;">None</div>
            </div>
            
            <!-- Blank Description -->
            <div class="dashboard-card warning-card" style="padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="font-size: 0.85rem; margin: 0;">📝 No Desc (<span id="blankDescCount">0</span>)</h3>
                    <button id="refreshBlankDescBtn" onclick="refreshBlankDescCard()" style="background: rgba(245,158,11,0.3); border: 1px solid rgba(245,158,11,0.5); color: #fcd34d; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table class="mini-table" id="blankDescTable" style="font-size: 0.7rem;">
                        <thead style="position: sticky; top: 0; background: #1e293b; z-index: 1;"><tr><th>ID</th><th>Title</th><th>State</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="noBlankDesc" style="text-align:center;color:#94a3b8;padding:8px;font-size:0.7rem;">OK</div>
            </div>
        </div>

        <!-- Data Quality Dashboards - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- 1. Blank/0 Size Dashboard -->
            <div class="dashboard-card dq-card" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">📏 Blank/0 Size (<span id="blankSizeCount">0</span>)</h3>
                    <button onclick="refreshBlankSizeCard()" style="background: rgba(239,68,68,0.3); border: 1px solid rgba(239,68,68,0.5); color: #fca5a5; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Del/Non-Del with blank or zero Size</p>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table id="blankSizeTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th></tr></thead>
                        <tbody id="blankSizeTableBody"></tbody>
                    </table>
                </div>
                <div id="noBlankSizeData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Size ✓</div>
            </div>

            <!-- 2. Blank Release Note Dashboard -->
            <div class="dashboard-card dq-card" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">📝 Blank Release Note (<span id="blankReleaseNoteCount">0</span>)</h3>
                    <button onclick="refreshBlankReleaseNoteCard()" style="background: rgba(245,158,11,0.3); border: 1px solid rgba(245,158,11,0.5); color: #fcd34d; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Del/Non-Del with blank Release Notes</p>
                <div style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
                    <table id="blankReleaseNoteTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th></tr></thead>
                        <tbody id="blankReleaseNoteTableBody"></tbody>
                    </table>
                </div>
                <div id="noBlankReleaseNoteData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Release Note ✓</div>
            </div>
        </div>
        
        <!-- No Parent Dashboard - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- 3. Blank Parent/No Parent Dashboard -->
            <div class="dashboard-card dq-card" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">🔗 No Parent (<span id="blankParentCount">0</span>)</h3>
                    <button onclick="refreshNoParentCard()" style="background: rgba(168,85,247,0.3); border: 1px solid rgba(168,85,247,0.5); color: #c4b5fd; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Del/Non-Del without Parent link</p>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table id="blankParentTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Cat</th></tr></thead>
                        <tbody id="blankParentTableBody"></tbody>
                    </table>
                </div>
                <div id="noBlankParentData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Parent ✓</div>
            </div>
            
            <!-- Last Sprint Open Items Dashboard -->
            <div class="dashboard-card dq-card" style="padding: 10px; background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">📋 Last Sprint Open (<span id="lastSprintOpenCount">0</span>)</h3>
                    <button onclick="refreshLastSprintOpenCard()" style="background: rgba(245,158,11,0.3); border: 1px solid rgba(245,158,11,0.5); color: #fcd34d; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Prev sprint items NOT Closed</p>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table id="lastSprintTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th></tr></thead>
                        <tbody id="lastSprintTableBody"></tbody>
                    </table>
                </div>
                <div id="noLastSprintData" style="display:none; text-align:center; color:#94a3b8; padding:6px; font-size: 0.6rem;">No open items ✓</div>
            </div>
        </div>

        <!-- Tag Missing & Blank Discipline - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- Tag Missing Dashboard -->
            <div class="dashboard-card dq-card" style="padding: 10px; background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">🏷️ Tag Missing (<span id="tagMissingCount">0</span>)</h3>
                    <button onclick="refreshTagMissingCard()" style="background: rgba(6,182,212,0.3); border: 1px solid rgba(6,182,212,0.5); color: #67e8f9; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Dev Tasks missing tags: <span style="color: #67e8f9; font-style: italic;">Product | ALM | Training | Support | Bug/Maintenance</span></p>
                <div style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
                    <table id="tagMissingTable2" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th></tr></thead>
                        <tbody id="tagMissingTableBody2"></tbody>
                    </table>
                </div>
                <div id="noTagMissingData2" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have tags ✓</div>
            </div>

            <!-- Blank Discipline Dashboard -->
            <div class="dashboard-card dq-card" style="padding: 10px; background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">⚠️ Blank Discipline (<span id="blankDisciplineCount">0</span>)</h3>
                    <button onclick="refreshBlankDisciplineCard()" style="background: rgba(168,85,247,0.3); border: 1px solid rgba(168,85,247,0.5); color: #c4b5fd; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">🔄</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Dev Tasks with empty Discipline</p>
                <div style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
                    <table id="blankDisciplineTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th></tr></thead>
                        <tbody id="blankDisciplineTableBody"></tbody>
                    </table>
                </div>
                <div id="noBlankDisciplineData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Discipline ✓</div>
            </div>
        </div>

        <!-- Requirements List -->
        <div class="table-section" style="padding: 12px;">
            <div class="table-header" style="margin-bottom: 8px;">
                <h3 style="font-size: 1rem;">📋 Requirements List</h3>
                <button class="btn btn-primary btn-compact" id="loadReqListBtn" onclick="toggleRequirementsList()" >📋 Show</button>
            </div>
            <div id="reqListContent" style="display: none;">
                <div class="table-tabs" style="gap: 4px; margin-bottom: 8px; flex-wrap: wrap;">
                    <button class="table-tab active" onclick="filterTable('all', this)" style="padding: 4px 8px; font-size: 0.7rem;">All</button>
                    <button class="table-tab" onclick="filterTable('deliverable', this)" style="padding: 4px 8px; font-size: 0.7rem;">Deliverable</button>
                    <button class="table-tab" onclick="filterTable('nonDeliverable', this)" style="padding: 4px 8px; font-size: 0.7rem;">Non-Deliverable</button>
                    <button class="table-tab" onclick="filterTable('deliverablesAdhoc', this)" style="padding: 4px 8px; font-size: 0.7rem; background: rgba(168,85,247,0.2); color: #d8b4fe;">Deliverables Adhoc</button>
                    <button class="table-tab" onclick="filterTable('deliverablesOnHold', this)" style="padding: 4px 8px; font-size: 0.7rem; background: rgba(245,158,11,0.2); color: #fcd34d;">Deliverables OnHold</button>
                    <button class="table-tab" onclick="filterTable('adhocSupport', this)" style="padding: 4px 8px; font-size: 0.7rem;">Adhoc Support</button>
                    <button class="table-tab" onclick="filterTable('affectOthers', this)" style="padding: 4px 8px; font-size: 0.7rem;">Affect Others</button>
                    <button class="table-tab" onclick="filterTable('affectedArea', this)" style="padding: 4px 8px; font-size: 0.7rem;">Affected Area</button>
                    <button class="table-tab" onclick="filterTable('urnIn', this)" style="padding: 4px 8px; font-size: 0.7rem;">URN-IN</button>
                    <button class="table-tab" onclick="filterTable('urnCf', this)" style="padding: 4px 8px; font-size: 0.7rem;">URN-CF</button>
                    <button class="table-tab" onclick="filterTable('urnMissing', this)" style="padding: 4px 8px; font-size: 0.7rem;">URN ❌</button>
                    <button class="table-tab" onclick="filterTable('noWeeklyTag', this)" style="padding: 4px 8px; font-size: 0.7rem; background: rgba(239,68,68,0.2); color: #fca5a5;">No Weekly Tag</button>
                </div>
                <div id="reqListFilters" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center;padding:8px 10px;background:rgba(0,0,0,0.15);border-radius:8px;border:1px solid rgba(99,102,241,0.15);">
                    <span style="color:#94a3b8;font-size:0.7rem;font-weight:600;">🔽 Filters:</span>
                    <select id="reqFilterState" onchange="renderTable()" class="req-filter-select">
                        <option value="all">All States</option>
                    </select>
                    <select id="reqFilterAssigned" onchange="renderTable()" class="req-filter-select">
                        <option value="all">All Assigned</option>
                    </select>
                    <select id="reqFilterIteration" onchange="renderTable()" class="req-filter-select">
                        <option value="all">All Iterations</option>
                    </select>
                    <select id="reqFilterCategory" onchange="renderTable()" class="req-filter-select">
                        <option value="all">All Categories</option>
                    </select>
                    <select id="reqFilterUrn" onchange="renderTable()" class="req-filter-select">
                        <option value="all">All URN</option>
                    </select>
                    <button onclick="resetReqListFilters()" style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#fca5a5;border-radius:6px;padding:5px 10px;font-size:0.65rem;cursor:pointer;font-weight:600;">✕ Clear</button>
                </div>
                <table id="reqListTable" style="font-size: 0.75rem; width: 100%; border-collapse: collapse;">
                    <thead id="reqListTableHead" class="bg-overlay"></thead>
                    <tbody id="reqTable"></tbody>
                </table>
                <div id="noData" style="display:none;text-align:center;color:#94a3b8;padding:20px;font-size:0.75rem;">No requirements</div>
            </div>
        </div>
        </div><!-- End Tab 1 -->

        <!-- Tab 2: Work Item Progress -->
        <div class="tab-content" id="tabContent2" style="display: none;">

        <!-- Weekly Progress Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #93c5fd; font-size: 1rem; margin: 0;">📅 Weekly Progress Tracker</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn btn-primary btn-compact" id="loadWeeklyBtn" onclick="toggleWeeklyProgress()" >📊 Show</button>
                </div>
            </div>
            <div id="weeklyProgressContent" style="display: none;">
                <p style="color: #94a3b8; font-size: 0.75rem; margin-bottom: 12px;">
                    Track sprint delivery by week tags (Week 1, Week 2, Week 3, Week 4) - 
                    <span style="background: rgba(59,130,246,0.3); padding: 2px 6px; border-radius: 4px; color: #93c5fd;">Deliverable</span> items only | Status: Resolved/Closed = Done
                </p>
                
                <!-- Current Week Focus Items -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #fbbf24; font-size: 0.9rem; margin: 0;">🎯 Current Week Focus Items (<span id="focusItemCount">0</span>)</h4>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <select id="weeklyIterationFilter" onchange="onWeeklyIterationFilterChange()" style="background: rgba(0,0,0,0.3); color: #e2e8f0; border: 1px solid rgba(99,102,241,0.4); border-radius: 6px; padding: 3px 8px; font-size: 0.7rem; cursor: pointer; outline: none; min-width: 130px;">
                                <option value="all">All Iterations</option>
                            </select>
                            <span style="color: #94a3b8; font-size: 0.7rem; margin-right: 4px;">Filter:</span>
                            <button onclick="filterFocusItems('all')" id="focusFilterAll" class="focus-filter-btn active" style="background: rgba(139,92,246,0.4); border: 1px solid rgba(139,92,246,0.6); color: #c4b5fd; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                            <button onclick="filterFocusItems('week1')" id="focusFilterWeek1" class="focus-filter-btn" style="background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.4); color: #93c5fd; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 1</button>
                            <button onclick="filterFocusItems('week2')" id="focusFilterWeek2" class="focus-filter-btn" style="background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); color: #6ee7b7; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 2</button>
                            <button onclick="filterFocusItems('week3')" id="focusFilterWeek3" class="focus-filter-btn" style="background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.4); color: #fcd34d; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 3</button>
                            <button onclick="filterFocusItems('week4')" id="focusFilterWeek4" class="focus-filter-btn" style="background: rgba(236,72,153,0.2); border: 1px solid rgba(236,72,153,0.4); color: #f9a8d4; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 4</button>
                        </div>
                    </div>
                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="weekFocusTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Week</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Original</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Remaining</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Completed</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Progress</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th>
                            </tr></thead>
                            <tbody id="weekFocusTableBody"></tbody>
                        </table>
                    </div>
                    <div id="noFocusItems" style="display:none; text-align:center; color:#94a3b8; padding:10px; font-size: 0.75rem;">No focus items</div>
                </div>
                
                <div id="noWeeklyData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No Deliverable requirements with weekly tags found</div>
            </div>
        </div>

        <!-- Bugs Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.3); padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="color: #fca5a5; font-size: 1rem; margin: 0;">🐛 Bugs (<span id="bugCount">0</span>)</h3>
                <button class="btn btn-primary btn-compact" id="toggleBugsBtn" onclick="toggleBugsDashboard()" >📋 Show</button>
            </div>
            <div id="bugsContent" style="display: none;">
                <!-- Filter Buttons -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <span style="color: #94a3b8; font-size: 0.7rem; margin-right: 4px;">Filter:</span>
                        <button onclick="filterBugs('all')" id="bugFilterAll" style="background: rgba(239,68,68,0.4); border: 1px solid rgba(239,68,68,0.6); color: #fca5a5; padding: 4px 12px; border-radius: 6px; font-size: 0.72rem; cursor: pointer; font-weight: 600;">All</button>
                        <button onclick="filterBugs('cs')" id="bugFilterCS" style="background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.4); color: #93c5fd; padding: 4px 12px; border-radius: 6px; font-size: 0.72rem; cursor: pointer;">🎧 CS</button>
                        <button onclick="filterBugs('production')" id="bugFilterProduction" style="background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.4); color: #fcd34d; padding: 4px 12px; border-radius: 6px; font-size: 0.72rem; cursor: pointer;">🚀 Production</button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 10px; gap: 8px;">
                    <div class="summary-stat" style="padding: 8px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3);">
                        <div class="value" id="bugTotalCount" style="font-size: 1.2rem; color: #f87171;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #fca5a5;">Total</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.3);">
                        <div class="value" id="bugClosedCount" style="font-size: 1.2rem; color: #34d399;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #6ee7b7;">Closed</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.3);">
                        <div class="value" id="bugActiveCount" style="font-size: 1.2rem; color: #fbbf24;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #fcd34d;">Active</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.3);">
                        <div class="value" id="bugResolvedCount" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #93c5fd;">Resolved</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.3);">
                        <div class="value" id="bugCSCount" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #93c5fd;">🎧 CS</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.3);">
                        <div class="value" id="bugProductionCount" style="font-size: 1.2rem; color: #fbbf24;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #fcd34d;">🚀 Prod</div>
                    </div>
                </div>
                
                <!-- Bugs Table -->
                <div style="max-height: 280px; overflow-y: auto;">
                    <table id="bugsTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Tags</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Severity</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="noBugs" style="text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No bugs</div>
            </div>
        </div>

        <!-- Discipline vs Task Execution Type Mismatch Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="color: #fca5a5; font-size: 1rem; margin: 0;">🔀 Discipline - Manual Task Execution Type</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportMismatchExcelBtn" onclick="exportMismatchToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">📥 Excel</button>
                    <button class="btn btn-primary" id="exportMismatchPdfBtn" onclick="exportMismatchToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">📄 PDF</button>
                    <button class="btn btn-primary btn-compact" id="toggleMismatchBtn" onclick="toggleMismatchDashboard()" >📋 Show</button>
                </div>
            </div>
            <div id="mismatchContent" style="display: none;">
                <p style="color: #60a5fa; font-size: 0.7rem; margin-bottom: 10px;"><strong>Expected Matrix:</strong> Development → AI-Dev* | Test → AI-Test* | <span class="c-muted">Closed/Resolved Tasks Only with AI Task Execution Type</span></p>
                <div style="max-height: 280px; overflow-y: auto;">
                    <table id="mismatchTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <thead id="mismatchTableHead" style="background: #0f172a; position: sticky; top: 0; z-index: 1;">
                        </thead>
                        <tbody id="mismatchTableBody"></tbody>
                    </table>
                </div>
                <div id="noMismatchData" style="display:none; text-align:center; color:#34d399; padding:12px; font-size: 0.75rem;">✓ No mismatches found - All tasks have correct discipline-execution type mapping</div>
            </div>
        </div>

        <!-- Discipline Verification Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="color: #93c5fd; font-size: 1rem; margin: 0;">🔍 Discipline Verification</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportDisciplineVerifyBtn" onclick="exportDisciplineVerificationToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">📥 Excel</button>
                    <button class="btn btn-primary" id="exportDisciplineVerifyPdfBtn" onclick="exportDisciplineVerificationToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">📄 PDF</button>
                    <button class="btn btn-primary btn-compact" id="loadDisciplineVerifyBtn" onclick="toggleDisciplineVerification()" >📊 Show</button>
                </div>
            </div>
            <div id="disciplineVerifyContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span class="c-muted">📋 Source:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Team Members Capacity</span>
                        <span class="c-dim">→</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Member Discipline</span>
                        <span class="c-dim">vs</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task Discipline</span>
                        <span class="c-dim">|</span>
                        <span class="c-muted">📌 Req:</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Non-Deliverable</span>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 12px; gap: 10px;">
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 12px;">
                        <div class="value" id="dvMemberCount" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label fs-sm-bold">Members</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(148,163,184,0.2); border-color: rgba(148,163,184,0.3); padding: 12px;">
                        <div class="value" id="dvTotalTasks" style="font-size: 1.2rem; color: #94a3b8;">0</div>
                        <div class="label fs-sm-bold">Total Tasks</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="dvMatchedCount" style="font-size: 1.2rem; color: #34d399;">0</div>
                        <div class="label fs-sm-bold">✅ Matched</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); padding: 12px;">
                        <div class="value" id="dvMismatchedCount" style="font-size: 1.2rem; color: #f87171;">0</div>
                        <div class="label fs-sm-bold">❌ Mismatched</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="dvBlankDisciplineCount" style="font-size: 1.2rem; color: #fbbf24;">0</div>
                        <div class="label fs-sm-bold">⚠️ Blank Disc.</div>
                    </div>
                </div>
                
                <!-- Mismatched & Blank Discipline Tasks Table -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #f87171; font-size: 0.85rem; margin: 0;">❌ Mismatched & ⚠️ Blank Discipline Tasks <span id="dvMismatchTaskCount" style="font-size: 0.75rem; color: #94a3b8;">(0)</span></h4>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="dvMismatchTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="dvMismatchHead" style="background: rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1;"></thead>
                            <tbody id="dvMismatchBody"></tbody>
                        </table>
                    </div>
                    <div id="noDVMismatchData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">✅ No discipline mismatches or blank disciplines found</div>
                </div>
                
            </div>
        </div>

        </div><!-- End Tab 2 -->

        <!-- Tab 3: AI Usage -->
        <div class="tab-content" id="tabContent3" style="display: none;">

        <!-- Dev & QA AI Adoption Block -->
        <div style="border:2px solid rgba(59,130,246,0.3);border-radius:10px;padding:12px;margin-bottom:16px;background:rgba(59,130,246,0.03);">
        <div style="margin-bottom:10px;padding:6px 12px;border-left:3px solid #3b82f6;background:rgba(59,130,246,0.08);border-radius:0 6px 6px 0;">
            <span style="color:#93c5fd;font-size:0.8rem;font-weight:700;">📋 Team AI Adoption Reports</span>
        </div>

        <!-- Dev AI Adoption Data Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #93c5fd; font-size: 1rem; margin: 0;">🤖 Dev AI Adoption Data</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportAIAdoptionBtn" onclick="exportAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">📥 Excel</button>
                    <button class="btn btn-primary" id="exportAIAdoptionPdfBtn" onclick="exportAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">📄 PDF</button>
                    <button class="btn btn-primary btn-compact" id="loadAIAdoptionBtn" onclick="toggleAIAdoptionData()" >📊 Show</button>
                </div>
            </div>
            <div id="aiAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span class="c-muted">📋 Criteria:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Discipline = Development</span>
                        <span class="c-dim">→</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-Dev* | AI-Test-Auto-*</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span class="c-muted">📌 Req/Chr/Bug:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 8px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 12px; gap: 10px;">
                    <div class="summary-stat" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); padding: 12px;">
                        <div class="value" id="aiDevMemberCount" style="font-size: 1.2rem; color: #a78bfa;">0</div>
                        <div class="label fs-sm-bold">Dev Members</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 12px;">
                        <div class="value" id="aiTotalTasks" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label fs-sm-bold">Total Tasks</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="aiTotalOrigEst" style="font-size: 1.2rem; color: #fbbf24;">0h</div>
                        <div class="label fs-sm-bold">Total Orig Est</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="aiTotalCompleted" style="font-size: 1.2rem; color: #34d399;">0h</div>
                        <div class="label fs-sm-bold">Total Completed</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 12px;">
                        <div class="value" id="aiAIAdoptionRate" style="font-size: 1.2rem; color: #60a5fa;">0%</div>
                        <div class="label fs-sm-bold">AI Adoption</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); padding: 12px;">
                        <div class="value" id="aiManualEfficiency" style="font-size: 1.2rem; color: #22d3ee;">0%</div>
                        <div class="label fs-sm-bold">Manual Eff.</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="aiAIEfficiency" style="font-size: 1.2rem; color: #34d399;">0%</div>
                        <div class="label fs-sm-bold">AI Eff.</div>
                    </div>
                </div>
                
                <!-- Area Filter Pagination -->
                <div id="aiAreaFilterBar" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px 10px; margin-bottom: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                        <span style="color: #94a3b8; font-size: 0.7rem; margin-right: 4px;">📍 Area:</span>
                        <div id="aiAreaFilterBtns" style="display: flex; gap: 4px; flex-wrap: wrap;"></div>
                    </div>
                </div>
                
                <!-- Week Filter -->
                <div id="aiWeekFilterBar" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px 10px; margin-bottom: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                        <span style="color: #94a3b8; font-size: 0.7rem; margin-right: 4px;">📅 Week:</span>
                        <div id="aiWeekFilterBtns" style="display: flex; gap: 4px; flex-wrap: wrap;"></div>
                    </div>
                </div>
                
                <!-- Member-wise Summary Table -->
                <div id="memberSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #c4b5fd; font-size: 0.85rem; margin: 0;">👥 Member-wise Summary</h4>
                        <button onclick="toggleMemberSummary()" id="toggleMemberSummaryBtn" style="background: rgba(139,92,246,0.3); border: 1px solid rgba(139,92,246,0.5); color: #c4b5fd; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="memberSummaryContent">
                        <table id="aiAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="aiAdoptionTableHead" class="bg-overlay"></thead>
                            <tbody id="aiAdoptionTableBody"></tbody>
                            <tfoot id="aiAdoptionTableFoot" style="font-weight: 600; background: rgba(139,92,246,0.15);"></tfoot>
                        </table>
                        <div id="noAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No AI adoption data found</div>
                    </div>
                </div>
                
                <!-- Area-wise Summary Table -->
                <div id="areaSummarySection" style="background: rgba(6,182,212,0.1); border: 1px solid rgba(6,182,212,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #67e8f9; font-size: 0.85rem; margin: 0;">🏷️ Area-wise Summary</h4>
                        <button onclick="toggleAreaSummary()" id="toggleAreaSummaryBtn" style="background: rgba(6,182,212,0.3); border: 1px solid rgba(6,182,212,0.5); color: #67e8f9; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="areaSummaryContent" style="overflow-x: auto;">
                        <table id="areaSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="areaSummaryHead" class="bg-overlay"></thead>
                            <tbody id="areaSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Project-wise Summary Table -->
                <div id="projectSummarySection" style="background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #a5b4fc; font-size: 0.85rem; margin: 0;">📁 Project-wise Summary</h4>
                        <button onclick="toggleProjectSummary()" id="toggleProjectSummaryBtn" style="background: rgba(99,102,241,0.3); border: 1px solid rgba(99,102,241,0.5); color: #a5b4fc; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="projectSummaryContent" style="overflow-x: auto;">
                        <table id="projectSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="projectSummaryHead" class="bg-overlay"></thead>
                            <tbody id="projectSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- QA AI Adoption Data Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #6ee7b7; font-size: 1rem; margin: 0;">🧪 QA AI Adoption Data</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportQAAIAdoptionBtn" onclick="exportQAAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">📥 Excel</button>
                    <button class="btn btn-primary" id="exportQAAIAdoptionPdfBtn" onclick="exportQAAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">📄 PDF</button>
                    <button class="btn btn-primary btn-compact" id="loadQAAIAdoptionBtn" onclick="toggleQAAIAdoptionData()" >📊 Show</button>
                </div>
            </div>
            <div id="qaAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span class="c-muted">📋 Criteria:</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Discipline = Test</span>
                        <span class="c-dim">→</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span class="c-muted">📌 Req/Chr/Bug:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 8px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span class="c-muted">🎯 AI Type:</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">TaskExecutionType → AI-Test*</span>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 12px; gap: 10px;">
                    <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); padding: 12px;">
                        <div class="value" id="qaDevMemberCount" style="font-size: 1.2rem; color: #22d3ee;">0</div>
                        <div class="label fs-sm-bold">QA Members</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 12px;">
                        <div class="value" id="qaTotalTasks" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label fs-sm-bold">Total Tasks</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="qaTotalOrigEst" style="font-size: 1.2rem; color: #fbbf24;">0h</div>
                        <div class="label fs-sm-bold">Total Orig Est</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="qaTotalCompleted" style="font-size: 1.2rem; color: #34d399;">0h</div>
                        <div class="label fs-sm-bold">Total Completed</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="qaManualEfficiency" style="font-size: 1.2rem; color: #fcd34d;">0%</div>
                        <div class="label fs-sm-bold">Manual Eff.</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="qaAIEfficiency" style="font-size: 1.2rem; color: #34d399;">0%</div>
                        <div class="label fs-sm-bold">AI Eff.</div>
                    </div>
                </div>
                
                <!-- Member-wise Summary Table -->
                <div id="qaMemberSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #67e8f9; font-size: 0.85rem; margin: 0;">👥 QA Member-wise Summary</h4>
                        <button onclick="toggleQAMemberSummary()" id="toggleQAMemberSummaryBtn" style="background: rgba(6,182,212,0.3); border: 1px solid rgba(6,182,212,0.5); color: #67e8f9; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="qaMemberSummaryContent">
                        <table id="qaAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="qaAIAdoptionTableHead" class="bg-overlay"></thead>
                            <tbody id="qaAIAdoptionTableBody"></tbody>
                            <tfoot id="qaAIAdoptionTableFoot" style="font-weight: 600; background: rgba(6,182,212,0.15);"></tfoot>
                        </table>
                        <div id="noQAAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No QA AI adoption data found</div>
                    </div>
                </div>
                
                <!-- QA Area-wise Summary Table -->
                <div id="qaAreaSummarySection" style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #c4b5fd; font-size: 0.85rem; margin: 0;">🏷️ QA Area-wise Summary</h4>
                        <button onclick="toggleQAAreaSummary()" id="toggleQAAreaSummaryBtn" style="background: rgba(168,85,247,0.3); border: 1px solid rgba(168,85,247,0.5); color: #c4b5fd; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="qaAreaSummaryContent" style="overflow-x: auto;">
                        <table id="qaAreaSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="qaAreaSummaryHead" class="bg-overlay"></thead>
                            <tbody id="qaAreaSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- QA Project-wise Summary Table -->
                <div id="qaProjectSummarySection" style="background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #a5b4fc; font-size: 0.85rem; margin: 0;">📁 QA Project-wise Summary</h4>
                        <button onclick="toggleQAProjectSummary()" id="toggleQAProjectSummaryBtn" style="background: rgba(99,102,241,0.3); border: 1px solid rgba(99,102,241,0.5); color: #a5b4fc; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="qaProjectSummaryContent" style="overflow-x: auto;">
                        <table id="qaProjectSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="qaProjectSummaryHead" class="bg-overlay"></thead>
                            <tbody id="qaProjectSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- End Dev & QA AI Adoption Block -->

        <!-- Dev Overall AI Adoption Summary -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #93c5fd; font-size: 1rem; margin: 0;">🤖 Dev Overall AI Adoption Summary</h3>
                <button class="btn btn-primary btn-compact" id="loadDevOverallSummaryBtn" onclick="toggleDevOverallAISummary()" >📊 Show</button>
            </div>
            <div id="devOverallAISummaryContent" style="display: none;">
                
                <!-- Query Criteria -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span class="c-muted">📋 Criteria:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Discipline = Development</span>
                        <span class="c-dim">→</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span class="c-muted">📌 Req/Chr/Bug:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 8px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                </div>
                
                <!-- Row 1: Task Counts & AI Adoption Rate -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #94a3b8; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">📋 Task Overview</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="devOasOverallTasks" style="font-size: 1.4rem; color: #60a5fa;">0</div>
                            <div class="label fs-sm-bold">Overall Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="devOasAiTasks" style="font-size: 1.4rem; color: #a78bfa;">0</div>
                            <div class="label fs-sm-bold">AI Adopted Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="devOasManualTasks" style="font-size: 1.4rem; color: #fbbf24;">0</div>
                            <div class="label fs-sm-bold">Manual Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="devOasMaiIneffTasks" style="font-size: 1.4rem; color: #fca5a5;">0</div>
                            <div class="label fs-sm-bold">MAI-Ineff Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="devOasAiAdoptionRate" style="font-size: 1.4rem; color: #34d399;">0%</div>
                            <div class="label fs-sm-bold">AI Adoption Rate</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: AI Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #c4b5fd; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">🤖 AI Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="devOasAiOrigEst" style="font-size: 1.3rem; color: #c4b5fd;">0h</div>
                            <div class="label fs-sm-bold">AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); padding: 14px;">
                            <div class="value" id="devOasAiRevisedEst" style="font-size: 1.3rem; color: #d8b4fe;">0h</div>
                            <div class="label fs-sm-bold">AI Revised Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="devOasAiTotalOrigEst" style="font-size: 1.3rem; color: #60a5fa;">0h</div>
                            <div class="label fs-sm-bold">Total AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="devOasAiCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label fs-sm-bold">AI Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="devOasAiEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">AI Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="devOasAiHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 3: MAI-Ineff Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #fca5a5; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">⚠️ Manual-AI-Ineffective Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="devOasMaiIneffOrigEst" style="font-size: 1.3rem; color: #fca5a5;">0h</div>
                            <div class="label fs-sm-bold">MAI-Ineff Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="devOasMaiIneffCompleted" style="font-size: 1.3rem; color: #fb7185;">0h</div>
                            <div class="label fs-sm-bold">MAI-Ineff Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="devOasMaiIneffEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">MAI-Ineff Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="devOasMaiIneffHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 4: Manual Hours -->
                <div>
                    <div style="color: #fcd34d; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">🔧 Manual Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="devOasManualOrigEst" style="font-size: 1.3rem; color: #fbbf24;">0h</div>
                            <div class="label fs-sm-bold">Manual Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="devOasManualCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label fs-sm-bold">Manual Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="devOasManualEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">Manual Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="devOasManualHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- QA Overall AI Adoption Summary -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #6ee7b7; font-size: 1rem; margin: 0;">🧪 QA Overall AI Adoption Summary</h3>
                <button class="btn btn-primary btn-compact" id="loadQAOverallSummaryBtn" onclick="toggleQAOverallAISummary()" >📊 Show</button>
            </div>
            <div id="qaOverallAISummaryContent" style="display: none;">
                
                <!-- Query Criteria -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span class="c-muted">📋 Criteria:</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Discipline = Test</span>
                        <span class="c-dim">→</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span class="c-muted">📌 Req/Chr/Bug:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 8px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                </div>
                
                <!-- Row 1: Task Counts & AI Adoption Rate -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #94a3b8; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">📋 Task Overview</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="qaOasOverallTasks" style="font-size: 1.4rem; color: #60a5fa;">0</div>
                            <div class="label fs-sm-bold">Overall Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiTasks" style="font-size: 1.4rem; color: #a78bfa;">0</div>
                            <div class="label fs-sm-bold">AI Adopted Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="qaOasManualTasks" style="font-size: 1.4rem; color: #fbbf24;">0</div>
                            <div class="label fs-sm-bold">Manual Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="qaOasMaiIneffTasks" style="font-size: 1.4rem; color: #fca5a5;">0</div>
                            <div class="label fs-sm-bold">MAI-Ineff Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiAdoptionRate" style="font-size: 1.4rem; color: #34d399;">0%</div>
                            <div class="label fs-sm-bold">AI Adoption Rate</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: AI Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #c4b5fd; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">🤖 AI Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiOrigEst" style="font-size: 1.3rem; color: #c4b5fd;">0h</div>
                            <div class="label fs-sm-bold">AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiRevisedEst" style="font-size: 1.3rem; color: #d8b4fe;">0h</div>
                            <div class="label fs-sm-bold">AI Revised Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiTotalOrigEst" style="font-size: 1.3rem; color: #60a5fa;">0h</div>
                            <div class="label fs-sm-bold">Total AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label fs-sm-bold">AI Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">AI Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="qaOasAiHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 3: MAI-Ineff Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #fca5a5; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">⚠️ Manual-AI-Ineffective Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="qaOasMaiIneffOrigEst" style="font-size: 1.3rem; color: #fca5a5;">0h</div>
                            <div class="label fs-sm-bold">MAI-Ineff Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="qaOasMaiIneffCompleted" style="font-size: 1.3rem; color: #fb7185;">0h</div>
                            <div class="label fs-sm-bold">MAI-Ineff Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="qaOasMaiIneffEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">MAI-Ineff Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="qaOasMaiIneffHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 4: Manual Hours -->
                <div>
                    <div style="color: #fcd34d; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">🔧 Manual Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="qaOasManualOrigEst" style="font-size: 1.3rem; color: #fbbf24;">0h</div>
                            <div class="label fs-sm-bold">Manual Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="qaOasManualCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label fs-sm-bold">Manual Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="qaOasManualEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">Manual Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="qaOasManualHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        </div><!-- End Tab 3 -->

        <!-- Tab 4: AI Analytics -->
        <div class="tab-content" id="tabContent4" style="display:none;">
        <!-- AI Analytics & Summary Block -->
        <div style="border:2px solid rgba(245,158,11,0.3);border-radius:10px;padding:12px;margin-bottom:16px;background:rgba(245,158,11,0.03);">
        <div style="margin-bottom:10px;padding:6px 12px;border-left:3px solid #f59e0b;background:rgba(245,158,11,0.08);border-radius:0 6px 6px 0;">
            <span style="color:#fcd34d;font-size:0.8rem;font-weight:700;">📊 AI Analytics & Summary</span>
        </div>

        <!-- Overall AI Adoption Summary -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #6ee7b7; font-size: 1rem; margin: 0;">📊 Overall AI Adoption Summary</h3>
                <button class="btn btn-primary btn-compact" id="loadOverallSummaryBtn" onclick="toggleOverallAISummary()" >📊 Show</button>
            </div>
            <div id="overallAISummaryContent" style="display: none;">
                
                <!-- Query Criteria -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span class="c-muted">📋 Criteria:</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">All Disciplines</span>
                        <span class="c-dim">→</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span class="c-muted">📌 Req/Chr/Bug:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 8px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                </div>
                
                <!-- Row 1: Task Counts & AI Adoption Rate -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #94a3b8; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">📋 Task Overview</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="oasOverallTasks" style="font-size: 1.4rem; color: #60a5fa;">0</div>
                            <div class="label fs-sm-bold">Overall Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="oasAiTasks" style="font-size: 1.4rem; color: #a78bfa;">0</div>
                            <div class="label fs-sm-bold">AI Adopted Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="oasManualTasks" style="font-size: 1.4rem; color: #fbbf24;">0</div>
                            <div class="label fs-sm-bold">Manual Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffTasks" style="font-size: 1.4rem; color: #fca5a5;">0</div>
                            <div class="label fs-sm-bold">MAI-Ineff Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="oasAiAdoptionRate" style="font-size: 1.4rem; color: #34d399;">0%</div>
                            <div class="label fs-sm-bold">AI Adoption Rate</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: AI Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #c4b5fd; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">🤖 AI Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="oasAiOrigEst" style="font-size: 1.3rem; color: #c4b5fd;">0h</div>
                            <div class="label fs-sm-bold">AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); padding: 14px;">
                            <div class="value" id="oasAiRevisedEst" style="font-size: 1.3rem; color: #d8b4fe;">0h</div>
                            <div class="label fs-sm-bold">AI Revised Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="oasAiTotalOrigEst" style="font-size: 1.3rem; color: #60a5fa;">0h</div>
                            <div class="label fs-sm-bold">Total AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="oasAiCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label fs-sm-bold">AI Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="oasAiEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">AI Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="oasAiHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 3: MAI-Ineff Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #fca5a5; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">⚠️ Manual-AI-Ineffective Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffOrigEst" style="font-size: 1.3rem; color: #fca5a5;">0h</div>
                            <div class="label fs-sm-bold">MAI-Ineff Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffCompleted" style="font-size: 1.3rem; color: #fb7185;">0h</div>
                            <div class="label fs-sm-bold">MAI-Ineff Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">MAI-Ineff Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 4: Manual Hours -->
                <div>
                    <div style="color: #fcd34d; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">🔧 Manual Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="oasManualOrigEst" style="font-size: 1.3rem; color: #fbbf24;">0h</div>
                            <div class="label fs-sm-bold">Manual Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="oasManualCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label fs-sm-bold">Manual Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="oasManualEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label fs-sm-bold">Manual Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="oasManualHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label fs-sm-bold">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- AI-Enabled Disciplines Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1)); border: 1px solid rgba(245,158,11,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #fcd34d; font-size: 1rem; margin: 0;">📊 AI-Enabled Disciplines</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportOverallAIAdoptionBtn" onclick="exportOverallAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">📥 Excel</button>
                    <button class="btn btn-primary" id="exportOverallAIAdoptionPdfBtn" onclick="exportOverallAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">📄 PDF</button>
                    <button class="btn btn-primary btn-compact" id="loadOverallAIAdoptionBtn" onclick="toggleOverallAIAdoptionData()" >📊 Show</button>
                </div>
            </div>
            <div id="overallAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <span class="c-muted">📋 Parent:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Requirement/CR/Bug</span>
                        <span class="c-dim">with tag =</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 6px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 6px; border-radius: 4px; color: #f9a8d4;">Non-Deliverable</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 6px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span class="c-muted">📋 Task:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-*</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span class="c-muted">🔍 AI Tool:</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Claude AI</span>
                        <span class="c-dim">vs</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #22d3ee;">GitHub Copilot</span>
                        <span class="c-dim">| Based on "Claude AI" tag</span>
                    </div>
                </div>
                
                <!-- Discipline-wise Summary Table -->
                <div id="overallDisciplineSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <h4 style="color: #fcd34d; font-size: 0.85rem; margin: 0 0 10px 0;">📈 AI-Enabled Disciplines Summary</h4>
                    <div style="overflow-x: auto;">
                        <table id="overallAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="overallAIAdoptionTableHead" class="bg-overlay"></thead>
                            <tbody id="overallAIAdoptionTableBody"></tbody>
                            <tfoot id="overallAIAdoptionTableFoot" style="font-weight: 600; background: rgba(16,185,129,0.15);"></tfoot>
                        </table>
                        <div id="noOverallAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No AI-Enabled tasks found.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TaskExecutionType AI Adoption Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(139,92,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #c4b5fd; font-size: 1rem; margin: 0;">⚡ Task Execution Type AI Adoption</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportExecTypeAIAdoptionBtn" onclick="exportExecTypeAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">📥 Excel</button>
                    <button class="btn btn-primary" id="exportExecTypeAIAdoptionPdfBtn" onclick="exportExecTypeAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">📄 PDF</button>
                    <button class="btn btn-primary btn-compact" id="loadExecTypeAIAdoptionBtn" onclick="toggleExecTypeAIAdoptionData()" >📊 Show</button>
                </div>
            </div>
            <div id="execTypeAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <span class="c-muted">📋 Parent:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Requirement/CR/Bug</span>
                        <span class="c-dim">tag =</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 6px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 6px; border-radius: 4px; color: #f9a8d4;">Non-Deliverable</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 6px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span class="c-muted">📋 Task:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-*</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span class="c-muted">🔍 AI Tool:</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Claude AI</span>
                        <span class="c-dim">vs</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #22d3ee;">GitHub Copilot</span>
                        <span class="c-dim">| Based on "Claude AI" tag</span>
                    </div>
                </div>
                
                <!-- TaskExecutionType-wise Summary Table -->
                <div id="execTypeSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <h4 style="color: #c4b5fd; font-size: 0.85rem; margin: 0 0 10px 0;">📈 TaskExecutionType-wise Summary</h4>
                    <div style="overflow-x: auto;">
                        <table id="execTypeAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="execTypeAIAdoptionTableHead" class="bg-overlay"></thead>
                            <tbody id="execTypeAIAdoptionTableBody"></tbody>
                            <tfoot id="execTypeAIAdoptionTableFoot" style="font-weight: 600; background: rgba(139,92,246,0.15);"></tfoot>
                        </table>
                        <div id="noExecTypeAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No TaskExecutionType data found.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project-wise AI Adoption Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(6,182,212,0.15), rgba(34,211,238,0.1)); border: 1px solid rgba(6,182,212,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #22d3ee; font-size: 1rem; margin: 0;">🏢 Project-wise AI Adoption</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-compact" id="loadProjectAIAdoptionBtn" onclick="toggleProjectAIAdoptionData()" >📊 Show</button>
                </div>
            </div>
            <div id="projectAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <span class="c-muted">📋 Parent:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Requirement/CR/Bug</span>
                        <span class="c-dim">tag =</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 6px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 6px; border-radius: 4px; color: #f9a8d4;">Non-Deliverable</span>
                        <span class="c-dim">|</span>
                        <span style="background: rgba(251,146,60,0.3); padding: 2px 6px; border-radius: 4px; color: #fdba74;">Adhoc Support</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span class="c-muted">📋 Task:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-*</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ≠ Rejected</span>
                        <span class="c-dim">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span class="c-muted">🔍 AI Tool:</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Claude AI</span>
                        <span class="c-dim">vs</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #22d3ee;">GitHub Copilot</span>
                        <span class="c-dim">| Based on "Claude AI" tag</span>
                    </div>
                </div>
                
                <!-- Project-wise Summary Table -->
                <div id="projectSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <h4 style="color: #22d3ee; font-size: 0.85rem; margin: 0 0 10px 0;">📈 Project-wise Summary</h4>
                    <div style="overflow-x: auto;">
                        <table id="projectAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="projectAIAdoptionTableHead" class="bg-overlay"></thead>
                            <tbody id="projectAIAdoptionTableBody"></tbody>
                            <tfoot id="projectAIAdoptionTableFoot" style="font-weight: 600; background: rgba(6,182,212,0.15);"></tfoot>
                        </table>
                        <div id="noProjectAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No Project-wise AI data found.</div>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- End AI Analytics & Summary Block -->
        </div><!-- End Tab 4 -->

        <!-- Tab 5: Feature Progress -->
        <div class="tab-content" id="tabContent5" style="display:none;">
            <div class="dashboard-card" style="margin-bottom:16px;position:relative;background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(99,102,241,0.1));border:1px solid rgba(59,130,246,0.3);padding:12px;" id="featureProgressCard">
                <div class="card-loading" id="featureProgressLoading"><div class="mini-spinner"></div></div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h3 style="color:#93c5fd;font-size:1rem;font-weight:700;margin:0;">🚀 Feature Progress (<span id="featureProgressCount">0</span>)</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" id="toggleFeatureProgressBtn" onclick="toggleFeatureProgressDashboard()" style="padding:4px 10px;font-size:0.75rem;">📊 Show</button>
                    </div>
                </div>
                <div id="featureProgressContent" style="display:none;">
                    <!-- State & Status -->
                    <div style="background:rgba(255,255,255,0.05);border-radius:6px;padding:10px;margin-bottom:10px;">
                        <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;">
                            <div style="flex:0 0 auto;">
                                <div style="font-size:0.65rem;color:#60a5fa;font-weight:600;margin-bottom:5px;">📂 Area Path</div>
                                <div id="featureAreaPathDropdown" class="fp-multiselect" style="min-width:170px;">
                                    <button class="fp-multiselect-btn" onclick="toggleFpDropdown('featureAreaPathDropdown')">All Areas</button>
                                    <div class="fp-multiselect-dropdown"></div>
                                </div>
                            </div>
                            <div style="flex:0 0 auto;">
                                <div style="font-size:0.65rem;color:#34d399;font-weight:600;margin-bottom:5px;">📋 State</div>
                                <div id="featureStateDropdown" class="fp-multiselect">
                                    <button class="fp-multiselect-btn" onclick="toggleFpDropdown('featureStateDropdown')">All States</button>
                                    <div class="fp-multiselect-dropdown"></div>
                                </div>
                            </div>
                            <div style="flex:0 0 auto;">
                                <div style="font-size:0.65rem;color:#c084fc;font-weight:600;margin-bottom:5px;">🏷️ Status</div>
                                <div id="featureStatusDropdown" class="fp-multiselect" style="min-width:180px;">
                                    <button class="fp-multiselect-btn" onclick="toggleFpDropdown('featureStatusDropdown')">All Statuses</button>
                                    <div class="fp-multiselect-dropdown"></div>
                                </div>
                            </div>
                            <div style="flex:0 0 auto;">
                                <div style="font-size:0.65rem;color:#f97316;font-weight:600;margin-bottom:5px;">🔄 Task Sprint</div>
                                <div id="featureTaskSprintDropdown" class="fp-multiselect" style="min-width:170px;">
                                    <button class="fp-multiselect-btn" onclick="toggleFpDropdown('featureTaskSprintDropdown')">All Sprints</button>
                                    <div class="fp-multiselect-dropdown"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="featureIterationFilters" style="display:none;"></div>
                    <!-- Table -->
                    <div style="border:1px solid rgba(255,255,255,0.1);border-radius:6px;overflow-x:auto;">
                        <table id="featureProgressTable" style="width:100%;border-collapse:collapse;font-size:0.6rem;table-layout:fixed;">
                            <colgroup>
                                <col style="width:28px;">
                                <col style="width:50px;">
                                <col style="width:16%;">
                                <col style="width:62px;">
                                <col style="width:80px;">
                                <col style="width:58px;">
                                <col style="width:58px;">
                                <col style="width:58px;">
                                <col style="width:62px;">
                                <col style="width:52px;">
                                <col style="width:52px;">
                                <col style="width:52px;">
                                <col style="width:58px;">
                                <col style="width:62px;">
                                <col style="width:62px;">
                            </colgroup>
                            <thead>
                                <tr style="line-height:1.15;">
                                    <th class="fp-th" style="text-align:center;padding:4px 2px;"><input type="checkbox" id="fpTableSelectAll" checked onchange="toggleAllFpTableCheckboxes(this.checked)" title="Select / Deselect All" style="cursor:pointer;accent-color:#3b82f6;"></th>
                                    <th class="fp-th fp-sortable" data-sort="id" style="text-align:left;" onclick="sortFeatureTable('id')">ID <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="title" style="text-align:left;" onclick="sortFeatureTable('title')">Title <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="state" style="text-align:center;" onclick="sortFeatureTable('state')">State <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="status" style="text-align:center;" onclick="sortFeatureTable('status')">Status <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="estimateInHours" style="text-align:right;" title="Estimate In Hours" onclick="sortFeatureTable('estimateInHours')">Est In<br>Hours <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="discoveryEffort" style="text-align:right;" title="Estimated Discovery Hours" onclick="sortFeatureTable('discoveryEffort')">Est Disc<br>Hours <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="devDeliveryHours" style="text-align:right;" title="Dev and Delivery Hours" onclick="sortFeatureTable('devDeliveryHours')">Dev &<br>Delivery <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="plannedHours" style="text-align:right;" title="Planned Hours" onclick="sortFeatureTable('plannedHours')">Planned <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="compDiscoveryHours" style="text-align:right;" title="Completed Discovery Hours" onclick="sortFeatureTable('compDiscoveryHours')">Comp<br>Disc <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="completedEffort" style="text-align:right;" title="Completed Effort" onclick="sortFeatureTable('completedEffort')">Comp<br>Effort <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="actualCompletedHours" style="text-align:right;" title="Actual Completed Hours" onclick="sortFeatureTable('actualCompletedHours')">Actual<br>Comp <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="taskLevelPlannedHours" style="text-align:right;" title="Task Level Planned Hours" onclick="sortFeatureTable('taskLevelPlannedHours')">Task<br>Planned <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="taskLevelCompletedDevHours" style="text-align:right;" title="Task Comp Dev Hours" onclick="sortFeatureTable('taskLevelCompletedDevHours')">Task<br>Comp Dev <span class="fp-sort-icon"></span></th>
                                    <th class="fp-th fp-sortable" data-sort="taskLevelActualCompHours" style="text-align:right;" title="Task Actual Completed Hours" onclick="sortFeatureTable('taskLevelActualCompHours')">Task<br>Act Comp <span class="fp-sort-icon"></span></th>
                                </tr>
                            </thead>
                            <tbody id="featureProgressTableBody"></tbody>
                            <tfoot id="featureProgressTableFooter" style="font-weight:600;"></tfoot>
                        </table>
                    </div>
                    <div id="noFeatureProgressData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No features found for this PI</div>
                    <div id="featureUpdateBtnRow" style="margin-top:10px;text-align:right;">
                        <button class="btn btn-success" id="updateFeatureHoursBtn" onclick="showUpdateFeaturePopup()" style="display:none;padding:6px 16px;font-size:0.75rem;" title="Update Feature Hours, State & Status in TFS">⬆️ Update Feature Data</button>
                    </div>
                </div>
            </div>

            <!-- Affected Area Feature -->
            <div class="dashboard-card" style="margin-bottom:16px;position:relative;background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.1));border:1px solid rgba(16,185,129,0.3);padding:12px;" id="affectedAreaCard">
                <div class="card-loading" id="affectedAreaLoading"><div class="mini-spinner"></div></div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h3 style="color:#6ee7b7;font-size:1rem;font-weight:700;margin:0;">🌐 Affected Area Features (<span id="affectedAreaCount">0</span>)</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" id="toggleAffectedAreaBtn" onclick="toggleAffectedAreaDashboard()" style="padding:4px 10px;font-size:0.75rem;">📊 Show</button>
                    </div>
                </div>
                <div id="affectedAreaContent" style="display:none;">
                    <div style="background:rgba(255,255,255,0.05);border-radius:6px;padding:8px 12px;margin-bottom:10px;font-size:0.75rem;display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;gap:12px;align-items:center;">
                            <span style="color:#94a3b8;font-size:0.65rem;">Features from other areas with tasks in your selected area</span>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <select id="affectedAreaIterFilter" onchange="renderAffectedAreaTable()" style="background:rgba(0,0,0,0.3);color:#e2e8f0;border:1px solid rgba(16,185,129,0.4);border-radius:6px;padding:3px 8px;font-size:0.65rem;cursor:pointer;outline:none;">
                                <option value="all">All Iterations</option>
                            </select>
                            <button class="btn btn-primary refresh-icon" id="refreshAffectedAreaBtn" onclick="loadAffectedAreaData()" title="Refresh" style="padding:3px 8px;font-size:0.7rem;">🔄</button>
                        </div>
                    </div>
                    <div id="affectedAreaSummary" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;"></div>
                    <div style="border:1px solid rgba(255,255,255,0.1);border-radius:6px;overflow-x:auto;">
                        <table id="affectedAreaTable" style="width:100%;border-collapse:collapse;font-size:0.6rem;">
                            <thead>
                                <tr style="line-height:1.15;">
                                    <th class="fp-th" style="text-align:center;width:30px;"></th>
                                    <th class="fp-th" style="text-align:left;width:50px;cursor:pointer;" onclick="sortAffectedArea('featureId')">FID</th>
                                    <th class="fp-th" style="text-align:left;cursor:pointer;" onclick="sortAffectedArea('featureTitle')">Feature Title</th>
                                    <th class="fp-th" style="text-align:left;width:10%;cursor:pointer;" onclick="sortAffectedArea('featureArea')">Area</th>
                                    <th class="fp-th" style="text-align:center;width:60px;cursor:pointer;" onclick="sortAffectedArea('featureState')">State</th>
                                    <th class="fp-th" style="text-align:center;width:40px;">Items</th>
                                    <th class="fp-th" style="text-align:right;width:55px;cursor:pointer;" onclick="sortAffectedArea('origEst')">Orig Est</th>
                                    <th class="fp-th" style="text-align:right;width:45px;cursor:pointer;" onclick="sortAffectedArea('rem')">Rem</th>
                                    <th class="fp-th" style="text-align:right;width:45px;cursor:pointer;" onclick="sortAffectedArea('comp')">Comp</th>
                                </tr>
                            </thead>
                            <tbody id="affectedAreaTableBody"></tbody>
                            <tfoot id="affectedAreaTableFooter" style="font-weight:600;"></tfoot>
                        </table>
                    </div>
                    <div id="noAffectedAreaData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No affected area features found</div>
                </div>
            </div>

            <!-- Feature Lookup moved to Tab 6 -->

        </div><!-- End Tab 5 -->

        <!-- Tab 6: Data Lookup -->
        <div class="tab-content" id="tabContent6" style="display:none;">

            <!-- Feature Lookup -->
            <div class="table-section" id="featureLookupSection" style="padding: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <h3 style="font-size: 0.85rem; margin: 0;">🔍 Feature Lookup</h3>
                    <input type="text" id="featureIdInput" placeholder="Feature ID" style="padding: 4px 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.3); color: #fff; width: 120px; height:32px; font-size: 0.75rem;" onkeydown="if(event.key==='Enter')lookupFeature()">
                    <button class="btn btn-primary" onclick="lookupFeature()" style="padding: 4px 10px; font-size: 0.7rem;">🔍 Lookup</button>
                </div>
                <div id="featureLookupResult"></div>
            </div>

            <!-- Requirement Task Lookup -->
            <div class="table-section" id="reqTaskLookupSection" style="padding: 12px;">
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <h3 style="font-size: 0.85rem; margin: 0;">🔍 Requirement Task Lookup</h3>
                    <input type="text" id="reqIdInput" placeholder="Enter Requirement ID" style="padding: 6px 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.3); color: #fff; width: 150px; height:32px; font-size: 0.75rem;" onkeydown="if(event.key==='Enter')lookupRequirement()">
                    <button class="btn btn-primary" onclick="lookupRequirement()" style="padding: 6px 12px; font-size: 0.7rem;">🔍 Lookup</button>
                </div>
                <div id="reqLookupResult"></div>
            </div>

        </div><!-- End Tab 6 -->

        <!-- Tab 7: Weekly Task Breakdown -->
        <div class="tab-content" id="tabContent7" style="display:none;">
            <div class="dashboard-card" style="margin-bottom:16px;padding:12px;background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(99,102,241,0.1));border:1px solid rgba(139,92,246,0.3);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3 style="color:#c4b5fd;font-size:1rem;margin:0;">📅 Weekly Task Breakdown — AI vs Manual</h3>
                    <button class="btn btn-primary btn-compact" id="loadWeeklyBreakdownBtn" onclick="loadWeeklyTaskBreakdown()">📊 Show</button>
                </div>
                <div id="weeklyBreakdownContent" style="display:none;">
                    <!-- Criteria -->
                    <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px;margin-bottom:12px;font-size:0.7rem;">
                        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                            <span class="c-muted">📋 Criteria:</span>
                            <span style="background:rgba(16,185,129,0.3);padding:2px 8px;border-radius:4px;color:#6ee7b7;">Resolved/Closed</span>
                            <span class="c-dim">+</span>
                            <span style="background:rgba(236,72,153,0.3);padding:2px 8px;border-radius:4px;color:#f9a8d4;">Reason ≠ Rejected</span>
                            <span class="c-dim">+</span>
                            <span style="background:rgba(6,182,212,0.3);padding:2px 8px;border-radius:4px;color:#67e8f9;">Orig Est > 0</span>
                            <span class="c-dim">+</span>
                            <span style="background:rgba(139,92,246,0.3);padding:2px 8px;border-radius:4px;color:#c4b5fd;">TaskExecutionType = AI-* | Manual | Manual-AI-Ineffective</span>
                            <span style="color:#64748b;margin-left:8px;">|</span>
                            <span class="c-muted">📅 Week:</span>
                            <span style="background:rgba(245,158,11,0.3);padding:2px 8px;border-radius:4px;color:#fcd34d;">StateChangeDate → 7 cal days per week from sprint start</span>
                        </div>
                    </div>
                    <!-- Summary Cards -->
                    <div class="summary-row" id="wbSummaryRow" style="margin-bottom:12px;gap:10px;"></div>
                    <!-- Sprint Date Info -->
                    <div id="wbSprintDateInfo" style="margin-bottom:6px;"></div>
                    <!-- Week Filters -->
                    <div id="wbWeekFilterBar" style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px 10px;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                            <span style="color:#94a3b8;font-size:0.7rem;margin-right:4px;">📅 Week:</span>
                            <div id="wbWeekFilterBtns" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
                        </div>
                    </div>
                    <!-- AI Tasks Section -->
                    <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);border-radius:8px;padding:10px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <h4 style="color:#6ee7b7;font-size:0.85rem;margin:0;">🤖 AI Tasks (<span id="wbAiCount">0</span>)</h4>
                            <span style="color:#34d399;font-size:0.7rem;font-weight:600;" id="wbAiHours">0h orig / 0h comp</span>
                        </div>
                        <div id="wbAiDiscBar" style="display:none;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:8px;background:rgba(0,0,0,0.15);border-radius:6px;padding:5px 8px;">
                            <span style="color:#6ee7b7;font-size:0.65rem;margin-right:2px;">🏷️ Discipline:</span>
                            <div id="wbAiDiscBtns" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
                        </div>
                        <div style="max-height:320px;overflow-y:auto;">
                            <table id="wbAiTable" style="width:100%;border-collapse:collapse;font-size:0.72rem;table-layout:auto;">
                                <thead id="wbAiTableHead" style="position:sticky;top:0;z-index:1;"></thead>
                                <tbody id="wbAiTableBody"></tbody>
                            </table>
                            <div id="wbAiNoData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No AI tasks found</div>
                        </div>
                    </div>
                    <!-- Manual Tasks Section -->
                    <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);border-radius:8px;padding:10px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <h4 style="color:#fcd34d;font-size:0.85rem;margin:0;">🔧 Manual Tasks (<span id="wbManualCount">0</span>)</h4>
                            <span style="color:#fbbf24;font-size:0.7rem;font-weight:600;" id="wbManualHours">0h orig / 0h comp</span>
                        </div>
                        <div id="wbManualDiscBar" style="display:none;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:8px;background:rgba(0,0,0,0.15);border-radius:6px;padding:5px 8px;">
                            <span style="color:#fcd34d;font-size:0.65rem;margin-right:2px;">🏷️ Discipline:</span>
                            <div id="wbManualDiscBtns" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
                        </div>
                        <div style="max-height:320px;overflow-y:auto;">
                            <table id="wbManualTable" style="width:100%;border-collapse:collapse;font-size:0.72rem;table-layout:auto;">
                                <thead id="wbManualTableHead" style="position:sticky;top:0;z-index:1;"></thead>
                                <tbody id="wbManualTableBody"></tbody>
                            </table>
                            <div id="wbManualNoData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No Manual tasks found</div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- End Tab 7 -->

    <!-- Update Feature Data Popup -->
    <div id="updateFeaturePopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);z-index:9999;align-items:center;justify-content:center;">
        <div class="fp-update-popup" style="background:#1e293b;border:1px solid rgba(59,130,246,0.4);border-radius:12px;max-width:1250px;width:97%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,0.6);">
            <div class="fp-update-header" style="padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h3 style="color:#93c5fd;font-size:1rem;margin:0;">⬆️ Update Feature Data in TFS</h3>
                    <p class="fp-update-subtitle" style="color:#64748b;font-size:0.62rem;margin:3px 0 0 0;">Hours: Planned ← Task Planned | Comp Effort ← Task Comp Dev | Actual Comp ← Task Act Comp &nbsp;|&nbsp; <span style="color:#fbbf24;">Change State/Status per feature below</span></p>
                </div>
                <button onclick="closeUpdateFeaturePopup()" style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#fca5a5;border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:1rem;line-height:1;">✕</button>
            </div>
            <div id="updateFeaturePopupSummary" class="fp-update-summary" style="padding:8px 16px;background:rgba(0,0,0,0.15);border-bottom:1px solid rgba(255,255,255,0.06);"></div>
            <div id="updateFeaturePopupBody" style="overflow:auto;flex:1;padding:8px 16px;"></div>
            <div id="updateFeaturePopupFooter" class="fp-update-footer" style="display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid rgba(255,255,255,0.08);">
                <button onclick="closeUpdateFeaturePopup()" class="btn" style="padding:6px 18px;font-size:0.75rem;background:rgba(100,116,139,0.3);border:1px solid rgba(100,116,139,0.5);color:#94a3b8;border-radius:6px;">Cancel</button>
                <button id="confirmUpdateFeatureBtn" onclick="confirmUpdateFeatureHours()" class="btn btn-success" style="padding:6px 18px;font-size:0.75rem;border-radius:6px;">✅ Confirm &amp; Update Selected</button>
            </div>
        </div>
    </div>

    <!-- AI Adoption Task Detail Popup -->
    <div id="aiTaskPopupOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);z-index:9999;align-items:center;justify-content:center;" onclick="if(event.target===this)this.style.display='none';">
        <div style="background:#1e293b;border:1px solid rgba(59,130,246,0.4);border-radius:12px;max-width:1100px;width:95%;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,0.6);">
            <div style="padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center;">
                <h3 id="aiTaskPopupTitle" style="color:#93c5fd;font-size:0.95rem;margin:0;"></h3>
                <button onclick="document.getElementById('aiTaskPopupOverlay').style.display='none'" style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#fca5a5;border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:1rem;line-height:1;">✕</button>
            </div>
            <div id="aiTaskPopupBody" style="overflow:auto;flex:1;padding:10px 16px;"></div>
        </div>
    </div>

    <script>
        // ============================================
        // OPTIMIZED TFS SPRINT DASHBOARD V4
        // Key Optimizations:
        // 1. REDUCED WIQL queries from 9 to 3 (tag filtering done in JS)
        // 2. Batch API calls (max 200 per request)
        // 3. Build task-parent mapping once
        // 4. Cache and reuse data
        // 5. Parallel API calls with Promise.all
        // 6. No external libraries (CSS charts)
        // 7. Auto-fetch projects on PAT blur
        // 8. DEFERRED: Weekly Progress Dashboard (on button click)
        // 9. DEFERRED: Last Sprint Data (on button click)
        // 10. DEFERRED: Requirements List render (on button click)
        // 11. DEFERRED: Discipline Checks (on button click)
        // 12. DEFERRED: Members Capacity details (on button click)
        // 13. Weekly tag tracking (Week1-4) for delivery status
        // 14. Light/Dark Theme Toggle
        // API CALL REDUCTION: 6 fewer WIQL queries vs V3
        // ============================================

        // ==================== THEME MANAGEMENT ====================
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeToggleBtn');
            const isLight = body.classList.toggle('light-theme');
            body.setAttribute('data-theme', isLight ? 'light' : 'dark');
            btn.textContent = isLight ? '☀️' : '🌙';
            btn.title = isLight ? 'Switch to Dark Theme' : 'Switch to Light Theme';
            localStorage.setItem('sprintTrackerTheme', isLight ? 'light' : 'dark');
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('sprintTrackerTheme');
            const btn = document.getElementById('themeToggleBtn');
            
            // Default is DARK theme (no class added, data-theme="dark")
            // Only apply light theme if explicitly saved
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                document.body.setAttribute('data-theme', 'light');
                if (btn) {
                    btn.textContent = '☀️';
                    btn.title = 'Switch to Dark Theme';
                }
            } else {
                // Ensure dark theme (remove light-theme class if present)
                document.body.classList.remove('light-theme');
                document.body.setAttribute('data-theme', 'dark');
                if (btn) {
                    btn.textContent = '🌙';
                    btn.title = 'Switch to Light Theme';
                }
                // Set dark as default in storage if not set
                if (!savedTheme) {
                    localStorage.setItem('sprintTrackerTheme', 'dark');
                }
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initTheme);
        // ==================== END THEME MANAGEMENT ====================

        let tfsUrl = '', project = '', config = { headers: null };
        let areas = [], iterations = [], requirements = [], bugs = [], tasks = [];
        let taskParentMap = {}; // Map: taskId -> parentId (built once)
        let reqTasksMap = {};   // Map: reqId -> [task objects]
        let apiCallCount = 0;

        // AI Adoption sorting state
        let aiAdoptionMemberData = []; // Store member results for sorting
        let aiAdoptionSortField = 'name';
        let aiAdoptionSortDir = 'asc';
        let aiAdoptionAreaFilter = 'All'; // Area filter for Dev AI pagination
        let aiAdoptionGrandTotals = {}; // Store grand totals for footer
        let aiAdoptionWeekFilter = 'All'; // Week filter for Dev AI
        
        // QA AI Adoption sorting state
        let qaAIAdoptionMemberData = []; // Store QA member results for sorting
        let qaAIAdoptionSortField = 'name';
        let qaAIAdoptionSortDir = 'asc';
        let qaAIAdoptionGrandTotals = {}; // Store QA grand totals for footer
        let qaAIAdoptionDataLoaded = false; // Track if QA AI Adoption is loaded
        
        // Discipline Verification dashboard state
        let dvDataLoaded = false;
        let dvAllTaskData = []; // All processed task data
        let dvSortField = 'assignedTo';
        let dvSortDir = 'asc';
        
        // Area-wise Summary sorting state
        let areaSummaryData = []; // Store area data for sorting
        let areaSortField = 'area';
        let areaSortDir = 'asc';

        // Data containers
        let teamBData = { requirements: [], totalOrigEst: 0, totalSize: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
        let sprintGoalData = { requirements: [], totalOrigEst: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
        let codeReviewData = { tasks: [], totalOrigEst: 0, done: 0, inProgress: 0, todo: 0 };
        let uiUxUdData = { tasks: [], totalOrigEst: 0 };
        let taskEstByCategory = { deliverableEst: 0, nonDeliverableEst: 0 };
        let weeklyData = { week1: [], week2: [], week3: [], week4: [], noWeekTag: [] };
        let capacityData = { 
            teamCapacity: 0, totalPlannedCapacity: 0, almEngExtraHours: 0, uiUxUdHours: 0,
            availableCapacity: 0, overPlannedCapacity: 0, overPlanPct: 0,
            devTeamCapacity: 0, devMemberCount: 0, devTaskCount: 0, devTotalPlanned: 0,
            devCategoryBreakdown: {}, devUnclassifiedTotal: 0, 
            devAvailableCapacity: 0, devPlannedCapacity: 0, devOverPlanPct: 0,
            sprintCalendarDays: 0, teamDaysOff: 0, teamDaysOffDates: [], memberDaysOff: 0, sprintWorkDays: 0, members: [] 
        };
        let currentFilter = 'all', sprintInfo = { name: '', areaName: '', iterationId: '' };
        let reqListSortField = 'id', reqListSortDir = 'asc'; // Sorting for Requirements List
        let storedSprintStartDate = null; // Store for deferred historical fetch
        let storedSprintEndDate = null;
        let weeklyProgressLoaded = false; // Track if Weekly Progress is loaded
        let weeklyIterFilter = 'all'; // Selected iteration filter for Weekly Progress
        let weeklyDataByIteration = {}; // weeklyData grouped per iteration path

        // PAT Preservation - Load saved credentials on page load
        (function loadSavedCredentials() {
            try {
                const savedTfsUrl = localStorage.getItem('sprintTracker_tfsUrl');
                const savedPat = localStorage.getItem('sprintTracker_pat');
                if (savedTfsUrl) document.getElementById('tfsUrl').value = savedTfsUrl;
                if (savedPat) {
                    document.getElementById('pat').value = savedPat;
                    // Auto-fetch projects after a small delay to allow DOM to settle
                    setTimeout(() => autoFetchProjects(), 500);
                }
            } catch (e) { }
        })();

        function saveCredentials() {
            try {
                const tfsUrl = document.getElementById('tfsUrl').value.trim();
                const pat = document.getElementById('pat').value.trim();
                if (tfsUrl) localStorage.setItem('sprintTracker_tfsUrl', tfsUrl);
                if (pat) localStorage.setItem('sprintTracker_pat', pat);
            } catch (e) { }
        }

        // Helper: Track API calls
        async function apiFetch(url, options = {}) {
            apiCallCount++;
            document.getElementById('apiCallCount').textContent = apiCallCount;
            return fetch(url, { ...options, headers: config.headers });
        }

        // Helper: Format hours
        function fmtH(val) { return (val || 0).toFixed(2); }

        // Helper: Check if task is UI/UX or UD
        function isUiUxUdTask(title) {
            const t = (title || '').toLowerCase();
            return t.startsWith('ui/ux') || t.startsWith('ud ') || t.startsWith('ud-') || t === 'ud';
        }

        // Helper: Batch fetch work items by IDs (max 200 per request)
        async function batchFetchWorkItems(ids, fields) {
            if (!ids || ids.length === 0) return [];
            const fieldStr = fields.join(',');
            const batches = [];
            for (let i = 0; i < ids.length; i += 200) {
                batches.push(ids.slice(i, i + 200).join(','));
            }
            const responses = await Promise.all(batches.map(batch => 
                apiFetch(`${tfsUrl}/_apis/wit/workitems?ids=${batch}&fields=${fieldStr}&api-version=5.0`)
            ));
            const results = [];
            for (const resp of responses) {
                if (resp.ok) {
                    const data = await resp.json();
                    results.push(...(data.value || []));
                }
            }
            return results;
        }

        async function batchFetchWithRelations(ids) {
            if (!ids || ids.length === 0) return [];
            const batches = [];
            for (let i = 0; i < ids.length; i += 200) {
                batches.push(ids.slice(i, i + 200).join(','));
            }
            const responses = await Promise.all(batches.map(batch => 
                apiFetch(`${tfsUrl}/_apis/wit/workitems?ids=${batch}&$expand=relations&api-version=5.0`)
            ));
            const results = [];
            for (const resp of responses) {
                if (resp.ok) {
                    const data = await resp.json();
                    results.push(...(data.value || []));
                }
            }
            return results;
        }

        let projectsFetched = false;
        let isAuthorizedUser = false;
        let currentUserRole = 'normal'; // 'super_admin', 'admin' or 'normal' - loaded from allowed_users.json
        let currentUserTabs = [1, 2, 3, 4, 5]; // Tab permissions - loaded from allowed_users.json (Tab 7 = super_admin only)
        let selectedProjects = [];
        
        async function autoFetchProjects() {
            const tfsUrlVal = document.getElementById('tfsUrl').value.trim().replace(/\/$/, '');
            const pat = document.getElementById('pat').value.trim();
            if (!tfsUrlVal || !pat || projectsFetched) return;
            
            const container = document.getElementById('projectCheckboxContainer');
            const status = document.getElementById('projectStatus');
            
            container.innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">⏳ Loading projects...</div>';
            status.textContent = 'Fetching projects...';
            status.style.color = '#94a3b8';
            
            try {
                const headers = { 'Authorization': 'Basic ' + btoa(':' + pat), 'Content-Type': 'application/json' };
                
                // Fetch user profile from TFS connectionData API
                const userInfoDiv = document.getElementById('patUserInfo');
                try {
                    const connResp = await fetch(`${tfsUrlVal}/_apis/connectionData`, { headers });
                    if (connResp.ok) {
                        const connData = await connResp.json();
                        const authUser = connData.authenticatedUser || {};
                        const authzUser = connData.authorizedUser || {};
                        const userName = authUser.providerDisplayName || authUser.displayName || authzUser.providerDisplayName || '-';
                        const userId = authUser.id || '-';
                        
                        // Get email from connectionData properties
                        const props = authUser.properties || {};
                        const authzProps = authzUser.properties || {};
                        const userEmail = props.Mail?.$value || props.ConfirmedNotificationAddress?.$value 
                                       || authzProps.Mail?.$value || authzProps.ConfirmedNotificationAddress?.$value
                                       || props.Account?.$value || '';
                        
                        document.getElementById('patUserName').textContent = userName;
                        document.getElementById('patUserEmail').textContent = userEmail ? `(${userEmail})` : '';
                        document.getElementById('patUserId').textContent = `ID: ${userId}`;
                        
                        // Access control - check user against allowed_users.json (loaded via script tag)
                        const userNameLower = userName.toLowerCase().replace(/\s+/g, ' ').trim();
                        let accessAllowed = false;
                        if (typeof ALLOWED_USERS_DATA !== 'undefined') {
                            const matchedUser = (ALLOWED_USERS_DATA.users || []).find(u => 
                                u.name.toLowerCase().replace(/\s+/g, ' ').trim() === userNameLower
                            );
                            if (matchedUser) {
                                accessAllowed = true;
                                currentUserRole = (matchedUser.role || 'normal').toLowerCase();
                                // super_admin & admin always get all tabs
                                if (['super_admin', 'admin'].includes(currentUserRole)) {
                                    currentUserTabs = currentUserRole === 'super_admin' ? [1, 2, 3, 4, 5, 6] : [1, 2, 3, 4, 5];
                                } else {
                                    currentUserTabs = Array.isArray(matchedUser.tabs) ? matchedUser.tabs : [1, 2];
                                }
                            }
                        }
                        
                        if (!accessAllowed) {
                            userInfoDiv.style.display = 'block';
                            userInfoDiv.style.borderColor = 'rgba(239,68,68,0.5)';
                            userInfoDiv.style.background = 'rgba(239,68,68,0.15)';
                            userInfoDiv.querySelector('span').textContent = '🚫 Access Denied:';
                            userInfoDiv.querySelector('span').style.color = '#f87171';
                            container.innerHTML = '<div style="color: #f87171; font-size: 0.85rem;">⛔ You are not authorized to access this dashboard.</div>';
                            status.textContent = '';
                            return;
                        }
                        
                        isAuthorizedUser = true;
                        userInfoDiv.style.display = 'block';
                        
                        // Apply tab-wise permissions
                        applyTabPermissions();
                    }
                } catch (connErr) { /* silently skip profile fetch */ }
                
                const resp = await fetch(`${tfsUrlVal}/_apis/projects?api-version=5.0`, { headers });
                if (!resp.ok) throw new Error('Failed to fetch projects');
                
                const data = await resp.json();
                const projects = (data.value || []).sort((a, b) => a.name.localeCompare(b.name));
                
                if (projects.length === 0) {
                    container.innerHTML = '<div style="color: #f87171; font-size: 0.85rem;">-- No projects found --</div>';
                    status.textContent = 'No projects found';
                    status.style.color = '#f87171';
                } else {
                    container.innerHTML = projects.map(p => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                               onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="project-checkbox" value="${p.name}" onchange="updateSelectedProjects()" 
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #e2e8f0; font-size: 0.85rem;">${p.name}</span>
                        </label>
                    `).join('');
                    status.textContent = `✅ Found ${projects.length} projects - Select projects`;
                    status.style.color = '#34d399';
                    projectsFetched = true;
                    saveCredentials(); // PAT Preservation - save after successful fetch
                }
            } catch (err) {
                container.innerHTML = '<div style="color: #f87171; font-size: 0.85rem;">-- Enter valid PAT --</div>';
                status.textContent = '❌ ' + err.message;
                status.style.color = '#f87171';
            }
        }
        
        function updateSelectedProjects() {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            selectedProjects = Array.from(checkboxes).map(cb => cb.value);
            
            // Update display
            const display = document.getElementById('selectedProjects');
            if (selectedProjects.length > 0) {
                display.innerHTML = '✓ Selected: <strong>' + selectedProjects.join('</strong>, <strong>') + '</strong>';
            } else {
                display.innerHTML = '';
            }
        }

        async function connectTFS() {
            tfsUrl = document.getElementById('tfsUrl').value.trim().replace(/\/$/, '');
            const pat = document.getElementById('pat').value.trim();
            
            if (!tfsUrl || !pat) { showError('Please fill in TFS URL and PAT'); return; }
            if (!isAuthorizedUser) { showError('⛔ Access denied. Your account is not authorized to use this dashboard.'); return; }
            if (selectedProjects.length === 0) { showError('Please select at least one project'); return; }
            
            // Use first selected project as primary
            project = selectedProjects[0];
            
            config.headers = { 'Authorization': 'Basic ' + btoa(':' + pat), 'Content-Type': 'application/json' };
            apiCallCount = 0;
            showLoading('Connecting to ' + selectedProjects.join(' & ') + '...');
            
            try {
                // Fetch areas and iterations from all selected projects
                let allAreas = [];
                let allIterations = [];
                
                for (const proj of selectedProjects) {
                    const [areasResp, iterResp] = await Promise.all([
                        apiFetch(`${tfsUrl}/${proj}/_apis/wit/classificationnodes/areas?$depth=10&api-version=5.0`),
                        apiFetch(`${tfsUrl}/${proj}/_apis/wit/classificationnodes/iterations?$depth=10&api-version=5.0`)
                    ]);
                    
                    if (!areasResp.ok) throw new Error('Connection failed for ' + proj);
                    
                    const projAreas = flattenNodes(await areasResp.json(), [], 0, 'area');
                    const projIterations = flattenNodes(await iterResp.json(), [], 0, 'iteration');
                    
                    // Add project identifier to areas
                    projAreas.forEach(a => {
                        a.project = proj;
                        a.displayName = selectedProjects.length > 1 ? `[${proj}] ${a.name}` : a.name;
                    });
                    
                    // Add project identifier to iterations
                    projIterations.forEach(i => {
                        i.project = proj;
                    });
                    
                    allAreas.push(...projAreas);
                    allIterations.push(...projIterations);
                }
                
                // Sort areas and iterations
                areas = allAreas.sort((a, b) => {
                    // Sort by project first, then by path
                    if (a.project !== b.project) return a.project.localeCompare(b.project);
                    return a.path.localeCompare(b.path);
                });
                
                // EXCLUDED AREAS - These teams are not included in the Area Path dropdown:
                // [CasepointARA] CasepointARA, 508 Compliance Team, Core Framework Web,
                // DA Tools Utilities, DataSite Team, DevOps Team, Global QA, Mobile App,
                // Review Utilities, AI, Document Export, ARA core
                const excludedAreas = [
                    'CasepointARA',
                    '508 Compliance Team',
                    'Core Framework Web',
                    'DA Tools Utilities',
                    'DataSite Team',
                    'Mobile App',
                    'Review Utilities',
                    'Document Export',
                    'AI',
                    'ARA core'
                ];
                
                // Filter out excluded areas
                areas = areas.filter(a => {
                    const areaName = a.name.trim();
                    return !excludedAreas.some(excluded => 
                        areaName.toLowerCase() === excluded.toLowerCase()
                    );
                });
                
                iterations = allIterations.sort((a, b) => a.path.localeCompare(b.path));
                
                // Populate area checkboxes with project groups
                const areaContainer = document.getElementById('areaCheckboxContainer');
                let areaHtml = '';
                
                // Helper function to create area checkbox HTML
                // Default selected areas: Conversion And Processing, Custom Data Parsing under CasepointARA
                const defaultSelectedAreas = ['conversion and processing', 'custom data parsing'];
                const isDefaultArea = (a) => {
                    const areaName = a.name.trim().toLowerCase();
                    return defaultSelectedAreas.some(d => areaName === d);
                };
                
                const createAreaCheckbox = (a, isFirst) => {
                    const projLabel = selectedProjects.length > 1 ? `[${a.project}] ` : '';
                    const shouldCheck = isDefaultArea(a);
                    return `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 5px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                               onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="area-checkbox" value="${a.path}" data-project="${a.project}" 
                                   ${shouldCheck ? 'checked' : ''} onchange="updateSelectedAreas()"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #e2e8f0; font-size: 0.8rem;">${projLabel}${a.name.trim()}</span>
                        </label>`;
                };
                
                if (selectedProjects.length > 1) {
                    // Group by project
                    selectedProjects.forEach((proj, projIdx) => {
                        const projAreas = areas.filter(a => a.project === proj);
                        if (projAreas.length > 0) {
                            areaHtml += `<div style="background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 8px; margin-bottom: 10px;">
                                <div style="color: #a5b4fc; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(99,102,241,0.3);">📁 ${proj}</div>`;
                            areaHtml += projAreas.map((a, idx) => createAreaCheckbox(a, projIdx === 0 && idx === 0)).join('');
                            areaHtml += '</div>';
                        }
                    });
                } else {
                    // Single project - simple list
                    areaHtml += areas.map((a, idx) => createAreaCheckbox(a, idx === 0)).join('');
                }
                
                if (areaHtml === '') {
                    areaHtml = '<div style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 20px;">No areas found</div>';
                }
                
                areaContainer.innerHTML = areaHtml;
                
                // If no default areas were checked, check the first area as fallback
                const checkedBoxes = document.querySelectorAll('.area-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    const firstCheckbox = document.querySelector('.area-checkbox');
                    if (firstCheckbox) firstCheckbox.checked = true;
                }
                
                updateSelectedAreas();
                
                // Filter iterations to show only last 2 quarters (current + previous)
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1; // 1-12
                
                // Determine current quarter
                let currentQuarter;
                if (currentMonth <= 3) currentQuarter = 1;
                else if (currentMonth <= 6) currentQuarter = 2;
                else if (currentMonth <= 9) currentQuarter = 3;
                else currentQuarter = 4;
                
                // Calculate previous quarter
                let prevQuarter = currentQuarter - 1;
                let prevYear = currentYear;
                if (prevQuarter === 0) {
                    prevQuarter = 4;
                    prevYear = currentYear - 1;
                }
                
                // Create valid quarter strings (e.g., "2026-Q1", "2025-Q4")
                const currentQStr = `${currentYear}-Q${currentQuarter}`;
                const prevQStr = `${prevYear}-Q${prevQuarter}`;
                
                
                // Filter iterations that match current or previous quarter
                // Pattern: PI-YYYY-QX or YYYY-QX in iteration name
                const filteredIterations = iterations.filter(i => {
                    const name = i.name.trim();
                    // Extract year-quarter pattern from name (e.g., "2026-Q1" from "PI-2026-Q1_2")
                    const match = name.match(/(\d{4})-Q([1-4])/i);
                    if (match) {
                        const iterQStr = `${match[1]}-Q${match[2]}`;
                        return iterQStr === currentQStr || iterQStr === prevQStr;
                    }
                    // Also check for iterations without clear quarter pattern - include them
                    return false;
                });
                
                // OPTIMIZATION: Combine iterations with same name from different projects
                const iterationsByName = {};
                filteredIterations.forEach(i => {
                    const name = i.name.trim();
                    if (!iterationsByName[name]) {
                        iterationsByName[name] = {
                            name: name,
                            paths: [],  // Store all paths (one per project)
                            projects: [],
                            attributes: i.attributes  // Use first iteration's attributes for dates
                        };
                    }
                    iterationsByName[name].paths.push({ path: i.path, project: i.project });
                    iterationsByName[name].projects.push(i.project);
                });
                
                // Convert to array for display
                const combinedIterations = Object.values(iterationsByName);
                
                // Find current sprint in combined iterations (reuse 'now' from above)
                const currentIteration = combinedIterations.find(i => i.attributes?.startDate && i.attributes?.finishDate && 
                    now >= new Date(i.attributes.startDate) && now <= new Date(i.attributes.finishDate));
                
                // Group by quarter for display
                const currentQIterations = combinedIterations.filter(i => {
                    const match = i.name.match(/(\d{4})-Q([1-4])/i);
                    return match && `${match[1]}-Q${match[2]}` === currentQStr;
                });
                const prevQIterations = combinedIterations.filter(i => {
                    const match = i.name.match(/(\d{4})-Q([1-4])/i);
                    return match && `${match[1]}-Q${match[2]}` === prevQStr;
                });
                
                // Build iteration checkboxes with quarter grouping
                const container = document.getElementById('iterationCheckboxContainer');
                let iterHtml = '';
                
                // Helper function to create checkbox HTML for combined iteration
                const createIterCheckbox = (i, isCurrent) => {
                    const d1 = i.attributes?.startDate ? new Date(i.attributes.startDate).toLocaleDateString() : '';
                    const d2 = i.attributes?.finishDate ? new Date(i.attributes.finishDate).toLocaleDateString() : '';
                    // Show project count if multiple projects have this iteration
                    const projInfo = i.projects.length > 1 ? `<span style="color: #60a5fa; font-size: 0.65rem; margin-left: 4px;">(${i.projects.length} projects)</span>` : '';
                    const currentBadge = isCurrent ? '<span style="background: rgba(16,185,129,0.4); color: #34d399; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; margin-left: 6px;">⭐ Current</span>' : '';
                    // Store all paths as JSON in data attribute
                    const pathsJson = JSON.stringify(i.paths).replace(/"/g, '&quot;');
                    return `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                               onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="iteration-checkbox" value="${i.name}" data-paths="${pathsJson}" 
                                   ${isCurrent ? 'checked' : ''} onchange="updateSelectedIterations()"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #e2e8f0; font-size: 0.8rem;">${i.name}</span>
                            ${projInfo}
                            <span style="color: #94a3b8; font-size: 0.7rem;">${d1 ? `(${d1} - ${d2})` : ''}</span>
                            ${currentBadge}
                        </label>`;
                };
                
                // Add current quarter group
                if (currentQIterations.length > 0) {
                    iterHtml += `<div style="background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; padding: 8px; margin-bottom: 10px;">
                        <div style="color: #34d399; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(16,185,129,0.3);">📅 Current Quarter (${currentQStr})</div>`;
                    iterHtml += currentQIterations.map(i => {
                        const isCurrent = currentIteration && i.name === currentIteration.name;
                        return createIterCheckbox(i, isCurrent);
                    }).join('');
                    iterHtml += '</div>';
                }
                
                // Add previous quarter group
                if (prevQIterations.length > 0) {
                    iterHtml += `<div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #fbbf24; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(245,158,11,0.3);">📅 Previous Quarter (${prevQStr})</div>`;
                    iterHtml += prevQIterations.map(i => createIterCheckbox(i, false)).join('');
                    iterHtml += '</div>';
                }
                
                if (iterHtml === '') {
                    iterHtml = '<div style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 20px;">No iterations found for current/previous quarter</div>';
                }
                
                container.innerHTML = iterHtml;
                
                // Update selected iterations display
                updateSelectedIterations();
                
                hideLoading();
                document.getElementById('configPanel').style.display = 'none';
                document.getElementById('filterPanel').classList.add('visible');
            } catch (err) { hideLoading(); showError(err.message); }
        }

        // Selected areas array
        let selectedAreaPaths = [];
        
        function updateSelectedAreas() {
            const MAX_AREAS = ['admin','super_admin'].includes(currentUserRole) ? 999 : 3;
            const isAdmin = ['admin','super_admin'].includes(currentUserRole);
            const allCheckboxes = document.querySelectorAll('.area-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.area-checkbox:checked');
            
            // If over limit, uncheck the one just clicked
            if (checkedCheckboxes.length > MAX_AREAS) {
                const lastChanged = event?.target;
                if (lastChanged && lastChanged.checked) {
                    lastChanged.checked = false;
                }
            }
            
            const checkedNow = document.querySelectorAll('.area-checkbox:checked');
            selectedAreaPaths = Array.from(checkedNow).map(cb => ({
                path: cb.value,
                project: cb.getAttribute('data-project')
            }));
            
            // Disable unchecked checkboxes when at limit
            const atLimit = selectedAreaPaths.length >= MAX_AREAS;
            allCheckboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = atLimit;
                    cb.parentElement.style.opacity = atLimit ? '0.4' : '1';
                    cb.parentElement.style.cursor = atLimit ? 'not-allowed' : 'pointer';
                } else {
                    cb.disabled = false;
                    cb.parentElement.style.opacity = '1';
                    cb.parentElement.style.cursor = 'pointer';
                }
            });
            
            // Update display
            const display = document.getElementById('selectedAreas');
            if (selectedAreaPaths.length > 0) {
                const names = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
                const limitNote = !isAdmin && atLimit ? ' <span style="color:#fbbf24;font-size:0.7rem;">(max reached)</span>' : '';
                const countDisplay = isAdmin ? `${selectedAreaPaths.length}` : `${selectedAreaPaths.length}/${MAX_AREAS}`;
                display.innerHTML = `✓ Selected: <strong>${countDisplay}</strong> area(s) - ${names}${limitNote}`;
            } else {
                display.innerHTML = '<span style="color: #f87171;">Please select at least one area</span>';
            }
        }
        
        // Global helper function to check if a task's area path matches the selected areas
        // This properly handles sibling areas that share a common prefix (e.g., "eCase" vs "eCase Platform")
        function isTaskAreaMatchingSelection(taskAreaPath) {
            if (!taskAreaPath || selectedAreaPaths.length === 0) return true;
            const taskAreaLower = taskAreaPath.toLowerCase();
            const useExactAreaMatch = document.getElementById('exactAreaMatch')?.checked || false;
            
            return selectedAreaPaths.some(a => {
                const selectedAreaLower = a.path.toLowerCase();
                // Always check for exact match first
                if (taskAreaLower === selectedAreaLower) return true;
                
                if (useExactAreaMatch) {
                    // Exact match only - already checked above
                    return false;
                } else {
                    // UNDER match: task area must be a child of the selected area
                    // Child areas have the format: selectedArea\ChildName
                    // We must ensure there's a backslash IMMEDIATELY after the selected area to avoid
                    // matching sibling areas like "eCase\eCase" incorrectly matching "eCase\eCase Platform"
                    return taskAreaLower.startsWith(selectedAreaLower + '\\');
                }
            });
        }
        
        // Toggle all area checkboxes (admin=all, normal=max 3)
        function toggleAllAreas(event) {
            event.preventDefault();
            const MAX_AREAS = ['admin','super_admin'].includes(currentUserRole) ? 999 : 3;
            const checkboxes = document.querySelectorAll('.area-checkbox');
            const checkedCount = document.querySelectorAll('.area-checkbox:checked').length;
            
            if (checkedCount > 0) {
                // If any are checked, uncheck all
                checkboxes.forEach(cb => cb.checked = false);
                event.target.textContent = 'Select All';
            } else {
                // Check areas (admin=all, normal=first 3)
                let count = 0;
                checkboxes.forEach(cb => {
                    cb.checked = count < MAX_AREAS;
                    count++;
                });
                event.target.textContent = 'Deselect All';
            }
            
            updateSelectedAreas();
        }

        // Selected iterations array
        let selectedIterationPaths = [];
        
        function updateSelectedIterations() {
            const checkboxes = document.querySelectorAll('.iteration-checkbox:checked');
            selectedIterationPaths = [];
            
            // Parse the combined iteration paths from each checkbox
            checkboxes.forEach(cb => {
                const pathsJson = cb.getAttribute('data-paths');
                if (pathsJson) {
                    try {
                        const paths = JSON.parse(pathsJson.replace(/&quot;/g, '"'));
                        // Add all paths from this combined iteration
                        paths.forEach(p => selectedIterationPaths.push(p));
                    } catch (e) {
                        console.error('Error parsing iteration paths:', e);
                    }
                }
            });
            
            // Update display - show unique iteration names
            const display = document.getElementById('selectedIterations');
            if (checkboxes.length > 0) {
                const names = Array.from(checkboxes).map(cb => cb.value).join(', ');
                const totalPaths = selectedIterationPaths.length;
                const pathInfo = totalPaths > checkboxes.length ? ` (${totalPaths} project paths)` : '';
                display.innerHTML = `✓ Selected: <strong>${checkboxes.length}</strong> sprint(s)${pathInfo} - ${names}`;
            } else {
                display.innerHTML = '<span style="color: #f87171;">Please select at least one sprint</span>';
            }
        }

        function flattenNodes(node, list = [], level = 0, nodeType = 'area') {
            if (node.name) {
                let p = node.path || node.name;
                // Clean up path - remove leading backslashes and classification node markers
                p = p.replace(/^\\+/, '');  // Remove leading backslashes
                
                if (nodeType === 'area') {
                    // For areas: \Project\Area\SubArea -> Project\SubArea
                    // Root area: \Project\Area -> Project (fixes FOIAXpress issue)
                    p = p.replace(/\\Area\\/gi, '\\');  // Remove \Area\ in middle (case-insensitive)
                    p = p.replace(/\\Area$/gi, '');     // Remove \Area at end (root area)
                } else {
                    // For iterations: \Project\Iteration\Sprint -> Project\Sprint
                    p = p.replace(/\\Iteration\\/gi, '\\');
                    p = p.replace(/\\Iteration$/gi, '');
                }
                
                list.push({ path: p, name: '  '.repeat(level) + node.name, attributes: node.attributes });
            }
            if (node.children) node.children.forEach(c => flattenNodes(c, list, level + 1, nodeType));
            return list;
        }

        async function loadData() {
            // Get selected areas and iterations from checkboxes
            if (selectedAreaPaths.length === 0) { alert('Please select at least one Area Path'); return; }
            if (selectedIterationPaths.length === 0) { alert('Please select at least one Sprint'); return; }
            
            // Use first selected area's project as primary project
            project = selectedAreaPaths[0].project || project;
            
            // Build area filter for WIQL (supports multiple areas)
            const useExactAreaMatch = document.getElementById('exactAreaMatch')?.checked || false;
            const areaOperator = useExactAreaMatch ? '=' : 'UNDER';
            const areaFilterClauses = selectedAreaPaths.map(a => `[System.AreaPath] ${areaOperator} '${a.path}'`);
            const areaFilter = areaFilterClauses.length > 1 
                ? `(${areaFilterClauses.join(' OR ')})` 
                : areaFilterClauses[0];
            
            // Build iteration filter for WIQL (supports multiple iterations)
            const iterFilterClauses = selectedIterationPaths.map(i => `[System.IterationPath] UNDER '${i.path}'`);
            const iterFilter = iterFilterClauses.length > 1 
                ? `(${iterFilterClauses.join(' OR ')})` 
                : iterFilterClauses[0];
            
            // Get names for display
            const areaNames = selectedAreaPaths.map(a => a.path.split('\\').pop()).join(', ');
            const exactMatchIndicator = useExactAreaMatch ? ' (Exact)' : '';
            // Get unique sprint names (since same sprint from multiple projects now appears once)
            const uniqueSprintNames = [...new Set(selectedIterationPaths.map(i => i.path.split('\\').pop()))];
            const sprintNames = uniqueSprintNames.join(', ');
            sprintInfo = { name: sprintNames, areaName: areaNames + exactMatchIndicator };
            
            // Local variables for backwards compatibility with capacity/team code
            const areaPath = selectedAreaPaths[0].path;
            const iterPath = selectedIterationPaths[0].path;
            
            apiCallCount = 0;
            showLoading(`Fetching data for ${selectedAreaPaths.length} area(s) & ${selectedIterationPaths.length} sprint(s)...`);
            document.getElementById('filterPanel').classList.remove('visible');
            
            try {
                // ====== PHASE 1: Fetch ALL work item IDs (SINGLE WIQL query) ======
                showLoading('Phase 1/3: Fetching work item IDs...');
                
                // ONE query for Reqs + Change Requests + Bugs + Tasks (was 3 separate queries)
                const wiqlResp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/wiql?api-version=5.0`, {
                    method: 'POST', body: JSON.stringify({ query: `SELECT [System.Id] FROM WorkItems WHERE [System.WorkItemType] IN ('Requirement', 'Change Request', 'Bug', 'Task') AND ${areaFilter} AND ${iterFilter}` })
                });
                const wiqlData = await wiqlResp.json();
                const allIds = (wiqlData.workItems || []).map(w => w.id);
                
                // ====== PHASE 2: Batch fetch ALL work items with unified field set ======
                showLoading(`Phase 2/3: Fetching ${allIds.length} work items...`);
                
                // Unified field set (superset of req + bug + task fields)
                const allFields = ['System.Id','System.Title','System.State','System.Reason','System.AssignedTo','System.Tags','System.IterationPath','System.AreaPath','System.Description','System.WorkItemType','Microsoft.VSTS.Scheduling.OriginalEstimate','Microsoft.VSTS.Scheduling.RemainingWork','Microsoft.VSTS.Scheduling.CompletedWork','Microsoft.VSTS.Scheduling.Size','Microsoft.VSTS.Common.Discipline','Microsoft.VSTS.Common.Severity','Casepoint.TFS.CustomFields.TaskExecutionType','Casepoint.TFS.CustomFields.ReleaseNotesCategory','Casepoint.TFS.CustomFields.ReleaseNotes','Casepoint.TFS.CustomFields.RevisedEstimate','Microsoft.VSTS.Common.StateChangeDate'];
                
                const allItemData = await batchFetchWorkItems(allIds, allFields);
                
                const reqData = allItemData.filter(w => {
                    const wit = w.fields['System.WorkItemType'];
                    return wit === 'Requirement' || wit === 'Change Request';
                });
                const bugData = allItemData.filter(w => w.fields['System.WorkItemType'] === 'Bug');
                const taskData = allItemData.filter(w => w.fields['System.WorkItemType'] === 'Task');
                
                bugs = bugData;
                tasks = taskData;
                const allReqIds = reqData.map(r => r.id);
                
                // Fetch relations ONLY for requirements (needed for parent-child mapping)
                showLoading(`Phase 2/3: Building relationships for ${allReqIds.length} requirements...`);
                const reqsWithRelations = await batchFetchWithRelations(allReqIds);
                
                // Also fetch relations for Adhoc Support bugs (so their child tasks appear in taskParentMap)
                const adhocSupportBugIds = bugData.filter(b => 
                    (b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')
                ).map(b => b.id);
                let adhocBugsWithRelations = [];
                if (adhocSupportBugIds.length > 0) {
                    showLoading(`Phase 2/3: Building relationships for ${adhocSupportBugIds.length} Adhoc Support bugs...`);
                    adhocBugsWithRelations = await batchFetchWithRelations(adhocSupportBugIds);
                }
                
                // ====== PHASE 3: Build tag-based sets & task-parent mapping ======
                showLoading('Phase 3/3: Processing data & fetching capacity...');
                
                // OPTIMIZATION: Derive tag-based ID sets from fetched data (saves 6 WIQL queries)
                const idSets = {
                    allReqs: new Set(reqData.map(r => r.id)),
                    bugs: new Set(bugData.map(b => b.id)),
                    tasks: new Set(taskData.map(t => t.id)),
                    // Derived from tags in JavaScript instead of separate WIQL queries
                    deliverable: new Set(reqData.filter(r => {
                        const tags = (r.fields['System.Tags'] || '').toLowerCase();
                        return tags.includes('deliverable') && !tags.includes('non-deliverable');
                    }).map(r => r.id)),
                    nonDeliverable: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('non-deliverable')
                    ).map(r => r.id)),
                    adhocSupport: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')
                    ).map(r => r.id)),
                    affectOthers: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('affect others')
                    ).map(r => r.id)),
                    affectedArea: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('affected area')
                    ).map(r => r.id)),
                    adhocBugs: new Set(bugData.filter(b => 
                        (b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')
                    ).map(b => b.id))
                };
                
                // Build task-parent mapping from relations
                taskParentMap = {};
                reqTasksMap = {};
                
                reqsWithRelations.forEach(req => {
                    const childTaskIds = (req.relations || [])
                        .filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward')
                        .map(r => parseInt(r.url.split('/').pop()));
                    
                    reqTasksMap[req.id] = childTaskIds;
                    childTaskIds.forEach(tid => taskParentMap[tid] = req.id);
                });
                
                // Map Adhoc Support bug child tasks into taskParentMap
                adhocBugsWithRelations.forEach(bug => {
                    const childTaskIds = (bug.relations || [])
                        .filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward')
                        .map(r => parseInt(r.url.split('/').pop()));
                    
                    reqTasksMap[bug.id] = childTaskIds;
                    childTaskIds.forEach(tid => { if (!taskParentMap[tid]) taskParentMap[tid] = bug.id; });
                });
                
                // Build set of requirements that have a parent (Hierarchy-Reverse)
                const reqsWithParent = new Set();
                reqsWithRelations.forEach(req => {
                    const hasParent = (req.relations || []).some(r => r.rel === 'System.LinkTypes.Hierarchy-Reverse');
                    if (hasParent) reqsWithParent.add(req.id);
                });
                
                // Create task lookup map
                const taskLookup = {};
                tasks.forEach(t => taskLookup[t.id] = t);
                
                // Process requirements using cached data
                requirements = reqData.map(req => {
                    const tags = (req.fields['System.Tags'] || '').toLowerCase();
                    const category = idSets.deliverable.has(req.id) ? 'deliverable' : 
                                    idSets.nonDeliverable.has(req.id) ? 'nonDeliverable' : 'unclassified';
                    const isAdhocSupport = idSets.adhocSupport.has(req.id);
                    const isAffectOthers = idSets.affectOthers.has(req.id);
                    const isAffectedArea = idSets.affectedArea.has(req.id);
                    const isDeliverablesAdhoc = tags.includes('deliverables adhoc');
                    const isDeliverablesOnHold = tags.includes('deliverables onhold');
                    const urnTag = tags.includes('urn-in') ? 'urnIn' : tags.includes('urn-cf') ? 'urnCf' : 'urnMissing';
                    const hasAffectOthers = tags.includes('affect others');
                    const hasAffectedArea = tags.includes('affected area');
                    const desc = req.fields['System.Description'] || '';
                    
                    // Detect weekly tags (Week 1, Week 2, Week 3, Week 4)
                    const weekTag = tags.includes('week 1') ? 'week1' : 
                                   tags.includes('week 2') ? 'week2' : 
                                   tags.includes('week 3') ? 'week3' : 
                                   tags.includes('week 4') ? 'week4' : null;
                    const hasWeeklyTag = weekTag !== null;
                    
                    // Calculate task hours from cached data (only Development & Test discipline tasks)
                    const childIds = reqTasksMap[req.id] || [];
                    const allowedDisc = ['development', 'test'];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => {
                        if (!t) return false;
                        const disc = (t.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase().trim();
                        return allowedDisc.includes(disc);
                    });
                    const taskEstimate = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const taskCompletedWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    const taskRemainingWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    
                    return {
                        ...req, category, isAdhocSupport, isAffectOthers, isAffectedArea, isDeliverablesAdhoc, isDeliverablesOnHold, urnTag, hasAffectOthers, hasAffectedArea,
                        size: req.fields['Microsoft.VSTS.Scheduling.Size'] || 0,
                        hasDescription: desc.trim().length > 0,
                        hasParent: reqsWithParent.has(req.id),
                        taskEstimate, taskCompletedWork, taskRemainingWork, weekTag, hasWeeklyTag
                    };
                });
                
                // Build weekly data - ONLY Deliverable items
                weeklyData = { week1: [], week2: [], week3: [], week4: [], noWeekTag: [] };
                weeklyDataByIteration = {};
                requirements.filter(req => req.category === 'deliverable').forEach(req => {
                    // Add to global weeklyData
                    if (req.weekTag === 'week1') weeklyData.week1.push(req);
                    else if (req.weekTag === 'week2') weeklyData.week2.push(req);
                    else if (req.weekTag === 'week3') weeklyData.week3.push(req);
                    else if (req.weekTag === 'week4') weeklyData.week4.push(req);
                    else weeklyData.noWeekTag.push(req);
                    
                    // Also group by iteration path
                    const iterPath = req.fields['System.IterationPath'] || 'Unknown';
                    if (!weeklyDataByIteration[iterPath]) {
                        weeklyDataByIteration[iterPath] = { week1: [], week2: [], week3: [], week4: [], noWeekTag: [] };
                    }
                    if (req.weekTag === 'week1') weeklyDataByIteration[iterPath].week1.push(req);
                    else if (req.weekTag === 'week2') weeklyDataByIteration[iterPath].week2.push(req);
                    else if (req.weekTag === 'week3') weeklyDataByIteration[iterPath].week3.push(req);
                    else if (req.weekTag === 'week4') weeklyDataByIteration[iterPath].week4.push(req);
                    else weeklyDataByIteration[iterPath].noWeekTag.push(req);
                });
                
                // Calculate UI/UX & UD tasks
                uiUxUdData = { tasks: [], totalOrigEst: 0 };
                tasks.filter(t => isUiUxUdTask(t.fields['System.Title'])).forEach(t => {
                    uiUxUdData.tasks.push(t);
                    uiUxUdData.totalOrigEst += t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                });
                
                // Calculate task estimates by category
                taskEstByCategory = { deliverableEst: 0, nonDeliverableEst: 0 };
                requirements.forEach(req => {
                    if (req.category === 'deliverable') taskEstByCategory.deliverableEst += req.taskEstimate;
                    else if (req.category === 'nonDeliverable') taskEstByCategory.nonDeliverableEst += req.taskEstimate;
                });
                
                // TEAM B - Requirements with "Ticket Support" or "Ticket Handling"
                teamBData = { requirements: [], totalOrigEst: 0, totalSize: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
                requirements.filter(r => {
                    const title = (r.fields['System.Title'] || '').toLowerCase();
                    return title.includes('ticket support') || title.includes('ticket handling');
                }).forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => t);
                    const origEst = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const remWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    const compWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    const size = req.fields['Microsoft.VSTS.Scheduling.Size'] || 0;
                    
                    teamBData.requirements.push({ ...req, taskCount: childTasks.length, taskIds: childIds, originalEstimate: origEst, size: size, remainingWork: remWork, completedWork: compWork });
                    teamBData.totalTasks += childTasks.length;
                    teamBData.totalOrigEst += origEst;
                    teamBData.totalSize += size;
                    teamBData.totalRemWork += remWork;
                    teamBData.totalCompWork += compWork;
                });
                
                // Sprint Goal - Requirements with "Sprint Goal" tag
                sprintGoalData = { requirements: [], totalOrigEst: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
                requirements.filter(r => (r.fields['System.Tags'] || '').toLowerCase().includes('sprint goal')).forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => t);
                    const origEst = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const remWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    const compWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    
                    sprintGoalData.requirements.push({ ...req, taskCount: childTasks.length, originalEstimate: origEst, remainingWork: remWork, completedWork: compWork });
                    sprintGoalData.totalTasks += childTasks.length;
                    sprintGoalData.totalOrigEst += origEst;
                    sprintGoalData.totalRemWork += remWork;
                    sprintGoalData.totalCompWork += compWork;
                });
                
                // Code Review tasks
                codeReviewData = { tasks: [], totalOrigEst: 0, done: 0, inProgress: 0, todo: 0 };
                tasks.filter(t => (t.fields['System.Title'] || '').toLowerCase().startsWith('code review')).forEach(t => {
                    const state = (t.fields['System.State'] || '').toLowerCase();
                    codeReviewData.tasks.push(t);
                    codeReviewData.totalOrigEst += t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                    if (['done', 'closed', 'completed'].includes(state)) codeReviewData.done++;
                    else if (['in progress', 'active'].includes(state)) codeReviewData.inProgress++;
                    else codeReviewData.todo++;
                });
                
                // ALM/TeamB/EngQa-Reserve - Tasks from untagged requirements
                let almEngExtraHours = 0;
                requirements.filter(r => r.category === 'unclassified' && !r.isAdhocSupport).forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => t);
                    almEngExtraHours += childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                });
                
                // ====== Fetch Team Capacity (PARALLELIZED - 3 bursts) ======
                // Multi-iteration support: calculate combined date range from ALL selected iterations
                let sprintCalendarDays = 0, sprintStartDate = null, sprintEndDate = null;
                const selectedIterObjects = [];
                
                selectedIterationPaths.forEach(selIter => {
                    const matchedIter = iterations.find(i => i.path === selIter.path);
                    if (matchedIter?.attributes?.startDate && matchedIter?.attributes?.finishDate) {
                        const iStart = new Date(matchedIter.attributes.startDate);
                        const iEnd = new Date(matchedIter.attributes.finishDate);
                        selectedIterObjects.push({ path: selIter.path, project: selIter.project, startDate: iStart, endDate: iEnd });
                        if (!sprintStartDate || iStart < sprintStartDate) sprintStartDate = iStart;
                        if (!sprintEndDate || iEnd > sprintEndDate) sprintEndDate = iEnd;
                    }
                });
                
                // Fallback to first iteration if no date info found
                if (selectedIterObjects.length === 0) {
                    const selectedIteration = iterations.find(i => i.path === iterPath);
                    if (selectedIteration?.attributes?.startDate && selectedIteration?.attributes?.finishDate) {
                        const iStart = new Date(selectedIteration.attributes.startDate);
                        const iEnd = new Date(selectedIteration.attributes.finishDate);
                        sprintStartDate = iStart;
                        sprintEndDate = iEnd;
                        selectedIterObjects.push({ path: iterPath, project: selectedIterationPaths[0]?.project || '', startDate: iStart, endDate: iEnd });
                    }
                }
                
                if (sprintStartDate && sprintEndDate) {
                    for (let d = new Date(sprintStartDate); d <= sprintEndDate; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() !== 0 && d.getDay() !== 6) sprintCalendarDays++;
                    }
                }
                
                let teamCapacity = 0, teamDaysOffCount = 0, totalMemberDaysOff = 0;
                let sprintWorkDays = sprintCalendarDays;
                let memberCapacities = [];
                let teamDaysOffDates = [];
                
                try {
                    // Step 1: Group areas by project (CPU only)
                    const areasByProject = {};
                    selectedAreaPaths.forEach(area => {
                        if (!areasByProject[area.project]) areasByProject[area.project] = [];
                        areasByProject[area.project].push(area);
                    });
                    
                    // Step 2: Parallel burst 1 - Fetch ALL project teams (1 call per project)
                    const projectNames = Object.keys(areasByProject);
                    const teamsResults = await Promise.all(
                        projectNames.map(p => apiFetch(`${tfsUrl}/_apis/projects/${p}/teams?api-version=5.0`).then(r => r.json()))
                    );
                    const teamsByProject = {};
                    projectNames.forEach((proj, i) => { teamsByProject[proj] = teamsResults[i].value || []; });
                    
                    // Step 3: Match all areas to teams (CPU only, no API calls)
                    const matchedTeams = [];
                    const processedTeams = new Set();
                    
                    for (const projName of projectNames) {
                        const teams = teamsByProject[projName];
                        for (const selectedArea of areasByProject[projName]) {
                            const areaNameLower = selectedArea.path.split('\\').pop().toLowerCase();
                            
                            let teamToUse = teams.find(t => t.name.toLowerCase() === areaNameLower)
                                || teams.find(t => t.name.toLowerCase() === `${areaNameLower} team`)
                                || teams.find(t => t.name.toLowerCase() === `${areaNameLower}-team`);
                            
                            if (!teamToUse) continue;
                            const teamKey = `${projName}/${teamToUse.name}`;
                            if (processedTeams.has(teamKey)) continue;
                            processedTeams.add(teamKey);
                            matchedTeams.push({ projName, teamName: teamToUse.name });
                        }
                    }
                    
                    // Fallback: use default teams if no matches
                    if (matchedTeams.length === 0) {
                        for (const projName of projectNames) {
                            const teams = teamsByProject[projName];
                            const defaultTeam = teams.find(t => t.name === projName || t.name === projName + ' Team') || teams[0];
                            if (defaultTeam) matchedTeams.push({ projName, teamName: defaultTeam.name });
                        }
                    }
                    
                    
                    // Step 4: Parallel burst 2 - Fetch ALL team iterations at once
                    const iterResults = await Promise.all(
                        matchedTeams.map(({ projName, teamName }) =>
                            apiFetch(`${tfsUrl}/${projName}/${encodeURIComponent(teamName)}/_apis/work/teamsettings/iterations?api-version=5.0`)
                                .then(r => r.ok ? r.json() : { value: [] })
                                .then(data => {
                                    // Match ALL selected iterations (not just the first)
                                    const matchingIters = (data.value || []).filter(i =>
                                        selectedIterationPaths.some(sel =>
                                            (sel.project === projName && i.path === sel.path) ||
                                            i.name === sel.path.split('\\').pop()
                                        )
                                    );
                                    return { projName, teamName, matchingIterations: matchingIters };
                                })
                        )
                    );
                    
                    // Step 5: Parallel burst 3 - Fetch ALL capacities + daysoff for ALL matched iterations
                    const teamsWithIter = [];
                    iterResults.forEach(t => {
                        (t.matchingIterations || []).forEach(iter => {
                            if (iter.id) teamsWithIter.push({ projName: t.projName, teamName: t.teamName, iterationId: iter.id, iterationPath: iter.path });
                        });
                    });
                    
                    const capResults = await Promise.all(
                        teamsWithIter.map(({ projName, teamName, iterationId, iterationPath }) =>
                            Promise.all([
                                apiFetch(`${tfsUrl}/${projName}/${encodeURIComponent(teamName)}/_apis/work/teamsettings/iterations/${iterationId}/teamdaysoff?api-version=5.0`)
                                    .then(r => r.ok ? r.json() : { daysOff: [] }),
                                apiFetch(`${tfsUrl}/${projName}/${encodeURIComponent(teamName)}/_apis/work/teamsettings/iterations/${iterationId}/capacities?api-version=5.0`)
                                    .then(r => r.ok ? r.json() : { value: [] })
                            ]).then(([daysOffData, capData]) => ({ projName, teamName, iterationId, iterationPath, daysOffData, capData }))
                        )
                    );
                    
                    // Step 6: Process all results (CPU only, no API calls)
                    // For multi-iteration: aggregate member capacities across all iterations
                    let firstTeamProcessed = false;
                    const memberCapMap = {}; // key: memberName|teamName → aggregated data
                    
                    capResults.forEach(({ projName, teamName, iterationId, iterationPath, daysOffData, capData }) => {
                        // Find this iteration's date range
                        const iterObj = selectedIterObjects.find(so => so.path === iterationPath) 
                            || selectedIterObjects.find(so => iterationPath && iterationPath.split('\\').pop() === so.path.split('\\').pop());
                        const iterStart = iterObj?.startDate || sprintStartDate;
                        const iterEnd = iterObj?.endDate || sprintEndDate;
                        
                        // Calculate work days for THIS iteration
                        let iterCalendarDays = 0;
                        if (iterStart && iterEnd) {
                            for (let d = new Date(iterStart); d <= iterEnd; d.setDate(d.getDate() + 1)) {
                                if (d.getDay() !== 0 && d.getDay() !== 6) iterCalendarDays++;
                            }
                        }
                        
                        // Process team days off (only for first team to avoid double counting)
                        let iterTeamDaysOff = 0;
                        if (!firstTeamProcessed) {
                            firstTeamProcessed = true;
                            (daysOffData.daysOff || []).forEach(dayOff => {
                                if (dayOff.start && dayOff.end) {
                                    const offStart = new Date(dayOff.start);
                                    const offEnd = new Date(dayOff.end);
                                    for (let d = new Date(offStart); d <= offEnd; d.setDate(d.getDate() + 1)) {
                                        if (d.getDay() !== 0 && d.getDay() !== 6 && d >= sprintStartDate && d <= sprintEndDate) {
                                            teamDaysOffCount++;
                                            teamDaysOffDates.push(d.toLocaleDateString());
                                        }
                                    }
                                }
                            });
                        }
                        // Also count team days off specific to this iteration
                        (daysOffData.daysOff || []).forEach(dayOff => {
                            if (dayOff.start && dayOff.end) {
                                const offStart = new Date(dayOff.start);
                                const offEnd = new Date(dayOff.end);
                                for (let d = new Date(offStart); d <= offEnd; d.setDate(d.getDate() + 1)) {
                                    if (d.getDay() !== 0 && d.getDay() !== 6 && d >= iterStart && d <= iterEnd) {
                                        iterTeamDaysOff++;
                                    }
                                }
                            }
                        });
                        const iterWorkDays = Math.max(0, iterCalendarDays - iterTeamDaysOff);
                        
                        // Process member capacities for this iteration
                        (capData.value || []).forEach(member => {
                            const memberName = member.teamMember?.displayName || 'Unknown';
                            const memberUniqueName = member.teamMember?.uniqueName || member.teamMember?.id || '';
                            const mapKey = `${memberName}|${teamName}`;
                            
                            let memberCapacityPerDay = 0, memberDevCapacityPerDay = 0;
                            const disciplineList = [];
                            
                            (member.activities || []).forEach(activity => {
                                const cap = activity.capacityPerDay || 0;
                                memberCapacityPerDay += cap;
                                if (activity.name) {
                                    disciplineList.push(activity.name);
                                    if (activity.name.toLowerCase() === 'development') memberDevCapacityPerDay += cap;
                                }
                            });
                            
                            let memberDaysOff = 0;
                            (member.daysOff || []).forEach(dayOff => {
                                if (dayOff.start && dayOff.end) {
                                    const offStart = new Date(dayOff.start);
                                    const offEnd = new Date(dayOff.end);
                                    for (let d = new Date(offStart); d <= offEnd; d.setDate(d.getDate() + 1)) {
                                        if (d.getDay() !== 0 && d.getDay() !== 6 && d >= iterStart && d <= iterEnd) {
                                            memberDaysOff++;
                                        }
                                    }
                                }
                            });
                            
                            const memberWorkDays = Math.max(0, iterWorkDays - memberDaysOff);
                            const memberTotalCapacity = memberCapacityPerDay * memberWorkDays;
                            const memberDevTotalCapacity = memberDevCapacityPerDay * memberWorkDays;
                            
                            if (memberCapMap[mapKey]) {
                                // Aggregate across iterations
                                memberCapMap[mapKey].daysOff += memberDaysOff;
                                memberCapMap[mapKey].workDays += memberWorkDays;
                                memberCapMap[mapKey].totalCapacity += memberTotalCapacity;
                                memberCapMap[mapKey].devTotalCapacity += memberDevTotalCapacity;
                                totalMemberDaysOff += memberDaysOff;
                            } else {
                                totalMemberDaysOff += memberDaysOff;
                                memberCapMap[mapKey] = {
                                    name: memberName, uniqueName: memberUniqueName, discipline: disciplineList.join(', ') || '-',
                                    team: teamName, project: projName,
                                    capacityPerDay: memberCapacityPerDay, devCapacityPerDay: memberDevCapacityPerDay,
                                    daysOff: memberDaysOff, workDays: memberWorkDays,
                                    totalCapacity: memberTotalCapacity, devTotalCapacity: memberDevTotalCapacity
                                };
                            }
                        });
                    });
                    
                    // Convert map to array and calculate totals
                    memberCapacities = Object.values(memberCapMap);
                    teamCapacity = memberCapacities.reduce((sum, m) => sum + m.totalCapacity, 0);
                    sprintWorkDays = Math.max(0, sprintCalendarDays - teamDaysOffCount);
                    
                } catch (e) { }
                
                // Calculate capacities
                const totalPlannedCapacity = tasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                const uiUxUdHours = uiUxUdData.totalOrigEst;
                const availableCapacity = Math.max(0, teamCapacity - almEngExtraHours - uiUxUdHours);
                const overPlannedCapacity = totalPlannedCapacity - almEngExtraHours - uiUxUdHours;
                const overPlanPct = availableCapacity > 0 ? ((overPlannedCapacity - availableCapacity) / availableCapacity) * 100 : (overPlannedCapacity > 0 ? 100 : 0);
                
                // Development Only calculations
                const devTeamCapacity = memberCapacities.reduce((sum, m) => sum + (m.devTotalCapacity || 0), 0);
                const devMemberCount = memberCapacities.filter(m => m.devCapacityPerDay > 0).length;
                
                // Filter Development tasks (Discipline = Development)
                const devTasks = tasks.filter(t => t.fields['Microsoft.VSTS.Common.Discipline'] === 'Development');
                
                const devTaskCount = devTasks.length;
                const devTotalPlanned = devTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                
                // Group unclassified requirements by first word of title + separate Adhoc Support
                const devCategoryBreakdown = {};
                let devUnclassifiedTotal = 0;
                
                // Process unclassified requirements (not deliverable, not non-deliverable)
                requirements.filter(r => r.category === 'unclassified').forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => {
                        return t && t.fields['Microsoft.VSTS.Common.Discipline'] === 'Development';
                    });
                    
                    const taskHours = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    
                    if (taskHours > 0) {
                        let categoryKey;
                        if (req.isAdhocSupport) {
                            categoryKey = 'Adhoc Support';
                        } else {
                            // Get first word of requirement title
                            const reqTitle = req.fields['System.Title'] || '';
                            categoryKey = reqTitle.split(/[\s\-:]+/)[0] || 'Other';
                        }
                        
                        if (!devCategoryBreakdown[categoryKey]) {
                            devCategoryBreakdown[categoryKey] = { hours: 0, taskCount: 0, reqCount: 0 };
                        }
                        devCategoryBreakdown[categoryKey].hours += taskHours;
                        devCategoryBreakdown[categoryKey].taskCount += childTasks.length;
                        devCategoryBreakdown[categoryKey].reqCount++;
                        devUnclassifiedTotal += taskHours;
                    }
                });
                
                const devAvailableCapacity = Math.max(0, devTeamCapacity - devUnclassifiedTotal);
                const devPlannedCapacity = devTotalPlanned - devUnclassifiedTotal;
                const devOverPlanPct = devAvailableCapacity > 0 ? ((devPlannedCapacity - devAvailableCapacity) / devAvailableCapacity) * 100 : (devPlannedCapacity > 0 ? 100 : 0);
                
                // Store sprint start date for later use
                storedSprintStartDate = sprintStartDate;
                storedSprintEndDate = sprintEndDate;
                
                // Store capacity data
                capacityData = {
                    teamCapacity: Math.round(teamCapacity * 100) / 100,
                    totalPlannedCapacity: Math.round(totalPlannedCapacity * 100) / 100,
                    almEngExtraHours: Math.round(almEngExtraHours * 100) / 100,
                    uiUxUdHours: Math.round(uiUxUdHours * 100) / 100,
                    availableCapacity: Math.round(availableCapacity * 100) / 100,
                    overPlannedCapacity: Math.round(overPlannedCapacity * 100) / 100,
                    overPlanPct: Math.round(overPlanPct * 100) / 100,
                    devTeamCapacity: Math.round(devTeamCapacity * 100) / 100,
                    devMemberCount, devTaskCount,
                    devTotalPlanned: Math.round(devTotalPlanned * 100) / 100,
                    devCategoryBreakdown,
                    devUnclassifiedTotal: Math.round(devUnclassifiedTotal * 100) / 100,
                    devAvailableCapacity: Math.round(devAvailableCapacity * 100) / 100,
                    devPlannedCapacity: Math.round(devPlannedCapacity * 100) / 100,
                    devOverPlanPct: Math.round(devOverPlanPct * 100) / 100,
                    sprintCalendarDays, teamDaysOff: teamDaysOffCount, teamDaysOffDates,
                    memberDaysOff: totalMemberDaysOff, sprintWorkDays, members: memberCapacities
                };
                
                hideLoading();
                renderContent();
                
            } catch (err) {
                hideLoading();
                document.getElementById('filterPanel').classList.add('visible');
                showError(err.message);
            }
        }

        function renderContent() {
            document.getElementById('content').classList.add('visible');
            document.getElementById('hdrArea').textContent = sprintInfo.areaName;
            document.getElementById('hdrSprint').textContent = sprintInfo.name;

            const delReqs = requirements.filter(r => r.category === 'deliverable');
            const nonDelReqs = requirements.filter(r => r.category === 'nonDeliverable');
            const blankDescReqs = requirements.filter(r => !r.hasDescription);
            const overEstTasks = tasks.filter(t => (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0) > 40);
            
            // Filter for blank/0 Size - Only Deliverable/Non-Deliverable Requirements and Change Requests with Size = 0 or blank
            const blankSizeReqs = requirements.filter(r => {
                // Must be Deliverable or Non-Deliverable
                if (r.category !== 'deliverable' && r.category !== 'nonDeliverable') return false;
                // Must be Requirement or Change Request work item type
                const workItemType = r.fields['System.WorkItemType'] || '';
                if (workItemType !== 'Requirement' && workItemType !== 'Change Request') return false;
                // Size must be 0, blank, null or undefined
                const size = r.fields['Microsoft.VSTS.Scheduling.Size'];
                return size === undefined || size === null || size === '' || size === 0 || Number(size) === 0;
            });

            const stats = {
                total: delReqs.length + nonDelReqs.length, deliverable: delReqs.length, nonDeliverable: nonDelReqs.length,
                delSize: delReqs.reduce((s, r) => s + r.size, 0),
                nonDelSize: nonDelReqs.reduce((s, r) => s + r.size, 0),
                blankSize: blankSizeReqs.length,
                bugs: bugs.length,
                urnIn: requirements.filter(r => r.urnTag === 'urnIn').length,
                urnCf: requirements.filter(r => r.urnTag === 'urnCf').length,
                blankDesc: blankDescReqs.length
            };

            // Summary stats
            document.getElementById('statTotalReq').textContent = stats.total;
            document.getElementById('statDeliverable').textContent = stats.deliverable;
            document.getElementById('statNonDeliverable').textContent = stats.nonDeliverable;
            document.getElementById('statBugs').textContent = stats.bugs;
            document.getElementById('statUrnIn').textContent = stats.urnIn;
            document.getElementById('statUrnCf').textContent = stats.urnCf;
            document.getElementById('statBlankDesc').textContent = stats.blankDesc;
            
            // Render Blank Size table
            renderBlankSizeData(blankSizeReqs);

            // Chart summaries
            document.getElementById('chartDelSize').textContent = stats.delSize.toFixed(2);
            document.getElementById('chartNonDelSize').textContent = stats.nonDelSize.toFixed(2);
            document.getElementById('chartTotalSize').textContent = (stats.delSize + stats.nonDelSize).toFixed(2);
            document.getElementById('chartDelTaskEst').textContent = fmtH(taskEstByCategory.deliverableEst) + 'h';
            document.getElementById('chartNonDelTaskEst').textContent = fmtH(taskEstByCategory.nonDeliverableEst) + 'h';
            document.getElementById('chartTotalTaskEst').textContent = fmtH(taskEstByCategory.deliverableEst + taskEstByCategory.nonDeliverableEst) + 'h';

            // Update CSS doughnut charts
            updateDoughnut('sizeChart', stats.delSize, stats.nonDelSize, '#3b82f6', '#a855f7', 'chartSizePct');
            updateDoughnut('taskEstChart', taskEstByCategory.deliverableEst, taskEstByCategory.nonDeliverableEst, '#06b6d4', '#ec4899', 'chartTaskEstPct');

            // Ratio bars - Deliverable by Size
            const classifiedSize = stats.delSize + stats.nonDelSize || 1;
            const delPct = ((stats.delSize / classifiedSize) * 100).toFixed(2);
            const nonDelPct = ((stats.nonDelSize / classifiedSize) * 100).toFixed(2);
            document.getElementById('lblDelSize').textContent = stats.delSize.toFixed(2);
            document.getElementById('lblNonDelSize').textContent = stats.nonDelSize.toFixed(2);
            document.getElementById('lblDelPct').textContent = delPct + '%';
            document.getElementById('lblNonDelPct').textContent = nonDelPct + '%';
            document.getElementById('barDel').style.width = delPct + '%';
            document.getElementById('barDel').textContent = parseFloat(delPct) > 8 ? delPct + '%' : '';
            document.getElementById('barNonDel').style.width = nonDelPct + '%';
            document.getElementById('barNonDel').textContent = parseFloat(nonDelPct) > 8 ? nonDelPct + '%' : '';

            // Ratio bars - Deliverable by Task Original Estimate
            const totalTaskEst = taskEstByCategory.deliverableEst + taskEstByCategory.nonDeliverableEst || 1;
            const delTaskEstPct = ((taskEstByCategory.deliverableEst / totalTaskEst) * 100).toFixed(2);
            const nonDelTaskEstPct = ((taskEstByCategory.nonDeliverableEst / totalTaskEst) * 100).toFixed(2);
            document.getElementById('lblDelTaskEst').textContent = fmtH(taskEstByCategory.deliverableEst) + 'h';
            document.getElementById('lblNonDelTaskEst').textContent = fmtH(taskEstByCategory.nonDeliverableEst) + 'h';
            document.getElementById('lblDelTaskEstPct').textContent = delTaskEstPct + '%';
            document.getElementById('lblNonDelTaskEstPct').textContent = nonDelTaskEstPct + '%';
            document.getElementById('barDelTaskEst').style.width = delTaskEstPct + '%';
            document.getElementById('barDelTaskEst').textContent = parseFloat(delTaskEstPct) > 8 ? delTaskEstPct + '%' : '';
            document.getElementById('barNonDelTaskEst').style.width = nonDelTaskEstPct + '%';
            document.getElementById('barNonDelTaskEst').textContent = parseFloat(nonDelTaskEstPct) > 8 ? nonDelTaskEstPct + '%' : '';

            // Over estimate tasks
            document.getElementById('overEstTaskCount').textContent = overEstTasks.length;
            const overEstBody = document.querySelector('#overEstTasksTable tbody');
            if (overEstTasks.length > 0) {
                document.getElementById('noOverEstTasks').style.display = 'none';
                overEstBody.innerHTML = overEstTasks.map(t => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td><td>${t.fields['System.Title'] || ''}</td><td>${t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0}</td><td>${t.fields['System.AssignedTo']?.displayName || '-'}</td></tr>`).join('');
            } else { document.getElementById('noOverEstTasks').style.display = 'block'; overEstBody.innerHTML = ''; }

            // Blank description
            document.getElementById('blankDescCount').textContent = blankDescReqs.length;
            document.getElementById('blankSizeCount').textContent = stats.blankSize;
            const blankDescBody = document.querySelector('#blankDescTable tbody');
            if (blankDescReqs.length > 0) {
                document.getElementById('noBlankDesc').style.display = 'none';
                blankDescBody.innerHTML = blankDescReqs.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td></tr>`).join('');
            } else { document.getElementById('noBlankDesc').style.display = 'block'; blankDescBody.innerHTML = ''; }

            // Bugs - Enhanced with filtering and member-wise count
            window.allBugs = bugs; // Store globally for filtering
            window.currentBugFilter = 'all';
            
            // Calculate tag counts
            const csTagBugs = bugs.filter(b => {
                const tags = (b.fields['System.Tags'] || '').toLowerCase();
                return tags.includes('cs');
            });
            const productionBugs = bugs.filter(b => {
                const tags = (b.fields['System.Tags'] || '').toLowerCase();
                return tags.includes('production_bug') || tags.includes('production bug');
            });
            
            document.getElementById('bugCount').textContent = bugs.length;
            document.getElementById('bugTotalCount').textContent = bugs.length;
            document.getElementById('bugClosedCount').textContent = bugs.filter(b => b.fields['System.State'] === 'Closed').length;
            document.getElementById('bugActiveCount').textContent = bugs.filter(b => ['Active', 'Open', 'New'].includes(b.fields['System.State'])).length;
            document.getElementById('bugResolvedCount').textContent = bugs.filter(b => b.fields['System.State'] === 'Resolved').length;
            document.getElementById('bugCSCount').textContent = csTagBugs.length;
            document.getElementById('bugProductionCount').textContent = productionBugs.length;
            
            // Render bugs table
            renderBugsTable('all');

            // Sprint Goal
            renderDashboard('sprintGoal', sprintGoalData);
            
            // TEAM B - Display Size in the summary
            document.getElementById('teamBReqCount').textContent = teamBData.requirements.length;
            document.getElementById('teamBTaskCount').textContent = teamBData.totalTasks;
            document.getElementById('teamBTotalSize').textContent = teamBData.totalSize;
            document.getElementById('teamBTotalOrigEst').textContent = fmtH(teamBData.totalOrigEst) + 'h';
            document.getElementById('teamBTotalRemWork').textContent = fmtH(teamBData.totalRemWork) + 'h';
            const teamBBody = document.querySelector('#teamBReqTable tbody');
            if (teamBData.requirements.length > 0) {
                document.getElementById('noTeamBData').style.display = 'none';
                teamBBody.innerHTML = teamBData.requirements.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td><td style="text-align:center;">${r.taskCount}</td><td style="text-align:center;color:#c084fc;">${r.size || 0}</td><td style="text-align:center;color:#fbbf24;">${fmtH(r.originalEstimate)}h</td><td style="text-align:center;color:#22d3ee;">${fmtH(r.remainingWork)}h</td></tr>`).join('');
            } else { document.getElementById('noTeamBData').style.display = 'block'; teamBBody.innerHTML = ''; }

            // ========== DATA QUALITY DASHBOARDS ==========
            try {
                // Filter for Deliverable and Non-Deliverable requirements only
                const classifiedReqs = requirements.filter(r => r.category === 'deliverable' || r.category === 'nonDeliverable');
                
                // 1. Blank/0 Size Dashboard - show if Size is blank or 0 (Only Requirement and Change Request)
                const blankSizeReqs = classifiedReqs.filter(r => {
                    // Must be Requirement or Change Request work item type
                    const workItemType = r.fields ? r.fields['System.WorkItemType'] : '';
                    if (workItemType !== 'Requirement' && workItemType !== 'Change Request') return false;
                    // Size must be 0, blank, null or undefined
                    const size = r.fields ? r.fields['Microsoft.VSTS.Scheduling.Size'] : undefined;
                    return size === undefined || size === null || size === '' || size === 0 || Number(size) === 0;
                });
                document.getElementById('blankSizeCount').textContent = blankSizeReqs.length;
                const blankSizeBody = document.getElementById('blankSizeTableBody');
                if (blankSizeReqs.length > 0) {
                    document.getElementById('noBlankSizeData').style.display = 'none';
                    blankSizeBody.innerHTML = blankSizeReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankSizeData').style.display = 'block'; blankSizeBody.innerHTML = ''; }

                // 2. Blank Release Notes Dashboard
                const blankReleaseNoteReqs = classifiedReqs.filter(r => {
                    const releaseNote = r.fields ? r.fields['Casepoint.TFS.CustomFields.ReleaseNotes'] : undefined;
                    return releaseNote === undefined || releaseNote === null || releaseNote === '' || (typeof releaseNote === 'string' && releaseNote.trim() === '');
                });
                document.getElementById('blankReleaseNoteCount').textContent = blankReleaseNoteReqs.length;
                const blankReleaseNoteBody = document.getElementById('blankReleaseNoteTableBody');
                if (blankReleaseNoteReqs.length > 0) {
                    document.getElementById('noBlankReleaseNoteData').style.display = 'none';
                    blankReleaseNoteBody.innerHTML = blankReleaseNoteReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        const state = r.fields ? (r.fields['System.State'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${state}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankReleaseNoteData').style.display = 'block'; blankReleaseNoteBody.innerHTML = ''; }

                // 3. No Parent Dashboard
                const noParentReqs = classifiedReqs.filter(r => !r.hasParent);
                document.getElementById('blankParentCount').textContent = noParentReqs.length;
                const blankParentBody = document.getElementById('blankParentTableBody');
                if (noParentReqs.length > 0) {
                    document.getElementById('noBlankParentData').style.display = 'none';
                    blankParentBody.innerHTML = noParentReqs.map(r => {
                        const cat = r.category === 'deliverable' ? 'Del' : 'Non-Del';
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td style="color:#c4b5fd;">${cat}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankParentData').style.display = 'block'; blankParentBody.innerHTML = ''; }
            } catch (err) {
                console.error('Data Quality Dashboard Error:', err);
            }

            // Capacity stats
            renderCapacityStats();
            
            // Reset lazy-loaded sections
            document.getElementById('reqListContent').style.display = 'none';
            document.getElementById('loadReqListBtn').textContent = '📋 Show';
            reqListLoaded = false;
            document.getElementById('membersCapacityContent').style.display = 'none';
            document.getElementById('loadMembersCapBtn').textContent = '📋 Show';
            membersCapacityLoaded = false;
            membersCapSortField = 'name';
            membersCapSortDir = 'asc';
            // Reset Weekly Progress
            document.getElementById('weeklyProgressContent').style.display = 'none';
            document.getElementById('loadWeeklyBtn').textContent = '📊 Show';
            document.getElementById('loadWeeklyBtn').style.background = '';
            document.getElementById('loadWeeklyBtn').style.borderColor = '';
            weeklyProgressLoaded = false;
            weeklyIterFilter = 'all';
            // weeklyDataByIteration is rebuilt in loadData() - don't clear it here
            const weeklyIterFilterEl = document.getElementById('weeklyIterationFilter');
            if (weeklyIterFilterEl) { weeklyIterFilterEl.value = 'all'; }
            // Reset AI Adoption Data
            document.getElementById('aiAdoptionContent').style.display = 'none';
            const aiBtn = document.getElementById('loadAIAdoptionBtn');
            aiBtn.textContent = '📊 Show';
            aiBtn.style.display = 'inline-block';
            aiBtn.style.background = '';
            aiBtn.style.borderColor = '';
            document.getElementById('exportAIAdoptionBtn').style.display = 'none';
            document.getElementById('exportAIAdoptionPdfBtn').style.display = 'none';
            aiAdoptionDataLoaded = false;
            aiAdoptionMemberData = [];
            aiAdoptionSortField = 'name';
            aiAdoptionSortDir = 'asc';
            aiAdoptionAreaFilter = 'All';
            aiAdoptionWeekFilter = 'All';
            aiAdoptionGrandTotals = {};
            areaSummaryData = [];
            areaSortField = 'area';
            areaSortDir = 'asc';
            // Reset Dev Area-wise & Project-wise Summary sections
            const devAreaSection = document.getElementById('areaSummarySection');
            if (devAreaSection) { devAreaSection.style.display = 'none'; }
            const devAreaBody = document.getElementById('areaSummaryBody');
            if (devAreaBody) devAreaBody.innerHTML = '';
            const devAreaHead = document.getElementById('areaSummaryHead');
            if (devAreaHead) devAreaHead.innerHTML = '';
            const devProjectSection = document.getElementById('projectSummarySection');
            if (devProjectSection) { devProjectSection.style.display = 'none'; }
            const devProjectBody = document.getElementById('projectSummaryBody');
            if (devProjectBody) devProjectBody.innerHTML = '';
            const devProjectHead = document.getElementById('projectSummaryHead');
            if (devProjectHead) devProjectHead.innerHTML = '';
            // Reset QA AI Adoption Data
            const qaContent = document.getElementById('qaAIAdoptionContent');
            const qaBtn = document.getElementById('loadQAAIAdoptionBtn');
            const qaExportBtn = document.getElementById('exportQAAIAdoptionBtn');
            const qaExportPdfBtn = document.getElementById('exportQAAIAdoptionPdfBtn');
            if (qaContent) qaContent.style.display = 'none';
            if (qaBtn) {
                qaBtn.textContent = '📊 Show';
                qaBtn.style.background = '';
                qaBtn.style.borderColor = '';
            }
            if (qaExportBtn) qaExportBtn.style.display = 'none';
            if (qaExportPdfBtn) qaExportPdfBtn.style.display = 'none';
            qaAIAdoptionDataLoaded = false;
            qaAIAdoptionMemberData = [];
            qaAIAdoptionSortField = 'name';
            qaAIAdoptionSortDir = 'asc';
            qaAIAdoptionGrandTotals = {};
            // Reset QA Area-wise & Project-wise Summary sections
            const qaAreaSection = document.getElementById('qaAreaSummarySection');
            if (qaAreaSection) { qaAreaSection.style.display = 'none'; }
            const qaAreaBody = document.getElementById('qaAreaSummaryBody');
            if (qaAreaBody) qaAreaBody.innerHTML = '';
            const qaAreaHead = document.getElementById('qaAreaSummaryHead');
            if (qaAreaHead) qaAreaHead.innerHTML = '';
            const qaProjectSection = document.getElementById('qaProjectSummarySection');
            if (qaProjectSection) { qaProjectSection.style.display = 'none'; }
            const qaProjectBody = document.getElementById('qaProjectSummaryBody');
            if (qaProjectBody) qaProjectBody.innerHTML = '';
            const qaProjectHead = document.getElementById('qaProjectSummaryHead');
            if (qaProjectHead) qaProjectHead.innerHTML = '';
            // Reset Discipline Mismatch Data
            const mismatchContent = document.getElementById('mismatchContent');
            const toggleMismatchBtn = document.getElementById('toggleMismatchBtn');
            const mismatchTableBody = document.getElementById('mismatchTableBody');
            const noMismatchData = document.getElementById('noMismatchData');
            if (mismatchContent) mismatchContent.style.display = 'none';
            if (toggleMismatchBtn) { toggleMismatchBtn.textContent = '📋 Show'; toggleMismatchBtn.style.background = ''; toggleMismatchBtn.style.borderColor = ''; }
            if (document.getElementById('exportMismatchExcelBtn')) document.getElementById('exportMismatchExcelBtn').style.display = 'none';
            if (document.getElementById('exportMismatchPdfBtn')) document.getElementById('exportMismatchPdfBtn').style.display = 'none';
            
            if (mismatchTableBody) mismatchTableBody.innerHTML = '';
            if (noMismatchData) noMismatchData.style.display = 'none';
            mismatchDataLoaded = false;
            mismatchAllData = [];
            mismatchSortField = 'id';
            mismatchSortDir = 'asc';
            // Reset Overall AI Adoption Data
            const overallContent = document.getElementById('overallAIAdoptionContent');
            const overallBtn = document.getElementById('loadOverallAIAdoptionBtn');
            const overallExportBtn = document.getElementById('exportOverallAIAdoptionBtn');
            if (overallContent) overallContent.style.display = 'none';
            if (overallBtn) overallBtn.textContent = '📊 Show';
            if (overallExportBtn) overallExportBtn.style.display = 'none';
            overallAIAdoptionDataLoaded = false;
            overallAIDisciplineData = [];
            overallAIGrandTotal = {};
            overallAISortField = 'discipline';
            overallAISortDir = 'asc';
            // Reset TaskExecutionType AI Adoption Data
            const execTypeContent = document.getElementById('execTypeAIAdoptionContent');
            const execTypeBtn = document.getElementById('loadExecTypeAIAdoptionBtn');
            const execTypeExportBtn = document.getElementById('exportExecTypeAIAdoptionBtn');
            if (execTypeContent) execTypeContent.style.display = 'none';
            if (execTypeBtn) execTypeBtn.textContent = '📊 Show';
            if (execTypeExportBtn) execTypeExportBtn.style.display = 'none';
            execTypeAIAdoptionDataLoaded = false;
            execTypeData = [];
            execTypeSortField = 'execType';
            execTypeSortDir = 'asc';
            execTypeGrandTotals = {};
            // Reset Project-wise AI Adoption Data
            const projectAIContent = document.getElementById('projectAIAdoptionContent');
            const projectAIBtn = document.getElementById('loadProjectAIAdoptionBtn');
            if (projectAIContent) projectAIContent.style.display = 'none';
            if (projectAIBtn) projectAIBtn.textContent = '📊 Show';
            projectAIAdoptionDataLoaded = false;
            projectAIData = [];
            projectAISortField = 'project';
            projectAISortDir = 'asc';
            // Reset Overall AI Adoption Summary
            const oasContent = document.getElementById('overallAISummaryContent');
            const oasBtn = document.getElementById('loadOverallSummaryBtn');
            if (oasContent) oasContent.style.display = 'none';
            if (oasBtn) {
                oasBtn.textContent = '📊 Show';
                oasBtn.style.background = '';
                oasBtn.style.borderColor = '';
            }
            overallAISummaryLoaded = false;
            // Reset Dev Overall AI Adoption Summary
            const devOasContent = document.getElementById('devOverallAISummaryContent');
            const devOasBtn = document.getElementById('loadDevOverallSummaryBtn');
            if (devOasContent) devOasContent.style.display = 'none';
            if (devOasBtn) {
                devOasBtn.textContent = '📊 Show';
                devOasBtn.style.background = '';
                devOasBtn.style.borderColor = '';
            }
            devOverallAISummaryLoaded = false;
            // Reset QA Overall AI Adoption Summary
            const qaOasContent = document.getElementById('qaOverallAISummaryContent');
            const qaOasBtn = document.getElementById('loadQAOverallSummaryBtn');
            if (qaOasContent) qaOasContent.style.display = 'none';
            if (qaOasBtn) {
                qaOasBtn.textContent = '📊 Show';
                qaOasBtn.style.background = '';
                qaOasBtn.style.borderColor = '';
            }
            qaOverallAISummaryLoaded = false;
            // Reset Discipline Verification Data
            const dvContent = document.getElementById('disciplineVerifyContent');
            const dvBtn = document.getElementById('loadDisciplineVerifyBtn');
            const dvExportBtn = document.getElementById('exportDisciplineVerifyBtn');
            if (dvContent) dvContent.style.display = 'none';
            if (dvBtn) {
                dvBtn.textContent = '📊 Show';
                dvBtn.style.background = '';
                dvBtn.style.borderColor = '';
            }
            if (dvExportBtn) dvExportBtn.style.display = 'none';
            const dvExportPdfBtn = document.getElementById('exportDisciplineVerifyPdfBtn');
            if (dvExportPdfBtn) dvExportPdfBtn.style.display = 'none';
            dvDataLoaded = false;
            dvAllTaskData = [];
            dvSortField = 'assignedTo';
            dvSortDir = 'asc';
            // Auto-load Tag Missing data (no button needed)
            renderTagMissingTasks();
            // Auto-load Last Sprint Open Items
            loadLastSprintOpenItems();
            // Auto-load Blank Discipline data (no button needed)
            renderBlankDisciplineTasks();
            // Discipline Mismatch data will be loaded on demand in Tab 2
            // Reset Feature Progress data (Tab 5 - loaded on demand)
            featureProgressDataLoaded = false;
            featureProgressData = [];
            featureSortColumn = null;
            featureSortDirection = 'asc';
            fpSelectedIds = new Set();
            activeFeatureFilters = { iterations: [], states: [], statuses: [] };
            if (document.getElementById('featureProgressContent')) document.getElementById('featureProgressContent').style.display = 'none';
            if (document.getElementById('toggleFeatureProgressBtn')) document.getElementById('toggleFeatureProgressBtn').textContent = '📊 Show';
            if (document.getElementById('updateFeatureHoursBtn')) document.getElementById('updateFeatureHoursBtn').style.display = 'none';
            // Reset Affected Area data
            affectedAreaDataLoaded = false;
            affectedAreaData = [];
            affectedAreaSortCol = null;
            affectedAreaSortDir = 'asc';
            if (document.getElementById('affectedAreaContent')) document.getElementById('affectedAreaContent').style.display = 'none';
            if (document.getElementById('toggleAffectedAreaBtn')) document.getElementById('toggleAffectedAreaBtn').textContent = '📊 Show';
            if (document.getElementById('affectedAreaCount')) document.getElementById('affectedAreaCount').textContent = '0';
            // Reset Weekly Task Breakdown (Tab 7)
            wbDataLoaded = false;
            wbAllTasks = [];
            wbWeekFilter = 'All';
            wbAiDiscFilter = 'All'; wbManualDiscFilter = 'All';
            wbAiSortField = 'id'; wbAiSortDir = 'asc';
            wbManualSortField = 'id'; wbManualSortDir = 'asc';
            if (document.getElementById('weeklyBreakdownContent')) document.getElementById('weeklyBreakdownContent').style.display = 'none';
            if (document.getElementById('loadWeeklyBreakdownBtn')) document.getElementById('loadWeeklyBreakdownBtn').textContent = '📊 Show';
        }

        function updateDoughnut(elementId, value1, value2, color1, color2, pctElementId) {
            const total = value1 + value2;
            const pct1 = total > 0 ? (value1 / total) * 100 : 0;
            const deg1 = (pct1 / 100) * 360;
            const element = document.getElementById(elementId);
            if (element) element.style.background = `conic-gradient(${color1} 0deg ${deg1}deg, ${color2} ${deg1}deg 360deg)`;
            const pctElement = document.getElementById(pctElementId);
            if (pctElement) pctElement.textContent = pct1.toFixed(2) + '%';
        }

        function renderDashboard(prefix, data) {
            document.getElementById(`${prefix}ReqCount`).textContent = data.requirements.length;
            document.getElementById(`${prefix}TaskCount`).textContent = data.totalTasks;
            document.getElementById(`${prefix}OriginalEst`).textContent = fmtH(data.totalOrigEst) + 'h';
            document.getElementById(`${prefix}RemainingWork`).textContent = fmtH(data.totalRemWork) + 'h';
            document.getElementById(`${prefix}CompletedWork`).textContent = fmtH(data.totalCompWork) + 'h';
            updateProgressBar(prefix, data.totalCompWork, data.totalRemWork);
            
            const tbody = document.querySelector(`#${prefix}ReqTable tbody`);
            if (data.requirements.length > 0) {
                document.getElementById(`no${prefix.charAt(0).toUpperCase() + prefix.slice(1)}Data`).style.display = 'none';
                tbody.innerHTML = data.requirements.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td><td>${r.taskCount}</td><td>${fmtH(r.originalEstimate)}</td><td>${fmtH(r.remainingWork)}</td><td>${fmtH(r.completedWork)}</td></tr>`).join('');
            } else {
                document.getElementById(`no${prefix.charAt(0).toUpperCase() + prefix.slice(1)}Data`).style.display = 'block';
                tbody.innerHTML = '';
            }
        }

        function updateProgressBar(prefix, completed, remaining) {
            const total = completed + remaining || 1;
            const compPct = ((completed / total) * 100).toFixed(1);
            const remPct = ((remaining / total) * 100).toFixed(1);
            document.getElementById(`${prefix}CompPct`).textContent = compPct + '%';
            document.getElementById(`${prefix}RemPct`).textContent = remPct + '%';
            document.getElementById(`${prefix}BarComp`).style.width = compPct + '%';
            document.getElementById(`${prefix}BarComp`).textContent = parseFloat(compPct) > 8 ? compPct + '%' : '';
            document.getElementById(`${prefix}BarRem`).style.width = remPct + '%';
            document.getElementById(`${prefix}BarRem`).textContent = parseFloat(remPct) > 8 ? remPct + '%' : '';
        }

        function renderCapacityStats() {
            const c = capacityData;
            document.getElementById('sprintCalendarDays').textContent = c.sprintCalendarDays;
            document.getElementById('teamDaysOff').textContent = c.teamDaysOff;
            document.getElementById('sprintWorkDays').textContent = c.sprintWorkDays;
            
            if (c.teamDaysOffDates.length > 0) {
                document.getElementById('teamDaysOffDetails').style.display = 'inline';
                document.getElementById('teamDaysOffDatesList').textContent = c.teamDaysOffDates.join(', ');
            } else {
                document.getElementById('teamDaysOffDetails').style.display = 'none';
            }
            
            document.getElementById('memberCount').textContent = c.members.length;
            document.getElementById('teamCapacity').textContent = fmtH(c.teamCapacity) + 'h';
            document.getElementById('totalPlannedCapacity').textContent = fmtH(c.totalPlannedCapacity) + 'h';
            document.getElementById('almEngExtraHours').textContent = fmtH(c.almEngExtraHours) + 'h';
            document.getElementById('uiUxUdHours').textContent = fmtH(c.uiUxUdHours) + 'h';
            document.getElementById('availableCapacity').textContent = fmtH(c.availableCapacity) + 'h';
            document.getElementById('overPlannedCapacity').textContent = fmtH(c.overPlannedCapacity) + 'h';
            document.getElementById('overPlanPct').textContent = c.overPlanPct.toFixed(2) + '%';
            
            // Formula display
            document.getElementById('formulaTeamCap').textContent = fmtH(c.teamCapacity);
            document.getElementById('formulaAlmEng').textContent = fmtH(c.almEngExtraHours);
            document.getElementById('formulaUiUxUd').textContent = fmtH(c.uiUxUdHours);
            document.getElementById('formulaAvailable').textContent = fmtH(c.availableCapacity);
            document.getElementById('formulaTotalPlanned').textContent = fmtH(c.totalPlannedCapacity);
            document.getElementById('formulaAlmEng2').textContent = fmtH(c.almEngExtraHours);
            document.getElementById('formulaUiUxUd2').textContent = fmtH(c.uiUxUdHours);
            document.getElementById('formulaOverPlanned').textContent = fmtH(c.overPlannedCapacity);
            
            // Show alerts based on over/under planning
            const isOverPlanned = c.overPlannedCapacity > c.availableCapacity;
            if (isOverPlanned) {
                document.getElementById('overPlanAlert').style.display = 'block';
                document.getElementById('underPlanAlert').style.display = 'none';
                document.getElementById('overPlanAlertPct').textContent = c.overPlanPct.toFixed(2) + '%';
            } else {
                document.getElementById('overPlanAlert').style.display = 'none';
                document.getElementById('underPlanAlert').style.display = 'block';
                document.getElementById('overPlanStat').style.background = 'rgba(16,185,129,0.2)';
                document.getElementById('overPlanPctStat').style.background = 'rgba(16,185,129,0.2)';
                document.getElementById('overPlanPctStat').querySelector('.value').style.color = '#34d399';
            }
            
            // Development Only stats
            document.getElementById('devTeamCapacity').textContent = fmtH(c.devTeamCapacity) + 'h';
            document.getElementById('devTotalPlanned').textContent = fmtH(c.devTotalPlanned) + 'h';
            document.getElementById('devAvailableCapacity').textContent = fmtH(c.devAvailableCapacity) + 'h';
            document.getElementById('devPlannedCapacity').textContent = fmtH(c.devPlannedCapacity) + 'h';
            document.getElementById('devOverPlanPct').textContent = c.devOverPlanPct.toFixed(2) + '%';
            document.getElementById('devMemberCount').textContent = c.devMemberCount;
            document.getElementById('devTaskCount').textContent = c.devTaskCount;
            document.getElementById('devUnclassifiedTotal').textContent = fmtH(c.devUnclassifiedTotal) + 'h';
            
            // Render dynamic category blocks
            const categoryBlocksContainer = document.getElementById('devCategoryBlocks');
            if (categoryBlocksContainer && c.devCategoryBreakdown) {
                const categories = Object.entries(c.devCategoryBreakdown);
                // Sort: Adhoc Support first, then by hours descending
                categories.sort((a, b) => {
                    if (a[0] === 'Adhoc Support') return -1;
                    if (b[0] === 'Adhoc Support') return 1;
                    return b[1].hours - a[1].hours;
                });
                
                const colors = [
                    { bg: 'rgba(245,158,11,0.2)', border: 'rgba(245,158,11,0.3)', text: '#fbbf24' },  // Adhoc Support - orange
                    { bg: 'rgba(99,102,241,0.2)', border: 'rgba(99,102,241,0.3)', text: '#818cf8' },
                    { bg: 'rgba(16,185,129,0.2)', border: 'rgba(16,185,129,0.3)', text: '#34d399' },
                    { bg: 'rgba(239,68,68,0.2)', border: 'rgba(239,68,68,0.3)', text: '#f87171' },
                    { bg: 'rgba(168,85,247,0.2)', border: 'rgba(168,85,247,0.3)', text: '#c4b5fd' },
                    { bg: 'rgba(6,182,212,0.2)', border: 'rgba(6,182,212,0.3)', text: '#22d3ee' },
                    { bg: 'rgba(236,72,153,0.2)', border: 'rgba(236,72,153,0.3)', text: '#f472b6' },
                    { bg: 'rgba(148,163,184,0.2)', border: 'rgba(148,163,184,0.3)', text: '#94a3b8' }
                ];
                
                categoryBlocksContainer.innerHTML = categories.map(([name, data], idx) => {
                    const color = name === 'Adhoc Support' ? colors[0] : colors[(idx % (colors.length - 1)) + 1];
                    const icon = name === 'Adhoc Support' ? '🎫' : '📁';
                    return `<div class="summary-stat" style="background: ${color.bg}; border-color: ${color.border}; min-width: 70px; flex: 1; padding: 6px;">
                        <div class="value" style="color: ${color.text}; font-size: 0.85rem;">${fmtH(data.hours)}h</div>
                        <div class="label" style="font-size: 0.5rem;">${icon} ${name}</div>
                        <div style="font-size: 0.45rem; color: #64748b; margin-top: 1px;">${data.taskCount} tasks</div>
                    </div>`;
                }).join('');
            }
            
            // Development Only formulas
            document.getElementById('devFormulaTeamCap').textContent = fmtH(c.devTeamCapacity);
            document.getElementById('devFormulaAlmEng').textContent = fmtH(c.devUnclassifiedTotal);
            document.getElementById('devFormulaAvailable').textContent = fmtH(c.devAvailableCapacity);
            document.getElementById('devFormulaTotalPlanned').textContent = fmtH(c.devTotalPlanned);
            document.getElementById('devFormulaAlmEng2').textContent = fmtH(c.devUnclassifiedTotal);
            document.getElementById('devFormulaPlanned').textContent = fmtH(c.devPlannedCapacity);
            document.getElementById('devFormulaOverPlanPct').textContent = c.devOverPlanPct.toFixed(2) + '%';
            
            const devStat = document.getElementById('devOverPlanPctStat');
            if (c.devOverPlanPct > 0) {
                devStat.style.background = 'rgba(239,68,68,0.2)';
                devStat.querySelector('.value').style.color = '#f87171';
            } else {
                devStat.style.background = 'rgba(16,185,129,0.2)';
                devStat.querySelector('.value').style.color = '#34d399';
            }
        }

        let membersCapacityLoaded = false;
        let membersCapSortField = 'name';
        let membersCapSortDir = 'asc';
        
        // ========== WEEKLY PROGRESS TRACKER ==========
        function toggleWeeklyProgress() {
            const btn = document.getElementById('loadWeeklyBtn');
            const content = document.getElementById('weeklyProgressContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!weeklyProgressLoaded) {
                    populateWeeklyIterationFilter();
                    renderWeeklyProgress();
                    weeklyProgressLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }
        
        function populateWeeklyIterationFilter() {
            const filterEl = document.getElementById('weeklyIterationFilter');
            filterEl.innerHTML = '<option value="all">All Iterations</option>';
            // Populate from actual data keys (requirement iteration paths) - these are guaranteed to match
            const sortedPaths = Object.keys(weeklyDataByIteration).sort();
            sortedPaths.forEach(iterPath => {
                const opt = document.createElement('option');
                opt.value = iterPath;
                opt.textContent = iterPath.split('\\').pop();
                filterEl.appendChild(opt);
            });
            // If saved filter still exists in options, restore it
            if (weeklyIterFilter !== 'all' && !sortedPaths.includes(weeklyIterFilter)) {
                weeklyIterFilter = 'all';
            }
            filterEl.value = weeklyIterFilter;
        }
        
        function onWeeklyIterationFilterChange() {
            const filterEl = document.getElementById('weeklyIterationFilter');
            weeklyIterFilter = filterEl.value;
            renderWeeklyProgress();
        }
        
        function getActiveWeeklyData() {
            if (weeklyIterFilter === 'all') return weeklyData;
            // Find matching iteration data by exact path or leaf name match
            if (weeklyDataByIteration[weeklyIterFilter]) return weeklyDataByIteration[weeklyIterFilter];
            // Fallback: try matching by leaf name
            const filterLeaf = weeklyIterFilter.split('\\').pop().toLowerCase();
            for (const [path, data] of Object.entries(weeklyDataByIteration)) {
                if (path.split('\\').pop().toLowerCase() === filterLeaf) return data;
            }
            return { week1: [], week2: [], week3: [], week4: [], noWeekTag: [] };
        }
        
        function getWeeklyIterationDates() {
            // When filtering by a specific iteration, use that iteration's dates
            if (weeklyIterFilter !== 'all') {
                const matchedIter = iterations.find(i => i.path === weeklyIterFilter);
                if (matchedIter?.attributes?.startDate) {
                    return {
                        start: new Date(matchedIter.attributes.startDate),
                        end: matchedIter.attributes.finishDate ? new Date(matchedIter.attributes.finishDate) : null
                    };
                }
                // Fallback: match by leaf name
                const filterLeaf = weeklyIterFilter.split('\\').pop().toLowerCase();
                const fallbackIter = iterations.find(i => i.path.split('\\').pop().toLowerCase() === filterLeaf);
                if (fallbackIter?.attributes?.startDate) {
                    return {
                        start: new Date(fallbackIter.attributes.startDate),
                        end: fallbackIter.attributes.finishDate ? new Date(fallbackIter.attributes.finishDate) : null
                    };
                }
            }
            // For "All" or fallback: use first selected iteration
            const selectedIteration = selectedIterationPaths.length > 0 
                ? iterations.find(i => i.path === selectedIterationPaths[0].path) 
                : null;
            if (selectedIteration?.attributes?.startDate) {
                return {
                    start: new Date(selectedIteration.attributes.startDate),
                    end: selectedIteration.attributes.finishDate ? new Date(selectedIteration.attributes.finishDate) : null
                };
            }
            return { start: null, end: null };
        }
        
        function renderWeeklyProgress() {
            const activeData = getActiveWeeklyData();
            const doneStates = ['resolved', 'closed', 'done', 'completed'];
            
            // Calculate current week of sprint using the appropriate iteration's dates
            const iterDates = getWeeklyIterationDates();
            let currentWeek = 0;
            let sprintStart = iterDates.start;
            if (sprintStart) {
                const today = new Date();
                const daysSinceStart = Math.floor((today - sprintStart) / (1000 * 60 * 60 * 24));
                currentWeek = Math.min(4, Math.max(1, Math.ceil((daysSinceStart + 1) / 7)));
            }
            
            // Total items for no-data check
            const totalAll = activeData.week1.length + activeData.week2.length + activeData.week3.length + activeData.week4.length;
            
            // Focus Items: All week items with priority/status
            const weekArrays = [activeData.week1, activeData.week2, activeData.week3, activeData.week4];
            let focusItems = [];
            
            // Add ALL week items (not just current week) for filtering
            for (let w = 0; w < 4; w++) {
                const weekItems = weekArrays[w].map(r => {
                    const isOverdue = w < currentWeek - 1 && !doneStates.includes((r.fields['System.State'] || '').toLowerCase());
                    const isCurrent = w === currentWeek - 1;
                    return { ...r, priority: isOverdue ? 'Overdue' : (isCurrent ? 'Current' : 'Scheduled'), weekNum: w + 1 };
                });
                focusItems.push(...weekItems);
            }
            
            // Store globally for filtering
            window.allFocusItems = focusItems;
            
            // Render with current filter (preserve week filter on iteration change)
            const currentFilter = window.currentFocusFilter || 'all';
            renderFocusItemsTable(currentFilter);
            
            // Show/hide no weekly data message
            if (totalAll === 0) {
                document.getElementById('noWeeklyData').style.display = 'block';
            } else {
                document.getElementById('noWeeklyData').style.display = 'none';
            }
        }
        
        // Week badge colors
        const weekBadgeStyles = {
            1: { bg: 'rgba(59,130,246,0.3)', border: 'rgba(59,130,246,0.6)', color: '#93c5fd' },
            2: { bg: 'rgba(16,185,129,0.3)', border: 'rgba(16,185,129,0.6)', color: '#6ee7b7' },
            3: { bg: 'rgba(245,158,11,0.3)', border: 'rgba(245,158,11,0.6)', color: '#fcd34d' },
            4: { bg: 'rgba(236,72,153,0.3)', border: 'rgba(236,72,153,0.6)', color: '#f9a8d4' }
        };
        
        function renderFocusItemsTable(filter) {
            const allItems = window.allFocusItems || [];
            const doneStates = ['closed', 'resolved', 'done', 'removed'];
            
            // Filter items
            let filteredItems = allItems;
            if (filter !== 'all') {
                const weekNum = parseInt(filter.replace('week', ''));
                filteredItems = allItems.filter(r => r.weekNum === weekNum);
            }
            
            // Update count
            document.getElementById('focusItemCount').textContent = filteredItems.length;
            
            // Update filter button styles
            ['all', 'week1', 'week2', 'week3', 'week4'].forEach(f => {
                const btn = document.getElementById('focusFilter' + f.charAt(0).toUpperCase() + f.slice(1));
                if (btn) {
                    if (f === filter) {
                        btn.style.opacity = '1';
                        btn.style.fontWeight = '600';
                        btn.style.boxShadow = '0 0 8px rgba(139,92,246,0.4)';
                    } else {
                        btn.style.opacity = '0.7';
                        btn.style.fontWeight = '400';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Render rows
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            const focusTableBody = document.getElementById('weekFocusTableBody');
            
            if (filteredItems.length === 0) {
                document.getElementById('noFocusItems').style.display = 'block';
                focusTableBody.innerHTML = '';
                return;
            }
            
            document.getElementById('noFocusItems').style.display = 'none';
            
            focusTableBody.innerHTML = filteredItems.map(req => {
                const state = req.fields['System.State'] || '';
                const isDone = doneStates.includes(state.toLowerCase());
                const stateColor = isDone ? '#10b981' : (state.toLowerCase() === 'active' ? '#60a5fa' : '#f59e0b');
                
                // Week badge with attractive styling
                const weekStyle = weekBadgeStyles[req.weekNum] || weekBadgeStyles[1];
                const weekBadge = `<span style="background:${weekStyle.bg};border:1px solid ${weekStyle.border};color:${weekStyle.color};padding:4px 12px;border-radius:6px;font-size:0.72rem;font-weight:600;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.2);">Week ${req.weekNum}</span>`;
                
                // Progress calculation
                const origEst = req.taskEstimate || 0;
                const completed = req.taskCompletedWork || 0;
                const progress = origEst > 0 ? Math.round((completed / origEst) * 100) : 0;
                const progressColor = progress >= 80 ? '#10b981' : (progress >= 50 ? '#fbbf24' : '#f472b6');
                const progressBar = `
                    <div style="display:flex;align-items:center;gap:6px;">
                        <div style="flex:1;height:8px;background:rgba(0,0,0,0.4);border-radius:4px;overflow:hidden;min-">
                            <div style="height:100%;background:linear-gradient(90deg, ${progressColor}, ${progressColor}dd);width:${progress}%;transition:width 0.3s;border-radius:4px;"></div>
                        </div>
                        <span style="color:${progressColor};font-weight:700;font-size:0.8rem;min-">${progress}%</span>
                    </div>`;
                
                // Get assigned member (first name only for space)
                const assignedTo = req.fields['System.AssignedTo']?.displayName || '-';
                const assignedFirstName = assignedTo !== '-' ? assignedTo.split(' ')[0] : '-';
                
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${req.id}" target="_blank" class="wi-link">${req.id}</a></td>
                    <td style="${tdStyle}">${req.fields['System.Title'] || ''}</td>
                    <td style="${tdStyle}color:${stateColor};font-weight:500;">${state}</td>
                    <td style="${tdStyle}text-align:center;">${weekBadge}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;font-weight:600;">${fmtH(origEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#f472b6;font-weight:500;">${fmtH(req.taskRemainingWork || 0)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;font-weight:500;">${fmtH(completed)}h</td>
                    <td style="${tdStyle}">${progressBar}</td>
                    <td style="${tdStyle}color:#a5b4fc;font-size:0.72rem;" title="${assignedTo}">${assignedFirstName}</td>
                </tr>`;
            }).join('');
        }
        
        function filterFocusItems(filter) {
            window.currentFocusFilter = filter;
            renderFocusItemsTable(filter);
        }
        
        function toggleMembersCapacity() {
            const btn = document.getElementById('loadMembersCapBtn');
            const content = document.getElementById('membersCapacityContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!membersCapacityLoaded) {
                    renderMembersCapacityTable();
                    membersCapacityLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📋 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }
        
        function renderMembersCapacityTable() {
            const members = capacityData.members || [];
            const thead = document.getElementById('membersCapacityTableHead');
            const tbody = document.getElementById('membersCapacityTableBody');
            
            if (members.length === 0) {
                document.getElementById('noMembersData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('noMembersData').style.display = 'none';
            
            // Sort members
            const sortedMembers = [...members].sort((a, b) => {
                let aVal, bVal;
                switch (membersCapSortField) {
                    case 'name': aVal = (a.name || '').toLowerCase(); bVal = (b.name || '').toLowerCase(); break;
                    case 'project': aVal = (a.project || '').toLowerCase(); bVal = (b.project || '').toLowerCase(); break;
                    case 'team': aVal = (a.team || '').toLowerCase(); bVal = (b.team || '').toLowerCase(); break;
                    case 'discipline': aVal = (a.discipline || '').toLowerCase(); bVal = (b.discipline || '').toLowerCase(); break;
                    case 'capPerDay': aVal = a.capacityPerDay || 0; bVal = b.capacityPerDay || 0; break;
                    case 'daysOff': aVal = a.daysOff || 0; bVal = b.daysOff || 0; break;
                    case 'workDays': aVal = a.workDays || 0; bVal = b.workDays || 0; break;
                    case 'total': aVal = a.totalCapacity || 0; bVal = b.totalCapacity || 0; break;
                    default: aVal = (a.name || '').toLowerCase(); bVal = (b.name || '').toLowerCase();
                }
                if (aVal < bVal) return membersCapSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return membersCapSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Build header with sort icons
            const sortIcon = (field) => membersCapSortField === field ? (membersCapSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            const thStyle = 'padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            const thStyleCenter = 'padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}" onclick="sortMembersCapacity('name')">Member${sortIcon('name')}</th>
                <th style="${thStyle}" onclick="sortMembersCapacity('project')">Project${sortIcon('project')}</th>
                <th style="${thStyle}" onclick="sortMembersCapacity('team')">Team${sortIcon('team')}</th>
                <th style="${thStyle}" onclick="sortMembersCapacity('discipline')">Discipline${sortIcon('discipline')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('capPerDay')">Cap/Day${sortIcon('capPerDay')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('daysOff')">Off${sortIcon('daysOff')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('workDays')">Days${sortIcon('workDays')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('total')">Total${sortIcon('total')}</th>
            </tr>`;
            
            tbody.innerHTML = sortedMembers.map(m => `<tr>
                <td style="padding:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${m.name}">${m.name}</td>
                <td style="padding:8px;color:#f472b6;font-size:0.7rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${m.project || '-'}">${m.project || '-'}</td>
                <td style="padding:8px;color:#67e8f9;font-size:0.7rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${m.team || '-'}">${m.team || '-'}</td>
                <td style="padding:8px;color:#a5b4fc;font-size:0.7rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${m.discipline || '-'}</td>
                <td style="padding:8px;text-align:center;">${fmtH(m.capacityPerDay)}h</td>
                <td style="padding:8px;text-align:center;color:${m.daysOff > 0 ? '#fbbf24' : '#94a3b8'};">${m.daysOff}</td>
                <td style="padding:8px;text-align:center;">${m.workDays}</td>
                <td style="padding:8px;text-align:center;color:#34d399;font-weight:600;">${fmtH(m.totalCapacity)}h</td>
            </tr>`).join('');
            
            // Update totals
            document.getElementById('totalCapPerDay').textContent = fmtH(members.reduce((sum, m) => sum + m.capacityPerDay, 0)) + 'h';
            document.getElementById('totalDaysOff').textContent = members.reduce((sum, m) => sum + m.daysOff, 0);
            document.getElementById('totalTeamCapacity').textContent = fmtH(capacityData.teamCapacity) + 'h';
        }
        
        function sortMembersCapacity(field) {
            if (membersCapSortField === field) {
                membersCapSortDir = membersCapSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                membersCapSortField = field;
                // Default to asc for text fields, desc for numeric
                membersCapSortDir = ['capPerDay', 'daysOff', 'workDays', 'total'].includes(field) ? 'desc' : 'asc';
            }
            renderMembersCapacityTable();
        }

        // ========== TAB SWITCHING ==========
        // ===== CARD LOADING HELPERS =====
        function showCardLoading(id) { const el = document.getElementById(id + 'Loading'); if (el) el.classList.add('visible'); }
        function hideCardLoading(id) { const el = document.getElementById(id + 'Loading'); if (el) el.classList.remove('visible'); }

        // ===== FEATURE PROGRESS =====
        let featureProgressDataLoaded = false;
        let featureProgressData = [];
        let featurePISprints = [];
        let featureFilters = { iterations: [], states: [], statuses: [], taskSprints: [], areaPaths: [] };
        let activeFeatureFilters = { iterations: [], states: [], statuses: [], taskSprints: [], areaPaths: [] };
        let featureSortColumn = null;
        let featureSortDirection = 'asc';

        function toggleFeatureProgressDashboard() {
            const content = document.getElementById('featureProgressContent');
            const btn = document.getElementById('toggleFeatureProgressBtn');
            const updateBtn = document.getElementById('updateFeatureHoursBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                if (updateBtn && ['admin','super_admin'].includes(currentUserRole) && featureProgressData.length > 0) {
                    updateBtn.style.display = 'inline-block';
                }
                if (!featureProgressDataLoaded) {
                    featureProgressDataLoaded = true;
                    loadFeatureProgressData();
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                if (updateBtn) updateBtn.style.display = 'none';
            }
        }

        function derivePIFromSprint(sprintPath) {
            const parts = sprintPath.split('\\');
            const sprintName = parts[parts.length - 1];
            const basePath = parts.slice(0, -1).join('\\');
            const piMatch = sprintName.match(/^((?:PI-)?\d{4}-Q\d)_(\d)$/i);
            let piName = '';
            let piSprints = [];
            if (piMatch) {
                const piPrefix = piMatch[1];
                piName = piPrefix;
                const sprintNames = [`${piPrefix}_1`, `${piPrefix}_2`, `${piPrefix}_3`];
                piSprints = sprintNames.map(name => {
                    const fullPath = basePath ? `${basePath}\\${name}` : name;
                    const found = iterations.find(iter => {
                        const iterName = iter.path.split('\\').pop();
                        return iterName === name;
                    });
                    return found ? { path: found.path, name: name } : { path: fullPath, name: name };
                });
            } else {
                piName = sprintName;
                piSprints = [{ path: sprintPath, name: sprintName }];
            }
            return { piName: piName, piPath: basePath, sprints: piSprints };
        }

        async function loadFeatureProgressData() {
            showCardLoading('featureProgress');
            try {
                const iterPath = selectedIterationPaths.length > 0 ? selectedIterationPaths[0].path : '';
                const areaPath = selectedAreaPaths.length > 0 ? selectedAreaPaths[0].path : '';

                if (!iterPath || !areaPath) {
                    document.getElementById('noFeatureProgressData').style.display = 'block';
                    document.getElementById('noFeatureProgressData').textContent = 'Please select at least one Area and Iteration.';
                    hideCardLoading('featureProgress');
                    return;
                }

                const piInfo = derivePIFromSprint(iterPath);
                featurePISprints = piInfo.sprints;

                const iterPaths = featurePISprints.map(s => s.path);

                const areaConditions = selectedAreaPaths.map(a => `[System.AreaPath] UNDER '${a.path}'`).join(' OR ');
                const iterConditions = iterPaths.map(s => `[System.IterationPath] UNDER '${s}'`).join(' OR ');
                const featureQuery = `SELECT [System.Id] FROM WorkItems WHERE [System.WorkItemType]='Feature' AND (${areaConditions}) AND (${iterConditions})`;
                const featureWiqlResp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/wiql?api-version=5.0`, {
                    method: 'POST', body: JSON.stringify({ query: featureQuery })
                });
                const featureWiqlData = await featureWiqlResp.json();
                const allFeatureIds = (featureWiqlData.workItems || []).map(w => w.id);

                let allFeatures = [];
                if (allFeatureIds.length > 0) {
                    const featureFields = [
                        'System.Id','System.WorkItemType','System.Title','System.AssignedTo',
                        'System.State','System.IterationPath','System.AreaPath','System.Tags',
                        'Casepoint.TFS.CustomFields.Status','Casepoint.TFS.CustomFields.EstimateInHours',
                        'Casepoint.TFS.CustomFields.DiscoveryEffort','Microsoft.VSTS.Scheduling.Effort',
                        'Casepoint.TFS.CustomFields.PlannedHours','Casepoint.TFS.CustomFields.ActualCompletedHours',
                        'Casepoint.TFS.CustomFields.CompletedEffort','Casepoint.TFS.CustomFields.CompletedDiscoveryHours',
                        'Microsoft.VSTS.Scheduling.PISize'
                    ];
                    const fetchedFeatures = await batchFetchWorkItems(allFeatureIds, featureFields);
                    allFeatures = fetchedFeatures.map(f => {
                        const sp = (f.fields['System.IterationPath'] || '');
                        return { ...f, sprintPath: sp, sprintName: sp.split('\\').pop() };
                    });
                }

                const uniqueFeatures = [];
                const seenIds = new Set();
                allFeatures.forEach(f => { if (!seenIds.has(f.id)) { seenIds.add(f.id); uniqueFeatures.push(f); } });

                // Fetch child work items (Feature → Requirements/Bugs → Tasks)
                const featureIds = uniqueFeatures.map(f => f.id);
                const featuresWithRel = await batchFetchWithRelations(featureIds);
                const featureChildMap = {};
                const allChildWiIds = [];
                featuresWithRel.forEach(feat => {
                    const childIds = (feat.relations || [])
                        .filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward')
                        .map(r => parseInt(r.url.split('/').pop()));
                    featureChildMap[feat.id] = childIds;
                    allChildWiIds.push(...childIds);
                });
                const uniqueChildWiIds = [...new Set(allChildWiIds)];

                // Fetch relations for child work items (Reqs/Bugs → Tasks)
                const childWiTaskMap = {};
                const allTaskIdsForFeatures = [];
                if (uniqueChildWiIds.length > 0) {
                    const batchSize = 50;
                    for (let i = 0; i < uniqueChildWiIds.length; i += batchSize) {
                        const batch = uniqueChildWiIds.slice(i, i + batchSize);
                        try {
                            const resp = await apiFetch(`${tfsUrl}/_apis/wit/workitems?ids=${batch.join(',')}&$expand=relations&api-version=5.0`);
                            if (resp.ok) {
                                const d = await resp.json();
                                (d.value || []).forEach(wi => {
                                    const taskIds = (wi.relations || [])
                                        .filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward')
                                        .map(r => parseInt(r.url.split('/').pop()));
                                    childWiTaskMap[wi.id] = taskIds;
                                    allTaskIdsForFeatures.push(...taskIds);
                                });
                            } else {
                                for (const singleId of batch) {
                                    try {
                                        const sResp = await apiFetch(`${tfsUrl}/_apis/wit/workitems?ids=${singleId}&$expand=relations&api-version=5.0`);
                                        if (sResp.ok) {
                                            const sD = await sResp.json();
                                            (sD.value || []).forEach(wi => {
                                                const taskIds = (wi.relations || []).filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward').map(r => parseInt(r.url.split('/').pop()));
                                                childWiTaskMap[wi.id] = taskIds;
                                                allTaskIdsForFeatures.push(...taskIds);
                                            });
                                        }
                                    } catch (e2) { /* skip deleted items */ }
                                }
                            }
                        } catch (e) { console.warn('[FeatureProgress] batch error:', e.message); }
                    }
                }

                const childTaskFields = ['System.Id','System.WorkItemType','Microsoft.VSTS.Scheduling.OriginalEstimate',
                    'Microsoft.VSTS.Scheduling.CompletedWork','Microsoft.VSTS.Common.Discipline',
                    'System.IterationPath','System.AreaPath','System.Reason'];
                const uniqueTaskIds = [...new Set(allTaskIdsForFeatures)];
                const allChildTasks = uniqueTaskIds.length > 0 ? await batchFetchWorkItems(uniqueTaskIds, childTaskFields) : [];
                const childTaskLookup = {};
                allChildTasks.forEach(t => { childTaskLookup[t.id] = t; });

                // Calculate task level metrics per feature
                const excludedDisciplines = ['analysis', 'user experience', 'user education'];
                const excludedDisciplinesActual = ['user experience', 'user education'];
                const includedDisciplinesPlanned = ['development', 'analysis', 'test'];
                const featureTaskPlannedMap = {}, featureTaskCompletedMap = {}, featureTaskActualCompMap = {};
                const featureTaskSprintsMap = {};
                const featureTaskAreaPathsMap = {};
                const featureRawTasksMap = {};
                const allTaskSprintNames = new Set();
                const allTaskAreaPaths = new Set();

                uniqueFeatures.forEach(f => {
                    const featureAreaPath = (f.fields['System.AreaPath'] || '').toLowerCase().trim();
                    const featureAreaPathOriginal = (f.fields['System.AreaPath'] || '').trim();
                    const childWiIds = featureChildMap[f.id] || [];
                    let totalOrigEst = 0, totalCompWork = 0, totalActualComp = 0;
                    const taskSprintsForFeature = new Set();
                    const taskAreaPathsForFeature = new Set();
                    const rawTasks = [];
                    // Include the feature's own area path
                    if (featureAreaPathOriginal) {
                        taskAreaPathsForFeature.add(featureAreaPathOriginal);
                        allTaskAreaPaths.add(featureAreaPathOriginal);
                    }
                    childWiIds.forEach(wiId => {
                        const taskIds = childWiTaskMap[wiId] || [];
                        taskIds.forEach(tid => {
                            const task = childTaskLookup[tid];
                            if (!task) return;
                            if (task.fields['System.WorkItemType'] !== 'Task') return;
                            const discipline = (task.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase().trim();
                            const iterPath = (task.fields['System.IterationPath'] || '');
                            const reason = (task.fields['System.Reason'] || '').toLowerCase().trim();
                            const taskAreaPath = (task.fields['System.AreaPath'] || '').toLowerCase().trim();
                            const taskAreaPathOriginal = (task.fields['System.AreaPath'] || '').trim();
                            const iterLeaf = iterPath.split('\\').pop().trim().toLowerCase();
                            const iterLeafOriginal = iterPath.split('\\').pop().trim();
                            const isRootIter = (iterLeaf === 'casepointara');
                            const isRejected = (reason === 'rejected');
                            const origEst = task.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                            const compWork = task.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                            // Collect task sprint name
                            if (!isRootIter && iterLeafOriginal) {
                                taskSprintsForFeature.add(iterLeafOriginal);
                                allTaskSprintNames.add(iterLeafOriginal);
                            }
                            // Collect task area path
                            if (taskAreaPathOriginal) {
                                taskAreaPathsForFeature.add(taskAreaPathOriginal);
                                allTaskAreaPaths.add(taskAreaPathOriginal);
                            }
                            // Store raw task record for dynamic recalculation
                            rawTasks.push({
                                discipline, iterLeafOriginal, taskAreaPath, taskAreaPathOriginal,
                                isRootIter, isRejected, origEst, compWork,
                                matchesFeatureArea: taskAreaPath === featureAreaPath
                            });
                            // Task Actual Completed
                            if (!excludedDisciplinesActual.includes(discipline) && !isRootIter && !isRejected) {
                                totalActualComp += compWork;
                            }
                            // Task Planned - only Development, Analysis, Test disciplines
                            if (includedDisciplinesPlanned.includes(discipline) && !isRootIter && !isRejected) {
                                totalOrigEst += origEst;
                            }
                            // Task Comp Dev
                            if (excludedDisciplines.includes(discipline)) return;
                            if (isRootIter || isRejected) return;
                            if (taskAreaPath === featureAreaPath) {
                                totalCompWork += compWork;
                            }
                        });
                    });
                    featureTaskPlannedMap[f.id] = totalOrigEst;
                    featureTaskCompletedMap[f.id] = totalCompWork;
                    featureTaskActualCompMap[f.id] = totalActualComp;
                    featureTaskSprintsMap[f.id] = [...taskSprintsForFeature];
                    featureTaskAreaPathsMap[f.id] = [...taskAreaPathsForFeature];
                    featureRawTasksMap[f.id] = rawTasks;
                });

                // Process feature data
                featureProgressData = uniqueFeatures.map(f => {
                    const discoveryEffort = f.fields['Casepoint.TFS.CustomFields.DiscoveryEffort'] || 0;
                    const compDiscoveryHours = f.fields['Casepoint.TFS.CustomFields.CompletedDiscoveryHours'] || 0;
                    const plannedHours = f.fields['Casepoint.TFS.CustomFields.PlannedHours'] || 0;
                    const completedEffort = f.fields['Casepoint.TFS.CustomFields.CompletedEffort'] || 0;
                    const actualCompletedHours = f.fields['Casepoint.TFS.CustomFields.ActualCompletedHours'] || 0;
                    const estimateInHours = f.fields['Casepoint.TFS.CustomFields.EstimateInHours'] || 0;
                    const devDeliveryHours = Math.max(0, estimateInHours - discoveryEffort);
                    const total = discoveryEffort + plannedHours;
                    return {
                        id: f.id, title: f.fields['System.Title'] || '', state: f.fields['System.State'] || '',
                        status: f.fields['Casepoint.TFS.CustomFields.Status'] || '-',
                        assignedTo: f.fields['System.AssignedTo']?.displayName || '-',
                        areaPath: f.fields['System.AreaPath'] || '',
                        iteration: f.sprintName, iterationPath: f.sprintPath,
                        tags: f.fields['System.Tags'] || '',
                        estimateInHours, discoveryEffort, devDeliveryHours, compDiscoveryHours, plannedHours, completedEffort, actualCompletedHours,
                        total, progressPct: total > 0 ? parseFloat(((actualCompletedHours / total) * 100).toFixed(1)) : 0,
                        taskLevelPlannedHours: featureTaskPlannedMap[f.id] || 0,
                        taskLevelCompletedDevHours: featureTaskCompletedMap[f.id] || 0,
                        taskLevelActualCompHours: featureTaskActualCompMap[f.id] || 0,
                        taskSprints: featureTaskSprintsMap[f.id] || [],
                        taskAreaPaths: featureTaskAreaPathsMap[f.id] || [],
                        rawTasks: featureRawTasksMap[f.id] || []
                    };
                });

                document.getElementById('featureProgressCount').textContent = featureProgressData.length;
                buildFeatureFilters([...allTaskSprintNames].sort(), [...allTaskAreaPaths].sort());
                renderFeatureProgressTable();
                const updateBtnAfterLoad = document.getElementById('updateFeatureHoursBtn');
                if (updateBtnAfterLoad) {
                    const isAdminUser = ['admin','super_admin'].includes(currentUserRole);
                    const hasData = featureProgressData.length > 0;
                    updateBtnAfterLoad.style.display = (hasData && isAdminUser) ? 'inline-block' : 'none';
                }
            } catch (e) {
                console.error('Error loading feature progress:', e);
                document.getElementById('noFeatureProgressData').style.display = 'block';
            }
            hideCardLoading('featureProgress');
        }

        function buildFeatureFilters(taskSprintNames, taskAreaPaths) {
            featureFilters.iterations = featurePISprints.map(s => s.name);
            // Collect dynamic states and statuses from actual data
            const dynamicStates = [...new Set(featureProgressData.map(f => f.state).filter(Boolean))].sort();
            const dynamicStatuses = [...new Set(featureProgressData.map(f => f.status).filter(s => s && s !== '-'))].sort();
            featureFilters.states = dynamicStates.length > 0 ? dynamicStates : ['Proposed', 'Active', 'Resolved', 'Closed'];
            featureFilters.statuses = dynamicStatuses.length > 0 ? dynamicStatuses : ['Discovery Pending','Discovery Started','Discovery Done','On Hold','Will not implement',
                'Under Consideration','In Dev','In QA','In PT','Ready to Ship','Shipped',
                'Documentation Pending','Documentation Started','Documentation Done'];
            featureFilters.taskSprints = taskSprintNames || [];
            // Area paths from actual child tasks
            featureFilters.areaPaths = taskAreaPaths || [];
            activeFeatureFilters = { iterations: [], states: [], statuses: [], taskSprints: [], areaPaths: [] };
            buildFpMultiSelect('featureAreaPathDropdown', featureFilters.areaPaths.map(p => p.split('\\').pop()), 'areaPaths', 'All Areas', featureFilters.areaPaths);
            buildFpMultiSelect('featureStateDropdown', featureFilters.states, 'states', 'All States');
            buildFpMultiSelect('featureStatusDropdown', featureFilters.statuses, 'statuses', 'All Statuses');
            buildFpMultiSelect('featureTaskSprintDropdown', featureFilters.taskSprints, 'taskSprints', 'All Sprints');
        }

        function buildFpMultiSelect(containerId, options, filterKey, placeholder, fullValues) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const dropdown = container.querySelector('.fp-multiselect-dropdown');
            const btn = container.querySelector('.fp-multiselect-btn');
            btn.textContent = placeholder;
            btn.dataset.filterKey = filterKey;
            btn.dataset.placeholder = placeholder;
            let html = `<label class="fp-multiselect-item select-all">
                <input type="checkbox" checked onchange="fpToggleSelectAll('${containerId}','${filterKey}',this)"> Select All
            </label>`;
            options.forEach((opt, i) => {
                const val = fullValues ? fullValues[i] : opt;
                html += `<label class="fp-multiselect-item">
                    <input type="checkbox" value="${String(val).replace(/"/g,'&quot;')}" checked onchange="fpToggleItem('${containerId}','${filterKey}')"> ${opt}
                </label>`;
            });
            dropdown.innerHTML = html;
        }

        function toggleFpDropdown(containerId) {
            const container = document.getElementById(containerId);
            const dropdown = container.querySelector('.fp-multiselect-dropdown');
            const btn = container.querySelector('.fp-multiselect-btn');
            const isOpen = dropdown.classList.contains('open');
            // Close all other dropdowns first
            document.querySelectorAll('.fp-multiselect-dropdown.open').forEach(d => {
                d.classList.remove('open');
                d.closest('.fp-multiselect').querySelector('.fp-multiselect-btn').classList.remove('open');
            });
            if (!isOpen) {
                dropdown.classList.add('open');
                btn.classList.add('open');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.fp-multiselect')) {
                document.querySelectorAll('.fp-multiselect-dropdown.open').forEach(d => {
                    d.classList.remove('open');
                    d.closest('.fp-multiselect').querySelector('.fp-multiselect-btn').classList.remove('open');
                });
            }
        });

        function fpToggleSelectAll(containerId, filterKey, selectAllCb) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('.fp-multiselect-item:not(.select-all) input[type="checkbox"]');
            checkboxes.forEach(cb => { cb.checked = selectAllCb.checked; });
            fpUpdateFilter(containerId, filterKey);
        }

        function fpToggleItem(containerId, filterKey) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('.fp-multiselect-item:not(.select-all) input[type="checkbox"]');
            const selectAllCb = container.querySelector('.fp-multiselect-item.select-all input[type="checkbox"]');
            const allChecked = [...checkboxes].every(cb => cb.checked);
            selectAllCb.checked = allChecked;
            fpUpdateFilter(containerId, filterKey);
        }

        function fpUpdateFilter(containerId, filterKey) {
            const container = document.getElementById(containerId);
            const btn = container.querySelector('.fp-multiselect-btn');
            const placeholder = btn.dataset.placeholder;
            const checkboxes = container.querySelectorAll('.fp-multiselect-item:not(.select-all) input[type="checkbox"]');
            const selectAllCb = container.querySelector('.fp-multiselect-item.select-all input[type="checkbox"]');
            const checked = [...checkboxes].filter(cb => cb.checked).map(cb => cb.value);
            const total = checkboxes.length;

            // If all checked or none checked, treat as "no filter" (show all)
            if (checked.length === total || checked.length === 0) {
                activeFeatureFilters[filterKey] = [];
                btn.innerHTML = placeholder;
            } else {
                activeFeatureFilters[filterKey] = checked;
                // For area paths, show short leaf names
                const displayItems = filterKey === 'areaPaths' ? checked.map(v => v.split('\\').pop()) : checked;
                const displayText = displayItems.length <= 2 ? displayItems.join(', ') : displayItems.length + ' selected';
                btn.innerHTML = displayText + ' <span class="fp-multiselect-badge">' + checked.length + '/' + total + '</span>';
            }
            renderFeatureProgressTable();
        }

        function getFilteredFeatureData() {
            let data = featureProgressData;
            if (activeFeatureFilters.areaPaths.length > 0) {
                data = data.filter(f => {
                    return f.taskAreaPaths.some(tap => {
                        const tapLower = tap.toLowerCase();
                        return activeFeatureFilters.areaPaths.some(ap => {
                            const apLower = ap.toLowerCase();
                            return tapLower === apLower || tapLower.startsWith(apLower + '\\');
                        });
                    });
                });
            }
            if (activeFeatureFilters.iterations.length > 0) data = data.filter(f => activeFeatureFilters.iterations.includes(f.iteration));
            if (activeFeatureFilters.states.length > 0) data = data.filter(f => activeFeatureFilters.states.includes(f.state));
            if (activeFeatureFilters.statuses.length > 0) {
                const lowerStatuses = activeFeatureFilters.statuses.map(s => s.toLowerCase());
                data = data.filter(f => lowerStatuses.includes((f.status || '').toLowerCase()));
            }
            if (activeFeatureFilters.taskSprints.length > 0) {
                data = data.filter(f => f.taskSprints.some(ts => activeFeatureFilters.taskSprints.includes(ts)));
            }

            // Recalculate task-level hours when taskSprints or areaPaths filters are active
            const hasSprintFilter = activeFeatureFilters.taskSprints.length > 0;
            const hasAreaFilter = activeFeatureFilters.areaPaths.length > 0;
            if (hasSprintFilter || hasAreaFilter) {
                const includedPlanned = ['development', 'analysis', 'test'];
                const excludedCompDev = ['analysis', 'user experience', 'user education'];
                const excludedActual = ['user experience', 'user education'];

                data = data.map(f => {
                    const filteredTasks = (f.rawTasks || []).filter(t => {
                        // Sprint filter: task's iteration leaf must be in selected sprints
                        if (hasSprintFilter && !activeFeatureFilters.taskSprints.includes(t.iterLeafOriginal)) return false;
                        // Area filter: task's area path must match selected areas
                        if (hasAreaFilter) {
                            const tapLower = (t.taskAreaPathOriginal || '').toLowerCase();
                            const areaMatch = activeFeatureFilters.areaPaths.some(ap => {
                                const apLower = ap.toLowerCase();
                                return tapLower === apLower || tapLower.startsWith(apLower + '\\');
                            });
                            if (!areaMatch) return false;
                        }
                        return true;
                    });

                    let taskPlanned = 0, taskCompDev = 0, taskActualComp = 0;
                    filteredTasks.forEach(t => {
                        if (t.isRootIter || t.isRejected) return;
                        if (includedPlanned.includes(t.discipline)) taskPlanned += t.origEst;
                        if (!excludedActual.includes(t.discipline)) taskActualComp += t.compWork;
                        if (!excludedCompDev.includes(t.discipline) && t.matchesFeatureArea) taskCompDev += t.compWork;
                    });

                    return {
                        ...f,
                        taskLevelPlannedHours: taskPlanned,
                        taskLevelCompletedDevHours: taskCompDev,
                        taskLevelActualCompHours: taskActualComp
                    };
                });
            }
            return data;
        }

        function getStatePillClass(state) {
            const s = (state || '').toLowerCase();
            if (s === 'closed') return 'fp-state-closed';
            if (s === 'active') return 'fp-state-active';
            if (s === 'resolved') return 'fp-state-resolved';
            return 'fp-state-proposed';
        }
        function getStatusPillClass(status) {
            const s = (status || '').toLowerCase();
            if (s.includes('discovery')) return 'fp-status-discovery';
            if (s.includes('in dev') || s === 'under consideration') return 'fp-status-dev';
            if (s.includes('qa') || s.includes('pt')) return 'fp-status-qa';
            if (s.includes('ship') || s.includes('shipped')) return 'fp-status-ship';
            if (s.includes('hold') || s.includes('will not')) return 'fp-status-hold';
            if (s.includes('doc')) return 'fp-status-doc';
            return 'fp-status-default';
        }

        function sortFeatureTable(column) {
            // Skip sorting if user is selecting text
            var sel = window.getSelection();
            if (sel && sel.toString().length > 0) return;
            if (featureSortColumn === column) {
                featureSortDirection = featureSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                featureSortColumn = column;
                featureSortDirection = (column === 'id' || column === 'title' || column === 'state' || column === 'status') ? 'asc' : 'desc';
            }
            // Update sort icons
            document.querySelectorAll('#featureProgressTable .fp-sort-icon').forEach(icon => {
                icon.className = 'fp-sort-icon';
            });
            const activeHeader = document.querySelector(`#featureProgressTable th[data-sort="${column}"] .fp-sort-icon`);
            if (activeHeader) activeHeader.className = 'fp-sort-icon ' + featureSortDirection;
            renderFeatureProgressTable();
        }

        function getSortedFeatureData(data) {
            if (!featureSortColumn || data.length === 0) return data;
            const col = featureSortColumn;
            const dir = featureSortDirection === 'asc' ? 1 : -1;
            const stringCols = ['title', 'state', 'status'];
            return [...data].sort((a, b) => {
                let va = a[col], vb = b[col];
                if (stringCols.includes(col)) {
                    va = (va || '').toLowerCase();
                    vb = (vb || '').toLowerCase();
                    return va < vb ? -dir : va > vb ? dir : 0;
                }
                return ((va || 0) - (vb || 0)) * dir;
            });
        }

        let fpSelectedIds = new Set(); // Track selected feature IDs for Update popup

        function renderFeatureProgressTable() {
            const filteredData = getFilteredFeatureData();
            const data = getSortedFeatureData(filteredData);
            const tbody = document.getElementById('featureProgressTableBody');
            const tfoot = document.getElementById('featureProgressTableFooter');
            const pd = 'padding:4px 3px;';
            if (fpSelectedIds.size === 0 && data.length > 0) {
                data.forEach(f => fpSelectedIds.add(f.id));
            }
            const currentIds = new Set(data.map(f => f.id));
            fpSelectedIds.forEach(id => { if (!currentIds.has(id)) fpSelectedIds.delete(id); });
            if (data.length > 0) {
                document.getElementById('noFeatureProgressData').style.display = 'none';
                tbody.innerHTML = data.map(f => {
                    const chk = fpSelectedIds.has(f.id);
                    const stCls = getStatePillClass(f.state);
                    const statusCls = getStatusPillClass(f.status);
                    const mm1 = Math.abs(f.plannedHours - f.taskLevelPlannedHours) > 0.01;
                    const mm2 = Math.abs(f.completedEffort - f.taskLevelCompletedDevHours) > 0.01;
                    const mm3 = Math.abs(f.actualCompletedHours - f.taskLevelActualCompHours) > 0.01;
                    const hlR = (m) => m ? ' fp-hl-red' : '';
                    const hlO = (m) => m ? ' fp-hl-orange' : '';
                    const ttP = mm1 ? `title="Mismatch: Planned(${fmtH(f.plannedHours)}) ≠ TaskPlanned(${fmtH(f.taskLevelPlannedHours)})"` : '';
                    const ttE = mm2 ? `title="Mismatch: CompEffort(${fmtH(f.completedEffort)}) ≠ TaskCompDev(${fmtH(f.taskLevelCompletedDevHours)})"` : '';
                    const ttA = mm3 ? `title="Mismatch: ActualComp(${fmtH(f.actualCompletedHours)}) ≠ TaskActComp(${fmtH(f.taskLevelActualCompHours)})"` : '';
                    return `<tr>
                        <td style="${pd}text-align:center;"><input type="checkbox" class="fp-table-chk" data-fid="${f.id}" ${chk?'checked':''} onchange="onFpTableCheckboxChange(this)" style="cursor:pointer;accent-color:#3b82f6;"></td>
                        <td style="${pd}"><a href="${tfsUrl}/${project}/_workitems/edit/${f.id}" target="_blank" class="wi-link">${f.id}</a></td>
                        <td class="fp-title" style="${pd}overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500;" title="${f.title}">${f.title}</td>
                        <td style="${pd}text-align:center;"><span class="fp-state-pill ${stCls}">${f.state}</span></td>
                        <td style="${pd}text-align:center;" title="${f.status}"><span class="fp-status-pill ${statusCls}">${f.status}</span></td>
                        <td class="fp-est-inhrs" style="${pd}text-align:right;font-weight:600;">${fmtH(f.estimateInHours)}h</td>
                        <td class="fp-est-disc" style="${pd}text-align:right;font-weight:600;">${fmtH(f.discoveryEffort)}h</td>
                        <td class="fp-dev-delivery" style="${pd}text-align:right;font-weight:600;">${fmtH(f.devDeliveryHours)}h</td>
                        <td class="fp-planned${hlR(mm1)}" style="${pd}text-align:right;font-weight:600;" ${ttP}>${fmtH(f.plannedHours)}h</td>
                        <td class="fp-comp-disc" style="${pd}text-align:right;font-weight:600;">${fmtH(f.compDiscoveryHours)}h</td>
                        <td class="fp-comp-eff${hlR(mm2)}" style="${pd}text-align:right;font-weight:600;" ${ttE}>${fmtH(f.completedEffort)}h</td>
                        <td class="fp-actual-comp${hlR(mm3)}" style="${pd}text-align:right;font-weight:600;" ${ttA}>${fmtH(f.actualCompletedHours)}h</td>
                        <td class="fp-task-plan${hlO(mm1)}" style="${pd}text-align:right;font-weight:700;" ${ttP}>${fmtH(f.taskLevelPlannedHours)}h</td>
                        <td class="fp-task-cdev${hlO(mm2)}" style="${pd}text-align:right;font-weight:700;" ${ttE}>${fmtH(f.taskLevelCompletedDevHours)}h</td>
                        <td class="fp-task-acomp${hlO(mm3)}" style="${pd}text-align:right;font-weight:700;" ${ttA}>${fmtH(f.taskLevelActualCompHours)}h</td>
                    </tr>`;
                }).join('');
                const totEstInHrs = data.reduce((s, f) => s + f.estimateInHours, 0);
                const totDiscEffort = data.reduce((s, f) => s + f.discoveryEffort, 0);
                const totDevDelivery = data.reduce((s, f) => s + f.devDeliveryHours, 0);
                const totCompDisc = data.reduce((s, f) => s + f.compDiscoveryHours, 0);
                const totPlanned = data.reduce((s, f) => s + f.plannedHours, 0);
                const totCompEffort = data.reduce((s, f) => s + f.completedEffort, 0);
                const totActualComp = data.reduce((s, f) => s + f.actualCompletedHours, 0);
                const totTaskPlanned = data.reduce((s, f) => s + f.taskLevelPlannedHours, 0);
                const totTaskCompDev = data.reduce((s, f) => s + f.taskLevelCompletedDevHours, 0);
                const totTaskActualComp = data.reduce((s, f) => s + f.taskLevelActualCompHours, 0);
                const fp = 'padding:5px 3px;';
                tfoot.innerHTML = `<tr>
                    <td colspan="5" class="fp-totals-lbl" style="${fp}text-align:right;font-weight:700;">Totals:</td>
                    <td class="fp-est-inhrs" style="${fp}text-align:right;font-weight:700;">${fmtH(totEstInHrs)}h</td>
                    <td class="fp-est-disc" style="${fp}text-align:right;font-weight:700;">${fmtH(totDiscEffort)}h</td>
                    <td class="fp-dev-delivery" style="${fp}text-align:right;font-weight:700;">${fmtH(totDevDelivery)}h</td>
                    <td class="fp-planned" style="${fp}text-align:right;font-weight:700;">${fmtH(totPlanned)}h</td>
                    <td class="fp-comp-disc" style="${fp}text-align:right;font-weight:700;">${fmtH(totCompDisc)}h</td>
                    <td class="fp-comp-eff" style="${fp}text-align:right;font-weight:700;">${fmtH(totCompEffort)}h</td>
                    <td class="fp-actual-comp" style="${fp}text-align:right;font-weight:700;">${fmtH(totActualComp)}h</td>
                    <td class="fp-task-plan" style="${fp}text-align:right;font-weight:700;">${fmtH(totTaskPlanned)}h</td>
                    <td class="fp-task-cdev" style="${fp}text-align:right;font-weight:700;">${fmtH(totTaskCompDev)}h</td>
                    <td class="fp-task-acomp" style="${fp}text-align:right;font-weight:700;">${fmtH(totTaskActualComp)}h</td>
                </tr>`;
                syncFpTableSelectAll();
                updateFpSelectedCount();
            } else {
                document.getElementById('noFeatureProgressData').style.display = 'block';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
            }
        }

        function onFpTableCheckboxChange(cb) {
            const fid = parseInt(cb.getAttribute('data-fid'));
            if (cb.checked) { fpSelectedIds.add(fid); } else { fpSelectedIds.delete(fid); }
            syncFpTableSelectAll();
            updateFpSelectedCount();
        }

        function toggleAllFpTableCheckboxes(checked) {
            document.querySelectorAll('.fp-table-chk').forEach(cb => {
                cb.checked = checked;
                const fid = parseInt(cb.getAttribute('data-fid'));
                if (checked) { fpSelectedIds.add(fid); } else { fpSelectedIds.delete(fid); }
            });
            updateFpSelectedCount();
        }

        function syncFpTableSelectAll() {
            const all = document.querySelectorAll('.fp-table-chk');
            const checked = document.querySelectorAll('.fp-table-chk:checked');
            const selectAll = document.getElementById('fpTableSelectAll');
            if (selectAll && all.length > 0) {
                selectAll.checked = checked.length === all.length;
                selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
            }
        }

        function updateFpSelectedCount() {
            const btn = document.getElementById('updateFeatureHoursBtn');
            if (!btn) return;
            const count = fpSelectedIds.size;
            const total = getFilteredFeatureData().length;
            if (count > 0 && count < total) {
                btn.textContent = `⬆️ Update Feature Data (${count})`;
            } else {
                btn.textContent = '⬆️ Update Feature Data';
            }
        }

        // ===== UPDATE FEATURE DATA IN TFS (POPUP) =====
        function showUpdateFeaturePopup() {
            if (!['admin','super_admin'].includes(currentUserRole)) {
                alert('⚠️ Only Admin and Super Admin can update feature data.'); return;
            }
            const filteredData = getFilteredFeatureData().filter(f => fpSelectedIds.has(f.id));
            if (filteredData.length === 0) { alert('⚠️ No features selected. Please check features in the table first.'); return; }
            const states = featureFilters.states.length > 0 ? featureFilters.states : ['Proposed','Active','Resolved','Closed'];
            const statuses = featureFilters.statuses.length > 0 ? featureFilters.statuses : [];
            const isLight = document.body.classList.contains('light-theme');
            const totalFiltered = getFilteredFeatureData().length;

            const tc = {
                muted: isLight ? '#64748b' : '#94a3b8',
                text: isLight ? '#1e293b' : '#e2e8f0',
                cellText: isLight ? '#334155' : '#cbd5e1',
                planned: isLight ? '#7c3aed' : '#c084fc',
                taskVal: isLight ? '#ea580c' : '#f97316',
                hlMismatch: isLight ? 'background:rgba(239,68,68,0.1);' : 'background:rgba(239,68,68,0.15);',
                hlTask: isLight ? 'background:rgba(251,146,60,0.1);' : 'background:rgba(251,146,60,0.15);',
                selBg: isLight ? 'background:#f1f5f9;color:#1e293b;border:1px solid #cbd5e1;' : 'background:rgba(0,0,0,0.3);color:#e2e8f0;border:1px solid rgba(99,102,241,0.3);',
                rowAlt: isLight ? 'background:#f8fafc;' : 'background:rgba(255,255,255,0.02);',
                thBg: isLight ? 'background:#f1f5f9;' : 'background:rgba(0,0,0,0.3);',
                thColor: isLight ? '#475569' : '#94a3b8',
                border: isLight ? 'border-bottom:1px solid #e2e8f0;' : 'border-bottom:1px solid rgba(255,255,255,0.06);',
                warn: isLight ? '#b45309' : '#fbbf24',
                blue: isLight ? '#2563eb' : '#60a5fa',
                red: isLight ? '#dc2626' : '#f87171',
                green: isLight ? '#059669' : '#34d399',
                footBg: isLight ? 'background:#eef2ff;' : 'background:rgba(59,130,246,0.1);',
                footBorder: isLight ? 'border-top:2px solid #93c5fd;' : 'border-top:2px solid rgba(59,130,246,0.4);',
                footText: isLight ? '#1e40af' : '#93c5fd'
            };

            const summaryDiv = document.getElementById('updateFeaturePopupSummary');
            const mismatchCount = filteredData.filter(f =>
                Math.abs(f.plannedHours - f.taskLevelPlannedHours) > 0.01 ||
                Math.abs(f.completedEffort - f.taskLevelCompletedDevHours) > 0.01 ||
                Math.abs(f.actualCompletedHours - f.taskLevelActualCompHours) > 0.01
            ).length;
            summaryDiv.innerHTML = `<div style="display:flex;gap:16px;flex-wrap:wrap;font-size:0.68rem;align-items:center;">
                <span style="color:${tc.muted};">Selected: <b style="color:${tc.blue};">${filteredData.length}</b> / ${totalFiltered} features</span>
                <span style="color:${tc.muted};">Hours Mismatch: <b style="color:${mismatchCount>0?tc.red:tc.green};">${mismatchCount}</b></span>
                <span style="color:${tc.warn};font-weight:500;">⚠️ Change State/Status per row. Hours auto-sync from tasks.</span>
            </div>`;

            const totals = {
                planned: filteredData.reduce((s,f) => s + f.plannedHours, 0),
                taskPlan: filteredData.reduce((s,f) => s + f.taskLevelPlannedHours, 0),
                compEff: filteredData.reduce((s,f) => s + f.completedEffort, 0),
                taskCDev: filteredData.reduce((s,f) => s + f.taskLevelCompletedDevHours, 0),
                actComp: filteredData.reduce((s,f) => s + f.actualCompletedHours, 0),
                taskACmp: filteredData.reduce((s,f) => s + f.taskLevelActualCompHours, 0)
            };

            const body = document.getElementById('updateFeaturePopupBody');
            const pd = 'padding:5px 6px;font-size:0.64rem;';
            const thS = `${pd}text-align:center;color:${tc.thColor};font-weight:600;white-space:nowrap;`;
            const tfp = 'padding:6px;font-size:0.66rem;font-weight:700;text-align:right;';
            body.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:0.64rem;">
                <thead><tr style="${tc.thBg}">
                    <th style="${pd}text-align:left;color:${tc.thColor};width:50px;">ID</th>
                    <th style="${pd}text-align:left;color:${tc.thColor};">Title</th>
                    <th style="${thS}width:85px;">State</th>
                    <th style="${thS}max-width:130px;">Status</th>
                    <th style="${thS}color:${tc.planned};width:55px;">Planned</th><th style="${thS}color:${tc.taskVal};width:55px;">Task Plan</th>
                    <th style="${thS}color:${tc.planned};width:55px;">Comp Eff</th><th style="${thS}color:${tc.taskVal};width:55px;">Task CDev</th>
                    <th style="${thS}color:${tc.planned};width:55px;">Act Comp</th><th style="${thS}color:${tc.taskVal};width:55px;">Task ACmp</th>
                </tr></thead><tbody>${filteredData.map((f, i) => {
                    const mm1 = Math.abs(f.plannedHours - f.taskLevelPlannedHours) > 0.01;
                    const mm2 = Math.abs(f.completedEffort - f.taskLevelCompletedDevHours) > 0.01;
                    const mm3 = Math.abs(f.actualCompletedHours - f.taskLevelActualCompHours) > 0.01;
                    const stOpts = states.map(s => `<option value="${s}"${s===f.state?' selected':''}>${s}</option>`).join('');
                    const suOpts = ['<option value="">-</option>', ...statuses.map(s => `<option value="${s}"${s===f.status?' selected':''}>${s}</option>`)].join('');
                    const rowBg = i % 2 === 0 ? '' : tc.rowAlt;
                    return `<tr id="fpPopupRow-${f.id}" style="${tc.border}${rowBg}">
                        <td style="${pd}"><a href="${tfsUrl}/${project}/_workitems/edit/${f.id}" target="_blank" class="wi-link">${f.id}</a></td>
                        <td style="${pd}color:${tc.cellText};max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${f.title}">${f.title}</td>
                        <td style="${pd}"><select data-fid="${f.id}" data-field="state" data-orig="${f.state}" style="font-size:0.62rem;padding:2px 4px;${tc.selBg}border-radius:4px;width:100%;">${stOpts}</select></td>
                        <td style="${pd}"><select data-fid="${f.id}" data-field="status" data-orig="${f.status||''}" style="font-size:0.62rem;padding:2px 4px;${tc.selBg}border-radius:4px;width:100%;">${suOpts}</select></td>
                        <td style="${pd}text-align:right;color:${tc.planned};${mm1?tc.hlMismatch:''}">${fmtH(f.plannedHours)}h</td>
                        <td style="${pd}text-align:right;color:${tc.taskVal};font-weight:700;${mm1?tc.hlTask:''}">${fmtH(f.taskLevelPlannedHours)}h</td>
                        <td style="${pd}text-align:right;color:${tc.planned};${mm2?tc.hlMismatch:''}">${fmtH(f.completedEffort)}h</td>
                        <td style="${pd}text-align:right;color:${tc.taskVal};font-weight:700;${mm2?tc.hlTask:''}">${fmtH(f.taskLevelCompletedDevHours)}h</td>
                        <td style="${pd}text-align:right;color:${tc.planned};${mm3?tc.hlMismatch:''}">${fmtH(f.actualCompletedHours)}h</td>
                        <td style="${pd}text-align:right;color:${tc.taskVal};font-weight:700;${mm3?tc.hlTask:''}">${fmtH(f.taskLevelActualCompHours)}h</td>
                    </tr>`;
                }).join('')}</tbody>
                <tfoot><tr style="${tc.footBg}${tc.footBorder}">
                    <td colspan="4" style="${tfp}color:${tc.footText};">Totals (${filteredData.length}):</td>
                    <td style="${tfp}color:${tc.planned};">${fmtH(totals.planned)}h</td>
                    <td style="${tfp}color:${tc.taskVal};">${fmtH(totals.taskPlan)}h</td>
                    <td style="${tfp}color:${tc.planned};">${fmtH(totals.compEff)}h</td>
                    <td style="${tfp}color:${tc.taskVal};">${fmtH(totals.taskCDev)}h</td>
                    <td style="${tfp}color:${tc.planned};">${fmtH(totals.actComp)}h</td>
                    <td style="${tfp}color:${tc.taskVal};">${fmtH(totals.taskACmp)}h</td>
                </tr></tfoot></table>`;
            document.getElementById('updateFeaturePopupFooter').innerHTML = `
                <button onclick="closeUpdateFeaturePopup()" class="btn" style="padding:6px 18px;font-size:0.75rem;background:rgba(100,116,139,0.3);border:1px solid rgba(100,116,139,0.5);color:${tc.muted};border-radius:6px;">Cancel</button>
                <button id="confirmUpdateFeatureBtn" onclick="confirmUpdateFeatureHours()" class="btn btn-success" style="padding:6px 18px;font-size:0.75rem;border-radius:6px;">✅ Confirm &amp; Update All (${filteredData.length})</button>`;
            document.getElementById('updateFeaturePopupFooter').style.display = 'flex';
            document.getElementById('updateFeaturePopup').style.display = 'flex';
        }

        function closeUpdateFeaturePopup() {
            document.getElementById('updateFeaturePopup').style.display = 'none';
        }

        async function confirmUpdateFeatureHours() {
            const selectedData = getFilteredFeatureData().filter(f => fpSelectedIds.has(f.id));
            if (selectedData.length === 0) { alert('⚠️ No features to update.'); return; }

            const btn = document.getElementById('confirmUpdateFeatureBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '⏳ Updating...';
            let successCount = 0, failedIds = [];

            try {
                for (let i = 0; i < selectedData.length; i++) {
                    const feature = selectedData[i];
                    btn.textContent = `⏳ ${i + 1}/${selectedData.length}...`;
                    try {
                        const patchBody = [
                            { op: 'replace', path: '/fields/Casepoint.TFS.CustomFields.PlannedHours', value: feature.taskLevelPlannedHours },
                            { op: 'replace', path: '/fields/Casepoint.TFS.CustomFields.CompletedEffort', value: feature.taskLevelCompletedDevHours },
                            { op: 'replace', path: '/fields/Casepoint.TFS.CustomFields.ActualCompletedHours', value: feature.taskLevelActualCompHours }
                        ];
                        const stSel = document.querySelector(`select[data-fid="${feature.id}"][data-field="state"]`);
                        const suSel = document.querySelector(`select[data-fid="${feature.id}"][data-field="status"]`);
                        if (stSel && stSel.value !== stSel.getAttribute('data-orig')) {
                            patchBody.push({ op: 'replace', path: '/fields/System.State', value: stSel.value });
                        }
                        if (suSel && suSel.value !== suSel.getAttribute('data-orig')) {
                            patchBody.push({ op: 'replace', path: '/fields/Casepoint.TFS.CustomFields.Status', value: suSel.value });
                        }
                        const resp = await fetch(`${tfsUrl}/_apis/wit/workitems/${feature.id}?api-version=5.0`, {
                            method: 'PATCH',
                            headers: { ...config.headers, 'Content-Type': 'application/json-patch+json' },
                            body: JSON.stringify(patchBody)
                        });
                        apiCallCount++;
                        document.getElementById('apiCallCount').textContent = apiCallCount;
                        if (!resp.ok) throw new Error(`${resp.status}: ${await resp.text()}`);
                        successCount++;
                        feature.plannedHours = feature.taskLevelPlannedHours;
                        feature.completedEffort = feature.taskLevelCompletedDevHours;
                        feature.actualCompletedHours = feature.taskLevelActualCompHours;
                        if (stSel && stSel.value !== feature.state) feature.state = stSel.value;
                        if (suSel && suSel.value !== feature.status) feature.status = suSel.value;
                    } catch (e) { failedIds.push(feature.id); console.error('[UpdateFeature]', feature.id, e.message); }
                }
                try { renderFeatureProgressTable(); } catch(e) { console.error('renderFeatureProgressTable error:', e); }
                try { updateFeatureSummaryStats(); } catch(e) { console.error('updateFeatureSummaryStats error:', e); }
            } finally {
                const isLight = document.body.classList.contains('light-theme');
                const allOk = failedIds.length === 0;
                const resultColor = allOk ? (isLight ? '#059669' : '#34d399') : (isLight ? '#b45309' : '#fbbf24');
                const failColor = isLight ? '#dc2626' : '#f87171';
                const mutedColor = isLight ? '#64748b' : '#94a3b8';
                const body = document.getElementById('updateFeaturePopupBody');
                body.innerHTML = `<div style="text-align:center;padding:30px;">
                    <div style="font-size:2.5rem;margin-bottom:12px;">${allOk ? '✅' : '⚠️'}</div>
                    <div style="color:${resultColor};font-size:1.1rem;font-weight:700;margin-bottom:8px;">
                        ${successCount}/${selectedData.length} feature(s) updated successfully
                    </div>
                    ${failedIds.length > 0 ? `<div style="color:${failColor};font-size:0.78rem;margin-bottom:10px;">❌ Failed: ${failedIds.map(id => '#' + id).join(', ')}</div>` : ''}
                    <div style="color:${mutedColor};font-size:0.7rem;margin-top:8px;">Hours synced from task-level data. State/Status changes applied where modified.</div>
                </div>`;
                document.getElementById('updateFeaturePopupSummary').innerHTML = '';
                document.getElementById('updateFeaturePopupFooter').innerHTML = `
                    <button onclick="closeUpdateFeaturePopup()" class="btn btn-primary" style="padding:6px 20px;font-size:0.75rem;border-radius:6px;">Close</button>`;
            }
        }

        // ===== AFFECTED AREA FEATURES =====
        let affectedAreaDataLoaded = false;
        let affectedAreaData = []; // [{featureId, featureTitle, featureArea, featureState, tasks:[{...}]}]
        let affectedAreaSortCol = null;
        let affectedAreaSortDir = 'asc';

        function toggleAffectedAreaDashboard() {
            const content = document.getElementById('affectedAreaContent');
            const btn = document.getElementById('toggleAffectedAreaBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                if (!affectedAreaDataLoaded) loadAffectedAreaData();
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
            }
        }

        async function loadAffectedAreaData() {
            showCardLoading('affectedArea');
            try {
                const iterPath = selectedIterationPaths.length > 0 ? selectedIterationPaths[0].path : '';
                if (!iterPath || selectedAreaPaths.length === 0) {
                    document.getElementById('noAffectedAreaData').style.display = 'block';
                    document.getElementById('noAffectedAreaData').textContent = 'Please select at least one Area and Iteration.';
                    hideCardLoading('affectedArea');
                    return;
                }

                const piInfo = derivePIFromSprint(iterPath);
                const iterPaths = piInfo.sprints.map(s => s.path);
                const selectedAreaLower = selectedAreaPaths.map(a => a.path.toLowerCase());

                const aaAreaConditions = selectedAreaPaths.map(a => `[System.AreaPath] UNDER '${a.path}'`).join(' OR ');
                const aaIterConditions = iterPaths.map(s => `[System.IterationPath] UNDER '${s}'`).join(' OR ');
                const taskQuery = `SELECT [System.Id] FROM WorkItems WHERE [System.WorkItemType]='Task' AND (${aaAreaConditions}) AND (${aaIterConditions})`;
                let allTaskIds = [];
                try {
                    const resp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/wiql?api-version=5.0`, {
                        method: 'POST', body: JSON.stringify({ query: taskQuery })
                    });
                    const data = await resp.json();
                    allTaskIds = (data.workItems || []).map(w => w.id);
                } catch (e) { console.error('[AffectedArea] WIQL error:', e.message); }
                allTaskIds = [...new Set(allTaskIds)];

                if (allTaskIds.length === 0) {
                    document.getElementById('noAffectedAreaData').style.display = 'block';
                    affectedAreaData = [];
                    document.getElementById('affectedAreaCount').textContent = '0';
                    document.getElementById('affectedAreaTableBody').innerHTML = '';
                    document.getElementById('affectedAreaTableFooter').innerHTML = '';
                    document.getElementById('affectedAreaSummary').innerHTML = '';
                    hideCardLoading('affectedArea');
                    return;
                }

                const tasksWithRel = await batchFetchWithRelations(allTaskIds);
                const taskDetailMap = {};
                tasksWithRel.forEach(t => { taskDetailMap[t.id] = t; });

                // Step 3: Find parent IDs (Requirement/Bug) for each task
                const parentIds = new Set();
                const taskParentMap = {};
                tasksWithRel.forEach(t => {
                    const parentRel = (t.relations || []).find(r => r.rel === 'System.LinkTypes.Hierarchy-Reverse');
                    if (parentRel) {
                        const pid = parseInt(parentRel.url.split('/').pop());
                        parentIds.add(pid);
                        taskParentMap[t.id] = pid;
                    }
                });

                // Step 4: Fetch parents with relations to find grandparent Features
                const parentsWithRel = parentIds.size > 0 ? await batchFetchWithRelations([...parentIds]) : [];
                const grandparentIds = new Set();
                const parentFeatureMap = {};
                parentsWithRel.forEach(p => {
                    const gpRel = (p.relations || []).find(r => r.rel === 'System.LinkTypes.Hierarchy-Reverse');
                    if (gpRel) {
                        const fid = parseInt(gpRel.url.split('/').pop());
                        grandparentIds.add(fid);
                        parentFeatureMap[p.id] = fid;
                    }
                });

                // Step 5: Fetch Features
                const featureFieldsList = ['System.Id','System.Title','System.State','System.AreaPath',
                    'System.IterationPath','Casepoint.TFS.CustomFields.Status'];
                const features = grandparentIds.size > 0 ? await batchFetchWorkItems([...grandparentIds], featureFieldsList) : [];
                const featureMap = {};
                features.forEach(f => { featureMap[f.id] = f; });

                // Step 5b: Fetch parent (Req/Bug) details for tree view
                const parentFields = ['System.Id','System.Title','System.State','System.WorkItemType','System.AreaPath','System.IterationPath'];
                const parentDetails = parentIds.size > 0 ? await batchFetchWorkItems([...parentIds], parentFields) : [];
                const parentDetailMap = {};
                parentDetails.forEach(p => { parentDetailMap[p.id] = p; });

                // Step 6: Filter features NOT in selected areas and group tasks by Feature → Req → Task
                const featureReqTaskGroups = {}; // featureId → { reqId → [tasks] }
                const allIterNames = new Set();
                allTaskIds.forEach(tid => {
                    const parentId = taskParentMap[tid];
                    if (!parentId) return;
                    const featureId = parentFeatureMap[parentId];
                    if (!featureId) return;
                    const feat = featureMap[featureId];
                    if (!feat) return;
                    const featAreaLower = (feat.fields['System.AreaPath'] || '').toLowerCase();
                    const isInSelectedArea = selectedAreaLower.some(sa => featAreaLower === sa || featAreaLower.startsWith(sa + '\\'));
                    if (isInSelectedArea) return;
                    const task = taskDetailMap[tid];
                    if (!task || task.fields['System.WorkItemType'] !== 'Task') return;
                    const disc = (task.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase().trim();
                    if (!['development', 'test', 'analysis'].includes(disc)) return;
                    const iterLeaf = (task.fields['System.IterationPath'] || '').split('\\').pop().trim();
                    if (iterLeaf && iterLeaf.toLowerCase() !== 'casepointara') allIterNames.add(iterLeaf);
                    if (!featureReqTaskGroups[featureId]) featureReqTaskGroups[featureId] = {};
                    if (!featureReqTaskGroups[featureId][parentId]) featureReqTaskGroups[featureId][parentId] = [];
                    featureReqTaskGroups[featureId][parentId].push({
                        taskId: task.id,
                        taskTitle: task.fields['System.Title'] || '',
                        taskState: task.fields['System.State'] || '',
                        assigned: task.fields['System.AssignedTo']?.displayName || '-',
                        discipline: task.fields['Microsoft.VSTS.Common.Discipline'] || '-',
                        iteration: iterLeaf,
                        origEst: task.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0,
                        rem: task.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0,
                        comp: task.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0,
                        reason: (task.fields['System.Reason'] || '').toLowerCase().trim()
                    });
                });

                // Build affectedAreaData with Feature → Reqs → Tasks hierarchy
                affectedAreaData = Object.keys(featureReqTaskGroups).map(fid => {
                    const feat = featureMap[parseInt(fid)];
                    const fArea = (feat.fields['System.AreaPath'] || '').split('\\').pop();
                    const reqGroups = featureReqTaskGroups[fid];
                    const reqs = Object.keys(reqGroups).map(rid => {
                        const parent = parentDetailMap[parseInt(rid)];
                        return {
                            reqId: parseInt(rid),
                            reqTitle: parent ? (parent.fields['System.Title'] || '') : `#${rid}`,
                            reqState: parent ? (parent.fields['System.State'] || '') : '-',
                            reqType: parent ? (parent.fields['System.WorkItemType'] || '') : '-',
                            tasks: reqGroups[rid]
                        };
                    });
                    return {
                        featureId: parseInt(fid),
                        featureTitle: feat.fields['System.Title'] || '',
                        featureArea: feat.fields['System.AreaPath'] || '',
                        featureAreaLeaf: fArea,
                        featureState: feat.fields['System.State'] || '',
                        reqs
                    };
                }).filter(f => f.reqs.some(r => r.tasks.length > 0)).sort((a, b) => a.featureId - b.featureId);

                affectedAreaDataLoaded = true;
                document.getElementById('affectedAreaCount').textContent = affectedAreaData.length;

                // Populate iteration filter
                const iterSelect = document.getElementById('affectedAreaIterFilter');
                const sortedIters = [...allIterNames].sort();
                iterSelect.innerHTML = '<option value="all">All Iterations</option>' +
                    sortedIters.map(n => `<option value="${n}">${n}</option>`).join('');

                renderAffectedAreaTable();
            } catch (err) {
                console.error('[AffectedArea] Error:', err);
                document.getElementById('noAffectedAreaData').style.display = 'block';
                document.getElementById('noAffectedAreaData').textContent = 'Error loading: ' + err.message;
            }
            hideCardLoading('affectedArea');
        }

        function sortAffectedArea(col) {
            if (affectedAreaSortCol === col) {
                affectedAreaSortDir = affectedAreaSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                affectedAreaSortCol = col;
                affectedAreaSortDir = ['featureId','featureTitle','featureArea','featureState'].includes(col) ? 'asc' : 'desc';
            }
            renderAffectedAreaTable();
        }

        function toggleAffectedAreaNode(featureId) {
            const rows = document.querySelectorAll(`.aa-req-${featureId}`);
            const btn = document.getElementById(`aa-toggle-${featureId}`);
            if (!btn) return;
            const isExpanded = btn.textContent === '−';
            rows.forEach(r => r.style.display = isExpanded ? 'none' : '');
            // Also collapse all task sub-rows when collapsing feature
            if (isExpanded) {
                document.querySelectorAll(`[class*="aa-task-${featureId}-"]`).forEach(r => r.style.display = 'none');
                document.querySelectorAll(`[id^="aa-req-toggle-${featureId}-"]`).forEach(b => b.textContent = '+');
            }
            btn.textContent = isExpanded ? '+' : '−';
        }
        function toggleAffectedAreaReq(featureId, reqId) {
            const rows = document.querySelectorAll(`.aa-task-${featureId}-${reqId}`);
            const btn = document.getElementById(`aa-req-toggle-${featureId}-${reqId}`);
            if (!btn) return;
            const isExpanded = btn.textContent === '−';
            rows.forEach(r => r.style.display = isExpanded ? 'none' : '');
            btn.textContent = isExpanded ? '+' : '−';
        }

        function renderAffectedAreaTable() {
            const iterFilter = document.getElementById('affectedAreaIterFilter').value;
            const tbody = document.getElementById('affectedAreaTableBody');
            const tfoot = document.getElementById('affectedAreaTableFooter');
            const summaryDiv = document.getElementById('affectedAreaSummary');
            const lt = document.body.classList.contains('light-theme');

            // Filter and calculate per-feature totals
            let filteredFeatures = affectedAreaData.map(f => {
                let fOrig = 0, fRem = 0, fComp = 0, taskCount = 0;
                const filteredReqs = f.reqs.map(r => {
                    const filteredTasks = r.tasks.filter(t => iterFilter === 'all' || t.iteration === iterFilter);
                    filteredTasks.forEach(t => { fOrig += t.origEst; fRem += t.rem; fComp += t.comp; });
                    taskCount += filteredTasks.length;
                    return { ...r, filteredTasks };
                }).filter(r => r.filteredTasks.length > 0);
                return { ...f, filteredReqs, fOrig, fRem, fComp, taskCount };
            }).filter(f => f.filteredReqs.length > 0);

            // Sort features
            if (affectedAreaSortCol) {
                const dir = affectedAreaSortDir === 'asc' ? 1 : -1;
                filteredFeatures.sort((a, b) => {
                    let va, vb;
                    switch (affectedAreaSortCol) {
                        case 'featureId': va = a.featureId; vb = b.featureId; break;
                        case 'featureTitle': va = a.featureTitle.toLowerCase(); vb = b.featureTitle.toLowerCase(); return va < vb ? -dir : va > vb ? dir : 0;
                        case 'featureArea': va = a.featureAreaLeaf.toLowerCase(); vb = b.featureAreaLeaf.toLowerCase(); return va < vb ? -dir : va > vb ? dir : 0;
                        case 'featureState': va = a.featureState.toLowerCase(); vb = b.featureState.toLowerCase(); return va < vb ? -dir : va > vb ? dir : 0;
                        case 'origEst': va = a.fOrig; vb = b.fOrig; break;
                        case 'rem': va = a.fRem; vb = b.fRem; break;
                        case 'comp': va = a.fComp; vb = b.fComp; break;
                        default: va = a.featureId; vb = b.featureId;
                    }
                    return ((va || 0) - (vb || 0)) * dir;
                });
            }

            // Summary
            const totTasks = filteredFeatures.reduce((s, f) => s + f.taskCount, 0);
            const totOrig = filteredFeatures.reduce((s, f) => s + f.fOrig, 0);
            const totRem = filteredFeatures.reduce((s, f) => s + f.fRem, 0);
            const totComp = filteredFeatures.reduce((s, f) => s + f.fComp, 0);
            const boxStyle = lt ? 'background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:4px 10px;font-size:0.65rem;' : 'background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:4px 10px;font-size:0.65rem;';
            const lblClr = lt ? 'color:#64748b;' : 'color:#94a3b8;';
            const valClr = lt ? 'color:#0f172a;font-weight:700;' : 'color:#e2e8f0;font-weight:700;';
            summaryDiv.innerHTML = `
                <div style="${boxStyle}"><span style="${lblClr}">Features:</span> <span style="${valClr}">${filteredFeatures.length}</span></div>
                <div style="${boxStyle}"><span style="${lblClr}">Tasks:</span> <span style="${valClr}">${totTasks}</span></div>
                <div style="${boxStyle}"><span style="${lblClr}">Orig Est:</span> <span style="color:#f97316;font-weight:700;">${fmtH(totOrig)}h</span></div>
                <div style="${boxStyle}"><span style="${lblClr}">Remaining:</span> <span style="color:#38bdf8;font-weight:700;">${fmtH(totRem)}h</span></div>
                <div style="${boxStyle}"><span style="${lblClr}">Completed:</span> <span style="color:#34d399;font-weight:700;">${fmtH(totComp)}h</span></div>
            `;

            if (filteredFeatures.length === 0) {
                document.getElementById('noAffectedAreaData').style.display = 'block';
                tbody.innerHTML = ''; tfoot.innerHTML = '';
                return;
            }
            document.getElementById('noAffectedAreaData').style.display = 'none';
            const pd = 'padding:4px 5px;';
            const tdClr = lt ? 'color:#334155;' : 'color:#cbd5e1;';
            const areaClr = lt ? 'color:#0369a1;' : 'color:#38bdf8;';
            const iterClr = lt ? 'color:#7c3aed;' : 'color:#c084fc;';
            const reqBg = lt ? 'background:rgba(99,102,241,0.06);' : 'background:rgba(99,102,241,0.08);';
            const taskBg = lt ? 'background:rgba(0,0,0,0.02);' : 'background:rgba(0,0,0,0.15);';

            let html = '';
            filteredFeatures.forEach(f => {
                const stCls = getStatePillClass(f.featureState);
                // Feature summary row
                html += `<tr style="border-top:2px solid rgba(16,185,129,0.3);cursor:pointer;" onclick="toggleAffectedAreaNode(${f.featureId})">
                    <td style="${pd}text-align:center;"><button id="aa-toggle-${f.featureId}" style="background:rgba(16,185,129,0.3);border:1px solid rgba(16,185,129,0.5);color:#6ee7b7;border-radius:4px;width:20px;height:20px;cursor:pointer;font-size:0.7rem;line-height:1;font-weight:700;">+</button></td>
                    <td style="${pd}${tdClr}font-weight:700;"><a href="${tfsUrl}/${project}/_workitems/edit/${f.featureId}" target="_blank" class="wi-link">${f.featureId}</a></td>
                    <td style="${pd}${tdClr}font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${f.featureTitle}">${f.featureTitle}</td>
                    <td style="${pd}${areaClr}font-weight:500;" title="${f.featureArea}">${f.featureAreaLeaf}</td>
                    <td style="${pd}text-align:center;"><span class="fp-state-pill ${stCls}" style="font-size:0.5rem;padding:1px 5px;">${f.featureState}</span></td>
                    <td style="${pd}text-align:center;${tdClr}font-weight:600;">${f.taskCount}</td>
                    <td style="${pd}text-align:right;color:#f97316;font-weight:700;">${fmtH(f.fOrig)}h</td>
                    <td style="${pd}text-align:right;color:#38bdf8;font-weight:700;">${fmtH(f.fRem)}h</td>
                    <td style="${pd}text-align:right;color:#34d399;font-weight:700;">${fmtH(f.fComp)}h</td>
                </tr>`;
                // Requirement rows (hidden by default, shown on feature expand)
                f.filteredReqs.forEach(r => {
                    const rOrig = r.filteredTasks.reduce((s,t) => s + t.origEst, 0);
                    const rRem = r.filteredTasks.reduce((s,t) => s + t.rem, 0);
                    const rComp = r.filteredTasks.reduce((s,t) => s + t.comp, 0);
                    const rStCls = getStatePillClass(r.reqState);
                    const hasSubTasks = r.filteredTasks.length > 0;
                    html += `<tr class="aa-req-${f.featureId}" style="display:none;${reqBg}${hasSubTasks?'cursor:pointer;':''}" ${hasSubTasks?`onclick="toggleAffectedAreaReq(${f.featureId},${r.reqId})"`:''}> 
                        <td style="${pd}text-align:center;">${hasSubTasks ? `<button id="aa-req-toggle-${f.featureId}-${r.reqId}" style="background:rgba(139,92,246,0.3);border:1px solid rgba(139,92,246,0.5);color:#c4b5fd;border-radius:4px;width:18px;height:18px;cursor:pointer;font-size:0.6rem;line-height:1;font-weight:700;">+</button>` : ''}</td>
                        <td style="${pd}padding-left:14px;${tdClr}font-weight:600;font-size:0.56rem;">
                            <span style="color:#a78bfa;">📄</span> <a href="${tfsUrl}/${project}/_workitems/edit/${r.reqId}" target="_blank" class="wi-link" style="font-size:0.58rem;" onclick="event.stopPropagation()">${r.reqId}</a>
                        </td>
                        <td colspan="2" style="${pd}${tdClr}font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.56rem;" title="${r.reqTitle}">${r.reqTitle} <span style="color:#a78bfa;font-size:0.5rem;">(${r.reqType})</span></td>
                        <td style="${pd}text-align:center;"><span class="fp-state-pill ${rStCls}" style="font-size:0.45rem;padding:1px 4px;">${r.reqState}</span></td>
                        <td style="${pd}text-align:center;${tdClr}font-size:0.55rem;">${r.filteredTasks.length}</td>
                        <td style="${pd}text-align:right;color:#f97316;font-size:0.55rem;">${fmtH(rOrig)}h</td>
                        <td style="${pd}text-align:right;color:#38bdf8;font-size:0.55rem;">${fmtH(rRem)}h</td>
                        <td style="${pd}text-align:right;color:#34d399;font-size:0.55rem;">${fmtH(rComp)}h</td>
                    </tr>`;
                    // Task rows under each Req (hidden, shown on req expand)
                    r.filteredTasks.forEach(t => {
                        const tStCls = getStatePillClass(t.taskState);
                        html += `<tr class="aa-task-${f.featureId}-${r.reqId}" style="display:none;${taskBg}">
                            <td style="${pd}"></td>
                            <td style="${pd}padding-left:28px;font-size:0.52rem;${tdClr}">
                                <a href="${tfsUrl}/${project}/_workitems/edit/${t.taskId}" target="_blank" class="wi-link" style="font-size:0.52rem;">${t.taskId}</a>
                            </td>
                            <td style="${pd}${tdClr}font-size:0.52rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${t.taskTitle}">${t.taskTitle}</td>
                            <td style="${pd}font-size:0.5rem;" title="${t.assigned}"><span style="${iterClr}">${t.iteration}</span> <span style="${tdClr}opacity:0.7;">| ${t.discipline}</span></td>
                            <td style="${pd}text-align:center;"><span class="fp-state-pill ${tStCls}" style="font-size:0.42rem;padding:0px 3px;">${t.taskState}</span></td>
                            <td style="${pd}text-align:center;font-size:0.5rem;${tdClr}" title="${t.assigned}">${t.assigned.split(' ')[0]}</td>
                            <td style="${pd}text-align:right;color:#f97316;font-size:0.52rem;">${fmtH(t.origEst)}h</td>
                            <td style="${pd}text-align:right;color:#38bdf8;font-size:0.52rem;">${fmtH(t.rem)}h</td>
                            <td style="${pd}text-align:right;color:#34d399;font-size:0.52rem;">${fmtH(t.comp)}h</td>
                        </tr>`;
                    });
                });
            });
            tbody.innerHTML = html;
            const fp = 'padding:5px 3px;';
            tfoot.innerHTML = `<tr>
                <td colspan="6" style="${fp}text-align:right;font-weight:700;${tdClr}">Totals (${filteredFeatures.length} features, ${totTasks} tasks):</td>
                <td style="${fp}text-align:right;font-weight:700;color:#f97316;">${fmtH(totOrig)}h</td>
                <td style="${fp}text-align:right;font-weight:700;color:#38bdf8;">${fmtH(totRem)}h</td>
                <td style="${fp}text-align:right;font-weight:700;color:#34d399;">${fmtH(totComp)}h</td>
            </tr>`;
        }

        function applyTabPermissions() {
            const tabNames = { 1: 'Sprint Planning', 2: 'Work Progress', 3: 'AI Usage', 4: 'AI Analytics', 5: 'Feature Progress', 6: 'Data Lookup', 7: 'Weekly Tasks' };
            const isAdmin = ['admin', 'super_admin'].includes(currentUserRole);
            [1, 2, 3, 4, 5, 6, 7].forEach(t => {
                const btn = document.getElementById('tabBtn' + t);
                if (!btn) return;
                if (currentUserTabs.includes(t)) {
                    btn.style.display = '';
                    btn.removeAttribute('title');
                } else {
                    btn.style.display = 'none';
                }
            });
            // If current visible tab is not allowed, switch to first allowed tab
            const activeTab = [1,2,3,4,5,6,7].find(t => document.getElementById('tabContent'+t)?.style.display === 'block');
            if (activeTab && !currentUserTabs.includes(activeTab)) {
                switchTab(currentUserTabs[0] || 1);
            }
            // Control admin-only features
            const updateBtn = document.getElementById('updateFeatureHoursBtn');
            if (updateBtn && !isAdmin) {
                updateBtn.style.display = 'none';
                updateBtn.setAttribute('data-role-hidden', 'true');
            }
        }

        function switchTab(tabNum) {
            // Tab permission check
            if (!currentUserTabs.includes(tabNum)) {
                return; // silently ignore
            }
            // Hide all tab contents
            document.getElementById('tabContent1').style.display = 'none';
            document.getElementById('tabContent2').style.display = 'none';
            document.getElementById('tabContent3').style.display = 'none';
            document.getElementById('tabContent4').style.display = 'none';
            document.getElementById('tabContent5').style.display = 'none';
            document.getElementById('tabContent6').style.display = 'none';
            document.getElementById('tabContent7').style.display = 'none';
            
            // Reset all tab buttons
            const inactiveStyle = 'padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;';
            const activeStyle = 'padding: 8px 16px; font-size: 0.8rem; background: rgba(59,130,246,0.3); border: 1px solid rgba(59,130,246,0.5); border-radius: 6px 6px 0 0; color: #93c5fd; cursor: pointer; transition: all 0.2s;';
            
            document.getElementById('tabBtn1').style.cssText = inactiveStyle;
            document.getElementById('tabBtn2').style.cssText = inactiveStyle;
            document.getElementById('tabBtn3').style.cssText = inactiveStyle;
            document.getElementById('tabBtn4').style.cssText = inactiveStyle;
            document.getElementById('tabBtn5').style.cssText = inactiveStyle;
            document.getElementById('tabBtn6').style.cssText = inactiveStyle;
            document.getElementById('tabBtn7').style.cssText = inactiveStyle;
            
            // Show selected tab and activate button
            document.getElementById('tabContent' + tabNum).style.display = 'block';
            document.getElementById('tabBtn' + tabNum).style.cssText = activeStyle;
        }

        function toggleBugsDashboard() {
            const btn = document.getElementById('toggleBugsBtn');
            const content = document.getElementById('bugsContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
            } else {
                content.style.display = 'none';
                btn.textContent = '📋 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }
        
        function renderBugsTable(filter) {
            const allBugs = window.allBugs || [];
            
            // Filter bugs based on selection
            let filteredBugs = allBugs;
            if (filter === 'cs') {
                filteredBugs = allBugs.filter(b => {
                    const tags = (b.fields['System.Tags'] || '').toLowerCase();
                    return tags.includes('cs');
                });
            } else if (filter === 'production') {
                filteredBugs = allBugs.filter(b => {
                    const tags = (b.fields['System.Tags'] || '').toLowerCase();
                    return tags.includes('production_bug') || tags.includes('production bug');
                });
            }
            
            // Update filter button styles
            ['all', 'cs', 'production'].forEach(f => {
                const btnId = f === 'all' ? 'bugFilterAll' : (f === 'cs' ? 'bugFilterCS' : 'bugFilterProduction');
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (f === filter) {
                        btn.style.opacity = '1';
                        btn.style.fontWeight = '700';
                        btn.style.boxShadow = '0 0 10px rgba(239,68,68,0.4)';
                    } else {
                        btn.style.opacity = '0.7';
                        btn.style.fontWeight = '400';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Update summary stats for filtered bugs
            document.getElementById('bugTotalCount').textContent = filteredBugs.length;
            document.getElementById('bugClosedCount').textContent = filteredBugs.filter(b => b.fields['System.State'] === 'Closed').length;
            document.getElementById('bugActiveCount').textContent = filteredBugs.filter(b => ['Active', 'Open', 'New'].includes(b.fields['System.State'])).length;
            document.getElementById('bugResolvedCount').textContent = filteredBugs.filter(b => b.fields['System.State'] === 'Resolved').length;
            
            // Calculate CS and Production counts for filtered
            const csCount = filteredBugs.filter(b => (b.fields['System.Tags'] || '').toLowerCase().includes('cs')).length;
            const prodCount = filteredBugs.filter(b => {
                const tags = (b.fields['System.Tags'] || '').toLowerCase();
                return tags.includes('production_bug') || tags.includes('production bug');
            }).length;
            document.getElementById('bugCSCount').textContent = csCount;
            document.getElementById('bugProductionCount').textContent = prodCount;
            
            // Render table
            const bugsBody = document.querySelector('#bugsTable tbody');
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            
            if (filteredBugs.length > 0) {
                document.getElementById('noBugs').style.display = 'none';
                bugsBody.innerHTML = filteredBugs.map(b => {
                    const state = b.fields['System.State'] || '';
                    const stateColor = state === 'Closed' ? '#34d399' : (state === 'Resolved' ? '#60a5fa' : '#fbbf24');
                    const severity = b.fields['Microsoft.VSTS.Common.Severity'] || '-';
                    const severityColor = severity.includes('1') ? '#f87171' : (severity.includes('2') ? '#fbbf24' : '#94a3b8');
                    const assignedTo = b.fields['System.AssignedTo']?.displayName || '-';
                    const assignedFirstName = assignedTo !== '-' ? assignedTo.split(' ')[0] : '-';
                    
                    // Parse tags for badges
                    const tags = (b.fields['System.Tags'] || '').split(';').map(t => t.trim()).filter(t => t);
                    const hasCS = tags.some(t => t.toLowerCase() === 'cs');
                    const hasProd = tags.some(t => t.toLowerCase().includes('production'));
                    
                    let tagBadges = '';
                    if (hasCS) tagBadges += '<span style="background:rgba(59,130,246,0.3);color:#93c5fd;padding:2px 6px;border-radius:4px;font-size:0.65rem;margin-right:4px;">🎧 CS</span>';
                    if (hasProd) tagBadges += '<span style="background:rgba(245,158,11,0.3);color:#fcd34d;padding:2px 6px;border-radius:4px;font-size:0.65rem;">🚀 Prod</span>';
                    if (!hasCS && !hasProd) tagBadges = '<span style="color:#64748b;">-</span>';
                    
                    return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${b.id}" target="_blank" class="wi-link">${b.id}</a></td>
                        <td style="${tdStyle}">${b.fields['System.Title'] || ''}</td>
                        <td style="${tdStyle}color:${stateColor};font-weight:500;">${state}</td>
                        <td style="${tdStyle}text-align:center;">${tagBadges}</td>
                        <td style="${tdStyle}color:${severityColor};">${severity}</td>
                        <td style="${tdStyle}color:#a5b4fc;" title="${assignedTo}">${assignedFirstName}</td>
                    </tr>`;
                }).join('');
            } else {
                document.getElementById('noBugs').style.display = 'block';
                bugsBody.innerHTML = '';
            }
        }
        
        function filterBugs(filter) {
            window.currentBugFilter = filter;
            renderBugsTable(filter);
        }

        // ========== DISCIPLINE vs TASK EXECUTION TYPE MISMATCH ==========
        let mismatchDataLoaded = false;
        let mismatchAllData = [];
        let mismatchSortField = 'id';
        let mismatchSortDir = 'asc';
        
        function toggleMismatchDashboard() {
            const btn = document.getElementById('toggleMismatchBtn');
            const content = document.getElementById('mismatchContent');
            const excelBtn = document.getElementById('exportMismatchExcelBtn');
            const pdfBtn = document.getElementById('exportMismatchPdfBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                excelBtn.style.display = 'inline-block';
                pdfBtn.style.display = 'inline-block';
                // Always reload data when showing to ensure fresh data after area change
                renderDisciplineMismatchTasks();
                mismatchDataLoaded = true;
            } else {
                content.style.display = 'none';
                btn.textContent = '📋 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                excelBtn.style.display = 'none';
                pdfBtn.style.display = 'none';
            }
        }

        // ==================== OVERALL AI ADOPTION SUMMARY ====================
        let overallAISummaryLoaded = false;
        
        function toggleOverallAISummary() {
            const btn = document.getElementById('loadOverallSummaryBtn');
            const content = document.getElementById('overallAISummaryContent');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!overallAISummaryLoaded) {
                    loadOverallAISummary();
                    overallAISummaryLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                overallAISummaryLoaded = false;
            }
        }
        
        function loadOverallAISummary() {
            // Valid requirement IDs: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable, Adhoc Support
            const validReqIds = new Set();
            requirements.forEach(req => {
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                if (tags.includes('deliverable') || tags.includes('deliverables adhoc') || 
                    tags.includes('deliverables onhold') || tags.includes('non-deliverable')) {
                    validReqIds.add(req.id);
                }
                if (req.isAdhocSupport) validReqIds.add(req.id);
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            
            // Accumulators
            let aiTaskCount = 0, manualTaskCount = 0, maiIneffTaskCount = 0;
            let aiOrigEst = 0, aiRevisedEst = 0, aiTotalOrigEst = 0, aiCompleted = 0;
            let maiIneffOrigEst = 0, maiIneffCompleted = 0;
            let manualOrigEst = 0, manualCompleted = 0;
            
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                const isAiType = execType.startsWith('AI-');
                const isManualType = execType === 'Manual';
                const isManualAiIneff = execType === 'Manual-AI-Ineffective';
                
                if (!isAiType && !isManualType && !isManualAiIneff) return;
                
                if (isAiType) {
                    aiTaskCount++;
                    if (revisedEst <= 0) aiOrigEst += originalEst;
                    aiRevisedEst += revisedEst;
                    aiTotalOrigEst += origEst; // Per-task: revisedEst > 0 ? revisedEst : originalEst
                    aiCompleted += compWork;
                } else if (isManualAiIneff) {
                    maiIneffTaskCount++;
                    maiIneffOrigEst += origEst;
                    maiIneffCompleted += compWork;
                } else {
                    manualTaskCount++;
                    manualOrigEst += origEst;
                    manualCompleted += compWork;
                }
            });
            
            const totalTasks = aiTaskCount + maiIneffTaskCount + manualTaskCount;
            // AI Adoption Rate = (AI hours + AI-Ineff hours) / (AI hours + AI-Ineff hours + Manual hours)
            const totalAdoptionHours = aiTotalOrigEst + maiIneffOrigEst + manualOrigEst;
            const aiAdoptionRate = totalAdoptionHours > 0 ? Math.round(((aiTotalOrigEst + maiIneffOrigEst) / totalAdoptionHours) * 100) : 0;
            
            // Use Total AI Orig Est (per-task: revised if available, else original) for efficiency
            const aiEfficiency = aiTotalOrigEst > 0 ? Math.round(((aiTotalOrigEst - aiCompleted) / aiTotalOrigEst) * 100) : 0;
            const aiHoursSaved = aiTotalOrigEst - aiCompleted;
            
            // Manual Efficiency = (Manual + AI-Ineff Orig) − (Manual + AI-Ineff Comp) / (Manual + AI-Ineff Orig)
            const manualEffDenom = manualOrigEst + maiIneffOrigEst;
            const manualEfficiency = manualEffDenom > 0 ? Math.round(((manualEffDenom - (manualCompleted + maiIneffCompleted)) / manualEffDenom) * 100) : 0;
            const manualHoursSaved = manualEffDenom - (manualCompleted + maiIneffCompleted);
            
            // Row 1 - Task Counts
            document.getElementById('oasOverallTasks').textContent = totalTasks;
            document.getElementById('oasAiTasks').textContent = aiTaskCount;
            document.getElementById('oasManualTasks').textContent = manualTaskCount;
            document.getElementById('oasMaiIneffTasks').textContent = maiIneffTaskCount;
            document.getElementById('oasAiAdoptionRate').textContent = aiAdoptionRate + '%';
            
            // Row 2 - AI Hours
            document.getElementById('oasAiOrigEst').textContent = fmtH(aiOrigEst) + 'h';
            document.getElementById('oasAiRevisedEst').textContent = fmtH(aiRevisedEst) + 'h';
            document.getElementById('oasAiTotalOrigEst').textContent = fmtH(aiTotalOrigEst) + 'h';
            document.getElementById('oasAiCompleted').textContent = fmtH(aiCompleted) + 'h';
            const aiEffEl = document.getElementById('oasAiEfficiency');
            aiEffEl.textContent = aiEfficiency + '%';
            aiEffEl.style.color = aiEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const aiSavedEl = document.getElementById('oasAiHoursSaved');
            aiSavedEl.textContent = fmtH(aiHoursSaved) + 'h';
            aiSavedEl.style.color = aiHoursSaved >= 0 ? '#f472b6' : '#f87171';
            
            // Row 3 - Manual Hours
            document.getElementById('oasManualOrigEst').textContent = fmtH(manualOrigEst) + 'h';
            document.getElementById('oasManualCompleted').textContent = fmtH(manualCompleted) + 'h';
            
            // MAI-Ineff Hours
            document.getElementById('oasMaiIneffOrigEst').textContent = fmtH(maiIneffOrigEst) + 'h';
            document.getElementById('oasMaiIneffCompleted').textContent = fmtH(maiIneffCompleted) + 'h';
            const maiIneffEfficiency = maiIneffOrigEst > 0 ? Math.round(((maiIneffOrigEst - maiIneffCompleted) / maiIneffOrigEst) * 100) : 0;
            const maiIneffHoursSaved = maiIneffOrigEst - maiIneffCompleted;
            const maiIneffEffEl = document.getElementById('oasMaiIneffEfficiency');
            maiIneffEffEl.textContent = maiIneffEfficiency + '%';
            maiIneffEffEl.style.color = maiIneffEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const maiIneffSavedEl = document.getElementById('oasMaiIneffHoursSaved');
            maiIneffSavedEl.textContent = fmtH(maiIneffHoursSaved) + 'h';
            maiIneffSavedEl.style.color = maiIneffHoursSaved >= 0 ? '#f472b6' : '#f87171';
            const manEffEl = document.getElementById('oasManualEfficiency');
            manEffEl.textContent = manualEfficiency + '%';
            manEffEl.style.color = manualEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const manSavedEl = document.getElementById('oasManualHoursSaved');
            manSavedEl.textContent = fmtH(manualHoursSaved) + 'h';
            manSavedEl.style.color = manualHoursSaved >= 0 ? '#f472b6' : '#f87171';
        }

        // ========== DEV OVERALL AI ADOPTION SUMMARY ==========
        let devOverallAISummaryLoaded = false;
        
        function toggleDevOverallAISummary() {
            const btn = document.getElementById('loadDevOverallSummaryBtn');
            const content = document.getElementById('devOverallAISummaryContent');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!devOverallAISummaryLoaded) {
                    loadDisciplineOverallAISummary('Development', 'devOas');
                    devOverallAISummaryLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                devOverallAISummaryLoaded = false;
            }
        }
        
        // ========== QA OVERALL AI ADOPTION SUMMARY ==========
        let qaOverallAISummaryLoaded = false;
        
        function toggleQAOverallAISummary() {
            const btn = document.getElementById('loadQAOverallSummaryBtn');
            const content = document.getElementById('qaOverallAISummaryContent');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!qaOverallAISummaryLoaded) {
                    loadDisciplineOverallAISummary('Test', 'qaOas');
                    qaOverallAISummaryLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                qaOverallAISummaryLoaded = false;
            }
        }
        
        // ========== SHARED DISCIPLINE-FILTERED OVERALL AI SUMMARY LOADER ==========
        function loadDisciplineOverallAISummary(disciplineFilter, prefix) {
            // Valid requirement IDs: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable, Adhoc Support
            const validReqIds = new Set();
            requirements.forEach(req => {
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                if (tags.includes('deliverable') || tags.includes('deliverables adhoc') || 
                    tags.includes('deliverables onhold') || tags.includes('non-deliverable')) {
                    validReqIds.add(req.id);
                }
                if (req.isAdhocSupport) validReqIds.add(req.id);
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            
            // Accumulators
            let aiTaskCount = 0, manualTaskCount = 0, maiIneffTaskCount = 0;
            let aiOrigEst = 0, aiRevisedEst = 0, aiTotalOrigEst = 0, aiCompleted = 0;
            let maiIneffOrigEst = 0, maiIneffCompleted = 0;
            let manualOrigEst = 0, manualCompleted = 0;
            
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                // Discipline filter
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                if (discipline !== disciplineFilter) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                const isAiType = execType.startsWith('AI-');
                const isManualType = execType === 'Manual';
                const isManualAiIneff = execType === 'Manual-AI-Ineffective';
                
                if (!isAiType && !isManualType && !isManualAiIneff) return;
                
                if (isAiType) {
                    aiTaskCount++;
                    if (revisedEst <= 0) aiOrigEst += originalEst;
                    aiRevisedEst += revisedEst;
                    aiTotalOrigEst += origEst;
                    aiCompleted += compWork;
                } else if (isManualAiIneff) {
                    maiIneffTaskCount++;
                    maiIneffOrigEst += origEst;
                    maiIneffCompleted += compWork;
                } else {
                    manualTaskCount++;
                    manualOrigEst += origEst;
                    manualCompleted += compWork;
                }
            });
            
            const totalTasks = aiTaskCount + maiIneffTaskCount + manualTaskCount;
            const totalAdoptionHours = aiTotalOrigEst + maiIneffOrigEst + manualOrigEst;
            const aiAdoptionRate = totalAdoptionHours > 0 ? Math.round(((aiTotalOrigEst + maiIneffOrigEst) / totalAdoptionHours) * 100) : 0;
            
            const aiEfficiency = aiTotalOrigEst > 0 ? Math.round(((aiTotalOrigEst - aiCompleted) / aiTotalOrigEst) * 100) : 0;
            const aiHoursSaved = aiTotalOrigEst - aiCompleted;
            
            const manualEffDenom = manualOrigEst + maiIneffOrigEst;
            const manualEfficiency = manualEffDenom > 0 ? Math.round(((manualEffDenom - (manualCompleted + maiIneffCompleted)) / manualEffDenom) * 100) : 0;
            const manualHoursSaved = manualEffDenom - (manualCompleted + maiIneffCompleted);
            
            // Row 1 - Task Counts
            document.getElementById(prefix + 'OverallTasks').textContent = totalTasks;
            document.getElementById(prefix + 'AiTasks').textContent = aiTaskCount;
            document.getElementById(prefix + 'ManualTasks').textContent = manualTaskCount;
            document.getElementById(prefix + 'MaiIneffTasks').textContent = maiIneffTaskCount;
            document.getElementById(prefix + 'AiAdoptionRate').textContent = aiAdoptionRate + '%';
            
            // Row 2 - AI Hours
            document.getElementById(prefix + 'AiOrigEst').textContent = fmtH(aiOrigEst) + 'h';
            document.getElementById(prefix + 'AiRevisedEst').textContent = fmtH(aiRevisedEst) + 'h';
            document.getElementById(prefix + 'AiTotalOrigEst').textContent = fmtH(aiTotalOrigEst) + 'h';
            document.getElementById(prefix + 'AiCompleted').textContent = fmtH(aiCompleted) + 'h';
            const aiEffEl = document.getElementById(prefix + 'AiEfficiency');
            aiEffEl.textContent = aiEfficiency + '%';
            aiEffEl.style.color = aiEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const aiSavedEl = document.getElementById(prefix + 'AiHoursSaved');
            aiSavedEl.textContent = fmtH(aiHoursSaved) + 'h';
            aiSavedEl.style.color = aiHoursSaved >= 0 ? '#f472b6' : '#f87171';
            
            // Row 3 - MAI-Ineff Hours
            document.getElementById(prefix + 'MaiIneffOrigEst').textContent = fmtH(maiIneffOrigEst) + 'h';
            document.getElementById(prefix + 'MaiIneffCompleted').textContent = fmtH(maiIneffCompleted) + 'h';
            const maiIneffEfficiency = maiIneffOrigEst > 0 ? Math.round(((maiIneffOrigEst - maiIneffCompleted) / maiIneffOrigEst) * 100) : 0;
            const maiIneffHoursSaved = maiIneffOrigEst - maiIneffCompleted;
            const maiIneffEffEl = document.getElementById(prefix + 'MaiIneffEfficiency');
            maiIneffEffEl.textContent = maiIneffEfficiency + '%';
            maiIneffEffEl.style.color = maiIneffEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const maiIneffSavedEl = document.getElementById(prefix + 'MaiIneffHoursSaved');
            maiIneffSavedEl.textContent = fmtH(maiIneffHoursSaved) + 'h';
            maiIneffSavedEl.style.color = maiIneffHoursSaved >= 0 ? '#f472b6' : '#f87171';
            
            // Row 4 - Manual Hours
            document.getElementById(prefix + 'ManualOrigEst').textContent = fmtH(manualOrigEst) + 'h';
            document.getElementById(prefix + 'ManualCompleted').textContent = fmtH(manualCompleted) + 'h';
            const manEffEl = document.getElementById(prefix + 'ManualEfficiency');
            manEffEl.textContent = manualEfficiency + '%';
            manEffEl.style.color = manualEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const manSavedEl = document.getElementById(prefix + 'ManualHoursSaved');
            manSavedEl.textContent = fmtH(manualHoursSaved) + 'h';
            manSavedEl.style.color = manualHoursSaved >= 0 ? '#f472b6' : '#f87171';
        }

        // ========== AI ADOPTION DATA ==========
        let aiAdoptionDataLoaded = false;
        
        function toggleAIAdoptionData() {
            const btn = document.getElementById('loadAIAdoptionBtn');
            const content = document.getElementById('aiAdoptionContent');
            const exportBtn = document.getElementById('exportAIAdoptionBtn');
            const exportPdfBtn = document.getElementById('exportAIAdoptionPdfBtn');
            
            // Toggle between Load and Unload
            if (content.style.display === 'none' || content.style.display === '') {
                // Load/Show content
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                exportBtn.style.display = 'inline-block';
                exportPdfBtn.style.display = 'inline-block';
                
                if (!aiAdoptionDataLoaded) {
                    renderAIAdoptionData();
                    aiAdoptionDataLoaded = true;
                }
            } else {
                // Unload/Hide content
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                exportBtn.style.display = 'none';
                exportPdfBtn.style.display = 'none';
            }
        }
        
        // Toggle functions for summary tables
        function toggleMemberSummary() {
            const content = document.getElementById('memberSummaryContent');
            const btn = document.getElementById('toggleMemberSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleAreaSummary() {
            const content = document.getElementById('areaSummaryContent');
            const btn = document.getElementById('toggleAreaSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleProjectSummary() {
            const content = document.getElementById('projectSummaryContent');
            const btn = document.getElementById('toggleProjectSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function renderAIAdoptionData() {
            // Get Development members from capacity data
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable' || req.isAdhocSupport) {
                    validReqIds.add(req.id);
                }
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => {
                const tags = (b.fields['System.Tags'] || '').toLowerCase();
                if (tags.includes('adhoc support')) {
                    validReqIds.add(b.id);
                }
            });
            
            const completedStates = ['resolved', 'closed'];
            
            const validTasks = tasks.filter(t => {
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;
                
                const state = (t.fields['System.State'] || '').toLowerCase();
                const reason = (t.fields['System.Reason'] || '').toLowerCase();
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                return completedStates.includes(state) && 
                       reason !== 'rejected' && 
                       origEst > 0;
            });
            
            // Calculate sprint week for each task based on StateChangeDate
            validTasks.forEach(t => {
                if (t._sprintWeek === undefined) {
                    t._sprintWeek = getSprintWeek(t);
                }
            });

            // Pre-count dev tasks per week for filter buttons (before week filter)
            const devExecCheck = validTasks.filter(t => {
                const disc = (t.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase();
                const et = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                return disc.includes('development') && (et.startsWith('AI-Dev') || et.startsWith('AI-Test-Auto-') || et === 'Manual' || et === 'Manual-AI-Ineffective');
            });
            const weekCounts = {};
            devExecCheck.forEach(t => { if (t._sprintWeek) weekCounts[t._sprintWeek] = (weekCounts[t._sprintWeek] || 0) + 1; });
            const weekTagKeys = ['week1','week2','week3','week4'].filter(w => weekCounts[w]);
            const weekFilterBarEl = document.getElementById('aiWeekFilterBar');
            const weekFilterBtnsEl = document.getElementById('aiWeekFilterBtns');
            if (weekTagKeys.length > 0 && weekFilterBarEl && weekFilterBtnsEl) {
                weekFilterBarEl.style.display = 'block';
                const wLabels = { week1: 'Week 1', week2: 'Week 2', week3: 'Week 3', week4: 'Week 4' };
                const wRgb = { week1: '59,130,246', week2: '16,185,129', week3: '245,158,11', week4: '236,72,153' };
                const wClr = { week1: '#93c5fd', week2: '#6ee7b7', week3: '#fcd34d', week4: '#f9a8d4' };
                const wBtnS = 'padding:3px 10px;border-radius:4px;font-size:0.65rem;cursor:pointer;border:1px solid;transition:all 0.2s;';
                weekFilterBtnsEl.innerHTML = `<button onclick="filterAIAdoptionByWeek('All')" style="${wBtnS}background:${aiAdoptionWeekFilter==='All'?'rgba(139,92,246,0.5)':'rgba(255,255,255,0.08)'};border-color:${aiAdoptionWeekFilter==='All'?'rgba(139,92,246,0.7)':'rgba(255,255,255,0.15)'};color:${aiAdoptionWeekFilter==='All'?'#c4b5fd':'#94a3b8'};">All (${devExecCheck.length})</button>` +
                    weekTagKeys.map(wt => {
                        const isAct = aiAdoptionWeekFilter === wt;
                        const rgb = wRgb[wt] || '100,116,139';
                        const clr = wClr[wt] || '#94a3b8';
                        return `<button onclick="filterAIAdoptionByWeek('${wt}')" style="${wBtnS}background:${isAct?`rgba(${rgb},0.5)`:'rgba(255,255,255,0.08)'};border-color:${isAct?`rgba(${rgb},0.7)`:'rgba(255,255,255,0.15)'};color:${isAct?clr:'#94a3b8'};">${wLabels[wt]||wt} (${weekCounts[wt]})</button>`;
                    }).join('');
            } else if (weekFilterBarEl) {
                weekFilterBarEl.style.display = 'none';
            }
            
            // Build member data map from capacity data
            const memberDataMap = {};
            devMembers.forEach(m => {
                memberDataMap[m.name.toLowerCase().trim()] = {
                    name: m.name,
                    project: m.project || '-',
                    team: m.team || '-',
                    taskCount: 0,
                    claudeAiCount: 0, copilotCount: 0, manualCount: 0,
                    totalOrigEst: 0, totalCompleted: 0,
                    aiOrigEst: 0, aiCompleted: 0,
                    manualOrigEst: 0, manualCompleted: 0,
                    manualAiIneffCount: 0, manualAiIneffOrigEst: 0, manualAiIneffCompleted: 0,
                    _tasks: [], _claudeTasks: [], _copilotTasks: [], _manualTasks: [], _aiIneffTasks: []
                };
            });
            
            // Also add members from task assignments who might not be in capacity data
            validTasks.forEach(t => {
                const assignedTo = t.fields['System.AssignedTo']?.displayName || '';
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const completed = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                // Check for Claude AI tag with flexible matching (Claude AI, ClaudeAI, Claude-AI, etc.)
                const hasClaudeAiTag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // Check if execution type starts with AI-Dev or AI-Test-Auto-
                const isAiType = execType.startsWith('AI-Dev') || execType.startsWith('AI-Test-Auto-');
                const isManualType = execType === 'Manual';
                const isManualAiIneff = execType === 'Manual-AI-Ineffective';
                
                // Only count if execution type is AI-Dev* or AI-Test-Auto-* or Manual or Manual-AI-Ineffective
                if (!isAiType && !isManualType && !isManualAiIneff) return;
                
                // Only count Development discipline tasks
                if (!discipline.toLowerCase().includes('development')) return;
                
                // Apply week filter
                if (aiAdoptionWeekFilter !== 'All' && t._sprintWeek !== aiAdoptionWeekFilter) return;
                
                // Match to member - use full name matching (not just first name)
                const assignedToLower = assignedTo.toLowerCase().trim();
                
                // First try to find existing member
                let memberKey = Object.keys(memberDataMap).find(nameLower => {
                    // Full name matching - check if one contains the other
                    return assignedToLower.includes(nameLower) || nameLower.includes(assignedToLower);
                });
                
                // If member not found in capacity data, add them from task assignment
                // This handles cases where member doesn't have capacity set but has tasks
                if (!memberKey && assignedTo) {
                    memberKey = assignedToLower;
                    const taskAreaPath = t.fields['System.AreaPath'] || '';
                    const taskProject = taskAreaPath.split('\\')[0] || '-';
                    const taskTeam = taskAreaPath.split('\\')[1] || '-';
                    memberDataMap[memberKey] = {
                        name: assignedTo, project: taskProject, team: taskTeam,
                        taskCount: 0, claudeAiCount: 0, copilotCount: 0, manualCount: 0,
                        totalOrigEst: 0, totalCompleted: 0,
                        aiOrigEst: 0, aiCompleted: 0,
                        manualOrigEst: 0, manualCompleted: 0,
                        manualAiIneffCount: 0, manualAiIneffOrigEst: 0, manualAiIneffCompleted: 0,
                        _tasks: [], _claudeTasks: [], _copilotTasks: [], _manualTasks: [], _aiIneffTasks: []
                    };
                }
                
                if (memberKey) {
                    const memberData = memberDataMap[memberKey];
                    memberData.taskCount++;
                    memberData._tasks.push(t);
                    
                    // Count Claude AI vs Copilot vs Manual tasks
                    if (isAiType && hasClaudeAiTag) {
                        memberData.claudeAiCount++;
                        memberData._claudeTasks.push(t);
                    } else if (isAiType && !hasClaudeAiTag) {
                        memberData.copilotCount++;
                        memberData._copilotTasks.push(t);
                    }
                    
                    if (isManualType) {
                        memberData.manualCount++;
                        memberData._manualTasks.push(t);
                    }
                    
                    if (isManualAiIneff) {
                        memberData.manualAiIneffCount++;
                        memberData._aiIneffTasks.push(t);
                    }
                    
                    memberData.totalOrigEst += origEst;
                    memberData.totalCompleted += completed;
                    
                    if (isAiType) {
                        memberData.aiOrigEst += origEst;
                        memberData.aiCompleted += completed;
                    } else if (isManualType) {
                        memberData.manualOrigEst += origEst;
                        memberData.manualCompleted += completed;
                    } else if (isManualAiIneff) {
                        memberData.manualAiIneffOrigEst += origEst;
                        memberData.manualAiIneffCompleted += completed;
                    }
                }
            });
            
            // Convert to array and filter members with tasks
            const memberResults = Object.values(memberDataMap).filter(m => m.taskCount > 0);
            
            // Calculate grand totals
            let grandTotalOrigEst = 0, grandTotalCompleted = 0;
            let grandAiOrigEst = 0, grandAiCompleted = 0;
            let grandManualOrigEst = 0, grandManualCompleted = 0;
            let grandManualAiIneffOrigEst = 0, grandManualAiIneffCompleted = 0;
            
            memberResults.forEach(m => {
                grandTotalOrigEst += m.totalOrigEst;
                grandTotalCompleted += m.totalCompleted;
                grandAiOrigEst += m.aiOrigEst;
                grandAiCompleted += m.aiCompleted;
                grandManualOrigEst += m.manualOrigEst;
                grandManualCompleted += m.manualCompleted;
                grandManualAiIneffOrigEst += m.manualAiIneffOrigEst;
                grandManualAiIneffCompleted += m.manualAiIneffCompleted;
            });
            
            // Calculate efficiencies — Manual Eff = (Manual + AI-Ineff Orig − Comp) / (Manual + AI-Ineff Orig)
            const devGrandManEffDenom = grandManualOrigEst + grandManualAiIneffOrigEst;
            const manualEfficiency = devGrandManEffDenom > 0 ? Math.round(((devGrandManEffDenom - (grandManualCompleted + grandManualAiIneffCompleted)) / devGrandManEffDenom) * 100) : 0;
            const aiEfficiency = grandAiOrigEst > 0 ? Math.round(((grandAiOrigEst - grandAiCompleted) / grandAiOrigEst) * 100) : 0;
            
            // AI Adoption = hours based: (AI OrigEst + AI-Ineff OrigEst) / (AI + AI-Ineff + Manual) OrigEst
            const totalAdoptHours = grandAiOrigEst + grandManualAiIneffOrigEst + grandManualOrigEst;
            const grandAiAdoptionRate = totalAdoptHours > 0 ? Math.round(((grandAiOrigEst + grandManualAiIneffOrigEst) / totalAdoptHours) * 100) : 0;
            
            // Update summary stats
            document.getElementById('aiDevMemberCount').textContent = memberResults.length;
            document.getElementById('aiTotalTasks').textContent = memberResults.reduce((sum, m) => sum + m.taskCount, 0);
            document.getElementById('aiTotalOrigEst').textContent = fmtH(grandTotalOrigEst) + 'h';
            document.getElementById('aiTotalCompleted').textContent = fmtH(grandTotalCompleted) + 'h';
            document.getElementById('aiManualEfficiency').textContent = manualEfficiency + '%';
            document.getElementById('aiAIEfficiency').textContent = aiEfficiency + '%';
            document.getElementById('aiAIAdoptionRate').textContent = grandAiAdoptionRate + '%';
            
            // Color efficiency values
            const manualEffEl = document.getElementById('aiManualEfficiency');
            const aiEffEl = document.getElementById('aiAIEfficiency');
            const aiAdoptEl = document.getElementById('aiAIAdoptionRate');
            manualEffEl.style.color = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            aiEffEl.style.color = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            aiAdoptEl.style.color = '#60a5fa';
            
            const thead = document.getElementById('aiAdoptionTableHead');
            const tbody = document.getElementById('aiAdoptionTableBody');
            const tfoot = document.getElementById('aiAdoptionTableFoot');
            
            if (memberResults.length === 0) {
                document.getElementById('noAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noAIAdoptionData').style.display = 'none';
            
            // Store member results globally for sorting
            aiAdoptionMemberData = memberResults.map((m, _i) => {
                // AI Adoption = hours based: (AI OrigEst + AI-Ineff OrigEst) / (AI + AI-Ineff + Manual) OrigEst
                const mTotalHours = m.aiOrigEst + m.manualAiIneffOrigEst + m.manualOrigEst;
                const mAiAdoption = mTotalHours > 0 ? Math.round(((m.aiOrigEst + m.manualAiIneffOrigEst) / mTotalHours) * 100) : 0;
                // Manual Eff = (Manual + AI-Ineff Orig - Comp) / (Manual + AI-Ineff Orig)
                const mManualEff = (m.manualOrigEst + m.manualAiIneffOrigEst) > 0 ? Math.round((((m.manualOrigEst + m.manualAiIneffOrigEst) - (m.manualCompleted + m.manualAiIneffCompleted)) / (m.manualOrigEst + m.manualAiIneffOrigEst)) * 100) : 0;
                const mAiEff = m.aiOrigEst > 0 ? Math.round(((m.aiOrigEst - m.aiCompleted) / m.aiOrigEst) * 100) : 0;
                const mHourSaved = m.aiOrigEst - m.aiCompleted;
                return { ...m, _idx: _i, aiAdoption: mAiAdoption, manualEff: mManualEff, aiEff: mAiEff, hourSaved: mHourSaved };
            });
            
            // Store grand totals globally
            aiAdoptionGrandTotals = {
                grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted,
                grandManualAiIneffOrigEst, grandManualAiIneffCompleted,
                manualEfficiency, aiEfficiency
            };
            
            // Build area filter buttons
            const uniqueAreas = [...new Set(aiAdoptionMemberData.map(m => m.team))].sort();
            const filterBar = document.getElementById('aiAreaFilterBar');
            const filterBtns = document.getElementById('aiAreaFilterBtns');
            if (uniqueAreas.length > 1 && filterBar && filterBtns) {
                filterBar.style.display = 'block';
                const btnStyle = 'padding:3px 10px;border-radius:4px;font-size:0.65rem;cursor:pointer;border:1px solid;transition:all 0.2s;';
                filterBtns.innerHTML = `<button onclick="filterAIAdoptionByArea('All')" style="${btnStyle}background:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.5)':'rgba(255,255,255,0.08)'};border-color:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.7)':'rgba(255,255,255,0.15)'};color:${aiAdoptionAreaFilter==='All'?'#c4b5fd':'#94a3b8'};">All (${aiAdoptionMemberData.length})</button>` +
                    uniqueAreas.map(area => {
                        const count = aiAdoptionMemberData.filter(m => m.team === area).length;
                        const isActive = aiAdoptionAreaFilter === area;
                        return `<button onclick="filterAIAdoptionByArea('${area.replace(/'/g, "\\'")}')" style="${btnStyle}background:${isActive?'rgba(6,182,212,0.5)':'rgba(255,255,255,0.08)'};border-color:${isActive?'rgba(6,182,212,0.7)':'rgba(255,255,255,0.15)'};color:${isActive?'#67e8f9':'#94a3b8'};">${area} (${count})</button>`;
                    }).join('');
            } else if (filterBar) {
                filterBar.style.display = 'none';
            }
            
            // Header row 1: With sortable columns
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => aiAdoptionSortField === field ? (aiAdoptionSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortAIAdoptionTable('manualAiIneffCount')">AI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(139,92,246,0.25);color:#c4b5fd;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">AI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Header row 2: Orig/Comp subheaders with sorting
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            // Render table rows
            renderAIAdoptionTableRows();
        }
        
        function filterAIAdoptionByArea(area) {
            aiAdoptionAreaFilter = area;
            // Re-render area buttons and table
            const uniqueAreas = [...new Set(aiAdoptionMemberData.map(m => m.team))].sort();
            const filterBtns = document.getElementById('aiAreaFilterBtns');
            if (filterBtns) {
                const btnStyle = 'padding:3px 10px;border-radius:4px;font-size:0.65rem;cursor:pointer;border:1px solid;transition:all 0.2s;';
                filterBtns.innerHTML = `<button onclick="filterAIAdoptionByArea('All')" style="${btnStyle}background:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.5)':'rgba(255,255,255,0.08)'};border-color:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.7)':'rgba(255,255,255,0.15)'};color:${aiAdoptionAreaFilter==='All'?'#c4b5fd':'#94a3b8'};">All (${aiAdoptionMemberData.length})</button>` +
                    uniqueAreas.map(a => {
                        const count = aiAdoptionMemberData.filter(m => m.team === a).length;
                        const isActive = aiAdoptionAreaFilter === a;
                        return `<button onclick="filterAIAdoptionByArea('${a.replace(/'/g, "\\'")}')" style="${btnStyle}background:${isActive?'rgba(6,182,212,0.5)':'rgba(255,255,255,0.08)'};border-color:${isActive?'rgba(6,182,212,0.7)':'rgba(255,255,255,0.15)'};color:${isActive?'#67e8f9':'#94a3b8'};">${a} (${count})</button>`;
                    }).join('');
            }
            renderAIAdoptionTableRows();
        }
        
        function filterAIAdoptionByWeek(week) {
            aiAdoptionWeekFilter = week;
            renderAIAdoptionData();
        }
        
        // Separate function to render AI Adoption table rows (for sorting)
        function renderAIAdoptionTableRows() {
            const tbody = document.getElementById('aiAdoptionTableBody');
            const tfoot = document.getElementById('aiAdoptionTableFoot');
            
            // Filter by area then sort
            const filteredData = aiAdoptionAreaFilter === 'All' ? aiAdoptionMemberData : aiAdoptionMemberData.filter(m => m.team === aiAdoptionAreaFilter);
            const sortedData = [...filteredData].sort((a, b) => {
                let aVal = a[aiAdoptionSortField];
                let bVal = b[aiAdoptionSortField];
                
                // Handle string comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }
                
                // Handle null/undefined
                if (aVal === null || aVal === undefined) aVal = aiAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = aiAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                
                if (aVal < bVal) return aiAdoptionSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return aiAdoptionSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            const tdStyle = 'padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.8rem;';
            const clickS = 'cursor:pointer;text-decoration:underline;text-underline-offset:2px;';
            tbody.innerHTML = sortedData.map((m, idx) => {
                const mHourSavedColor = m.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const mManualEffColor = m.manualEff >= 0 ? '#34d399' : '#f87171';
                const mAiEffColor = m.aiEff >= 0 ? '#34d399' : '#f87171';
                const mTotalOrig = m.aiOrigEst + m.manualAiIneffOrigEst;
                const mi = m._idx;
                
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;white-space:nowrap;">${m.name}</td>
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-size:0.7rem;">${m.project}</td>
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-size:0.7rem;">${m.team}</td>
                    <td style="${tdStyle}text-align:center;${clickS}" onclick="showAiAdoptionTaskPopup(${mi},'all')" title="View all tasks">${m.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;${m.claudeAiCount>0?clickS:''}" ${m.claudeAiCount>0?`onclick="showAiAdoptionTaskPopup(${mi},'claude')" title="View Claude tasks"`:``}>${m.claudeAiCount > 0 ? m.claudeAiCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;${m.copilotCount>0?clickS:''}" ${m.copilotCount>0?`onclick="showAiAdoptionTaskPopup(${mi},'copilot')" title="View Copilot tasks"`:``}>${m.copilotCount > 0 ? m.copilotCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;${m.manualAiIneffCount>0?clickS:''}" ${m.manualAiIneffCount>0?`onclick="showAiAdoptionTaskPopup(${mi},'aiIneff')" title="View AI-Ineff tasks"`:``}>${m.manualAiIneffCount > 0 ? m.manualAiIneffCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;${m.manualCount>0?clickS:''}" ${m.manualCount>0?`onclick="showAiAdoptionTaskPopup(${mi},'manual')" title="View Manual tasks"`:``}>${m.manualCount > 0 ? m.manualCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.aiOrigEst > 0 ? fmtH(m.aiOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.aiCompleted > 0 ? fmtH(m.aiCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${m.manualAiIneffOrigEst > 0 ? fmtH(m.manualAiIneffOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${m.manualAiIneffCompleted > 0 ? fmtH(m.manualAiIneffCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.manualOrigEst > 0 ? fmtH(m.manualOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.manualCompleted > 0 ? fmtH(m.manualCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${m.aiAdoption + '%'}</td>
                    <td style="${tdStyle}text-align:center;color:${mManualEffColor};font-weight:600;">${(m.manualOrigEst + m.manualAiIneffOrigEst) > 0 ? m.manualEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mAiEffColor};font-weight:600;">${m.aiOrigEst > 0 ? m.aiEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mHourSavedColor};font-weight:600;">${m.aiOrigEst > 0 ? fmtH(m.hourSaved) + 'h' : '-'}</td>
                </tr>`;
            }).join('');
            
            // Footer totals row - recalculate from filtered data
            let grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency;
            if (aiAdoptionAreaFilter === 'All') {
                ({ grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency } = aiAdoptionGrandTotals);
            } else {
                grandAiOrigEst = filteredData.reduce((s,m) => s + m.aiOrigEst, 0);
                grandAiCompleted = filteredData.reduce((s,m) => s + m.aiCompleted, 0);
                grandManualOrigEst = filteredData.reduce((s,m) => s + m.manualOrigEst, 0);
                grandManualCompleted = filteredData.reduce((s,m) => s + m.manualCompleted, 0);
                grandManualAiIneffOrigEst = filteredData.reduce((s,m) => s + m.manualAiIneffOrigEst, 0);
                grandManualAiIneffCompleted = filteredData.reduce((s,m) => s + m.manualAiIneffCompleted, 0);
                const footManEffDenom = grandManualOrigEst + grandManualAiIneffOrigEst;
                manualEfficiency = footManEffDenom > 0 ? Math.round(((footManEffDenom - (grandManualCompleted + grandManualAiIneffCompleted)) / footManEffDenom) * 100) : 0;
                aiEfficiency = grandAiOrigEst > 0 ? Math.round(((grandAiOrigEst - grandAiCompleted) / grandAiOrigEst) * 100) : 0;
            }
            const totalTasks = filteredData.reduce((sum, m) => sum + m.taskCount, 0);
            const totalClaudeAi = filteredData.reduce((sum, m) => sum + m.claudeAiCount, 0);
            const totalCopilot = filteredData.reduce((sum, m) => sum + m.copilotCount, 0);
            const totalManual = filteredData.reduce((sum, m) => sum + m.manualCount, 0);
            const totalManualAiIneff = filteredData.reduce((sum, m) => sum + m.manualAiIneffCount, 0);
            const tfStyle = 'padding:10px 8px;border-top:2px solid rgba(139,92,246,0.4);font-size:0.8rem;';
            const footManualEffColor = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            const footAiEffColor = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            
            // Calculate overall AI Adoption = hours based: (AI + AI-Ineff) OrigEst / (AI + AI-Ineff + Manual) OrigEst
            const footTotalHours = grandAiOrigEst + grandManualAiIneffOrigEst + grandManualOrigEst;
            const grandAiAdoption = footTotalHours > 0 ? Math.round(((grandAiOrigEst + grandManualAiIneffOrigEst) / footTotalHours) * 100) : 0;
            
            // Calculate total Hour Saved
            const grandHourSaved = grandAiOrigEst - grandAiCompleted;
            const footHourSavedColor = grandHourSaved >= 0 ? '#f472b6' : '#f87171';
            
            // Only Grand Total in main table footer
            tfoot.innerHTML = `<tr>
                <td colspan="3" style="${tfStyle}text-align:right;color:#e2e8f0;font-weight:700;">Grand Total:</td>
                <td style="${tfStyle}text-align:center;color:#e2e8f0;font-weight:700;">${totalTasks}</td>
                <td style="${tfStyle}text-align:center;color:#c4b5fd;font-weight:700;">${totalClaudeAi}</td>
                <td style="${tfStyle}text-align:center;color:#22d3ee;font-weight:700;">${totalCopilot}</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${totalManualAiIneff}</td>
                <td style="${tfStyle}text-align:center;color:#fcd34d;font-weight:700;">${totalManual}</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandAiOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandAiCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${fmtH(grandManualAiIneffOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#fb7185;font-weight:700;">${fmtH(grandManualAiIneffCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandManualOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandManualCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#60a5fa;font-weight:700;">${grandAiAdoption}%</td>
                <td style="${tfStyle}text-align:center;color:${footManualEffColor};font-weight:700;">${manualEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footAiEffColor};font-weight:700;">${aiEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footHourSavedColor};font-weight:700;">${fmtH(grandHourSaved)}h</td>
            </tr>`;
            
            // Render Area-wise Summary Table
            renderAreaSummaryTable();
            
            // Render Project-wise Summary Table
            renderProjectSummaryTable();
        }
        
        // Render Area-wise Summary Table
        function renderAreaSummaryTable() {
            const areaSummarySection = document.getElementById('areaSummarySection');
            const areaSummaryHead = document.getElementById('areaSummaryHead');
            const areaSummaryBody = document.getElementById('areaSummaryBody');
            
            if (!aiAdoptionMemberData || aiAdoptionMemberData.length === 0) {
                areaSummarySection.style.display = 'none';
                return;
            }
            
            areaSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const areaSummaryContent = document.getElementById('areaSummaryContent');
            const toggleAreaBtn = document.getElementById('toggleAreaSummaryBtn');
            if (areaSummaryContent) areaSummaryContent.style.display = '';
            if (toggleAreaBtn) toggleAreaBtn.textContent = 'Hide';
            
            // Group by area
            const areaTotals = {};
            aiAdoptionMemberData.forEach(m => {
                const area = m.team || '-';
                if (!areaTotals[area]) {
                    areaTotals[area] = {
                        area: area,
                        project: m.project || '-',
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                areaTotals[area].taskCount += m.taskCount;
                areaTotals[area].claudeAiCount += m.claudeAiCount;
                areaTotals[area].copilotCount += m.copilotCount;
                areaTotals[area].manualAiIneffCount += m.manualAiIneffCount;
                areaTotals[area].manualCount += m.manualCount;
                areaTotals[area].aiOrigEst += m.aiOrigEst;
                areaTotals[area].aiCompleted += m.aiCompleted;
                areaTotals[area].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                areaTotals[area].manualAiIneffCompleted += m.manualAiIneffCompleted;
                areaTotals[area].manualOrigEst += m.manualOrigEst;
                areaTotals[area].manualCompleted += m.manualCompleted;
            });
            
            // Calculate derived fields for sorting
            areaSummaryData = Object.values(areaTotals).map(a => {
                const totalOrig = a.aiOrigEst + a.manualAiIneffOrigEst + a.manualOrigEst;
                return {
                    ...a,
                    aiAdoption: totalOrig > 0 ? Math.round(((a.aiOrigEst + a.manualAiIneffOrigEst) / totalOrig) * 100) : 0,
                    manualEff: (a.manualOrigEst + a.manualAiIneffOrigEst) > 0 ? Math.round((((a.manualOrigEst + a.manualAiIneffOrigEst) - (a.manualCompleted + a.manualAiIneffCompleted)) / (a.manualOrigEst + a.manualAiIneffOrigEst)) * 100) : 0,
                    aiEff: a.aiOrigEst > 0 ? Math.round(((a.aiOrigEst - a.aiCompleted) / a.aiOrigEst) * 100) : 0,
                    hourSaved: a.aiOrigEst - a.aiCompleted
                };
            });
            
            // Sort data
            areaSummaryData.sort((a, b) => {
                let aVal = a[areaSortField];
                let bVal = b[areaSortField];
                
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                
                if (aVal === null || aVal === undefined) aVal = areaSortDir === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = areaSortDir === 'asc' ? Infinity : -Infinity;
                
                if (aVal < bVal) return areaSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return areaSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Sort icon helper
            const sortIcon = (field) => areaSortField === field ? (areaSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            // Header with clickable sorting
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#67e8f9;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            areaSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;" onclick="sortAreaSummary('area')">Area${sortIcon('area')}</th>
                <th style="${thStyle}text-align:left;" onclick="sortAreaSummary('project')">Project${sortIcon('project')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);" onclick="sortAreaSummary('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);" onclick="sortAreaSummary('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);" onclick="sortAreaSummary('manualAiIneffCount')">AI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);" onclick="sortAreaSummary('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('aiOrigEst')">AI Orig${sortIcon('aiOrigEst')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('aiCompleted')">AI Comp${sortIcon('aiCompleted')}</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);" onclick="sortAreaSummary('manualAiIneffOrigEst')">AI-Ineff Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);" onclick="sortAreaSummary('manualAiIneffCompleted')">AI-Ineff Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('manualOrigEst')">Man Orig${sortIcon('manualOrigEst')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('manualCompleted')">Man Comp${sortIcon('manualCompleted')}</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);" onclick="sortAreaSummary('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);" onclick="sortAreaSummary('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Body rows
            const tdStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            let bodyHtml = '';
            areaSummaryData.forEach(a => {
                const aHourSavedColor = a.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const aManualEffColor = a.manualEff >= 0 ? '#34d399' : '#f87171';
                const aAiEffColor = a.aiEff >= 0 ? '#34d399' : '#f87171';
                
                bodyHtml += `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(6,182,212,0.1)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-weight:600;">🏷️ ${a.area}</td>
                    <td style="${tdStyle}text-align:left;color:#94a3b8;font-size:0.65rem;">${a.project}</td>
                    <td style="${tdStyle}text-align:center;color:#e2e8f0;font-weight:600;">${a.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${a.claudeAiCount}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${a.copilotCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${a.manualAiIneffCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${a.manualCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(a.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(a.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${a.aiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${aManualEffColor};">${a.manualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aAiEffColor};">${a.aiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aHourSavedColor};font-weight:600;">${fmtH(a.hourSaved)}h</td>
                </tr>`;
            });
            areaSummaryBody.innerHTML = bodyHtml;
        }
        
        // Sort Area-wise Summary
        function sortAreaSummary(field) {
            if (areaSortField === field) {
                areaSortDir = areaSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                areaSortField = field;
                areaSortDir = 'asc';
            }
            renderAreaSummaryTable();
        }
        
        // Render Project-wise Summary Table
        function renderProjectSummaryTable() {
            const projectSummarySection = document.getElementById('projectSummarySection');
            const projectSummaryHead = document.getElementById('projectSummaryHead');
            const projectSummaryBody = document.getElementById('projectSummaryBody');
            
            if (!aiAdoptionMemberData || aiAdoptionMemberData.length === 0) {
                projectSummarySection.style.display = 'none';
                return;
            }
            
            projectSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const projectSummaryContent = document.getElementById('projectSummaryContent');
            const toggleProjectBtn = document.getElementById('toggleProjectSummaryBtn');
            if (projectSummaryContent) projectSummaryContent.style.display = '';
            if (toggleProjectBtn) toggleProjectBtn.textContent = 'Hide';
            
            // Group by project
            const projectTotals = {};
            aiAdoptionMemberData.forEach(m => {
                const proj = m.project || '-';
                if (!projectTotals[proj]) {
                    projectTotals[proj] = {
                        project: proj,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                projectTotals[proj].taskCount += m.taskCount;
                projectTotals[proj].claudeAiCount += m.claudeAiCount;
                projectTotals[proj].copilotCount += m.copilotCount;
                projectTotals[proj].manualAiIneffCount += m.manualAiIneffCount;
                projectTotals[proj].manualCount += m.manualCount;
                projectTotals[proj].aiOrigEst += m.aiOrigEst;
                projectTotals[proj].aiCompleted += m.aiCompleted;
                projectTotals[proj].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                projectTotals[proj].manualAiIneffCompleted += m.manualAiIneffCompleted;
                projectTotals[proj].manualOrigEst += m.manualOrigEst;
                projectTotals[proj].manualCompleted += m.manualCompleted;
            });
            
            // Header
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#a5b4fc;font-size:0.7rem;text-transform:uppercase;';
            projectSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;">Project</th>
                <th style="${thStyle}">Tasks</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);">Claude</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">Copilot</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Manual</th>
                <th style="${thStyle}">AI Orig</th>
                <th style="${thStyle}">AI Comp</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Orig</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Comp</th>
                <th style="${thStyle}">Man Orig</th>
                <th style="${thStyle}">Man Comp</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);">AI Adopt</th>
                <th style="${thStyle}">Man Eff</th>
                <th style="${thStyle}">AI Eff</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);">Hr Save</th>
            </tr>`;
            
            // Body rows
            const tdStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            let bodyHtml = '';
            Object.values(projectTotals).forEach(p => {
                const pTotalOrig = p.aiOrigEst + p.manualAiIneffOrigEst + p.manualOrigEst;
                const pAiAdoption = pTotalOrig > 0 ? Math.round(((p.aiOrigEst + p.manualAiIneffOrigEst) / pTotalOrig) * 100) : 0;
                const pManualEff = (p.manualOrigEst + p.manualAiIneffOrigEst) > 0 ? Math.round((((p.manualOrigEst + p.manualAiIneffOrigEst) - (p.manualCompleted + p.manualAiIneffCompleted)) / (p.manualOrigEst + p.manualAiIneffOrigEst)) * 100) : 0;
                const pAiEff = p.aiOrigEst > 0 ? Math.round(((p.aiOrigEst - p.aiCompleted) / p.aiOrigEst) * 100) : 0;
                const pHourSaved = p.aiOrigEst - p.aiCompleted;
                const pHourSavedColor = pHourSaved >= 0 ? '#f472b6' : '#f87171';
                const pManualEffColor = pManualEff >= 0 ? '#34d399' : '#f87171';
                const pAiEffColor = pAiEff >= 0 ? '#34d399' : '#f87171';
                
                bodyHtml += `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(99,102,241,0.1)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-weight:600;">📁 ${p.project}</td>
                    <td style="${tdStyle}text-align:center;color:#e2e8f0;font-weight:600;">${p.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${p.claudeAiCount}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${p.copilotCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${p.manualAiIneffCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${p.manualCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(p.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(p.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${pAiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${pManualEffColor};">${pManualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${pAiEffColor};">${pAiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${pHourSavedColor};font-weight:600;">${fmtH(pHourSaved)}h</td>
                </tr>`;
            });
            projectSummaryBody.innerHTML = bodyHtml;
        }
        
        // Show task detail popup for Dev AI Adoption count cells
        function showAiAdoptionTaskPopup(memberIdx, type) {
            const overlay = document.getElementById('aiTaskPopupOverlay');
            const modalBox = overlay.firstElementChild;
            const lt = document.body.classList.contains('light-theme');
            try {
                const member = aiAdoptionMemberData[memberIdx];
                if (!member) { console.error('Member not found at index:', memberIdx); return; }
                const typeLabels = { all: 'All Tasks', claude: 'Claude AI Tasks', copilot: 'Copilot Tasks', aiIneff: 'AI-Ineffective Tasks', manual: 'Manual Tasks' };
                const typeColors = { all: '#93c5fd', claude: '#c4b5fd', copilot: '#22d3ee', aiIneff: '#fca5a5', manual: '#fcd34d' };
                const taskMap = { all: '_tasks', claude: '_claudeTasks', copilot: '_copilotTasks', aiIneff: '_aiIneffTasks', manual: '_manualTasks' };
                const taskList = member[taskMap[type]] || [];
                document.getElementById('aiTaskPopupTitle').textContent = `${member.name} — ${typeLabels[type]} (${taskList.length})`;
                document.getElementById('aiTaskPopupTitle').style.color = typeColors[type];
                const esc = s => (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const thBg = lt ? 'background:#e2e8f0;color:#1e293b;' : 'background:rgba(255,255,255,0.08);color:#e2e8f0;';
                const thS = `${thBg}padding:6px 5px;font-size:0.68rem;white-space:nowrap;text-align:left;`;
                const tdBdr = lt ? 'border-bottom:1px solid #e2e8f0;' : 'border-bottom:1px solid rgba(255,255,255,0.06);';
                const tdClr = lt ? 'color:#334155;' : 'color:#cbd5e1;';
                let html = `<table style="width:100%;border-collapse:collapse;font-size:0.72rem;">
                    <thead><tr>
                        <th style="${thS}width:6%;">ID</th>
                        <th style="${thS}">Title</th>
                        <th style="${thS}width:10%;">Exec Type</th>
                        <th style="${thS}width:7%;">State</th>
                        <th style="${thS}width:6%;text-align:right;">Orig</th>
                        <th style="${thS}width:6%;text-align:right;">Comp</th>
                        <th style="${thS}width:6%;text-align:center;">Week</th>
                        <th style="${thS}width:8%;text-align:center;">Resolved</th>
                        <th style="${thS}width:9%;">Area</th>
                    </tr></thead><tbody>`;
                const wLabels = { week1: 'W1', week2: 'W2', week3: 'W3', week4: 'W4' };
                const wClr = { week1: '#93c5fd', week2: '#6ee7b7', week3: '#fcd34d', week4: '#f9a8d4' };
                taskList.forEach(t => {
                    const f = t.fields;
                    const re = f['Casepoint.TFS.CustomFields.RevisedEstimate']||0;
                    const oe = f['Microsoft.VSTS.Scheduling.OriginalEstimate']||0;
                    const orig = re > 0 ? re : oe;
                    const comp = f['Microsoft.VSTS.Scheduling.CompletedWork']||0;
                    const et = f['Casepoint.TFS.CustomFields.TaskExecutionType']||'-';
                    const area = (f['System.AreaPath']||'').split('\\').pop();
                    const wt = t._sprintWeek;
                    const wColor = wClr[wt] || (lt?'#64748b':'#94a3b8');
                    const stCls = getStatePillClass(f['System.State']||'');
                    const scd = f['Microsoft.VSTS.Common.StateChangeDate'];
                    const scdFmt = scd ? new Date(scd).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '-';
                    const dateClr = lt ? 'color:#475569;' : 'color:#94a3b8;';
                    const etClr = lt ? 'color:#0e7490;' : 'color:#22d3ee;';
                    const origClr = lt ? 'color:#c2410c;' : 'color:#f97316;';
                    const compClr = lt ? 'color:#047857;' : 'color:#34d399;';
                    const areaClr = lt ? 'color:#0369a1;' : 'color:#38bdf8;';
                    html += `<tr style="${tdBdr}">
                        <td style="padding:4px 5px;${tdClr}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link" style="font-size:0.68rem;">${t.id}</a></td>
                        <td style="padding:4px 5px;${tdClr}max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(f['System.Title'])}">${esc(f['System.Title'])}</td>
                        <td style="padding:4px 5px;${etClr}font-size:0.66rem;">${esc(et)}</td>
                        <td style="padding:4px 5px;"><span class="fp-state-pill ${stCls}" style="font-size:0.5rem;padding:1px 5px;">${f['System.State']||''}</span></td>
                        <td style="padding:4px 5px;text-align:right;${origClr}font-weight:600;">${fmtH(orig)}h</td>
                        <td style="padding:4px 5px;text-align:right;${compClr}">${fmtH(comp)}h</td>
                        <td style="padding:4px 5px;text-align:center;color:${wColor};font-weight:600;font-size:0.66rem;">${wLabels[wt]||'-'}</td>
                        <td style="padding:4px 5px;text-align:center;${dateClr}font-size:0.62rem;">${scdFmt}</td>
                        <td style="padding:4px 5px;${areaClr}font-size:0.66rem;" title="${esc(f['System.AreaPath'])}">${area}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                if (taskList.length === 0) html = '<div style="text-align:center;color:#94a3b8;padding:20px;">No tasks</div>';
                document.getElementById('aiTaskPopupBody').innerHTML = html;
            } catch(e) {
                console.error('showAiAdoptionTaskPopup error:', e);
                document.getElementById('aiTaskPopupBody').innerHTML = '<div style="text-align:center;color:#f87171;padding:20px;">Error loading tasks</div>';
            }
            // Always show popup
            overlay.style.display = 'flex';
            if (lt) {
                modalBox.style.background = '#ffffff';
                modalBox.style.borderColor = 'rgba(59,130,246,0.3)';
            } else {
                modalBox.style.background = '#1e293b';
                modalBox.style.borderColor = 'rgba(59,130,246,0.4)';
            }
        }
        
        // Sort AI Adoption table
        function sortAIAdoptionTable(field) {
            if (aiAdoptionSortField === field) {
                // Toggle direction
                aiAdoptionSortDir = aiAdoptionSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                // New field, default to ascending for name/project/team, descending for numbers
                aiAdoptionSortField = field;
                aiAdoptionSortDir = (field === 'name' || field === 'project' || field === 'team') ? 'asc' : 'desc';
            }
            
            // Update header sort icons
            const thead = document.getElementById('aiAdoptionTableHead');
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => aiAdoptionSortField === f ? (aiAdoptionSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortAIAdoptionTable('manualAiIneffCount')">AI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(139,92,246,0.25);color:#c4b5fd;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">AI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            // Re-render the rows
            renderAIAdoptionTableRows();
        }

        // ==================== QA AI ADOPTION DATA FUNCTIONS ====================
        
        function toggleQAAIAdoptionData() {
            const btn = document.getElementById('loadQAAIAdoptionBtn');
            const content = document.getElementById('qaAIAdoptionContent');
            const exportBtn = document.getElementById('exportQAAIAdoptionBtn');
            const exportPdfBtn = document.getElementById('exportQAAIAdoptionPdfBtn');
            
            // Toggle between Load and Unload
            if (content.style.display === 'none' || content.style.display === '') {
                // Load/Show content
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                exportBtn.style.display = 'inline-block';
                exportPdfBtn.style.display = 'inline-block';
                
                if (!qaAIAdoptionDataLoaded) {
                    renderQAAIAdoptionData();
                    qaAIAdoptionDataLoaded = true;
                }
            } else {
                // Unload/Hide content
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                exportBtn.style.display = 'none';
                exportPdfBtn.style.display = 'none';
            }
        }
        
        function toggleQAMemberSummary() {
            const content = document.getElementById('qaMemberSummaryContent');
            const btn = document.getElementById('toggleQAMemberSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleQAAreaSummary() {
            const content = document.getElementById('qaAreaSummaryContent');
            const btn = document.getElementById('toggleQAAreaSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleQAProjectSummary() {
            const content = document.getElementById('qaProjectSummaryContent');
            const btn = document.getElementById('toggleQAProjectSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function renderQAAIAdoptionData() {
            // Execution types to track for QA - AI-Test* types
            const allExecTypes = ['AI-Test-Case Creation', 'AI-Test-Execution', 'AI-Test-Defect Analysis', 'AI-Test-Documentation', 'Manual'];
            const aiExecTypes = ['AI-Test-Case Creation', 'AI-Test-Execution', 'AI-Test-Defect Analysis', 'AI-Test-Documentation'];
            
            // Get Test/QA members from capacity data (Discipline = Test)
            const qaMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('test')
            );
            
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable' || req.isAdhocSupport) {
                    validReqIds.add(req.id);
                }
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            
            // Filter tasks based on criteria: Resolved/Closed + Reason != Rejected + OrigEst > 0
            const completedStates = ['resolved', 'closed'];
            
            const validTasks = tasks.filter(t => {
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;
                
                const state = (t.fields['System.State'] || '').toLowerCase();
                const reason = (t.fields['System.Reason'] || '').toLowerCase();
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                return completedStates.includes(state) && 
                       reason !== 'rejected' && 
                       origEst > 0;
            });
            
            // Build member data map from capacity data
            const memberDataMap = {};
            qaMembers.forEach(m => {
                memberDataMap[m.name.toLowerCase().trim()] = {
                    name: m.name,
                    project: m.project || '-',
                    team: m.team || '-',
                    taskCount: 0,
                    claudeAiCount: 0,
                    copilotCount: 0,
                    manualCount: 0,
                    totalOrigEst: 0,
                    totalCompleted: 0,
                    aiOrigEst: 0,
                    aiCompleted: 0,
                    manualOrigEst: 0,
                    manualCompleted: 0,
                    manualAiIneffCount: 0,
                    manualAiIneffOrigEst: 0,
                    manualAiIneffCompleted: 0
                };
            });
            
            // Also add members from task assignments who might not be in capacity data
            validTasks.forEach(t => {
                const assignedTo = t.fields['System.AssignedTo']?.displayName || '';
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const completed = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                // Check for Claude AI tag with flexible matching (Claude AI, ClaudeAI, Claude-AI, etc.)
                const hasClaudeAiTag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // Check if execution type starts with AI-Test
                const isAiType = execType.startsWith('AI-Test');
                const isManualType = execType === 'Manual';
                const isManualAiIneff = execType === 'Manual-AI-Ineffective';
                
                // Only count if execution type is AI-Test* or Manual or Manual-AI-Ineffective
                if (!isAiType && !isManualType && !isManualAiIneff) return;
                
                // Only count Test discipline tasks
                if (!discipline.toLowerCase().includes('test')) return;
                
                // Match to member - use full name matching
                const assignedToLower = assignedTo.toLowerCase().trim();
                
                // First try to find existing member
                let memberKey = Object.keys(memberDataMap).find(nameLower => {
                    return assignedToLower.includes(nameLower) || nameLower.includes(assignedToLower);
                });
                
                // If member not found in capacity data, add them from task assignment
                if (!memberKey && assignedTo) {
                    memberKey = assignedToLower;
                    const taskAreaPath = t.fields['System.AreaPath'] || '';
                    const taskProject = taskAreaPath.split('\\')[0] || '-';
                    const taskTeam = taskAreaPath.split('\\')[1] || '-';
                    memberDataMap[memberKey] = {
                        name: assignedTo,
                        project: taskProject,
                        team: taskTeam,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualCount: 0,
                        totalOrigEst: 0,
                        totalCompleted: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0,
                        manualAiIneffCount: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0
                    };
                }
                
                if (memberKey) {
                    const memberData = memberDataMap[memberKey];
                    memberData.taskCount++;
                    
                    // Count Claude AI vs Copilot vs Manual tasks
                    // If "Claude AI" tag found -> Claude AI column, otherwise -> Copilot column
                    if (isAiType && hasClaudeAiTag) {
                        memberData.claudeAiCount++;
                    } else if (isAiType && !hasClaudeAiTag) {
                        memberData.copilotCount++;
                    }
                    
                    if (isManualType) {
                        memberData.manualCount++;
                    }
                    
                    if (isManualAiIneff) {
                        memberData.manualAiIneffCount++;
                    }
                    
                    memberData.totalOrigEst += origEst;
                    memberData.totalCompleted += completed;
                    
                    if (isAiType) {
                        memberData.aiOrigEst += origEst;
                        memberData.aiCompleted += completed;
                    } else if (isManualType) {
                        memberData.manualOrigEst += origEst;
                        memberData.manualCompleted += completed;
                    } else if (isManualAiIneff) {
                        memberData.manualAiIneffOrigEst += origEst;
                        memberData.manualAiIneffCompleted += completed;
                    }
                }
            });
            
            // Convert to array and filter members with tasks
            const memberResults = Object.values(memberDataMap).filter(m => m.taskCount > 0);
            
            // Calculate grand totals
            let grandTotalOrigEst = 0, grandTotalCompleted = 0;
            let grandAiOrigEst = 0, grandAiCompleted = 0;
            let grandManualOrigEst = 0, grandManualCompleted = 0;
            let grandManualAiIneffOrigEst = 0, grandManualAiIneffCompleted = 0;
            
            memberResults.forEach(m => {
                grandTotalOrigEst += m.totalOrigEst;
                grandTotalCompleted += m.totalCompleted;
                grandAiOrigEst += m.aiOrigEst;
                grandAiCompleted += m.aiCompleted;
                grandManualOrigEst += m.manualOrigEst;
                grandManualCompleted += m.manualCompleted;
                grandManualAiIneffOrigEst += m.manualAiIneffOrigEst;
                grandManualAiIneffCompleted += m.manualAiIneffCompleted;
            });
            
            // Calculate efficiencies — Manual Eff = (Manual + AI-Ineff Orig − Comp) / (Manual + AI-Ineff Orig)
            const qaGrandManEffDenom = grandManualOrigEst + grandManualAiIneffOrigEst;
            const manualEfficiency = qaGrandManEffDenom > 0 ? Math.round(((qaGrandManEffDenom - (grandManualCompleted + grandManualAiIneffCompleted)) / qaGrandManEffDenom) * 100) : 0;
            const aiEfficiency = grandAiOrigEst > 0 ? Math.round(((grandAiOrigEst - grandAiCompleted) / grandAiOrigEst) * 100) : 0;
            
            // Update summary stats
            document.getElementById('qaDevMemberCount').textContent = memberResults.length;
            document.getElementById('qaTotalTasks').textContent = memberResults.reduce((sum, m) => sum + m.taskCount, 0);
            document.getElementById('qaTotalOrigEst').textContent = fmtH(grandTotalOrigEst) + 'h';
            document.getElementById('qaTotalCompleted').textContent = fmtH(grandTotalCompleted) + 'h';
            document.getElementById('qaManualEfficiency').textContent = manualEfficiency + '%';
            document.getElementById('qaAIEfficiency').textContent = aiEfficiency + '%';
            
            // Color efficiency values
            const manualEffEl = document.getElementById('qaManualEfficiency');
            const aiEffEl = document.getElementById('qaAIEfficiency');
            manualEffEl.style.color = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            aiEffEl.style.color = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            
            const thead = document.getElementById('qaAIAdoptionTableHead');
            const tbody = document.getElementById('qaAIAdoptionTableBody');
            const tfoot = document.getElementById('qaAIAdoptionTableFoot');
            
            if (memberResults.length === 0) {
                document.getElementById('noQAAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noQAAIAdoptionData').style.display = 'none';
            
            // Store member results globally for sorting
            qaAIAdoptionMemberData = memberResults.map(m => {
                const mTotalHours = m.aiOrigEst + m.manualAiIneffOrigEst + m.manualOrigEst;
                const mAiAdoption = mTotalHours > 0 ? Math.round(((m.aiOrigEst + m.manualAiIneffOrigEst) / mTotalHours) * 100) : 0;
                const mManualEff = (m.manualOrigEst + m.manualAiIneffOrigEst) > 0 ? Math.round((((m.manualOrigEst + m.manualAiIneffOrigEst) - (m.manualCompleted + m.manualAiIneffCompleted)) / (m.manualOrigEst + m.manualAiIneffOrigEst)) * 100) : 0;
                const mAiEff = m.aiOrigEst > 0 ? Math.round(((m.aiOrigEst - m.aiCompleted) / m.aiOrigEst) * 100) : 0;
                const mHourSaved = m.aiOrigEst - m.aiCompleted;
                return { ...m, aiAdoption: mAiAdoption, manualEff: mManualEff, aiEff: mAiEff, hourSaved: mHourSaved };
            });
            
            // Store grand totals globally
            qaAIAdoptionGrandTotals = {
                grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted,
                grandManualAiIneffOrigEst, grandManualAiIneffCompleted,
                manualEfficiency, aiEfficiency
            };
            
            // Header row 1: With sortable columns
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => qaAIAdoptionSortField === field ? (qaAIAdoptionSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortQAAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortQAAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortQAAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortQAAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortQAAIAdoptionTable('manualAiIneffCount')">MAI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortQAAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(6,182,212,0.25);color:#67e8f9;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">MAI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortQAAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortQAAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortQAAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortQAAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Header row 2: Orig/Comp subheaders with sorting
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortQAAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortQAAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            // Render table rows
            renderQAAIAdoptionTableRows();
        }
        
        function renderQAAIAdoptionTableRows() {
            const tbody = document.getElementById('qaAIAdoptionTableBody');
            const tfoot = document.getElementById('qaAIAdoptionTableFoot');
            
            const sortedData = [...qaAIAdoptionMemberData].sort((a, b) => {
                let aVal = a[qaAIAdoptionSortField];
                let bVal = b[qaAIAdoptionSortField];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }
                
                if (aVal === null || aVal === undefined) aVal = qaAIAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = qaAIAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                
                if (aVal < bVal) return qaAIAdoptionSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return qaAIAdoptionSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            const tdStyle = 'padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.8rem;';
            tbody.innerHTML = sortedData.map(m => {
                const mHourSavedColor = m.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const mManualEffColor = m.manualEff >= 0 ? '#34d399' : '#f87171';
                const mAiEffColor = m.aiEff >= 0 ? '#34d399' : '#f87171';
                const mTotalOrig = m.aiOrigEst + m.manualAiIneffOrigEst;
                
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;white-space:nowrap;">${m.name}</td>
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-size:0.7rem;">${m.project}</td>
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-size:0.7rem;">${m.team}</td>
                    <td style="${tdStyle}text-align:center;">${m.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${m.claudeAiCount > 0 ? m.claudeAiCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${m.copilotCount > 0 ? m.copilotCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${m.manualAiIneffCount > 0 ? m.manualAiIneffCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${m.manualCount > 0 ? m.manualCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.aiOrigEst > 0 ? fmtH(m.aiOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.aiCompleted > 0 ? fmtH(m.aiCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${m.manualAiIneffOrigEst > 0 ? fmtH(m.manualAiIneffOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${m.manualAiIneffCompleted > 0 ? fmtH(m.manualAiIneffCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.manualOrigEst > 0 ? fmtH(m.manualOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.manualCompleted > 0 ? fmtH(m.manualCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${m.aiAdoption + '%'}</td>
                    <td style="${tdStyle}text-align:center;color:${mManualEffColor};font-weight:600;">${(m.manualOrigEst + m.manualAiIneffOrigEst) > 0 ? m.manualEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mAiEffColor};font-weight:600;">${m.aiOrigEst > 0 ? m.aiEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mHourSavedColor};font-weight:600;">${m.aiOrigEst > 0 ? fmtH(m.hourSaved) + 'h' : '-'}</td>
                </tr>`;
            }).join('');
            
            // Footer totals row
            const { grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency } = qaAIAdoptionGrandTotals;
            const totalTasks = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.taskCount, 0);
            const totalClaudeAi = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.claudeAiCount, 0);
            const totalCopilot = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.copilotCount, 0);
            const totalManual = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualCount, 0);
            const totalManualAiIneff = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualAiIneffCount, 0);
            const tfStyle = 'padding:10px 8px;border-top:2px solid rgba(6,182,212,0.4);font-size:0.8rem;';
            const footManualEffColor = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            const footAiEffColor = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            
            const qaFootTotalHours = grandAiOrigEst + grandManualAiIneffOrigEst + grandManualOrigEst;
            const grandAiAdoption = qaFootTotalHours > 0 ? Math.round(((grandAiOrigEst + grandManualAiIneffOrigEst) / qaFootTotalHours) * 100) : 0;
            const grandHourSaved = grandAiOrigEst - grandAiCompleted;
            const footHourSavedColor = grandHourSaved >= 0 ? '#f472b6' : '#f87171';
            
            tfoot.innerHTML = `<tr>
                <td colspan="3" style="${tfStyle}text-align:right;color:#e2e8f0;font-weight:700;">Grand Total:</td>
                <td style="${tfStyle}text-align:center;color:#e2e8f0;font-weight:700;">${totalTasks}</td>
                <td style="${tfStyle}text-align:center;color:#c4b5fd;font-weight:700;">${totalClaudeAi}</td>
                <td style="${tfStyle}text-align:center;color:#22d3ee;font-weight:700;">${totalCopilot}</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${totalManualAiIneff}</td>
                <td style="${tfStyle}text-align:center;color:#fcd34d;font-weight:700;">${totalManual}</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandAiOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandAiCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${fmtH(grandManualAiIneffOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#fb7185;font-weight:700;">${fmtH(grandManualAiIneffCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandManualOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandManualCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#60a5fa;font-weight:700;">${grandAiAdoption}%</td>
                <td style="${tfStyle}text-align:center;color:${footManualEffColor};font-weight:700;">${manualEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footAiEffColor};font-weight:700;">${aiEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footHourSavedColor};font-weight:700;">${fmtH(grandHourSaved)}h</td>
            </tr>`;
            
            // Render QA Area-wise Summary Table
            renderQAAreaSummaryTable();
            
            // Render QA Project-wise Summary Table
            renderQAProjectSummaryTable();
        }
        
        function renderQAAreaSummaryTable() {
            const qaAreaSummarySection = document.getElementById('qaAreaSummarySection');
            const qaAreaSummaryHead = document.getElementById('qaAreaSummaryHead');
            const qaAreaSummaryBody = document.getElementById('qaAreaSummaryBody');
            
            if (qaAIAdoptionMemberData.length === 0) {
                qaAreaSummarySection.style.display = 'none';
                return;
            }
            
            qaAreaSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const qaAreaContent = document.getElementById('qaAreaSummaryContent');
            const toggleQAAreaBtn = document.getElementById('toggleQAAreaSummaryBtn');
            if (qaAreaContent) qaAreaContent.style.display = '';
            if (toggleQAAreaBtn) toggleQAAreaBtn.textContent = 'Hide';
            
            // Group by area (team)
            const areaMap = {};
            qaAIAdoptionMemberData.forEach(m => {
                const area = m.team || 'Unknown';
                if (!areaMap[area]) {
                    areaMap[area] = {
                        area,
                        memberCount: 0,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                areaMap[area].memberCount++;
                areaMap[area].taskCount += m.taskCount;
                areaMap[area].claudeAiCount += m.claudeAiCount;
                areaMap[area].copilotCount += m.copilotCount;
                areaMap[area].manualAiIneffCount += m.manualAiIneffCount;
                areaMap[area].manualCount += m.manualCount;
                areaMap[area].aiOrigEst += m.aiOrigEst;
                areaMap[area].aiCompleted += m.aiCompleted;
                areaMap[area].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                areaMap[area].manualAiIneffCompleted += m.manualAiIneffCompleted;
                areaMap[area].manualOrigEst += m.manualOrigEst;
                areaMap[area].manualCompleted += m.manualCompleted;
            });
            
            const areaData = Object.values(areaMap).map(a => {
                const totalOrig = a.aiOrigEst + a.manualAiIneffOrigEst + a.manualOrigEst;
                const aiAdoption = totalOrig > 0 ? Math.round(((a.aiOrigEst + a.manualAiIneffOrigEst) / totalOrig) * 100) : 0;
                const manualEff = (a.manualOrigEst + a.manualAiIneffOrigEst) > 0 ? Math.round((((a.manualOrigEst + a.manualAiIneffOrigEst) - (a.manualCompleted + a.manualAiIneffCompleted)) / (a.manualOrigEst + a.manualAiIneffOrigEst)) * 100) : 0;
                const aiEff = a.aiOrigEst > 0 ? Math.round(((a.aiOrigEst - a.aiCompleted) / a.aiOrigEst) * 100) : 0;
                const hourSaved = a.aiOrigEst - a.aiCompleted;
                return { ...a, aiAdoption, manualEff, aiEff, hourSaved };
            });
            
            // Header
            const thStyle = 'padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;';
            qaAreaSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;">Area</th>
                <th style="${thStyle}">Members</th>
                <th style="${thStyle}">Tasks</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);">Claude</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">Copilot</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Manual</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Orig</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Comp</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Orig</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Comp</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Orig</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Comp</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);">AI Adopt</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Eff</th>
                <th style="${thStyle}background:rgba(16,185,129,0.2);">AI Eff</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);">Hr Save</th>
            </tr>`;
            
            // Body
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            qaAreaSummaryBody.innerHTML = areaData.map(a => {
                const hrSavedColor = a.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const manEffColor = a.manualEff >= 0 ? '#34d399' : '#f87171';
                const aiEffColor = a.aiEff >= 0 ? '#34d399' : '#f87171';
                return `<tr>
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-weight:600;">${a.area}</td>
                    <td style="${tdStyle}text-align:center;">${a.memberCount}</td>
                    <td style="${tdStyle}text-align:center;">${a.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${a.claudeAiCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${a.copilotCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${a.manualAiIneffCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${a.manualCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(a.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(a.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${a.aiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${manEffColor};font-weight:600;">${a.manualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aiEffColor};font-weight:600;">${a.aiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${hrSavedColor};font-weight:600;">${fmtH(a.hourSaved)}h</td>
                </tr>`;
            }).join('');
        }
        
        function renderQAProjectSummaryTable() {
            const qaProjectSummarySection = document.getElementById('qaProjectSummarySection');
            const qaProjectSummaryHead = document.getElementById('qaProjectSummaryHead');
            const qaProjectSummaryBody = document.getElementById('qaProjectSummaryBody');
            
            if (qaAIAdoptionMemberData.length === 0) {
                qaProjectSummarySection.style.display = 'none';
                return;
            }
            
            qaProjectSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const qaProjectContent = document.getElementById('qaProjectSummaryContent');
            const toggleQAProjectBtn = document.getElementById('toggleQAProjectSummaryBtn');
            if (qaProjectContent) qaProjectContent.style.display = '';
            if (toggleQAProjectBtn) toggleQAProjectBtn.textContent = 'Hide';
            
            // Group by project
            const projectMap = {};
            qaAIAdoptionMemberData.forEach(m => {
                const project = m.project || 'Unknown';
                if (!projectMap[project]) {
                    projectMap[project] = {
                        project,
                        memberCount: 0,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                projectMap[project].memberCount++;
                projectMap[project].taskCount += m.taskCount;
                projectMap[project].claudeAiCount += m.claudeAiCount;
                projectMap[project].copilotCount += m.copilotCount;
                projectMap[project].manualAiIneffCount += m.manualAiIneffCount;
                projectMap[project].manualCount += m.manualCount;
                projectMap[project].aiOrigEst += m.aiOrigEst;
                projectMap[project].aiCompleted += m.aiCompleted;
                projectMap[project].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                projectMap[project].manualAiIneffCompleted += m.manualAiIneffCompleted;
                projectMap[project].manualOrigEst += m.manualOrigEst;
                projectMap[project].manualCompleted += m.manualCompleted;
            });
            
            const projectData = Object.values(projectMap).map(p => {
                const totalOrig = p.aiOrigEst + p.manualAiIneffOrigEst + p.manualOrigEst;
                const aiAdoption = totalOrig > 0 ? Math.round(((p.aiOrigEst + p.manualAiIneffOrigEst) / totalOrig) * 100) : 0;
                const manualEff = (p.manualOrigEst + p.manualAiIneffOrigEst) > 0 ? Math.round((((p.manualOrigEst + p.manualAiIneffOrigEst) - (p.manualCompleted + p.manualAiIneffCompleted)) / (p.manualOrigEst + p.manualAiIneffOrigEst)) * 100) : 0;
                const aiEff = p.aiOrigEst > 0 ? Math.round(((p.aiOrigEst - p.aiCompleted) / p.aiOrigEst) * 100) : 0;
                const hourSaved = p.aiOrigEst - p.aiCompleted;
                return { ...p, aiAdoption, manualEff, aiEff, hourSaved };
            });
            
            // Header
            const thStyle = 'padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;';
            qaProjectSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;">Project</th>
                <th style="${thStyle}">Members</th>
                <th style="${thStyle}">Tasks</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);">Claude</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">Copilot</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Manual</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Orig</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Comp</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Orig</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Comp</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Orig</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Comp</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);">AI Adopt</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Eff</th>
                <th style="${thStyle}background:rgba(16,185,129,0.2);">AI Eff</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);">Hr Save</th>
            </tr>`;
            
            // Body
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            qaProjectSummaryBody.innerHTML = projectData.map(p => {
                const hrSavedColor = p.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const manEffColor = p.manualEff >= 0 ? '#34d399' : '#f87171';
                const aiEffColor = p.aiEff >= 0 ? '#34d399' : '#f87171';
                return `<tr>
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-weight:600;">${p.project}</td>
                    <td style="${tdStyle}text-align:center;">${p.memberCount}</td>
                    <td style="${tdStyle}text-align:center;">${p.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${p.claudeAiCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${p.copilotCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${p.manualAiIneffCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${p.manualCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(p.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(p.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${p.aiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${manEffColor};font-weight:600;">${p.manualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aiEffColor};font-weight:600;">${p.aiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${hrSavedColor};font-weight:600;">${fmtH(p.hourSaved)}h</td>
                </tr>`;
            }).join('');
        }
        
        function sortQAAIAdoptionTable(field) {
            if (qaAIAdoptionSortField === field) {
                qaAIAdoptionSortDir = qaAIAdoptionSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                qaAIAdoptionSortField = field;
                qaAIAdoptionSortDir = (field === 'name' || field === 'project' || field === 'team') ? 'asc' : 'desc';
            }
            
            // Update header sort icons
            const thead = document.getElementById('qaAIAdoptionTableHead');
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => qaAIAdoptionSortField === f ? (qaAIAdoptionSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortQAAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortQAAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortQAAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortQAAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortQAAIAdoptionTable('manualAiIneffCount')">MAI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortQAAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(6,182,212,0.25);color:#67e8f9;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">MAI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortQAAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortQAAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortQAAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortQAAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortQAAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortQAAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            renderQAAIAdoptionTableRows();
        }
        
        // Export QA AI Adoption Data to Excel
        function exportQAAIAdoptionToExcel() {
            if (qaAIAdoptionMemberData.length === 0) {
                alert('No QA AI Adoption data to export');
                return;
            }
            
            let csv = 'QA AI Adoption Data - Member Summary\n';
            csv += 'Member,Project,Area,Tasks,Claude,Copilot,AI-Ineff,Manual,AI Orig Est,AI Completed,AI-Ineff Orig,AI-Ineff Comp,Manual Orig Est,Manual Completed,AI Adoption %,Manual Eff %,AI Eff %,Hour Saved\n';
            
            qaAIAdoptionMemberData.forEach(m => {
                csv += `"${m.name}","${m.project}","${m.team}",${m.taskCount},${m.claudeAiCount},${m.copilotCount},${m.manualAiIneffCount},${m.manualCount},${m.aiOrigEst},${m.aiCompleted},${m.manualAiIneffOrigEst},${m.manualAiIneffCompleted},${m.manualOrigEst},${m.manualCompleted},${m.aiAdoption},${m.manualEff},${m.aiEff},${m.hourSaved}\n`;
            });
            
            // Add grand totals
            const { grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency } = qaAIAdoptionGrandTotals;
            const totalTasks = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.taskCount, 0);
            const totalClaudeAi = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.claudeAiCount, 0);
            const totalCopilot = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.copilotCount, 0);
            const totalManual = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualCount, 0);
            const totalManualAiIneff = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualAiIneffCount, 0);
            const csvTotalHours = grandAiOrigEst + grandManualAiIneffOrigEst + grandManualOrigEst;
            const grandAiAdoption = csvTotalHours > 0 ? Math.round(((grandAiOrigEst + grandManualAiIneffOrigEst) / csvTotalHours) * 100) : 0;
            const grandHourSaved = grandAiOrigEst - grandAiCompleted;
            
            csv += `"Grand Total","","",${totalTasks},${totalClaudeAi},${totalCopilot},${totalManualAiIneff},${totalManual},${grandAiOrigEst},${grandAiCompleted},${grandManualAiIneffOrigEst},${grandManualAiIneffCompleted},${grandManualOrigEst},${grandManualCompleted},${grandAiAdoption},${manualEfficiency},${aiEfficiency},${grandHourSaved}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `QA_AI_Adoption_Data_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Export QA AI Adoption Data to PDF
        function exportQAAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            
            // Get all the summary data
            const qaMemberCount = document.getElementById('qaDevMemberCount').textContent;
            const totalTasks = document.getElementById('qaTotalTasks').textContent;
            const totalOrigEst = document.getElementById('qaTotalOrigEst').textContent;
            const totalCompleted = document.getElementById('qaTotalCompleted').textContent;
            const manualEff = document.getElementById('qaManualEfficiency').textContent;
            const aiEff = document.getElementById('qaAIEfficiency').textContent;
            
            // Clone and get table HTML with inline styles preserved
            const memberTable = document.getElementById('qaAIAdoptionTable');
            const areaTable = document.getElementById('qaAreaSummaryTable');
            const projectTable = document.getElementById('qaProjectSummaryTable');
            
            let pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QA AI Adoption Report - ${sprintName}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media print {
            @page { size: landscape; margin: 0; }
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
            table { page-break-inside: auto; }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            font-size: 9pt; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0; 
            padding: 20px;
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(135deg, rgba(6,182,212,0.2), rgba(8,145,178,0.15));
            border: 1px solid rgba(6,182,212,0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
        h1 { color: #67e8f9; font-size: 16pt; margin-bottom: 8px; }
        .header-info { color: #94a3b8; font-size: 8pt; }
        .header-info strong { color: #e2e8f0; }
        
        .summary-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .summary-box { 
            background: rgba(6,182,212,0.15);
            border: 1px solid rgba(6,182,212,0.3);
            border-radius: 8px; 
            padding: 12px 16px; 
            min-width: 90px;
            text-align: center;
        }
        .summary-box .value { font-size: 16pt; font-weight: 700; color: #22d3ee; }
        .summary-box .label { font-size: 7pt; color: #94a3b8; text-transform: uppercase; margin-top: 4px; }
        
        .section { 
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .section.area { 
            background: rgba(168,85,247,0.1);
            border: 1px solid rgba(168,85,247,0.3);
        }
        .section.project { 
            background: rgba(99,102,241,0.1);
            border: 1px solid rgba(99,102,241,0.3);
        }
        h2 { 
            color: #67e8f9; 
            font-size: 11pt; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        h2.area { color: #c4b5fd; }
        h2.project { color: #a5b4fc; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 8pt;
            table-layout: fixed;
            word-wrap: break-word;
        }
        th { 
            background: rgba(0,0,0,0.3);
            color: #67e8f9; 
            padding: 8px 5px; 
            text-align: center; 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 7pt;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        th.area { color: #c4b5fd; }
        th.project { color: #a5b4fc; }
        td { 
            padding: 6px 5px; 
            border-bottom: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }
        td.left { text-align: left; }
        tr:hover { background: rgba(6,182,212,0.1); }
        
        .text-purple { color: #c4b5fd; }
        .text-cyan { color: #22d3ee; }
        .text-yellow { color: #fcd34d; }
        .text-green { color: #34d399; }
        .text-blue { color: #60a5fa; }
        .text-pink { color: #f472b6; }
        .text-white { color: #e2e8f0; }
        .text-muted { color: #94a3b8; }
        .font-bold { font-weight: 600; }
        
        .footer-row { 
            background: rgba(6,182,212,0.15) !important;
            font-weight: 600;
        }
        .footer-row td { border-top: 2px solid rgba(6,182,212,0.3); }
        
        .footer { 
            margin-top: 20px; 
            font-size: 7pt; 
            color: #64748b; 
            text-align: center; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            padding-top: 10px; 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧪 QA AI Adoption Report</h1>
        <div class="header-info">
            <strong>Sprint:</strong> ${sprintName} &nbsp;|&nbsp; 
            <strong>Area:</strong> ${areaNames} &nbsp;|&nbsp;
            <strong>Projects:</strong> ${selectedProjects.join(', ')} &nbsp;|&nbsp;
            <strong>Generated:</strong> ${new Date().toLocaleString()}
        </div>
    </div>
    
    <div class="summary-grid">
        <div class="summary-box"><div class="value">${qaMemberCount}</div><div class="label">QA Members</div></div>
        <div class="summary-box"><div class="value">${totalTasks}</div><div class="label">Total Tasks</div></div>
        <div class="summary-box"><div class="value">${totalOrigEst}</div><div class="label">Total Orig Est</div></div>
        <div class="summary-box"><div class="value">${totalCompleted}</div><div class="label">Total Completed</div></div>
        <div class="summary-box"><div class="value">${manualEff}</div><div class="label">Manual Eff.</div></div>
        <div class="summary-box"><div class="value">${aiEff}</div><div class="label">AI Eff.</div></div>
    </div>
    
    <div class="section">
        <h2>👥 QA Member-wise Summary</h2>
        ${buildPdfTable(memberTable, 'member')}
    </div>
    
    <div class="section area">
        <h2 class="area">🏷️ QA Area-wise Summary</h2>
        ${buildPdfTable(areaTable, 'area')}
    </div>
    
    <div class="section project">
        <h2 class="project">📁 QA Project-wise Summary</h2>
        ${buildPdfTable(projectTable, 'project')}
    </div>
    
    <div class="footer">
        Sprint Requirements Tracker - QA AI Adoption Report | Generated on ${new Date().toLocaleString()}
    </div>
</body>
</html>`;
            
            // Generate and download PDF directly using jsPDF and html2canvas
            generateAndDownloadPDF(pdfContent, `QA_AI_Adoption_Report_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.pdf`);
        }
        
        // ==================== OVERALL DISCIPLINE AI ADOPTION FUNCTIONS ====================
        let overallAIAdoptionDataLoaded = false;
        let overallAISortField = 'discipline';
        let overallAISortDir = 'asc';
        let overallAIDisciplineData = [];
        let overallAIGrandTotal = {};
        
        function toggleOverallAIAdoptionData() {
            const btn = document.getElementById('loadOverallAIAdoptionBtn');
            const content = document.getElementById('overallAIAdoptionContent');
            const exportBtn = document.getElementById('exportOverallAIAdoptionBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                loadOverallAIAdoptionData();
                exportBtn.style.display = 'inline-block';
                document.getElementById('exportOverallAIAdoptionPdfBtn').style.display = 'inline-block';
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                exportBtn.style.display = 'none';
                document.getElementById('exportOverallAIAdoptionPdfBtn').style.display = 'none';
            }
        }
        
        function loadOverallAIAdoptionData() {
            // Create set of valid requirement IDs
            // Include: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable (exact tag match)
            const validReqIds = new Set();
            requirements.forEach(req => {
                // Check exact tag values
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                const hasDeliverable = tags.includes('deliverable');
                const hasDeliverablesAdhoc = tags.includes('deliverables adhoc');
                const hasDeliverablesOnHold = tags.includes('deliverables onhold');
                const hasNonDeliverable = tags.includes('non-deliverable');
                
                if (hasDeliverable || hasDeliverablesAdhoc || hasDeliverablesOnHold || hasNonDeliverable) {
                    validReqIds.add(req.id);
                }
                if (req.isAdhocSupport) validReqIds.add(req.id);
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            
            // Define all known TFS Disciplines - these will always show in the table
            const allDisciplines = [
                'Analysis',
                'Development', 
                'Documentation',
                'Test',
                'User Education',
                'User Experience'
            ];
            
            // Initialize data structure for ALL disciplines with zero values
            const disciplineDataMap = new Map();
            allDisciplines.forEach(disc => {
                disciplineDataMap.set(disc, {
                    discipline: disc,
                    category: 'AI-Enabled',
                    totalTasks: 0,
                    claudeAI: 0,
                    copilot: 0,
                    totalAI: 0,
                    estHours: 0,
                    actualHours: 0,
                    claudeEstHours: 0,
                    claudeActualHours: 0,
                    copilotEstHours: 0,
                    copilotActualHours: 0
                });
            });
            
            // Process all tasks - only AI-* TaskExecutionType
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                
                // Only consider AI-* execution types
                if (!execType || !execType.startsWith('AI-')) return;
                
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || 'Unknown';
                
                // Check for "Claude AI" tag - handle various formats (Claude AI, ClaudeAI, Claude-AI, etc.)
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                // Check for claude ai tag with flexible matching
                const hasClaudeAITag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // If discipline not in predefined list, add it (handles 'Unknown' or any new disciplines)
                if (!disciplineDataMap.has(discipline)) {
                    disciplineDataMap.set(discipline, {
                        discipline: discipline,
                        category: 'AI-Enabled',
                        totalTasks: 0,
                        claudeAI: 0,
                        copilot: 0,
                        totalAI: 0,
                        estHours: 0,
                        actualHours: 0,
                        claudeEstHours: 0,
                        claudeActualHours: 0,
                        copilotEstHours: 0,
                        copilotActualHours: 0
                    });
                }
                
                const data = disciplineDataMap.get(discipline);
                data.totalTasks++;
                data.totalAI++;
                data.estHours += origEst;
                data.actualHours += compWork;
                
                // If "Claude AI" tag found -> Claude AI column, otherwise -> GitHub Copilot column
                if (hasClaudeAITag) {
                    data.claudeAI++;
                    data.claudeEstHours += origEst;
                    data.claudeActualHours += compWork;
                } else {
                    data.copilot++;
                    data.copilotEstHours += origEst;
                    data.copilotActualHours += compWork;
                }
            });
            
            // Calculate derived values for ALL disciplines (including those with zero data)
            let dataArray = [];
            disciplineDataMap.forEach((data, disc) => {
                data.aiPercent = data.totalTasks > 0 ? Math.round((data.totalAI / data.totalTasks) * 100) : 0;
                data.hoursSaved = data.estHours - data.actualHours;
                data.efficiency = data.estHours > 0 ? Math.round((data.hoursSaved / data.estHours) * 100) : 0;
                // Claude AI efficiency
                const claudeHoursSaved = data.claudeEstHours - data.claudeActualHours;
                data.claudeEfficiency = data.claudeEstHours > 0 ? Math.round((claudeHoursSaved / data.claudeEstHours) * 100) : 0;
                // Copilot efficiency
                const copilotHoursSaved = data.copilotEstHours - data.copilotActualHours;
                data.copilotEfficiency = data.copilotEstHours > 0 ? Math.round((copilotHoursSaved / data.copilotEstHours) * 100) : 0;
                dataArray.push(data);
            });
            
            // Sort by discipline name
            dataArray.sort((a, b) => a.discipline.localeCompare(b.discipline));
            
            // Calculate subtotal (only from disciplines that have data)
            const disciplinesWithData = dataArray.filter(d => d.totalTasks > 0);
            const subtotal = {
                discipline: 'SUBTOTAL (AI-Enabled)',
                category: '-',
                totalTasks: disciplinesWithData.reduce((sum, d) => sum + d.totalTasks, 0),
                claudeAI: disciplinesWithData.reduce((sum, d) => sum + d.claudeAI, 0),
                copilot: disciplinesWithData.reduce((sum, d) => sum + d.copilot, 0),
                totalAI: disciplinesWithData.reduce((sum, d) => sum + d.totalAI, 0),
                estHours: disciplinesWithData.reduce((sum, d) => sum + d.estHours, 0),
                actualHours: disciplinesWithData.reduce((sum, d) => sum + d.actualHours, 0),
                claudeEstHours: disciplinesWithData.reduce((sum, d) => sum + d.claudeEstHours, 0),
                claudeActualHours: disciplinesWithData.reduce((sum, d) => sum + d.claudeActualHours, 0),
                copilotEstHours: dataArray.reduce((sum, d) => sum + d.copilotEstHours, 0),
                copilotActualHours: dataArray.reduce((sum, d) => sum + d.copilotActualHours, 0)
            };
            subtotal.aiPercent = subtotal.totalTasks > 0 ? Math.round((subtotal.totalAI / subtotal.totalTasks) * 100) : 0;
            subtotal.hoursSaved = subtotal.estHours - subtotal.actualHours;
            subtotal.efficiency = subtotal.estHours > 0 ? Math.round((subtotal.hoursSaved / subtotal.estHours) * 100) : 0;
            // Claude AI efficiency for subtotal
            const subtotalClaudeHoursSaved = subtotal.claudeEstHours - subtotal.claudeActualHours;
            subtotal.claudeEfficiency = subtotal.claudeEstHours > 0 ? Math.round((subtotalClaudeHoursSaved / subtotal.claudeEstHours) * 100) : 0;
            // Copilot efficiency for subtotal
            const subtotalCopilotHoursSaved = subtotal.copilotEstHours - subtotal.copilotActualHours;
            subtotal.copilotEfficiency = subtotal.copilotEstHours > 0 ? Math.round((subtotalCopilotHoursSaved / subtotal.copilotEstHours) * 100) : 0;
            
            // Store globally for sorting
            overallAIDisciplineData = dataArray;
            overallAIGrandTotal = subtotal;
            
            // Render table
            renderOverallAIAdoptionTable(dataArray, subtotal);
        }
        
        function renderOverallAIAdoptionTable(disciplineData, subtotal) {
            const thead = document.getElementById('overallAIAdoptionTableHead');
            const tbody = document.getElementById('overallAIAdoptionTableBody');
            const tfoot = document.getElementById('overallAIAdoptionTableFoot');
            
            if (disciplineData.length === 0) {
                document.getElementById('noOverallAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noOverallAIAdoptionData').style.display = 'none';
            
            // Store data globally for sorting
            overallAIDisciplineData = disciplineData;
            overallAIGrandTotal = subtotal;
            
            // Header with sortable columns
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => overallAISortField === field ? (overallAISortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:11%;" onclick="sortOverallAIAdoptionTable('discipline')">Discipline${sortIcon('discipline')}</th>
                <th style="${thStyle}width:7%;">Category</th>
                <th style="${thStyle}width:6%;" onclick="sortOverallAIAdoptionTable('totalTasks')">Tasks${sortIcon('totalTasks')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortOverallAIAdoptionTable('claudeAI')">Claude${sortIcon('claudeAI')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortOverallAIAdoptionTable('copilot')">Copilot${sortIcon('copilot')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:6%;" onclick="sortOverallAIAdoptionTable('estHours')">Orig Est${sortIcon('estHours')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:7%;" onclick="sortOverallAIAdoptionTable('actualHours')">Completed${sortIcon('actualHours')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:7%;" onclick="sortOverallAIAdoptionTable('claudeEfficiency')">Claude %${sortIcon('claudeEfficiency')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:7%;" onclick="sortOverallAIAdoptionTable('copilotEfficiency')">Copilot %${sortIcon('copilotEfficiency')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortOverallAIAdoptionTable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:7%;" onclick="sortOverallAIAdoptionTable('hoursSaved')">Hr Save${sortIcon('hoursSaved')}</th>
            </tr>`;
            
            // Render table rows
            renderOverallAIAdoptionTableRows();
        }
        
        function renderOverallAIAdoptionTableRows() {
            const tbody = document.getElementById('overallAIAdoptionTableBody');
            const tfoot = document.getElementById('overallAIAdoptionTableFoot');
            
            const sortedData = [...overallAIDisciplineData].sort((a, b) => {
                let aVal = a[overallAISortField];
                let bVal = b[overallAISortField];
                
                // Handle string comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }
                // Handle numeric strings like "100.0"
                if (!isNaN(parseFloat(aVal)) && !isNaN(parseFloat(bVal))) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                
                if (aVal < bVal) return overallAISortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return overallAISortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Discipline colors map
            const disciplineColors = {
                'Development': '#93c5fd',
                'Test': '#6ee7b7',
                'QA': '#6ee7b7',
                'Analysis': '#fcd34d',
                'Business Analysis': '#fcd34d',
                'Design': '#c4b5fd',
                'Documentation': '#f9a8d4',
                'User Documentation': '#f9a8d4',
                'Requirements': '#fca5a5',
                'User Education': '#67e8f9',
                'User Experience': '#a5b4fc'
            };
            const defaultColor = '#94a3b8';
            
            // Helper function to display value or '-' if zero/empty
            const displayVal = (val) => (val === 0 || val === '0' || val === null || val === undefined) ? '-' : val;
            const displayHours = (val) => (val === 0 || val === null || val === undefined) ? '-' : fmtH(val) + 'h';
            const displayPercent = (val) => (val === 0 || val === '0' || val === null || val === undefined) ? '-' : val + '%';
            
            // Body rows
            const tdStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.08);';
            tbody.innerHTML = sortedData.map(d => {
                const hasData = d.totalTasks > 0;
                const effValue = parseFloat(d.efficiency);
                const effColor = !hasData ? '#94a3b8' : (effValue >= 30 ? '#34d399' : (effValue >= 15 ? '#fbbf24' : '#f87171'));
                const hrSaveColor = !hasData ? '#94a3b8' : (d.hoursSaved > 0 ? '#34d399' : '#f87171');
                const disciplineColor = disciplineColors[d.discipline] || defaultColor;
                // Claude efficiency color
                const claudeEffValue = parseFloat(d.claudeEfficiency);
                const claudeEffColor = !hasData || d.claudeAI === 0 ? '#94a3b8' : (claudeEffValue >= 30 ? '#34d399' : (claudeEffValue >= 15 ? '#fbbf24' : '#f87171'));
                // Copilot efficiency color
                const copilotEffValue = parseFloat(d.copilotEfficiency);
                const copilotEffColor = !hasData || d.copilot === 0 ? '#94a3b8' : (copilotEffValue >= 30 ? '#34d399' : (copilotEffValue >= 15 ? '#fbbf24' : '#f87171'));
                
                return `<tr>
                    <td style="${tdStyle}text-align:left;font-weight:600;color:${disciplineColor};">${d.discipline}</td>
                    <td style="${tdStyle}color:#67e8f9;">AI-Enabled</td>
                    <td style="${tdStyle}color:${hasData ? '#e2e8f0' : '#94a3b8'};">${displayVal(d.totalTasks)}</td>
                    <td style="${tdStyle}color:${hasData && d.claudeAI > 0 ? '#c4b5fd' : '#94a3b8'};">${displayVal(d.claudeAI)}</td>
                    <td style="${tdStyle}color:${hasData && d.copilot > 0 ? '#22d3ee' : '#94a3b8'};">${displayVal(d.copilot)}</td>
                    <td style="${tdStyle}color:${hasData ? '#fbbf24' : '#94a3b8'};">${displayHours(d.estHours)}</td>
                    <td style="${tdStyle}color:${hasData ? '#34d399' : '#94a3b8'};">${displayHours(d.actualHours)}</td>
                    <td style="${tdStyle}color:${claudeEffColor};font-weight:600;">${d.claudeAI > 0 ? displayPercent(d.claudeEfficiency) : '-'}</td>
                    <td style="${tdStyle}color:${copilotEffColor};font-weight:600;">${d.copilot > 0 ? displayPercent(d.copilotEfficiency) : '-'}</td>
                    <td style="${tdStyle}color:${effColor};font-weight:600;">${displayPercent(d.efficiency)}</td>
                    <td style="${tdStyle}color:${hrSaveColor};font-weight:600;">${displayHours(d.hoursSaved)}</td>
                </tr>`;
            }).join('');
            
            // Footer (Grand Total)
            const gt = overallAIGrandTotal;
            const gtEffValue = parseFloat(gt.efficiency);
            const gtEffColor = gtEffValue >= 30 ? '#34d399' : (gtEffValue >= 15 ? '#fbbf24' : '#f87171');
            const gtHrSaveColor = gt.hoursSaved > 0 ? '#34d399' : '#f87171';
            // Claude efficiency color for subtotal
            const gtClaudeEffValue = parseFloat(gt.claudeEfficiency);
            const gtClaudeEffColor = gtClaudeEffValue >= 30 ? '#34d399' : (gtClaudeEffValue >= 15 ? '#fbbf24' : '#f87171');
            // Copilot efficiency color for subtotal
            const gtCopilotEffValue = parseFloat(gt.copilotEfficiency);
            const gtCopilotEffColor = gtCopilotEffValue >= 30 ? '#34d399' : (gtCopilotEffValue >= 15 ? '#fbbf24' : '#f87171');
            
            tfoot.innerHTML = `<tr style="background:rgba(16,185,129,0.15);">
                <td style="${tdStyle}text-align:left;font-weight:700;color:#34d399;">Grand Total</td>
                <td style="${tdStyle}font-weight:700;">-</td>
                <td style="${tdStyle}font-weight:700;">${gt.totalTasks}</td>
                <td style="${tdStyle}color:#c4b5fd;font-weight:700;">${gt.claudeAI}</td>
                <td style="${tdStyle}color:#22d3ee;font-weight:700;">${gt.copilot}</td>
                <td style="${tdStyle}color:#fbbf24;font-weight:700;">${fmtH(gt.estHours)}h</td>
                <td style="${tdStyle}color:#34d399;font-weight:700;">${fmtH(gt.actualHours)}h</td>
                <td style="${tdStyle}color:${gtClaudeEffColor};font-weight:700;">${gt.claudeEfficiency}%</td>
                <td style="${tdStyle}color:${gtCopilotEffColor};font-weight:700;">${gt.copilotEfficiency}%</td>
                <td style="${tdStyle}color:${gtEffColor};font-weight:700;">${gt.efficiency}%</td>
                <td style="${tdStyle}color:${gtHrSaveColor};font-weight:700;">${fmtH(gt.hoursSaved)}h</td>
            </tr>`;
        }
        
        function sortOverallAIAdoptionTable(field) {
            if (overallAISortField === field) {
                overallAISortDir = overallAISortDir === 'asc' ? 'desc' : 'asc';
            } else {
                overallAISortField = field;
                overallAISortDir = (field === 'discipline') ? 'asc' : 'desc';
            }
            
            // Update header sort icons
            const thead = document.getElementById('overallAIAdoptionTableHead');
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => overallAISortField === f ? (overallAISortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:11%;" onclick="sortOverallAIAdoptionTable('discipline')">Discipline${sortIcon('discipline')}</th>
                <th style="${thStyle}width:7%;">Category</th>
                <th style="${thStyle}width:6%;" onclick="sortOverallAIAdoptionTable('totalTasks')">Tasks${sortIcon('totalTasks')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortOverallAIAdoptionTable('claudeAI')">Claude${sortIcon('claudeAI')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortOverallAIAdoptionTable('copilot')">Copilot${sortIcon('copilot')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:6%;" onclick="sortOverallAIAdoptionTable('estHours')">Orig Est${sortIcon('estHours')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:7%;" onclick="sortOverallAIAdoptionTable('actualHours')">Completed${sortIcon('actualHours')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:7%;" onclick="sortOverallAIAdoptionTable('claudeEfficiency')">Claude %${sortIcon('claudeEfficiency')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:7%;" onclick="sortOverallAIAdoptionTable('copilotEfficiency')">Copilot %${sortIcon('copilotEfficiency')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortOverallAIAdoptionTable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:7%;" onclick="sortOverallAIAdoptionTable('hoursSaved')">Hr Save${sortIcon('hoursSaved')}</th>
            </tr>`;
            
            // Re-render rows with new sort
            renderOverallAIAdoptionTableRows();
        }
        
        function exportOverallAIAdoptionToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'AI-ENABLED DISCIPLINES\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            
            csv += 'Discipline,Category,Tasks,Claude,Copilot,Orig Est,Completed,Claude %,Copilot %,Eff %,Hr Saved\n';
            
            overallAIDisciplineData.forEach(d => {
                csv += `"${d.discipline}",AI-Enabled,${d.totalTasks},${d.claudeAI},${d.copilot},${fmtH(d.estHours)}h,${fmtH(d.actualHours)}h,${d.claudeEfficiency}%,${d.copilotEfficiency}%,${d.efficiency}%,${fmtH(d.hoursSaved)}h\n`;
            });
            
            const gt = overallAIGrandTotal;
            csv += `"Grand Total",-,${gt.totalTasks},${gt.claudeAI},${gt.copilot},${fmtH(gt.estHours)}h,${fmtH(gt.actualHours)}h,${gt.claudeEfficiency}%,${gt.copilotEfficiency}%,${gt.efficiency}%,${fmtH(gt.hoursSaved)}h\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Enabled_Disciplines_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==================== TASK EXECUTION TYPE AI ADOPTION FUNCTIONS ====================
        let execTypeAIAdoptionDataLoaded = false;
        let execTypeData = [];
        let execTypeSortField = 'execType';
        let execTypeSortDir = 'asc';
        let execTypeGrandTotals = {};
        
        function toggleExecTypeAIAdoptionData() {
            const btn = document.getElementById('loadExecTypeAIAdoptionBtn');
            const content = document.getElementById('execTypeAIAdoptionContent');
            const exportBtn = document.getElementById('exportExecTypeAIAdoptionBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                loadExecTypeAIAdoptionData();
                exportBtn.style.display = 'inline-block';
                document.getElementById('exportExecTypeAIAdoptionPdfBtn').style.display = 'inline-block';
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                exportBtn.style.display = 'none';
                document.getElementById('exportExecTypeAIAdoptionPdfBtn').style.display = 'none';
            }
        }
        
        function loadExecTypeAIAdoptionData() {
            // Create set of valid requirement IDs
            // Include: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable (exact tag match)
            const validReqIds = new Set();
            requirements.forEach(req => {
                // Check exact tag values
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                const hasDeliverable = tags.includes('deliverable');
                const hasDeliverablesAdhoc = tags.includes('deliverables adhoc');
                const hasDeliverablesOnHold = tags.includes('deliverables onhold');
                const hasNonDeliverable = tags.includes('non-deliverable');
                
                if (hasDeliverable || hasDeliverablesAdhoc || hasDeliverablesOnHold || hasNonDeliverable) {
                    validReqIds.add(req.id);
                }
                if (req.isAdhocSupport) validReqIds.add(req.id);
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            
            // Define all known AI-* TaskExecutionType values
            const allAIExecTypes = [
                'AI-Dev-Analysis',
                'AI-Dev-Code Review',
                'AI-Dev-Development',
                'AI-Dev-Documentation',
                'AI-Test-Case Creation',
                'AI-Test-Defect Analysis',
                'AI-Test-Documentation',
                'AI-Test-Execution',
                'AI-BA-Analysis',
                'AI-BA-Documentation',
                'AI-UD-Documentation'
            ];
            
            // Initialize execTypeMap with all known AI-* types (with zero values)
            const execTypeMap = new Map();
            allAIExecTypes.forEach(execType => {
                execTypeMap.set(execType, {
                    execType: execType,
                    taskCount: 0,
                    claudeCount: 0,
                    copilotCount: 0,
                    origEst: 0,
                    completed: 0,
                    claudeOrigEst: 0,
                    claudeCompleted: 0,
                    copilotOrigEst: 0,
                    copilotCompleted: 0
                });
            });
            
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                let execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                
                // Only consider AI-* execution types
                if (!execType || !execType.startsWith('AI-')) return;
                
                // Check for "Claude AI" tag with flexible matching (Claude AI, ClaudeAI, Claude-AI, etc.)
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                const hasClaudeAITag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // If execType not in predefined list, add it
                if (!execTypeMap.has(execType)) {
                    execTypeMap.set(execType, {
                        execType: execType,
                        taskCount: 0,
                        claudeCount: 0,
                        copilotCount: 0,
                        origEst: 0,
                        completed: 0,
                        claudeOrigEst: 0,
                        claudeCompleted: 0,
                        copilotOrigEst: 0,
                        copilotCompleted: 0
                    });
                }
                
                const data = execTypeMap.get(execType);
                data.taskCount++;
                data.origEst += origEst;
                data.completed += compWork;
                
                // If "Claude AI" tag found -> Claude AI column, otherwise -> GitHub Copilot column
                if (hasClaudeAITag) {
                    data.claudeCount++;
                    data.claudeOrigEst += origEst;
                    data.claudeCompleted += compWork;
                } else {
                    data.copilotCount++;
                    data.copilotOrigEst += origEst;
                    data.copilotCompleted += compWork;
                }
            });
            
            // Calculate derived values
            let dataArray = [];
            execTypeMap.forEach((data, key) => {
                data.efficiency = data.origEst > 0 ? Math.round(((data.origEst - data.completed) / data.origEst) * 100) : 0;
                data.hourSaved = data.origEst - data.completed;
                // Claude AI % = (Claude Orig - Claude Completed) / Claude Orig * 100
                data.claudeEff = data.claudeOrigEst > 0 ? Math.round(((data.claudeOrigEst - data.claudeCompleted) / data.claudeOrigEst) * 100) : 0;
                // Copilot % = (Copilot Orig - Copilot Completed) / Copilot Orig * 100
                data.copilotEff = data.copilotOrigEst > 0 ? Math.round(((data.copilotOrigEst - data.copilotCompleted) / data.copilotOrigEst) * 100) : 0;
                // Better Tool - compare Claude % vs Copilot %
                if (data.taskCount > 0) {
                    if (data.claudeEff > data.copilotEff) {
                        data.betterTool = 'Claude AI';
                    } else if (data.copilotEff > data.claudeEff) {
                        data.betterTool = 'GitHub Copilot';
                    } else if (data.claudeEff === data.copilotEff && data.claudeEff > 0) {
                        data.betterTool = 'Tie';
                    } else {
                        data.betterTool = '';
                    }
                } else {
                    data.betterTool = '';
                }
                dataArray.push(data);
            });
            
            // Sort by execType name by default
            dataArray.sort((a, b) => a.execType.localeCompare(b.execType));
            
            // Calculate grand totals
            const grandTotal = {
                execType: 'Grand Total',
                taskCount: dataArray.reduce((sum, d) => sum + d.taskCount, 0),
                claudeCount: dataArray.reduce((sum, d) => sum + d.claudeCount, 0),
                copilotCount: dataArray.reduce((sum, d) => sum + d.copilotCount, 0),
                origEst: dataArray.reduce((sum, d) => sum + d.origEst, 0),
                completed: dataArray.reduce((sum, d) => sum + d.completed, 0),
                claudeOrigEst: dataArray.reduce((sum, d) => sum + d.claudeOrigEst, 0),
                claudeCompleted: dataArray.reduce((sum, d) => sum + d.claudeCompleted, 0),
                copilotOrigEst: dataArray.reduce((sum, d) => sum + d.copilotOrigEst, 0),
                copilotCompleted: dataArray.reduce((sum, d) => sum + d.copilotCompleted, 0)
            };
            grandTotal.efficiency = grandTotal.origEst > 0 ? 
                Math.round(((grandTotal.origEst - grandTotal.completed) / grandTotal.origEst) * 100) : 0;
            grandTotal.hourSaved = grandTotal.origEst - grandTotal.completed;
            grandTotal.claudeEff = grandTotal.claudeOrigEst > 0 ? 
                Math.round(((grandTotal.claudeOrigEst - grandTotal.claudeCompleted) / grandTotal.claudeOrigEst) * 100) : 0;
            grandTotal.copilotEff = grandTotal.copilotOrigEst > 0 ? 
                Math.round(((grandTotal.copilotOrigEst - grandTotal.copilotCompleted) / grandTotal.copilotOrigEst) * 100) : 0;
            // Better Tool for grand total
            if (grandTotal.claudeEff > grandTotal.copilotEff) {
                grandTotal.betterTool = 'Claude AI';
            } else if (grandTotal.copilotEff > grandTotal.claudeEff) {
                grandTotal.betterTool = 'GitHub Copilot';
            } else if (grandTotal.claudeEff === grandTotal.copilotEff && grandTotal.claudeEff > 0) {
                grandTotal.betterTool = 'Tie';
            } else {
                grandTotal.betterTool = '';
            }
            
            // Store globally for sorting
            execTypeData = dataArray;
            execTypeGrandTotals = grandTotal;
            
            // Render table
            renderExecTypeAIAdoptionTable();
        }
        
        function renderExecTypeAIAdoptionTable() {
            const thead = document.getElementById('execTypeAIAdoptionTableHead');
            const tbody = document.getElementById('execTypeAIAdoptionTableBody');
            const tfoot = document.getElementById('execTypeAIAdoptionTableFoot');
            
            // Always show the table since we display all predefined TaskExecutionTypes
            document.getElementById('noExecTypeAIAdoptionData').style.display = 'none';
            
            // Sort data
            const sortedData = [...execTypeData].sort((a, b) => {
                let aVal = a[execTypeSortField];
                let bVal = b[execTypeSortField];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (execTypeSortDir === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Header with sortable columns
            const thStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => execTypeSortField === field ? (execTypeSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:18%;" onclick="sortExecTypeTable('execType')">Task Execution Type${sortIcon('execType')}</th>
                <th style="${thStyle}width:6%;" onclick="sortExecTypeTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortExecTypeTable('claudeCount')">Claude${sortIcon('claudeCount')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortExecTypeTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:8%;" onclick="sortExecTypeTable('origEst')">Orig Est${sortIcon('origEst')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:8%;" onclick="sortExecTypeTable('completed')">Completed${sortIcon('completed')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:8%;" onclick="sortExecTypeTable('claudeEff')">Claude %${sortIcon('claudeEff')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:8%;" onclick="sortExecTypeTable('copilotEff')">Copilot %${sortIcon('copilotEff')}</th>
                <th style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:7%;" onclick="sortExecTypeTable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:8%;" onclick="sortExecTypeTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Execution type color mapping
            const execTypeColors = {
                'AI-Dev-Analysis': '#c4b5fd',
                'AI-Dev-Code Review': '#a5b4fc',
                'AI-Dev-Development': '#93c5fd',
                'AI-Dev-Documentation': '#67e8f9',
                'AI-Test-Case Creation': '#6ee7b7',
                'AI-Test-Defect Analysis': '#34d399',
                'AI-Test-Documentation': '#a3e635',
                'AI-Test-Execution': '#fbbf24',
                'AI-BA-Analysis': '#f472b6',
                'AI-BA-Documentation': '#fb7185',
                'AI-UD-Documentation': '#fca5a5'
            };
            const defaultColor = '#c4b5fd';
            
            // Body rows
            const tdStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.08);';
            tbody.innerHTML = sortedData.map(d => {
                const hasData = d.taskCount > 0;
                const effColor = d.efficiency >= 20 ? '#34d399' : (d.efficiency >= 10 ? '#fbbf24' : '#f87171');
                const hrSaveColor = d.hourSaved > 0 ? '#34d399' : '#f87171';
                const claudeEffColor = d.claudeEff >= 20 ? '#34d399' : (d.claudeEff >= 10 ? '#fbbf24' : '#f87171');
                const copilotEffColor = d.copilotEff >= 20 ? '#34d399' : (d.copilotEff >= 10 ? '#fbbf24' : '#f87171');
                const execColor = execTypeColors[d.execType] || defaultColor;
                

                
                // Style for rows with no data - grayed out
                const rowOpacity = hasData ? '1' : '0.4';
                const noDataStyle = hasData ? '' : 'font-style:italic;';
                const displayVal = (val, suffix = '') => hasData ? `${val}${suffix}` : '-';
                
                return `<tr style="opacity:${rowOpacity};">
                    <td style="${tdStyle}text-align:left;font-weight:600;color:${execColor};${noDataStyle}">${d.execType}</td>
                    <td style="${tdStyle}${noDataStyle}">${displayVal(d.taskCount)}</td>
                    <td style="${tdStyle}color:#c4b5fd;${noDataStyle}">${displayVal(d.claudeCount)}</td>
                    <td style="${tdStyle}color:#22d3ee;${noDataStyle}">${displayVal(d.copilotCount)}</td>
                    <td style="${tdStyle}color:#fbbf24;${noDataStyle}">${hasData ? fmtH(d.origEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}color:#34d399;${noDataStyle}">${hasData ? fmtH(d.completed) + 'h' : '-'}</td>
                    <td style="${tdStyle}color:${hasData ? claudeEffColor : '#64748b'};font-weight:600;${noDataStyle}">${displayVal(d.claudeEff, '%')}</td>
                    <td style="${tdStyle}color:${hasData ? copilotEffColor : '#64748b'};font-weight:600;${noDataStyle}">${displayVal(d.copilotEff, '%')}</td>
                    <td style="${tdStyle}color:${hasData ? effColor : '#64748b'};font-weight:600;${noDataStyle}">${displayVal(d.efficiency, '%')}</td>
                    <td style="${tdStyle}color:${hasData ? hrSaveColor : '#64748b'};font-weight:600;${noDataStyle}">${hasData ? fmtH(d.hourSaved) + 'h' : '-'}</td>
                </tr>`;
            }).join('');
            
            // Footer (Grand Total) - determine overall better tool
            const gt = execTypeGrandTotals;
            const gtEffColor = gt.efficiency >= 20 ? '#34d399' : (gt.efficiency >= 10 ? '#fbbf24' : '#f87171');
            const gtHrSaveColor = gt.hourSaved > 0 ? '#34d399' : '#f87171';
            const gtClaudeEffColor = gt.claudeEff >= 20 ? '#34d399' : (gt.claudeEff >= 10 ? '#fbbf24' : '#f87171');
            const gtCopilotEffColor = gt.copilotEff >= 20 ? '#34d399' : (gt.copilotEff >= 10 ? '#fbbf24' : '#f87171');
            

            
            tfoot.innerHTML = `<tr style="background:rgba(139,92,246,0.1);">
                <td style="${tdStyle}text-align:left;font-weight:700;color:#c4b5fd;">Grand Total</td>
                <td style="${tdStyle}font-weight:700;">${gt.taskCount}</td>
                <td style="${tdStyle}color:#c4b5fd;font-weight:700;">${gt.claudeCount}</td>
                <td style="${tdStyle}color:#22d3ee;font-weight:700;">${gt.copilotCount}</td>
                <td style="${tdStyle}color:#fbbf24;font-weight:700;">${fmtH(gt.origEst)}h</td>
                <td style="${tdStyle}color:#34d399;font-weight:700;">${fmtH(gt.completed)}h</td>
                <td style="${tdStyle}color:${gtClaudeEffColor};font-weight:700;">${gt.claudeEff}%</td>
                <td style="${tdStyle}color:${gtCopilotEffColor};font-weight:700;">${gt.copilotEff}%</td>
                <td style="${tdStyle}color:${gtEffColor};font-weight:700;">${gt.efficiency}%</td>
                <td style="${tdStyle}color:${gtHrSaveColor};font-weight:700;">${fmtH(gt.hourSaved)}h</td>
            </tr>`;
        }
        
        function sortExecTypeTable(field) {
            if (execTypeSortField === field) {
                execTypeSortDir = execTypeSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                execTypeSortField = field;
                execTypeSortDir = 'asc';
            }
            renderExecTypeAIAdoptionTable();
        }
        
        function exportExecTypeAIAdoptionToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'TaskExecutionType AI Adoption Data (AI-* Only)\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            
            csv += 'Task Execution Type,Tasks,Claude,Copilot,Orig Est,Completed,Claude %,Copilot %,Eff %,Hr Saved\n';
            
            execTypeData.forEach(d => {
                csv += `"${d.execType}",${d.taskCount},${d.claudeCount},${d.copilotCount},${fmtH(d.origEst)}h,${fmtH(d.completed)}h,${d.claudeEff}%,${d.copilotEff}%,${d.efficiency}%,${fmtH(d.hourSaved)}h\n`;
            });
            
            const gt = execTypeGrandTotals;
            csv += `\nGrand Total,${gt.taskCount},${gt.claudeCount},${gt.copilotCount},${fmtH(gt.origEst)}h,${fmtH(gt.completed)}h,${gt.claudeEff}%,${gt.copilotEff}%,${gt.efficiency}%,${fmtH(gt.hourSaved)}h\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TaskExecutionType_AI_Adoption_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==================== PROJECT-WISE AI ADOPTION FUNCTIONS ====================
        let projectAIAdoptionDataLoaded = false;
        let projectAIData = [];
        let projectAISortField = 'project';
        let projectAISortDir = 'asc';
        let projectAIGrandTotals = {};
        
        function toggleProjectAIAdoptionData() {
            const btn = document.getElementById('loadProjectAIAdoptionBtn');
            const content = document.getElementById('projectAIAdoptionContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                loadProjectAIAdoptionData();
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
            }
        }
        
        function loadProjectAIAdoptionData() {
            // Create set of valid requirement IDs
            // Include: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable, Adhoc Support (exact tag match)
            const validReqIds = new Set();
            
            requirements.forEach(req => {
                // Check exact tag values
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                const hasDeliverable = tags.includes('deliverable');
                const hasDeliverablesAdhoc = tags.includes('deliverables adhoc');
                const hasDeliverablesOnHold = tags.includes('deliverables onhold');
                const hasNonDeliverable = tags.includes('non-deliverable');
                
                if (hasDeliverable || hasDeliverablesAdhoc || hasDeliverablesOnHold || hasNonDeliverable) {
                    validReqIds.add(req.id);
                }
                if (req.isAdhocSupport) validReqIds.add(req.id);
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            
            // Initialize project data map
            const projectDataMap = new Map();
            
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                
                // Only consider AI-* execution types
                if (!execType || !execType.startsWith('AI-')) return;
                
                // Get project from task's area path - first segment is always the TFS project name
                // Format: "ProjectName\AreaName\SubArea" e.g. "CasepointARA\eCase\SubTeam"
                const areaPath = t.fields['System.AreaPath'] || '';
                const projectName = areaPath.split('\\')[0] || 'Unknown';
                
                // Check for "Claude AI" tag
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                const hasClaudeAITag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                if (!projectDataMap.has(projectName)) {
                    projectDataMap.set(projectName, {
                        project: projectName,
                        taskCount: 0,
                        claudeCount: 0,
                        copilotCount: 0,
                        origEst: 0,
                        completed: 0,
                        claudeOrigEst: 0,
                        claudeCompleted: 0,
                        copilotOrigEst: 0,
                        copilotCompleted: 0
                    });
                }
                
                const data = projectDataMap.get(projectName);
                data.taskCount++;
                data.origEst += origEst;
                data.completed += compWork;
                
                if (hasClaudeAITag) {
                    data.claudeCount++;
                    data.claudeOrigEst += origEst;
                    data.claudeCompleted += compWork;
                } else {
                    data.copilotCount++;
                    data.copilotOrigEst += origEst;
                    data.copilotCompleted += compWork;
                }
            });
            
            // Calculate derived values
            let dataArray = [];
            projectDataMap.forEach((data, key) => {
                data.efficiency = data.origEst > 0 ? Math.round(((data.origEst - data.completed) / data.origEst) * 100) : 0;
                data.hourSaved = data.origEst - data.completed;
                data.claudeEff = data.claudeOrigEst > 0 ? Math.round(((data.claudeOrigEst - data.claudeCompleted) / data.claudeOrigEst) * 100) : 0;
                data.copilotEff = data.copilotOrigEst > 0 ? Math.round(((data.copilotOrigEst - data.copilotCompleted) / data.copilotOrigEst) * 100) : 0;
                // Better Tool
                if (data.claudeEff > data.copilotEff) {
                    data.betterTool = 'Claude AI';
                } else if (data.copilotEff > data.claudeEff) {
                    data.betterTool = 'GitHub Copilot';
                } else if (data.claudeEff === data.copilotEff && data.claudeEff > 0) {
                    data.betterTool = 'Tie';
                } else {
                    data.betterTool = '';
                }
                dataArray.push(data);
            });
            
            // Sort by project name by default
            dataArray.sort((a, b) => a.project.localeCompare(b.project));
            
            // Calculate grand totals
            const grandTotal = {
                project: 'Grand Total',
                taskCount: dataArray.reduce((sum, d) => sum + d.taskCount, 0),
                claudeCount: dataArray.reduce((sum, d) => sum + d.claudeCount, 0),
                copilotCount: dataArray.reduce((sum, d) => sum + d.copilotCount, 0),
                origEst: dataArray.reduce((sum, d) => sum + d.origEst, 0),
                completed: dataArray.reduce((sum, d) => sum + d.completed, 0),
                claudeOrigEst: dataArray.reduce((sum, d) => sum + d.claudeOrigEst, 0),
                claudeCompleted: dataArray.reduce((sum, d) => sum + d.claudeCompleted, 0),
                copilotOrigEst: dataArray.reduce((sum, d) => sum + d.copilotOrigEst, 0),
                copilotCompleted: dataArray.reduce((sum, d) => sum + d.copilotCompleted, 0)
            };
            grandTotal.efficiency = grandTotal.origEst > 0 ? 
                Math.round(((grandTotal.origEst - grandTotal.completed) / grandTotal.origEst) * 100) : 0;
            grandTotal.hourSaved = grandTotal.origEst - grandTotal.completed;
            grandTotal.claudeEff = grandTotal.claudeOrigEst > 0 ? 
                Math.round(((grandTotal.claudeOrigEst - grandTotal.claudeCompleted) / grandTotal.claudeOrigEst) * 100) : 0;
            grandTotal.copilotEff = grandTotal.copilotOrigEst > 0 ? 
                Math.round(((grandTotal.copilotOrigEst - grandTotal.copilotCompleted) / grandTotal.copilotOrigEst) * 100) : 0;
            // Better Tool for grand total
            if (grandTotal.claudeEff > grandTotal.copilotEff) {
                grandTotal.betterTool = 'Claude AI';
            } else if (grandTotal.copilotEff > grandTotal.claudeEff) {
                grandTotal.betterTool = 'GitHub Copilot';
            } else if (grandTotal.claudeEff === grandTotal.copilotEff && grandTotal.claudeEff > 0) {
                grandTotal.betterTool = 'Tie';
            } else {
                grandTotal.betterTool = '';
            }
            
            // Store globally for sorting
            projectAIData = dataArray;
            projectAIGrandTotals = grandTotal;
            
            // Render table
            renderProjectAIAdoptionTable();
        }
        
        function renderProjectAIAdoptionTable() {
            const thead = document.getElementById('projectAIAdoptionTableHead');
            const tbody = document.getElementById('projectAIAdoptionTableBody');
            const tfoot = document.getElementById('projectAIAdoptionTableFoot');
            
            if (projectAIData.length === 0) {
                document.getElementById('noProjectAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noProjectAIAdoptionData').style.display = 'none';
            
            // Sort data
            const sortedData = [...projectAIData].sort((a, b) => {
                let aVal = a[projectAISortField];
                let bVal = b[projectAISortField];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (projectAISortDir === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Header with sortable columns
            const thStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => projectAISortField === field ? (projectAISortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:18%;" onclick="sortProjectAITable('project')">Project${sortIcon('project')}</th>
                <th style="${thStyle}width:6%;" onclick="sortProjectAITable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortProjectAITable('claudeCount')">Claude${sortIcon('claudeCount')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortProjectAITable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:8%;" onclick="sortProjectAITable('origEst')">Orig Est${sortIcon('origEst')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:8%;" onclick="sortProjectAITable('completed')">Completed${sortIcon('completed')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:8%;" onclick="sortProjectAITable('claudeEff')">Claude %${sortIcon('claudeEff')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:8%;" onclick="sortProjectAITable('copilotEff')">Copilot %${sortIcon('copilotEff')}</th>
                <th style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:7%;" onclick="sortProjectAITable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:8%;" onclick="sortProjectAITable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Project colors
            const projectColors = {
                'CasepointARA': '#93c5fd',
                'eCase': '#6ee7b7',
                'Casepoint': '#c4b5fd',
                'Automation': '#fcd34d',
                'Infrastructure': '#f9a8d4'
            };
            const defaultColor = '#22d3ee';
            
            // Body rows
            const tdStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.08);';
            tbody.innerHTML = sortedData.map(d => {
                const effColor = d.efficiency >= 20 ? '#34d399' : (d.efficiency >= 10 ? '#fbbf24' : '#f87171');
                const hrSaveColor = d.hourSaved > 0 ? '#34d399' : '#f87171';
                const claudeEffColor = d.claudeEff >= 20 ? '#34d399' : (d.claudeEff >= 10 ? '#fbbf24' : '#f87171');
                const copilotEffColor = d.copilotEff >= 20 ? '#34d399' : (d.copilotEff >= 10 ? '#fbbf24' : '#f87171');
                const projectColor = projectColors[d.project] || defaultColor;
                

                
                return `<tr>
                    <td style="${tdStyle}text-align:left;font-weight:600;color:${projectColor};">${d.project}</td>
                    <td style="${tdStyle}">${d.taskCount}</td>
                    <td style="${tdStyle}color:#c4b5fd;">${d.claudeCount}</td>
                    <td style="${tdStyle}color:#22d3ee;">${d.copilotCount}</td>
                    <td style="${tdStyle}color:#fbbf24;">${fmtH(d.origEst)}h</td>
                    <td style="${tdStyle}color:#34d399;">${fmtH(d.completed)}h</td>
                    <td style="${tdStyle}color:${claudeEffColor};font-weight:600;">${d.claudeEff}%</td>
                    <td style="${tdStyle}color:${copilotEffColor};font-weight:600;">${d.copilotEff}%</td>
                    <td style="${tdStyle}color:${effColor};font-weight:600;">${d.efficiency}%</td>
                    <td style="${tdStyle}color:${hrSaveColor};font-weight:600;">${fmtH(d.hourSaved)}h</td>
                </tr>`;
            }).join('');
            
            // Footer (Grand Total)
            const gt = projectAIGrandTotals;
            const gtEffColor = gt.efficiency >= 20 ? '#34d399' : (gt.efficiency >= 10 ? '#fbbf24' : '#f87171');
            const gtHrSaveColor = gt.hourSaved > 0 ? '#34d399' : '#f87171';
            const gtClaudeEffColor = gt.claudeEff >= 20 ? '#34d399' : (gt.claudeEff >= 10 ? '#fbbf24' : '#f87171');
            const gtCopilotEffColor = gt.copilotEff >= 20 ? '#34d399' : (gt.copilotEff >= 10 ? '#fbbf24' : '#f87171');
            

            
            tfoot.innerHTML = `<tr style="background:rgba(6,182,212,0.1);">
                <td style="${tdStyle}text-align:left;font-weight:700;color:#22d3ee;">Grand Total</td>
                <td style="${tdStyle}font-weight:700;">${gt.taskCount}</td>
                <td style="${tdStyle}color:#c4b5fd;font-weight:700;">${gt.claudeCount}</td>
                <td style="${tdStyle}color:#22d3ee;font-weight:700;">${gt.copilotCount}</td>
                <td style="${tdStyle}color:#fbbf24;font-weight:700;">${fmtH(gt.origEst)}h</td>
                <td style="${tdStyle}color:#34d399;font-weight:700;">${fmtH(gt.completed)}h</td>
                <td style="${tdStyle}color:${gtClaudeEffColor};font-weight:700;">${gt.claudeEff}%</td>
                <td style="${tdStyle}color:${gtCopilotEffColor};font-weight:700;">${gt.copilotEff}%</td>
                <td style="${tdStyle}color:${gtEffColor};font-weight:700;">${gt.efficiency}%</td>
                <td style="${tdStyle}color:${gtHrSaveColor};font-weight:700;">${fmtH(gt.hourSaved)}h</td>
            </tr>`;
        }
        
        function sortProjectAITable(field) {
            if (projectAISortField === field) {
                projectAISortDir = projectAISortDir === 'asc' ? 'desc' : 'asc';
            } else {
                projectAISortField = field;
                projectAISortDir = (field === 'project') ? 'asc' : 'desc';
            }
            renderProjectAIAdoptionTable();
        }
        
        
        // ==================== END QA AI ADOPTION DATA FUNCTIONS ====================

        function renderBlankSizeData(blankSizeReqs) {
            const tbody = document.getElementById('blankSizeTableBody');
            const noDataDiv = document.getElementById('noBlankSizeData');
            const tdStyle = 'padding:4px;border-bottom:1px solid rgba(255,255,255,0.08);';
            
            if (blankSizeReqs.length === 0) {
                noDataDiv.style.display = 'block';
                tbody.innerHTML = '';
            } else {
                noDataDiv.style.display = 'none';
                tbody.innerHTML = blankSizeReqs.map(req => {
                    const title = req.fields['System.Title'] || '';
                    return `<tr>
                        <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${req.id}" target="_blank" class="wi-link">${req.id}</a></td>
                        <td style="${tdStyle}">${title}</td>
                    </tr>`;
                }).join('');
            }
        }
        
        // ==================== DISCIPLINE VERIFICATION FUNCTIONS ====================
        
        function toggleDisciplineVerification() {
            const btn = document.getElementById('loadDisciplineVerifyBtn');
            const content = document.getElementById('disciplineVerifyContent');
            const exportBtn = document.getElementById('exportDisciplineVerifyBtn');
            const exportPdfBtn = document.getElementById('exportDisciplineVerifyPdfBtn');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                exportBtn.style.display = 'inline-block';
                exportPdfBtn.style.display = 'inline-block';
                
                if (!dvDataLoaded) {
                    loadDisciplineVerificationData();
                    dvDataLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                exportBtn.style.display = 'none';
                exportPdfBtn.style.display = 'none';
                dvDataLoaded = false; // Reset so data refreshes on next Load
            }
        }
        
        function loadDisciplineVerificationData() {
            const members = capacityData.members || [];
            if (members.length === 0) return;
            
            // Build member entries as array (allow same name in different teams/areas)
            // Use uniqueName (email/id) as primary key for reliable matching
            const memberEntries = [];
            members.forEach(m => {
                const disciplines = (m.discipline || '').split(',').map(d => d.trim().toLowerCase()).filter(d => d && d !== '-');
                memberEntries.push({
                    nameLower: m.name.toLowerCase().trim(),
                    uniqueName: (m.uniqueName || '').toLowerCase().trim(),
                    name: m.name,
                    project: m.project || '-',
                    team: m.team || '-',
                    disciplines: disciplines,
                    disciplineDisplay: m.discipline || '-'
                });
            });
            
            // Process ALL tasks in the sprint (no requirement category filter)
            dvAllTaskData = [];
            
            tasks.forEach(t => {
                if (!t.fields) return;
                
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const assignedToObj = t.fields['System.AssignedTo'];
                if (!assignedToObj) return;
                const assignedTo = assignedToObj.displayName || '';
                if (!assignedTo) return;
                
                const taskUniqueName = (assignedToObj.uniqueName || assignedToObj.id || '').toLowerCase().trim();
                const assignedToLower = assignedTo.toLowerCase().trim();
                const taskDiscipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const taskState = t.fields['System.State'] || '';
                
                let memberInfo;
                
                if (taskUniqueName) {
                    // Primary match: by uniqueName (email/id) - most reliable
                    memberInfo = memberEntries.find(m => m.uniqueName && m.uniqueName === taskUniqueName);
                    
                    // If multiple entries with same uniqueName exist (same person, different teams),
                    // disambiguate by area path
                    if (memberInfo) {
                        const sameUserEntries = memberEntries.filter(m => m.uniqueName === taskUniqueName);
                        if (sameUserEntries.length > 1) {
                            const taskAreaLower = taskAreaPath.toLowerCase();
                            const areaMatch = sameUserEntries.find(m =>
                                m.team && taskAreaLower.includes(m.team.toLowerCase())
                            );
                            if (areaMatch) memberInfo = areaMatch;
                        }
                    }
                }
                
                // Fallback: name-based matching (for older TFS data without uniqueName)
                if (!memberInfo) {
                    const nameMatches = memberEntries.filter(m =>
                        assignedToLower === m.nameLower ||
                        assignedToLower.includes(m.nameLower) || m.nameLower.includes(assignedToLower)
                    );
                    if (nameMatches.length === 0) return;
                    
                    if (nameMatches.length === 1) {
                        memberInfo = nameMatches[0];
                    } else {
                        const taskAreaLower = taskAreaPath.toLowerCase();
                        memberInfo = nameMatches.find(m =>
                            m.team && taskAreaLower.includes(m.team.toLowerCase())
                        ) || nameMatches[0];
                    }
                }
                
                // Determine match status - exact discipline comparison
                let matchStatus;
                if (!taskDiscipline || taskDiscipline.trim() === '') {
                    matchStatus = 'blank';
                } else if (memberInfo.disciplines.length === 0) {
                    matchStatus = 'blank';
                } else {
                    const taskDiscLower = taskDiscipline.toLowerCase().trim();
                    const isMatch = memberInfo.disciplines.some(md => md === taskDiscLower);
                    matchStatus = isMatch ? 'matched' : 'mismatched';
                }
                
                dvAllTaskData.push({
                    id: t.id,
                    title: t.fields['System.Title'] || '',
                    assignedTo: assignedTo,
                    memberDiscipline: memberInfo.disciplineDisplay,
                    taskDiscipline: taskDiscipline || '-',
                    matchStatus: matchStatus,
                    state: taskState,
                    area: memberInfo.team || '-',
                    project: (taskAreaPath.split('\\')[0]) || memberInfo.project
                });
            });
            
            // Update summary stats
            const uniqueMembers = new Set(dvAllTaskData.map(t => t.assignedTo)).size;
            const totalTasks = dvAllTaskData.length;
            const matchedCount = dvAllTaskData.filter(t => t.matchStatus === 'matched').length;
            const mismatchedCount = dvAllTaskData.filter(t => t.matchStatus === 'mismatched').length;
            const blankCount = dvAllTaskData.filter(t => t.matchStatus === 'blank').length;
            
            document.getElementById('dvMemberCount').textContent = uniqueMembers;
            document.getElementById('dvTotalTasks').textContent = totalTasks;
            document.getElementById('dvMatchedCount').textContent = matchedCount;
            document.getElementById('dvMismatchedCount').textContent = mismatchedCount;
            document.getElementById('dvBlankDisciplineCount').textContent = blankCount;
            
            renderDVMismatchTable();
        }
        
        function renderDVMismatchTable() {
            const thead = document.getElementById('dvMismatchHead');
            const tbody = document.getElementById('dvMismatchBody');
            const noDataEl = document.getElementById('noDVMismatchData');
            const countEl = document.getElementById('dvMismatchTaskCount');
            
            // Filter mismatched AND blank discipline tasks
            const flaggedTasks = dvAllTaskData.filter(t => t.matchStatus === 'mismatched' || t.matchStatus === 'blank');
            countEl.textContent = `(${flaggedTasks.length})`;
            
            if (flaggedTasks.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '';
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';
            
            // Sort
            const sorted = [...flaggedTasks].sort((a, b) => {
                let aVal = a[dvSortField];
                let bVal = b[dvSortField];
                if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = (bVal || '').toLowerCase(); }
                if (aVal < bVal) return dvSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return dvSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Header
            const thStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => dvSortField === f ? (dvSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:center;width:8%;" onclick="sortDVTable('matchStatus')">Status${sortIcon('matchStatus')}</th>
                <th style="${thStyle}text-align:left;width:5%;" onclick="sortDVTable('id')">ID${sortIcon('id')}</th>
                <th style="${thStyle}text-align:left;" onclick="sortDVTable('title')">Title${sortIcon('title')}</th>
                <th style="${thStyle}text-align:left;width:12%;" onclick="sortDVTable('assignedTo')">Assigned${sortIcon('assignedTo')}</th>
                <th style="${thStyle}text-align:center;width:10%;" onclick="sortDVTable('area')">Area${sortIcon('area')}</th>
                <th style="${thStyle}text-align:center;width:11%;" onclick="sortDVTable('memberDiscipline')">Mem Disc.${sortIcon('memberDiscipline')}</th>
                <th style="${thStyle}text-align:center;width:11%;" onclick="sortDVTable('taskDiscipline')">Task Disc.${sortIcon('taskDiscipline')}</th>
                <th style="${thStyle}text-align:center;width:7%;" onclick="sortDVTable('state')">State${sortIcon('state')}</th>
            </tr>`;
            
            // Body
            const tdStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.78rem;';
            tbody.innerHTML = sorted.map(t => {
                const stateColor = t.state === 'Closed' ? '#34d399' : (t.state === 'Resolved' ? '#60a5fa' : (t.state === 'Active' ? '#fbbf24' : '#94a3b8'));
                const statusIcon = t.matchStatus === 'mismatched' ? '❌' : '⚠️';
                const statusColor = t.matchStatus === 'mismatched' ? '#f87171' : '#fbbf24';
                const statusLabel = t.matchStatus === 'mismatched' ? 'Mismatch' : 'Blank';
                const taskDiscDisplay = t.taskDiscipline === '-' ? '<span style="color:#fbbf24;font-style:italic;">— blank —</span>' : `<span style="color:#f87171;font-weight:600;">${t.taskDiscipline}</span>`;
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:center;color:${statusColor};font-size:0.7rem;font-weight:600;">${statusIcon} ${statusLabel}</td>
                    <td style="${tdStyle}"><a href="${tfsUrl}/${t.project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                    <td style="${tdStyle}">${t.title}</td>
                    <td style="${tdStyle}">${t.assignedTo}</td>
                    <td style="${tdStyle}text-align:center;color:#67e8f9;font-size:0.7rem;">${t.area}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${t.memberDiscipline}</td>
                    <td style="${tdStyle}text-align:center;">${taskDiscDisplay}</td>
                    <td style="${tdStyle}text-align:center;color:${stateColor};">${t.state}</td>
                </tr>`;
            }).join('');
        }
        
        function sortDVTable(field) {
            if (dvSortField === field) {
                dvSortDir = dvSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                dvSortField = field;
                dvSortDir = (field === 'assignedTo' || field === 'title' || field === 'memberDiscipline' || field === 'taskDiscipline' || field === 'state' || field === 'area') ? 'asc' : 'desc';
            }
            renderDVMismatchTable();
        }
        
        function exportDisciplineVerificationToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'Discipline Verification Report\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            
            csv += 'MISMATCHED & BLANK DISCIPLINE TASKS\n';
            csv += 'Status,ID,Title,Assigned To,Area,Member Discipline,Task Discipline,State\n';
            
            dvAllTaskData.filter(t => t.matchStatus === 'mismatched' || t.matchStatus === 'blank').forEach(t => {
                const status = t.matchStatus === 'mismatched' ? 'Mismatch' : 'Blank';
                csv += `${status},${t.id},"${t.title.replace(/"/g, '""')}","${t.assignedTo}","${t.area}","${t.memberDiscipline}","${t.taskDiscipline}","${t.state}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Discipline_Mismatch_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderBlankDisciplineTasks() {
            // Find tasks with blank/empty Discipline field - all members, filtered by area
            const blankDisciplineTasks = tasks.filter(t => {
                if (!t.fields) return false;
                
                // Filter by area path to match selected areas
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'];
                return discipline === undefined || discipline === null || discipline === '' || (typeof discipline === 'string' && discipline.trim() === '');
            });

            // Update count
            document.getElementById('blankDisciplineCount').textContent = blankDisciplineTasks.length;

            // Render table - simplified 3 columns
            const tbody = document.getElementById('blankDisciplineTableBody');
            const tdStyle = 'padding:6px;border-bottom:1px solid rgba(255,255,255,0.08);';
            if (tbody) {
                if (blankDisciplineTasks.length === 0) {
                    document.getElementById('noBlankDisciplineData').style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    document.getElementById('noBlankDisciplineData').style.display = 'none';
                    tbody.innerHTML = blankDisciplineTasks.map(t => {
                        const title = t.fields['System.Title'] || '';
                        const assignedTo = t.fields['System.AssignedTo']?.displayName || '-';
                        return `<tr>
                            <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                            <td style="${tdStyle}">${title}</td>
                            <td style="${tdStyle}">${assignedTo.split(' ')[0]}</td>
                        </tr>`;
                    }).join('');
                }
            }
        }

        function renderDisciplineMismatchTasks() {
            // Get Development members for filtering
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            const devMemberNames = devMembers.map(m => m.name.toLowerCase().trim());
            
            // Matrix: Discipline -> Expected Task Execution Type prefix
            const disciplineMatrix = {
                'Development': 'AI-Dev',
                'Test': 'AI-Test'
            };

            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable' || req.isAdhocSupport) {
                    validReqIds.add(req.id);
                }
            });
            // Also include Adhoc Support bugs as valid parents
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });

            // Find CLOSED tasks with mismatched Discipline and Task Execution Type
            const mismatchedTasks = tasks.filter(t => {
                if (!t.fields) return false;
                
                // Filter by area path to match selected areas
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;

                const assignedTo = (t.fields['System.AssignedTo']?.displayName || '').toLowerCase().trim();
                const isDevMember = devMemberNames.some(name => 
                    assignedTo.includes(name) || name.includes(assignedTo)
                );
                if (!isDevMember) return false;

                const state = t.fields['System.State'] || '';
                if (state !== 'Closed' && state !== 'Resolved') return false;

                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'];
                if (discipline !== 'Development') return false;

                const taskExecutionType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                if (!discipline || !disciplineMatrix[discipline]) return false;

                const expectedPrefix = disciplineMatrix[discipline];
                return !taskExecutionType.startsWith(expectedPrefix);
            });

            // Update count
            

            // Store globally for sorting
            mismatchAllData = mismatchedTasks;
            renderMismatchTableRows();
        }
        
        function renderMismatchTableRows() {
            const thead = document.getElementById('mismatchTableHead');
            const tbody = document.getElementById('mismatchTableBody');
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            
            // Sortable header
            const thStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            const sortIcon = (field) => mismatchSortField === field ? (mismatchSortDir === 'asc' ? ' ▲' : ' ▼') : ' ⇅';
            
            if (thead) {
                thead.innerHTML = `<tr>
                    <th style="${thStyle}text-align:left;width:5%;" onclick="sortMismatchTable('id')">ID${sortIcon('id')}</th>
                    <th style="${thStyle}text-align:left;" onclick="sortMismatchTable('title')">Title${sortIcon('title')}</th>
                    <th style="${thStyle}text-align:left;width:8%;" onclick="sortMismatchTable('state')">State${sortIcon('state')}</th>
                    <th style="${thStyle}text-align:left;width:14%;" onclick="sortMismatchTable('assigned')">Assigned${sortIcon('assigned')}</th>
                    <th style="${thStyle}text-align:center;width:10%;" onclick="sortMismatchTable('discipline')">Discipline${sortIcon('discipline')}</th>
                    <th style="${thStyle}text-align:center;width:15%;" onclick="sortMismatchTable('execType')">Task Exec Type${sortIcon('execType')}</th>
                </tr>`;
            }

            if (tbody) {
                if (mismatchAllData.length === 0) {
                    document.getElementById('noMismatchData').style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    document.getElementById('noMismatchData').style.display = 'none';
                    
                    const sorted = [...mismatchAllData].sort((a, b) => {
                        let aVal, bVal;
                        switch(mismatchSortField) {
                            case 'id': aVal = a.id; bVal = b.id; break;
                            case 'title': aVal = (a.fields['System.Title'] || '').toLowerCase(); bVal = (b.fields['System.Title'] || '').toLowerCase(); break;
                            case 'state': aVal = (a.fields['System.State'] || '').toLowerCase(); bVal = (b.fields['System.State'] || '').toLowerCase(); break;
                            case 'assigned': aVal = (a.fields['System.AssignedTo']?.displayName || '').toLowerCase(); bVal = (b.fields['System.AssignedTo']?.displayName || '').toLowerCase(); break;
                            case 'areaPath': aVal = (a.fields['System.AreaPath'] || '').toLowerCase(); bVal = (b.fields['System.AreaPath'] || '').toLowerCase(); break;
                            case 'discipline': aVal = (a.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase(); bVal = (b.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase(); break;
                            case 'execType': aVal = (a.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '').toLowerCase(); bVal = (b.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '').toLowerCase(); break;
                            default: aVal = a.id; bVal = b.id;
                        }
                        if (aVal < bVal) return mismatchSortDir === 'asc' ? -1 : 1;
                        if (aVal > bVal) return mismatchSortDir === 'asc' ? 1 : -1;
                        return 0;
                    });
                    
                    tbody.innerHTML = sorted.map(t => {
                        const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '-';
                        return `<tr>
                            <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                            <td style="${tdStyle}">${t.fields['System.Title'] || ''}</td>
                            <td style="${tdStyle}">${t.fields['System.State'] || ''}</td>
                            <td style="${tdStyle}">${t.fields['System.AssignedTo']?.displayName || '-'}</td>
                            <td style="${tdStyle}text-align:center;">${t.fields['Microsoft.VSTS.Common.Discipline'] || '-'}</td>
                            <td style="${tdStyle}text-align:center;">${execType}</td>
                        </tr>`;
                    }).join('');
                }
            }
        }
        
        function sortMismatchTable(field) {
            if (mismatchSortField === field) {
                mismatchSortDir = mismatchSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                mismatchSortField = field;
                mismatchSortDir = 'asc';
            }
            renderMismatchTableRows();
        }

        function renderTagMissingTasks() {
            // Get Development members for filtering
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            const devMemberNames = devMembers.map(m => m.name.toLowerCase().trim());
            
            // AI Execution Types for calculating AI Efforts
            const aiExecTypes = ['AI-Dev-Analysis', 'AI-Dev-Code Review', 'AI-Dev-Development', 'AI-Dev-Documentation'];
            
            // Required tags - task must have at least one of these (exact match)
            const requiredTags = ['product', 'alm', 'training', 'support', 'bug/maintenance'];

            // Find tasks that don't have any of the required tags - only for Development members
            const tagMissingTasks = tasks.filter(t => {
                if (!t.fields) return false;
                
                // Check if assigned to Development member - use full name matching
                const assignedTo = (t.fields['System.AssignedTo']?.displayName || '').toLowerCase().trim();
                const isDevMember = devMemberNames.some(name => 
                    assignedTo.includes(name) || name.includes(assignedTo)
                );
                if (!isDevMember) return false;
                
                const tagsString = t.fields['System.Tags'] || '';
                // Split tags by semicolon and trim each tag for exact matching
                const tagList = tagsString.split(';').map(tag => tag.trim().toLowerCase());
                // Check if task has at least one of the required tags (exact match)
                const hasRequiredTag = requiredTags.some(reqTag => tagList.includes(reqTag));
                return !hasRequiredTag;
            });

            // Update count
            document.getElementById('tagMissingCount').textContent = tagMissingTasks.length;

            // Render table - using new table IDs for separate dashboard
            const tbody = document.getElementById('tagMissingTableBody2');
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            if (tbody) {
                if (tagMissingTasks.length === 0) {
                    document.getElementById('noTagMissingData2').style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    document.getElementById('noTagMissingData2').style.display = 'none';
                    tbody.innerHTML = tagMissingTasks.map(t => {
                        return `<tr>
                            <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                            <td style="${tdStyle}">${t.fields['System.Title'] || ''}</td>
                            <td style="${tdStyle}">${t.fields['System.AssignedTo']?.displayName || '-'}</td>
                        </tr>`;
                    }).join('');
                }
            }
        }

        let reqListLoaded = false;
        function toggleRequirementsList() {
            const btn = document.getElementById('loadReqListBtn');
            const content = document.getElementById('reqListContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!reqListLoaded) {
                    renderTable();
                    reqListLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📋 Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }

        let lastSprintOpenItems = [];
        async function loadLastSprintOpenItems() {
            const tbody = document.getElementById('lastSprintTableBody');
            const noDataDiv = document.getElementById('noLastSprintData');
            tbody.innerHTML = '';
            noDataDiv.style.display = 'none';
            
            if (selectedAreaPaths.length === 0) {
                noDataDiv.style.display = 'block';
                noDataDiv.textContent = 'No area selected';
                document.getElementById('lastSprintOpenCount').textContent = '0';
                return;
            }
            
            if (selectedIterationPaths.length === 0) {
                noDataDiv.style.display = 'block';
                noDataDiv.textContent = 'No sprint selected';
                document.getElementById('lastSprintOpenCount').textContent = '0';
                return;
            }
            const currentIterPath = selectedIterationPaths[0].path;
            
            const useExactAreaMatch = document.getElementById('exactAreaMatch')?.checked || false;
            const areaOperator = useExactAreaMatch ? '=' : 'UNDER';
            const areaFilterClauses = selectedAreaPaths.map(a => `[System.AreaPath] ${areaOperator} '${a.path}'`);
            const areaFilter = areaFilterClauses.length > 1 
                ? `(${areaFilterClauses.join(' OR ')})` 
                : areaFilterClauses[0];
            
            const currentIterIdx = iterations.findIndex(i => i.path === currentIterPath);
            if (currentIterIdx <= 0) {
                noDataDiv.style.display = 'block';
                noDataDiv.textContent = 'No previous sprint found';
                document.getElementById('lastSprintOpenCount').textContent = '0';
                return;
            }
            
            const prevIter = iterations[currentIterIdx - 1];
            const prevIterPath = prevIter.path;
            
            try {
                // Query for NOT Closed Requirements/CRs from previous sprint
                const query = `SELECT [System.Id] FROM WorkItems WHERE [System.WorkItemType] IN ('Requirement', 'Change Request') AND ${areaFilter} AND [System.IterationPath] UNDER '${prevIterPath}' AND [System.State] <> 'Closed'`;
                
                const resp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/wiql?api-version=5.0`, {
                    method: 'POST', body: JSON.stringify({ query })
                });
                const data = await resp.json();
                const ids = (data.workItems || []).map(w => w.id);
                
                document.getElementById('lastSprintOpenCount').textContent = ids.length;
                
                if (ids.length === 0) {
                    noDataDiv.textContent = 'No open items ✓';
                    noDataDiv.style.display = 'block';
                    lastSprintOpenItems = [];
                    return;
                }
                
                // Fetch work item details
                const batchSize = 200;
                const items = [];
                for (let i = 0; i < ids.length; i += batchSize) {
                    const batchIds = ids.slice(i, i + batchSize).join(',');
                    const itemsResp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/workitems?ids=${batchIds}&fields=System.Id,System.Title,System.State,System.AssignedTo,Microsoft.VSTS.Scheduling.RemainingWork&api-version=5.0`);
                    const itemsData = await itemsResp.json();
                    items.push(...(itemsData.value || []));
                }
                
                lastSprintOpenItems = items;
                
                // Render the table
                tbody.innerHTML = items.map(item => {
                    const f = item.fields;
                    return `<tr>
                        <td><a href="${tfsUrl}/${project}/_workitems/edit/${item.id}" target="_blank" class="wi-link">${item.id}</a></td>
                        <td>${f['System.Title'] || ''}</td>
                        <td>${f['System.State'] || ''}</td>
                    </tr>`;
                }).join('');
                
                noDataDiv.style.display = items.length === 0 ? 'block' : 'none';
            } catch (err) {
                console.error('Error loading last sprint data:', err);
                document.getElementById('noLastSprintData').style.display = 'block';
                document.getElementById('noLastSprintData').textContent = 'Error loading data';
            }
        }

        function renderTable() {
            let filtered = requirements;
            if (currentFilter === 'deliverable') filtered = requirements.filter(r => r.category === 'deliverable');
            else if (currentFilter === 'nonDeliverable') filtered = requirements.filter(r => r.category === 'nonDeliverable');
            else if (currentFilter === 'deliverablesAdhoc') filtered = requirements.filter(r => r.isDeliverablesAdhoc);
            else if (currentFilter === 'deliverablesOnHold') filtered = requirements.filter(r => r.isDeliverablesOnHold);
            else if (currentFilter === 'adhocSupport') filtered = requirements.filter(r => r.isAdhocSupport);
            else if (currentFilter === 'affectOthers') filtered = requirements.filter(r => r.isAffectOthers);
            else if (currentFilter === 'affectedArea') filtered = requirements.filter(r => r.isAffectedArea);
            else if (currentFilter === 'urnIn') filtered = requirements.filter(r => r.urnTag === 'urnIn');
            else if (currentFilter === 'urnCf') filtered = requirements.filter(r => r.urnTag === 'urnCf');
            else if (currentFilter === 'urnMissing') filtered = requirements.filter(r => r.urnTag === 'urnMissing');
            else if (currentFilter === 'noWeeklyTag') filtered = requirements.filter(r => r.category === 'deliverable' && !r.hasWeeklyTag);

            // Populate column filter dropdowns from current tab-filtered data
            populateReqListFilters(filtered);

            // Apply column filters
            const stateF = document.getElementById('reqFilterState')?.value || 'all';
            const assignedF = document.getElementById('reqFilterAssigned')?.value || 'all';
            const iterF = document.getElementById('reqFilterIteration')?.value || 'all';
            const catF = document.getElementById('reqFilterCategory')?.value || 'all';
            const urnF = document.getElementById('reqFilterUrn')?.value || 'all';
            if (stateF !== 'all') filtered = filtered.filter(r => (r.fields['System.State'] || '') === stateF);
            if (assignedF !== 'all') filtered = filtered.filter(r => (r.fields['System.AssignedTo']?.displayName || '-') === assignedF);
            if (iterF !== 'all') filtered = filtered.filter(r => (r.fields['System.IterationPath'] || '').split('\\').pop() === iterF);
            if (catF !== 'all') filtered = filtered.filter(r => (r.category || '') === catF);
            if (urnF !== 'all') filtered = filtered.filter(r => (r.urnTag || '') === urnF);

            // Sort the filtered data
            const sortedData = [...filtered].sort((a, b) => {
                let aVal, bVal;
                switch (reqListSortField) {
                    case 'id': aVal = a.id; bVal = b.id; break;
                    case 'title': aVal = (a.fields['System.Title'] || '').toLowerCase(); bVal = (b.fields['System.Title'] || '').toLowerCase(); break;
                    case 'state': aVal = (a.fields['System.State'] || '').toLowerCase(); bVal = (b.fields['System.State'] || '').toLowerCase(); break;
                    case 'size': aVal = a.size || 0; bVal = b.size || 0; break;
                    case 'assigned': aVal = (a.fields['System.AssignedTo']?.displayName || '').toLowerCase(); bVal = (b.fields['System.AssignedTo']?.displayName || '').toLowerCase(); break;
                    case 'category': aVal = a.category || ''; bVal = b.category || ''; break;
                    case 'urn': aVal = a.urnTag || ''; bVal = b.urnTag || ''; break;
                    case 'iteration': aVal = (a.fields['System.IterationPath'] || '').toLowerCase(); bVal = (b.fields['System.IterationPath'] || '').toLowerCase(); break;
                    default: aVal = a.id; bVal = b.id;
                }
                if (aVal < bVal) return reqListSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return reqListSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Render header with sort icons
            const thStyle = 'padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            const sortIcon = (field) => reqListSortField === field ? (reqListSortDir === 'asc' ? ' ▲' : ' ▼') : '';
            document.getElementById('reqListTableHead').innerHTML = `<tr>
                <th style="${thStyle}" onclick="sortReqList('id')">ID${sortIcon('id')}</th>
                <th style="${thStyle}" onclick="sortReqList('title')">Title${sortIcon('title')}</th>
                <th style="${thStyle}" onclick="sortReqList('state')">State${sortIcon('state')}</th>
                <th style="${thStyle}" onclick="sortReqList('size')">Size${sortIcon('size')}</th>
                <th style="${thStyle}" onclick="sortReqList('assigned')">Assigned${sortIcon('assigned')}</th>
                <th style="${thStyle}" onclick="sortReqList('iteration')">Iteration${sortIcon('iteration')}</th>
                <th style="${thStyle}" onclick="sortReqList('category')">Cat${sortIcon('category')}</th>
                <th style="${thStyle}" onclick="sortReqList('urn')">URN${sortIcon('urn')}</th>
                <th style="${thStyle}">Tags</th>
            </tr>`;

            const tbody = document.getElementById('reqTable');
            document.getElementById('noData').style.display = sortedData.length === 0 ? 'block' : 'none';

            // Tag color palette for unique colors per tag
            const tagColorPalette = [
                { bg: 'rgba(59,130,246,0.25)', color: '#93c5fd', lBg: 'rgba(59,130,246,0.15)', lColor: '#1d4ed8' },
                { bg: 'rgba(16,185,129,0.25)', color: '#6ee7b7', lBg: 'rgba(16,185,129,0.15)', lColor: '#047857' },
                { bg: 'rgba(245,158,11,0.25)', color: '#fcd34d', lBg: 'rgba(245,158,11,0.15)', lColor: '#92400e' },
                { bg: 'rgba(168,85,247,0.25)', color: '#d8b4fe', lBg: 'rgba(168,85,247,0.15)', lColor: '#6b21a8' },
                { bg: 'rgba(236,72,153,0.25)', color: '#f9a8d4', lBg: 'rgba(236,72,153,0.15)', lColor: '#9d174d' },
                { bg: 'rgba(6,182,212,0.25)', color: '#67e8f9', lBg: 'rgba(6,182,212,0.15)', lColor: '#0e7490' },
                { bg: 'rgba(239,68,68,0.25)', color: '#fca5a5', lBg: 'rgba(239,68,68,0.15)', lColor: '#b91c1c' },
                { bg: 'rgba(34,197,94,0.25)', color: '#86efac', lBg: 'rgba(34,197,94,0.15)', lColor: '#15803d' },
                { bg: 'rgba(99,102,241,0.25)', color: '#a5b4fc', lBg: 'rgba(99,102,241,0.15)', lColor: '#4338ca' },
                { bg: 'rgba(251,146,60,0.25)', color: '#fdba74', lBg: 'rgba(251,146,60,0.15)', lColor: '#c2410c' },
            ];
            const tagColorMap = {};
            let tagColorIdx = 0;
            const isLight = document.body.classList.contains('light-theme');

            tbody.innerHTML = sortedData.map(req => {
                const f = req.fields;
                const catLabel = req.category === 'deliverable' ? 'Deliverable' : req.category === 'nonDeliverable' ? 'Non-Deliverable' : '-';
                const catClass = req.category === 'deliverable' ? 'deliverable' : req.category === 'nonDeliverable' ? 'non-deliverable' : '';
                const urnLabel = req.urnTag === 'urnIn' ? 'URN-IN' : req.urnTag === 'urnCf' ? 'URN-CF' : '-';
                const urnClass = req.urnTag === 'urnIn' ? 'urn-in' : req.urnTag === 'urnCf' ? 'urn-cf' : '';
                const iterLeaf = (f['System.IterationPath'] || '').split('\\').pop();
                const rawTags = (f['System.Tags'] || '').split(';').map(t => t.trim()).filter(t => t);
                const tagBadges = rawTags.length > 0 ? rawTags.map(tag => {
                    const tagKey = tag.toLowerCase();
                    if (!tagColorMap[tagKey]) { tagColorMap[tagKey] = tagColorPalette[tagColorIdx % tagColorPalette.length]; tagColorIdx++; }
                    const tc = tagColorMap[tagKey];
                    const bg = isLight ? tc.lBg : tc.bg;
                    const clr = isLight ? tc.lColor : tc.color;
                    return `<span style="display:inline-block;background:${bg};color:${clr};padding:1px 6px;border-radius:4px;font-size:0.6rem;margin:1px 2px;white-space:nowrap;font-weight:500;">${tag}</span>`;
                }).join('') : '<span class="c-dim">-</span>';
                return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${req.id}" target="_blank" class="wi-link">${req.id}</a></td><td>${f['System.Title'] || ''}</td><td>${f['System.State'] || ''}</td><td style="text-align:center;">${req.size}</td><td  title="${f['System.AssignedTo']?.displayName || '-'}">${f['System.AssignedTo']?.displayName || '-'}</td><td style="color:#c084fc;">${iterLeaf}</td><td>${catClass ? `<span class="badge badge-${catClass}">${catLabel}</span>` : '-'}</td><td>${urnClass ? `<span class="badge badge-${urnClass}">${urnLabel}</span>` : '-'}</td><td style="max-width:180px;">${tagBadges}</td></tr>`;
            }).join('');
        }

        function populateReqListFilters(data) {
            const stateEl = document.getElementById('reqFilterState');
            const assignedEl = document.getElementById('reqFilterAssigned');
            const iterEl = document.getElementById('reqFilterIteration');
            const catEl = document.getElementById('reqFilterCategory');
            const urnEl = document.getElementById('reqFilterUrn');
            if (!stateEl) return;
            const curState = stateEl.value, curAssigned = assignedEl.value, curIter = iterEl.value;
            const curCat = catEl ? catEl.value : 'all', curUrn = urnEl ? urnEl.value : 'all';

            const states = [...new Set(data.map(r => r.fields['System.State'] || ''))].filter(Boolean).sort();
            const assigned = [...new Set(data.map(r => r.fields['System.AssignedTo']?.displayName || '-'))].sort();
            const iters = [...new Set(data.map(r => (r.fields['System.IterationPath'] || '').split('\\').pop()).filter(Boolean))].sort();
            const cats = [...new Set(data.map(r => r.category || ''))].filter(Boolean).sort();
            const urns = [...new Set(data.map(r => r.urnTag || ''))].filter(Boolean).sort();

            const catLabels = { deliverable: 'Deliverable', nonDeliverable: 'Non-Deliverable' };
            const urnLabels = { urnIn: 'URN-IN', urnCf: 'URN-CF' };

            stateEl.innerHTML = '<option value="all">All States</option>' + states.map(s => `<option value="${s}">${s}</option>`).join('');
            assignedEl.innerHTML = '<option value="all">All Assigned</option>' + assigned.map(a => `<option value="${a}">${a}</option>`).join('');
            iterEl.innerHTML = '<option value="all">All Iterations</option>' + iters.map(i => `<option value="${i}">${i}</option>`).join('');
            if (catEl) catEl.innerHTML = '<option value="all">All Categories</option>' + cats.map(c => `<option value="${c}">${catLabels[c] || c}</option>`).join('');
            if (urnEl) urnEl.innerHTML = '<option value="all">All URN</option>' + urns.map(u => `<option value="${u}">${urnLabels[u] || u}</option>`).join('');

            // Restore selection if still valid
            if (states.includes(curState)) stateEl.value = curState;
            if (assigned.includes(curAssigned)) assignedEl.value = curAssigned;
            if (iters.includes(curIter)) iterEl.value = curIter;
            if (catEl && cats.includes(curCat)) catEl.value = curCat;
            if (urnEl && urns.includes(curUrn)) urnEl.value = curUrn;
        }

        function resetReqListFilters() {
            const stateEl = document.getElementById('reqFilterState');
            const assignedEl = document.getElementById('reqFilterAssigned');
            const iterEl = document.getElementById('reqFilterIteration');
            const catEl = document.getElementById('reqFilterCategory');
            const urnEl = document.getElementById('reqFilterUrn');
            if (stateEl) stateEl.value = 'all';
            if (assignedEl) assignedEl.value = 'all';
            if (iterEl) iterEl.value = 'all';
            if (catEl) catEl.value = 'all';
            if (urnEl) urnEl.value = 'all';
            renderTable();
        }

        function sortReqList(field) {
            if (reqListSortField === field) {
                reqListSortDir = reqListSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                reqListSortField = field;
                reqListSortDir = 'asc';
            }
            renderTable();
        }

        function filterTable(cat, btn) {
            currentFilter = cat;
            document.querySelectorAll('.table-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderTable();
        }

        // Export AI Adoption Data to Excel
        // Helper: Calculate AI adoption metrics from aggregated data
        function calcAIMetrics(d) {
            // AI Adoption = hours based: (AI OrigEst + AI-Ineff OrigEst) / (AI + AI-Ineff + Manual) OrigEst
            const aiOrig = d.aiOrigEst || 0;
            const aiIneffOrig = d.manualAiIneffOrigEst || 0;
            const manOrig = d.manualOrigEst || 0;
            const totalHours = aiOrig + aiIneffOrig + manOrig;
            const manComp = d.manualCompleted || 0;
            const aiIneffComp = d.manualAiIneffCompleted || 0;
            const manEffDenom = manOrig + aiIneffOrig;
            return {
                aiAdoption: totalHours > 0 ? Math.round(((aiOrig + aiIneffOrig) / totalHours) * 100) : 0,
                manualEff: manEffDenom > 0 ? Math.round(((manEffDenom - (manComp + aiIneffComp)) / manEffDenom) * 100) : 0,
                aiEff: aiOrig > 0 ? Math.round(((aiOrig - (d.aiCompleted||0)) / aiOrig) * 100) : 0,
                hourSaved: aiOrig - (d.aiCompleted||0)
            };
        }

        // Helper: Build Excel data cells (counts + hours + metrics)
        function buildExcelDataCells(d, bg) {
            const s = bg ? ` style="background-color: ${bg};"` : '';
            const sb = bg ? ` style="font-weight: bold; background-color: ${bg};"` : '';
            const m = calcAIMetrics(d);
            return `<td class="center"${sb}>${d.taskCount}</td>
        <td class="center"${s}>${d.claudeAiCount}</td>
        <td class="center"${s}>${d.copilotCount}</td>
        <td class="center"${s}>${d.manualAiIneffCount || 0}</td>
        <td class="center"${s}>${d.manualCount}</td>
        <td class="number"${s}>${d.aiOrigEst.toFixed(2)}</td>
        <td class="number"${s}>${d.aiCompleted.toFixed(2)}</td>
        <td class="number"${s}>${(d.manualAiIneffOrigEst || 0).toFixed(2)}</td>
        <td class="number"${s}>${(d.manualAiIneffCompleted || 0).toFixed(2)}</td>
        <td class="number"${s}>${d.manualOrigEst.toFixed(2)}</td>
        <td class="number"${s}>${d.manualCompleted.toFixed(2)}</td>
        <td class="center"${sb}>${m.aiAdoption}%</td>
        <td class="center"${s}>${m.manualEff}%</td>
        <td class="center"${s}>${m.aiEff}%</td>
        <td class="number"${sb}>${m.hourSaved.toFixed(2)}</td>`;
        }

        // Helper: Aggregate member data by a key function
        function aggregateMembersByKey(members, keyFn) {
            const groups = {};
            const fields = ['taskCount','claudeAiCount','copilotCount','manualAiIneffCount','manualCount',
                'aiOrigEst','aiCompleted','manualAiIneffOrigEst','manualAiIneffCompleted','manualOrigEst','manualCompleted'];
            members.forEach(m => {
                const key = keyFn(m);
                if (!groups[key]) { groups[key] = { key }; fields.forEach(f => groups[key][f] = 0); }
                fields.forEach(f => groups[key][f] += (m[f] || 0));
            });
            return Object.values(groups);
        }

        function exportAIAdoptionToExcel() {
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable' || req.isAdhocSupport) validReqIds.add(req.id);
            });
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            const completedStates = ['resolved', 'closed'];
            const validTasks = tasks.filter(t => {
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;
                const state = (t.fields['System.State'] || '').toLowerCase();
                const reason = (t.fields['System.Reason'] || '').toLowerCase();
                const origEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                return completedStates.includes(state) && reason !== 'rejected' && origEst > 0;
            });
            const memberDataMap = {};
            devMembers.forEach(m => {
                memberDataMap[m.name] = {
                    name: m.name, project: m.project || '-', team: m.team || '-',
                    taskCount: 0, claudeAiCount: 0, copilotCount: 0, manualCount: 0,
                    aiOrigEst: 0, aiCompleted: 0, manualOrigEst: 0, manualCompleted: 0,
                    manualAiIneffCount: 0, manualAiIneffOrigEst: 0, manualAiIneffCompleted: 0
                };
            });
            validTasks.forEach(t => {
                const assignedTo = t.fields['System.AssignedTo']?.displayName || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                const origEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const completed = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                const hasClaudeAiTag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                const isAiType = execType.startsWith('AI-Dev') || execType.startsWith('AI-Test-Auto-');
                const isManualType = execType === 'Manual';
                if (!isAiType && !isManualType) return;
                const assignedToLower = assignedTo.toLowerCase().trim();
                const memberKey = Object.keys(memberDataMap).find(name => {
                    const nameLower = name.toLowerCase().trim();
                    return assignedToLower.includes(nameLower) || nameLower.includes(assignedToLower);
                });
                if (memberKey) {
                    const md = memberDataMap[memberKey];
                    md.taskCount++;
                    if (isAiType) {
                        if (hasClaudeAiTag) md.claudeAiCount++; else md.copilotCount++;
                        md.aiOrigEst += origEst; md.aiCompleted += completed;
                    } else if (isManualType) {
                        md.manualCount++; md.manualOrigEst += origEst; md.manualCompleted += completed;
                    }
                }
            });
            const memberResults = Object.values(memberDataMap).filter(m => m.taskCount > 0);
            const grand = { taskCount: 0, claudeAiCount: 0, copilotCount: 0, manualCount: 0, manualAiIneffCount: 0,
                aiOrigEst: 0, aiCompleted: 0, manualOrigEst: 0, manualCompleted: 0,
                manualAiIneffOrigEst: 0, manualAiIneffCompleted: 0 };
            memberResults.forEach(m => { Object.keys(grand).forEach(k => grand[k] += (m[k] || 0)); });
            const gm = calcAIMetrics(grand);
            const sprintName = document.getElementById('iterationPath')?.textContent || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const hdrs = `<th>Tasks</th><th>Claude AI</th><th>Copilot</th><th>AI-Ineff</th><th>Manual</th><th>AI Orig (h)</th><th>AI Comp (h)</th><th>AI-Ineff Orig (h)</th><th>AI-Ineff Comp (h)</th><th>Manual Orig (h)</th><th>Manual Comp (h)</th><th>AI Adoption %</th><th>Manual Eff %</th><th>AI Eff %</th><th>Hour Saved (h)</th>`;

            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="UTF-8">
<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>AI Adoption Report</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
<style>
    table { border-collapse: collapse; font-family: Calibri, Arial, sans-serif; font-size: 11pt; }
    th { background-color: #4472C4; color: white; font-weight: bold; padding: 8px 12px; border: 1px solid #2F5496; text-align: center; }
    td { padding: 6px 12px; border: 1px solid #B4C6E7; }
    tr:nth-child(even) td { background-color: #D6DCE5; }
    tr:nth-child(odd) td { background-color: #FFFFFF; }
    .left { text-align: left; } .center { text-align: center; } .number { text-align: right; }
    .footer td { background-color: #4472C4 !important; color: white; font-weight: bold; }
</style></head><body>
<table><tr><th>Member</th><th>Project</th><th>Area</th>${hdrs}</tr>`;
            memberResults.forEach(m => {
                html += `\n    <tr><td class="left">${m.name}</td><td class="left">${m.project}</td><td class="left">${m.team}</td>${buildExcelDataCells(m)}</tr>`;
            });
            html += `\n    <tr class="footer"><td class="left">GRAND TOTAL</td><td></td><td></td>${buildExcelDataCells(grand)}</tr>`;

            // Area-wise summary
            html += `\n</table><br/><br/>\n<table><tr><th colspan="18" style="background-color: #217346; text-align: left;">📊 AREA-WISE SUMMARY</th></tr>
    <tr><th>Area</th><th>Project</th><th>Team</th>${hdrs}</tr>`;
            aggregateMembersByKey(memberResults, m => m.team || '-').forEach(a => {
                const proj = memberResults.find(m => (m.team||'-') === a.key)?.project || '-';
                html += `\n    <tr style="background-color: #D6EAF8;"><td class="left" style="font-weight:bold;background-color:#D6EAF8;">🏷️ ${a.key}</td><td class="left" style="background-color:#D6EAF8;">${proj}</td><td style="background-color:#D6EAF8;"></td>${buildExcelDataCells(a, '#D6EAF8')}</tr>`;
            });

            // Project-wise summary
            html += `\n</table><br/><br/>\n<table><tr><th colspan="16" style="background-color: #6F42C1; text-align: left;">📁 PROJECT-WISE SUMMARY</th></tr>
    <tr><th>Project</th>${hdrs}</tr>`;
            aggregateMembersByKey(memberResults, m => m.project || '-').forEach(p => {
                html += `\n    <tr style="background-color: #E2EFDA;"><td class="left" style="font-weight:bold;background-color:#E2EFDA;">📁 ${p.key}</td>${buildExcelDataCells(p, '#E2EFDA')}</tr>`;
            });

            html += `\n</table></body></html>`;
            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Adoption_Report_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.xls`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Export AI Adoption Data to PDF
        function exportAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            
            // Get all the summary data
            const devMemberCount = document.getElementById('aiDevMemberCount').textContent;
            const totalTasks = document.getElementById('aiTotalTasks').textContent;
            const totalOrigEst = document.getElementById('aiTotalOrigEst').textContent;
            const totalCompleted = document.getElementById('aiTotalCompleted').textContent;
            const manualEff = document.getElementById('aiManualEfficiency').textContent;
            const aiEff = document.getElementById('aiAIEfficiency').textContent;
            
            // Clone and get table HTML with inline styles preserved
            const memberTable = document.getElementById('aiAdoptionTable');
            const areaTable = document.getElementById('areaSummaryTable');
            const projectTable = document.getElementById('projectSummaryTable');
            
            let pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI Adoption Report - ${sprintName}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media print {
            @page { size: landscape; margin: 0; }
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
            table { page-break-inside: auto; }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            font-size: 9pt; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0; 
            padding: 20px;
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(168,85,247,0.15));
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
        h1 { color: #c4b5fd; font-size: 16pt; margin-bottom: 8px; }
        .header-info { color: #94a3b8; font-size: 8pt; }
        .header-info strong { color: #e2e8f0; }
        
        .summary-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .summary-box { 
            background: rgba(139,92,246,0.15);
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 8px; 
            padding: 12px 16px; 
            min-width: 90px;
            text-align: center;
        }
        .summary-box .value { font-size: 16pt; font-weight: 700; color: #a78bfa; }
        .summary-box .label { font-size: 7pt; color: #94a3b8; text-transform: uppercase; margin-top: 4px; }
        
        .section { 
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .section.area { 
            background: rgba(6,182,212,0.1);
            border: 1px solid rgba(6,182,212,0.3);
        }
        .section.project { 
            background: rgba(99,102,241,0.1);
            border: 1px solid rgba(99,102,241,0.3);
        }
        h2 { 
            color: #c4b5fd; 
            font-size: 11pt; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        h2.area { color: #67e8f9; }
        h2.project { color: #a5b4fc; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 8pt;
            table-layout: fixed;
            word-wrap: break-word;
        }
        th { 
            background: rgba(0,0,0,0.3);
            color: #c4b5fd; 
            padding: 8px 5px; 
            text-align: center; 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 7pt;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        th.area { color: #67e8f9; }
        th.project { color: #a5b4fc; }
        td { 
            padding: 6px 5px; 
            border-bottom: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }
        td.left { text-align: left; }
        tr:hover { background: rgba(139,92,246,0.1); }
        
        .text-purple { color: #c4b5fd; }
        .text-cyan { color: #22d3ee; }
        .text-yellow { color: #fcd34d; }
        .text-green { color: #34d399; }
        .text-blue { color: #60a5fa; }
        .text-pink { color: #f472b6; }
        .text-white { color: #e2e8f0; }
        .text-muted { color: #94a3b8; }
        .font-bold { font-weight: 600; }
        
        .footer-row { 
            background: rgba(139,92,246,0.15) !important;
            font-weight: 600;
        }
        .footer-row td { border-top: 2px solid rgba(139,92,246,0.3); }
        
        .footer { 
            margin-top: 20px; 
            font-size: 7pt; 
            color: #64748b; 
            text-align: center; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            padding-top: 10px; 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🤖 AI Adoption Report</h1>
        <div class="header-info">
            <strong>Sprint:</strong> ${sprintName} &nbsp;|&nbsp; 
            <strong>Area:</strong> ${areaNames} &nbsp;|&nbsp;
            <strong>Projects:</strong> ${selectedProjects.join(', ')} &nbsp;|&nbsp;
            <strong>Generated:</strong> ${new Date().toLocaleString()}
        </div>
    </div>
    
    <div class="summary-grid">
        <div class="summary-box"><div class="value">${devMemberCount}</div><div class="label">Dev Members</div></div>
        <div class="summary-box"><div class="value">${totalTasks}</div><div class="label">Total Tasks</div></div>
        <div class="summary-box"><div class="value">${totalOrigEst}</div><div class="label">Total Orig Est</div></div>
        <div class="summary-box"><div class="value">${totalCompleted}</div><div class="label">Total Completed</div></div>
        <div class="summary-box"><div class="value">${manualEff}</div><div class="label">Manual Eff.</div></div>
        <div class="summary-box"><div class="value">${aiEff}</div><div class="label">AI Eff.</div></div>
    </div>
    
    <div class="section">
        <h2>👥 Member-wise Summary</h2>
        ${buildPdfTable(memberTable, 'member')}
    </div>
    
    <div class="section area">
        <h2 class="area">🏷️ Area-wise Summary</h2>
        ${buildPdfTable(areaTable, 'area')}
    </div>
    
    <div class="section project">
        <h2 class="project">📁 Project-wise Summary</h2>
        ${buildPdfTable(projectTable, 'project')}
    </div>
    
    <div class="footer">
        Sprint Requirements Tracker - AI Adoption Report | Generated on ${new Date().toLocaleString()}
    </div>
</body>
</html>`;
            
            // Generate and download PDF directly using jsPDF and html2canvas
            generateAndDownloadPDF(pdfContent, `AI_Adoption_Report_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.pdf`);
        }
        
        // Helper function to generate and download PDF directly
        async function generateAndDownloadPDF(htmlContent, filename) {
            // Create a hidden iframe to render the content
            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.left = '-9999px';
            iframe.style.width = '1400px';
            iframe.style.height = '900px';
            document.body.appendChild(iframe);
            
            iframe.contentDocument.open();
            iframe.contentDocument.write(htmlContent);
            iframe.contentDocument.close();
            
            // Wait for content to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            try {
                const { jsPDF } = window.jspdf;
                const element = iframe.contentDocument.body;
                
                // Capture the content as canvas
                const canvas = await html2canvas(element, {
                    scale: 1.5,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#0f172a',
                    width: element.scrollWidth,
                    height: element.scrollHeight,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight
                });
                
                // Create PDF in landscape A4
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pageWidth = 297; // A4 landscape width in mm
                const pageHeight = 210; // A4 landscape height in mm
                const margin = 5;
                
                const imgWidth = pageWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const imgData = canvas.toDataURL('image/png');
                
                // Add first page
                pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
                
                // Handle multi-page if content is too long
                let heightLeft = imgHeight - (pageHeight - margin * 2);
                let position = -(pageHeight - margin * 2) + margin;
                
                while (heightLeft > 0) {
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - margin * 2);
                    position -= (pageHeight - margin * 2);
                }
                
                // Download PDF directly
                pdf.save(filename);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                // Clean up iframe
                document.body.removeChild(iframe);
            }
        }
        
        // Helper function to build PDF table with proper styling
        function buildPdfTable(table, type) {
            if (!table || !table.innerHTML.trim()) {
                return '<p style="color:#94a3b8;text-align:center;padding:12px;">No data available</p>';
            }
            
            const thClass = type === 'area' ? 'area' : type === 'project' ? 'project' : '';
            
            // Clone and process the table
            const clone = table.cloneNode(true);
            
            // Remove sort icons from headers
            clone.querySelectorAll('th').forEach(th => {
                th.textContent = th.textContent.replace(/[▲▼⇅]/g, '').trim();
                if (thClass) th.classList.add(thClass);
            });
            
            // Process cells to add appropriate classes based on content/color
            clone.querySelectorAll('td').forEach(td => {
                const style = td.getAttribute('style') || '';
                if (style.includes('#c4b5fd') || style.includes('a78bfa')) td.classList.add('text-purple');
                else if (style.includes('#22d3ee') || style.includes('67e8f9')) td.classList.add('text-cyan');
                else if (style.includes('#fcd34d') || style.includes('fbbf24')) td.classList.add('text-yellow');
                else if (style.includes('#34d399')) td.classList.add('text-green');
                else if (style.includes('#60a5fa')) td.classList.add('text-blue');
                else if (style.includes('#f472b6')) td.classList.add('text-pink');
                else if (style.includes('#e2e8f0')) td.classList.add('text-white');
                else if (style.includes('#94a3b8')) td.classList.add('text-muted');
                
                if (style.includes('font-weight')) td.classList.add('font-bold');
                if (style.includes('text-align:left') || style.includes('text-align: left')) td.classList.add('left');
                
                // Remove inline styles
                td.removeAttribute('style');
            });
            
            // Process footer rows
            clone.querySelectorAll('tfoot tr').forEach(tr => {
                tr.classList.add('footer-row');
            });
            
            // Remove all remaining inline styles from rows
            clone.querySelectorAll('tr').forEach(tr => {
                tr.removeAttribute('style');
                tr.removeAttribute('onmouseover');
                tr.removeAttribute('onmouseout');
            });
            
            clone.querySelectorAll('th').forEach(th => {
                th.removeAttribute('style');
                th.removeAttribute('onclick');
            });
            
            return clone.outerHTML;
        }

        // ==================== TAB 6: WEEKLY TASK BREAKDOWN ====================
        let wbWeekFilter = 'All';
        let wbAiDiscFilter = 'All', wbManualDiscFilter = 'All';
        let wbDataLoaded = false;
        let wbAllTasks = [];
        let wbAiSortField = 'id', wbAiSortDir = 'asc';
        let wbManualSortField = 'id', wbManualSortDir = 'asc';

        function loadWeeklyTaskBreakdown() {
            const content = document.getElementById('weeklyBreakdownContent');
            const btn = document.getElementById('loadWeeklyBreakdownBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '🔼 Hide';
                if (!wbDataLoaded) {
                    wbDataLoaded = true;
                    buildWeeklyBreakdownData();
                }
            } else {
                content.style.display = 'none';
                btn.textContent = '📊 Show';
            }
        }

        function getSprintWeek(task) {
            // Determine which week of the sprint this task was resolved/closed
            const sDate = storedSprintStartDate;
            if (!sDate) return null;
            const stateChangeStr = task.fields['Microsoft.VSTS.Common.StateChangeDate'];
            if (!stateChangeStr) return null;
            const stateDate = new Date(stateChangeStr);
            if (isNaN(stateDate.getTime())) return null;
            const diffMs = stateDate - sDate;
            if (diffMs < 0) return null; // before sprint start
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const week = Math.min(4, Math.floor(diffDays / 7) + 1);
            return 'week' + week;
        }

        function buildWeeklyBreakdownData() {
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable' || req.isAdhocSupport) validReqIds.add(req.id);
            });
            bugs.forEach(b => { if ((b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')) validReqIds.add(b.id); });
            const completedStates = ['resolved', 'closed'];
            wbAllTasks = tasks.filter(t => {
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;
                const state = (t.fields['System.State'] || '').toLowerCase();
                const reason = (t.fields['System.Reason'] || '').toLowerCase();
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                const isAiType = execType.startsWith('AI-Dev') || execType.startsWith('AI-Test');
                const isManualType = execType === 'Manual' || execType === 'Manual-AI-Ineffective';
                if (!isAiType && !isManualType) return false;
                return completedStates.includes(state) && reason !== 'rejected' && origEst > 0;
            });
            // Calculate sprint week for each task
            wbAllTasks.forEach(t => { t._sprintWeek = getSprintWeek(t); });
            renderWeeklyBreakdown();
        }

        function filterWbByWeek(week) {
            wbWeekFilter = week;
            renderWeeklyBreakdown();
        }

        function filterWbAiDisc(disc) {
            wbAiDiscFilter = disc;
            renderWeeklyBreakdown();
        }

        function filterWbManualDisc(disc) {
            wbManualDiscFilter = disc;
            renderWeeklyBreakdown();
        }

        function renderWeeklyBreakdown() {
            const lt = document.body.classList.contains('light-theme');
            const filtered = wbWeekFilter === 'All' ? wbAllTasks : wbAllTasks.filter(t => t._sprintWeek === wbWeekFilter);
            const aiTasksAll = filtered.filter(t => { const et = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || ''; return et.startsWith('AI-Dev') || et.startsWith('AI-Test'); });
            const manualTasksAll = filtered.filter(t => { const et = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || ''; return et === 'Manual' || et === 'Manual-AI-Ineffective'; });

            // Apply discipline filters
            const aiTasks = wbAiDiscFilter === 'All' ? aiTasksAll : aiTasksAll.filter(t => (t.fields['Microsoft.VSTS.Common.Discipline']||'') === wbAiDiscFilter);
            const manualTasks = wbManualDiscFilter === 'All' ? manualTasksAll : manualTasksAll.filter(t => (t.fields['Microsoft.VSTS.Common.Discipline']||'') === wbManualDiscFilter);

            // Week counts
            const weekCounts = {};
            wbAllTasks.forEach(t => { if (t._sprintWeek) weekCounts[t._sprintWeek] = (weekCounts[t._sprintWeek] || 0) + 1; });
            const weekTagKeys = ['week1','week2','week3','week4'].filter(w => weekCounts[w]);
            const wLabels = { week1: 'Week 1', week2: 'Week 2', week3: 'Week 3', week4: 'Week 4' };
            const wRgb = { week1: '59,130,246', week2: '16,185,129', week3: '245,158,11', week4: '236,72,153' };
            const wClr = { week1: '#93c5fd', week2: '#6ee7b7', week3: '#fcd34d', week4: '#f9a8d4' };
            const btnS = 'padding:3px 10px;border-radius:4px;font-size:0.65rem;cursor:pointer;border:1px solid;transition:all 0.2s;';
            const btnsEl = document.getElementById('wbWeekFilterBtns');
            btnsEl.innerHTML = `<button onclick="filterWbByWeek('All')" style="${btnS}background:${wbWeekFilter==='All'?'rgba(139,92,246,0.5)':'rgba(255,255,255,0.08)'};border-color:${wbWeekFilter==='All'?'rgba(139,92,246,0.7)':'rgba(255,255,255,0.15)'};color:${wbWeekFilter==='All'?'#c4b5fd':'#94a3b8'};">All (${wbAllTasks.length})</button>` +
                weekTagKeys.map(wt => {
                    const isAct = wbWeekFilter === wt;
                    const rgb = wRgb[wt] || '100,116,139'; const clr = wClr[wt] || '#94a3b8';
                    return `<button onclick="filterWbByWeek('${wt}')" style="${btnS}background:${isAct?`rgba(${rgb},0.5)`:'rgba(255,255,255,0.08)'};border-color:${isAct?`rgba(${rgb},0.7)`:'rgba(255,255,255,0.15)'};color:${isAct?clr:'#94a3b8'};">${wLabels[wt]||wt} (${weekCounts[wt]})</button>`;
                }).join('');

            // Sprint date range info
            const dateInfoEl = document.getElementById('wbSprintDateInfo');
            if (storedSprintStartDate && storedSprintEndDate) {
                const fmt = d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dateInfoEl.innerHTML = `<span style="color:${lt?'#475569':'#94a3b8'};font-size:0.65rem;">📅 Sprint: ${fmt(storedSprintStartDate)} — ${fmt(storedSprintEndDate)} &nbsp;|&nbsp; Week = 7 calendar days from start</span>`;
            } else {
                dateInfoEl.innerHTML = `<span style="color:#f87171;font-size:0.65rem;">⚠️ Sprint dates not available — week calculation unavailable</span>`;
            }

            // Summary cards
            const getOrig = t => { const re = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate']||0; const oe = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate']||0; return re>0?re:oe; };
            const aiOrigH = aiTasks.reduce((s,t) => s + getOrig(t), 0);
            const aiCompH = aiTasks.reduce((s,t) => s + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork']||0), 0);
            const manOrigH = manualTasks.reduce((s,t) => s + getOrig(t), 0);
            const manCompH = manualTasks.reduce((s,t) => s + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork']||0), 0);
            // AI Adoption = hours based: (AI + AI-Ineff) OrigEst / (AI + AI-Ineff + Manual) OrigEst
            const aiAllOrigH = aiTasksAll.reduce((s,t) => s + getOrig(t), 0);
            const aiIneffAllOrigH = manualTasksAll.filter(t => (t.fields['Casepoint.TFS.CustomFields.TaskExecutionType']||'') === 'Manual-AI-Ineffective').reduce((s,t) => s + getOrig(t), 0);
            const manAllOrigH = manualTasksAll.filter(t => (t.fields['Casepoint.TFS.CustomFields.TaskExecutionType']||'') === 'Manual').reduce((s,t) => s + getOrig(t), 0);
            const totalAdoptH = aiAllOrigH + aiIneffAllOrigH + manAllOrigH;
            const aiAdoptRate = totalAdoptH > 0 ? Math.round(((aiAllOrigH + aiIneffAllOrigH) / totalAdoptH) * 100) : 0;
            const aiEff = aiOrigH > 0 ? Math.round(((aiOrigH - aiCompH) / aiOrigH) * 100) : 0;
            const manEff = manOrigH > 0 ? Math.round(((manOrigH - manCompH) / manOrigH) * 100) : 0;
            document.getElementById('wbSummaryRow').innerHTML = `
                <div class="summary-stat" style="background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.3);padding:12px;"><div class="value" style="font-size:1.2rem;color:#60a5fa;">${filtered.length}</div><div class="label fs-sm-bold">Total Tasks</div></div>
                <div class="summary-stat" style="background:rgba(16,185,129,0.2);border-color:rgba(16,185,129,0.3);padding:12px;"><div class="value" style="font-size:1.2rem;color:#34d399;">${aiTasksAll.length}</div><div class="label fs-sm-bold">AI Tasks</div></div>
                <div class="summary-stat" style="background:rgba(245,158,11,0.2);border-color:rgba(245,158,11,0.3);padding:12px;"><div class="value" style="font-size:1.2rem;color:#fbbf24;">${manualTasksAll.length}</div><div class="label fs-sm-bold">Manual Tasks</div></div>
                <div class="summary-stat" style="background:rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.3);padding:12px;"><div class="value" style="font-size:1.2rem;color:#c4b5fd;">${aiAdoptRate}%</div><div class="label fs-sm-bold">AI Adoption</div></div>
                <div class="summary-stat" style="background:rgba(16,185,129,0.15);border-color:rgba(16,185,129,0.25);padding:12px;"><div class="value" style="font-size:1.2rem;color:${aiEff>=0?'#34d399':'#f87171'};">${aiEff}%</div><div class="label fs-sm-bold">AI Eff.</div></div>
                <div class="summary-stat" style="background:rgba(245,158,11,0.15);border-color:rgba(245,158,11,0.25);padding:12px;"><div class="value" style="font-size:1.2rem;color:${manEff>=0?'#fcd34d':'#f87171'};">${manEff}%</div><div class="label fs-sm-bold">Manual Eff.</div></div>`;

            // Discipline filters for AI section
            const aiDiscs = [...new Set(aiTasksAll.map(t => t.fields['Microsoft.VSTS.Common.Discipline']||'-'))].sort();
            const aiDiscEl = document.getElementById('wbAiDiscBtns');
            if (aiDiscs.length > 1) {
                document.getElementById('wbAiDiscBar').style.display = 'flex';
                aiDiscEl.innerHTML = `<button onclick="filterWbAiDisc('All')" style="${btnS}background:${wbAiDiscFilter==='All'?'rgba(16,185,129,0.5)':'rgba(255,255,255,0.08)'};border-color:${wbAiDiscFilter==='All'?'rgba(16,185,129,0.7)':'rgba(255,255,255,0.15)'};color:${wbAiDiscFilter==='All'?'#6ee7b7':'#94a3b8'};">All (${aiTasksAll.length})</button>` +
                    aiDiscs.map(d => {
                        const cnt = aiTasksAll.filter(t => (t.fields['Microsoft.VSTS.Common.Discipline']||'-') === d).length;
                        const isA = wbAiDiscFilter === d;
                        return `<button onclick="filterWbAiDisc('${d.replace(/'/g,"\\'")}')" style="${btnS}background:${isA?'rgba(16,185,129,0.5)':'rgba(255,255,255,0.08)'};border-color:${isA?'rgba(16,185,129,0.7)':'rgba(255,255,255,0.15)'};color:${isA?'#6ee7b7':'#94a3b8'};">${d} (${cnt})</button>`;
                    }).join('');
            } else { document.getElementById('wbAiDiscBar').style.display = 'none'; }

            // Discipline filters for Manual section
            const manDiscs = [...new Set(manualTasksAll.map(t => t.fields['Microsoft.VSTS.Common.Discipline']||'-'))].sort();
            const manDiscEl = document.getElementById('wbManualDiscBtns');
            if (manDiscs.length > 1) {
                document.getElementById('wbManualDiscBar').style.display = 'flex';
                manDiscEl.innerHTML = `<button onclick="filterWbManualDisc('All')" style="${btnS}background:${wbManualDiscFilter==='All'?'rgba(245,158,11,0.5)':'rgba(255,255,255,0.08)'};border-color:${wbManualDiscFilter==='All'?'rgba(245,158,11,0.7)':'rgba(255,255,255,0.15)'};color:${wbManualDiscFilter==='All'?'#fcd34d':'#94a3b8'};">All (${manualTasksAll.length})</button>` +
                    manDiscs.map(d => {
                        const cnt = manualTasksAll.filter(t => (t.fields['Microsoft.VSTS.Common.Discipline']||'-') === d).length;
                        const isA = wbManualDiscFilter === d;
                        return `<button onclick="filterWbManualDisc('${d.replace(/'/g,"\\'")}')" style="${btnS}background:${isA?'rgba(245,158,11,0.5)':'rgba(255,255,255,0.08)'};border-color:${isA?'rgba(245,158,11,0.7)':'rgba(255,255,255,0.15)'};color:${isA?'#fcd34d':'#94a3b8'};">${d} (${cnt})</button>`;
                    }).join('');
            } else { document.getElementById('wbManualDiscBar').style.display = 'none'; }

            // Counts and hours
            document.getElementById('wbAiCount').textContent = aiTasks.length;
            document.getElementById('wbManualCount').textContent = manualTasks.length;
            document.getElementById('wbAiHours').textContent = `${fmtH(aiOrigH)}h orig / ${fmtH(aiCompH)}h comp`;
            document.getElementById('wbManualHours').textContent = `${fmtH(manOrigH)}h orig / ${fmtH(manCompH)}h comp`;

            // Render tables
            renderWbTable('Ai', aiTasks, wbAiSortField, wbAiSortDir, lt);
            renderWbTable('Manual', manualTasks, wbManualSortField, wbManualSortDir, lt);
        }

        function renderWbTable(type, taskList, sortField, sortDir, lt) {
            const thead = document.getElementById(`wb${type}TableHead`);
            const tbody = document.getElementById(`wb${type}TableBody`);
            const noData = document.getElementById(`wb${type}NoData`);
            const thBg = lt ? 'background:#e2e8f0;color:#1e293b;' : 'background:rgba(255,255,255,0.08);color:#e2e8f0;';
            const thS = `${thBg}padding:6px 5px;cursor:pointer;user-select:none;font-size:0.68rem;white-space:nowrap;`;
            const si = (col) => sortField === col ? (sortDir === 'asc' ? ' ▲' : ' ▼') : '';
            const pfx = type === 'Ai' ? 'wbAi' : 'wbManual';
            thead.innerHTML = `<tr>
                <th style="${thS}text-align:left;width:5%;" onclick="sortWbTable('${pfx}','id')">ID${si('id')}</th>
                <th style="${thS}text-align:left;" onclick="sortWbTable('${pfx}','title')">Title${si('title')}</th>
                <th style="${thS}text-align:left;width:10%;" onclick="sortWbTable('${pfx}','assigned')">Assigned${si('assigned')}</th>
                <th style="${thS}text-align:center;width:8%;" onclick="sortWbTable('${pfx}','discipline')">Discipline${si('discipline')}</th>
                <th style="${thS}text-align:center;width:12%;" onclick="sortWbTable('${pfx}','execType')">Exec Type${si('execType')}</th>
                <th style="${thS}text-align:center;width:6%;" onclick="sortWbTable('${pfx}','state')">State${si('state')}</th>
                <th style="${thS}text-align:right;width:5%;" onclick="sortWbTable('${pfx}','origEst')">Orig${si('origEst')}</th>
                <th style="${thS}text-align:right;width:5%;" onclick="sortWbTable('${pfx}','comp')">Comp${si('comp')}</th>
                <th style="${thS}text-align:center;width:6%;" onclick="sortWbTable('${pfx}','week')">Week${si('week')}</th>
                <th style="${thS}text-align:center;width:8%;" onclick="sortWbTable('${pfx}','stateDate')">Resolved${si('stateDate')}</th>
                <th style="${thS}text-align:left;width:8%;" onclick="sortWbTable('${pfx}','area')">Area${si('area')}</th>
            </tr>`;
            if (taskList.length === 0) { noData.style.display = 'block'; tbody.innerHTML = ''; return; }
            noData.style.display = 'none';
            const sorted = [...taskList].sort((a, b) => {
                let aV, bV;
                switch(sortField) {
                    case 'id': aV = a.id; bV = b.id; break;
                    case 'title': aV = (a.fields['System.Title']||'').toLowerCase(); bV = (b.fields['System.Title']||'').toLowerCase(); break;
                    case 'assigned': aV = (a.fields['System.AssignedTo']?.displayName||'').toLowerCase(); bV = (b.fields['System.AssignedTo']?.displayName||'').toLowerCase(); break;
                    case 'discipline': aV = (a.fields['Microsoft.VSTS.Common.Discipline']||'').toLowerCase(); bV = (b.fields['Microsoft.VSTS.Common.Discipline']||'').toLowerCase(); break;
                    case 'execType': aV = (a.fields['Casepoint.TFS.CustomFields.TaskExecutionType']||'').toLowerCase(); bV = (b.fields['Casepoint.TFS.CustomFields.TaskExecutionType']||'').toLowerCase(); break;
                    case 'state': aV = (a.fields['System.State']||'').toLowerCase(); bV = (b.fields['System.State']||'').toLowerCase(); break;
                    case 'origEst': { const ra = a.fields['Casepoint.TFS.CustomFields.RevisedEstimate']||0; const oa = a.fields['Microsoft.VSTS.Scheduling.OriginalEstimate']||0; aV = ra>0?ra:oa; const rb = b.fields['Casepoint.TFS.CustomFields.RevisedEstimate']||0; const ob = b.fields['Microsoft.VSTS.Scheduling.OriginalEstimate']||0; bV = rb>0?rb:ob; break; }
                    case 'comp': aV = a.fields['Microsoft.VSTS.Scheduling.CompletedWork']||0; bV = b.fields['Microsoft.VSTS.Scheduling.CompletedWork']||0; break;
                    case 'week': aV = a._sprintWeek||'zz'; bV = b._sprintWeek||'zz'; break;
                    case 'stateDate': aV = a.fields['Microsoft.VSTS.Common.StateChangeDate']||''; bV = b.fields['Microsoft.VSTS.Common.StateChangeDate']||''; break;
                    case 'area': aV = (a.fields['System.AreaPath']||'').toLowerCase(); bV = (b.fields['System.AreaPath']||'').toLowerCase(); break;
                    default: aV = a.id; bV = b.id;
                }
                if (aV < bV) return sortDir === 'asc' ? -1 : 1;
                if (aV > bV) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });
            const tdBorder = lt ? 'border-bottom:1px solid #e2e8f0;' : 'border-bottom:1px solid rgba(255,255,255,0.06);';
            const tdClr = lt ? 'color:#334155;' : 'color:#cbd5e1;';
            const discClr = lt ? 'color:#6d28d9;' : 'color:#a78bfa;';
            const execClr = lt ? 'color:#0e7490;' : 'color:#22d3ee;';
            const origClr = lt ? 'color:#c2410c;' : 'color:#f97316;';
            const compClr = lt ? 'color:#047857;' : 'color:#34d399;';
            const areaClr = lt ? 'color:#0369a1;' : 'color:#38bdf8;';
            const dateClr = lt ? 'color:#475569;' : 'color:#94a3b8;';
            const wLabels = { week1: 'W1', week2: 'W2', week3: 'W3', week4: 'W4' };
            const wClr = { week1: '#93c5fd', week2: '#6ee7b7', week3: '#fcd34d', week4: '#f9a8d4' };
            tbody.innerHTML = sorted.map(t => {
                const f = t.fields;
                const re = f['Casepoint.TFS.CustomFields.RevisedEstimate']||0;
                const oe = f['Microsoft.VSTS.Scheduling.OriginalEstimate']||0;
                const orig = re > 0 ? re : oe;
                const comp = f['Microsoft.VSTS.Scheduling.CompletedWork']||0;
                const tArea = (f['System.AreaPath']||'').split('\\').pop();
                const wt = t._sprintWeek;
                const wColor = wClr[wt] || (lt?'#64748b':'#94a3b8');
                const stCls = getStatePillClass(f['System.State']||'');
                const scd = f['Microsoft.VSTS.Common.StateChangeDate'];
                const scdFmt = scd ? new Date(scd).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '-';
                return `<tr style="${tdBorder}">
                    <td style="padding:4px 5px;${tdClr}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link" style="font-size:0.68rem;">${t.id}</a></td>
                    <td style="padding:4px 5px;${tdClr}max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${f['System.Title']||''}">${f['System.Title']||''}</td>
                    <td style="padding:4px 5px;${tdClr}font-size:0.66rem;" title="${f['System.AssignedTo']?.displayName||'-'}">${(f['System.AssignedTo']?.displayName||'-').split(' ')[0]}</td>
                    <td style="padding:4px 5px;${discClr}text-align:center;font-size:0.66rem;">${f['Microsoft.VSTS.Common.Discipline']||'-'}</td>
                    <td style="padding:4px 5px;${execClr}text-align:center;font-size:0.66rem;">${f['Casepoint.TFS.CustomFields.TaskExecutionType']||'-'}</td>
                    <td style="padding:4px 5px;text-align:center;"><span class="fp-state-pill ${stCls}" style="font-size:0.5rem;padding:1px 5px;">${f['System.State']||''}</span></td>
                    <td style="padding:4px 5px;text-align:right;${origClr}font-weight:600;">${fmtH(orig)}h</td>
                    <td style="padding:4px 5px;text-align:right;${compClr}">${fmtH(comp)}h</td>
                    <td style="padding:4px 5px;text-align:center;color:${wColor};font-weight:600;font-size:0.66rem;">${wLabels[wt]||'-'}</td>
                    <td style="padding:4px 5px;text-align:center;${dateClr}font-size:0.62rem;">${scdFmt}</td>
                    <td style="padding:4px 5px;${areaClr}font-size:0.66rem;" title="${f['System.AreaPath']||''}">${tArea}</td>
                </tr>`;
            }).join('');
        }

        function sortWbTable(pfx, col) {
            if (pfx === 'wbAi') {
                if (wbAiSortField === col) wbAiSortDir = wbAiSortDir === 'asc' ? 'desc' : 'asc';
                else { wbAiSortField = col; wbAiSortDir = 'asc'; }
            } else {
                if (wbManualSortField === col) wbManualSortDir = wbManualSortDir === 'asc' ? 'desc' : 'asc';
                else { wbManualSortField = col; wbManualSortDir = 'asc'; }
            }
            renderWeeklyBreakdown();
        }

        async function lookupFeature() {
            const featureId = document.getElementById('featureIdInput').value.trim();
            const resultDiv = document.getElementById('featureLookupResult');
            if (!featureId) { resultDiv.innerHTML = '<div class="error">Please enter a Feature ID</div>'; return; }
            resultDiv.innerHTML = '<div style="color:#94a3b8;padding:8px;font-size:0.75rem;">🔄 Loading feature...</div>';
            try {
                const resp = await apiFetch(`${tfsUrl}/_apis/wit/workitems/${featureId}?$expand=relations&api-version=5.0`);
                if (!resp.ok) throw new Error(`Feature ${featureId} not found`);
                const data = await resp.json();
                const f = data.fields;
                if (f['System.WorkItemType'] !== 'Feature') throw new Error(`#${featureId} is a ${f['System.WorkItemType']}, not a Feature`);

                const featureAreaPath = (f['System.AreaPath'] || '').toLowerCase().trim();
                const stCls = getStatePillClass(f['System.State']);
                const statusVal = f['Casepoint.TFS.CustomFields.Status'] || '-';
                const statusCls = getStatusPillClass(statusVal);
                const lt = document.body.classList.contains('light-theme');

                // Theme tokens
                const T = {
                    card: lt ? 'background:#f8fafc;border:1px solid #e2e8f0;' : 'background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);',
                    box: lt ? 'background:#f1f5f9;border:1px solid #e2e8f0;' : 'background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);',
                    h: lt ? 'color:#0f172a;' : 'color:#e2e8f0;',
                    sub: lt ? 'color:#475569;' : 'color:#94a3b8;',
                    val: lt ? 'color:#1e293b;font-weight:700;' : 'color:#e2e8f0;font-weight:700;',
                    lbl: lt ? 'color:#64748b;' : 'color:#64748b;',
                    tpln: lt ? 'color:#c2410c;' : 'color:#f97316;',
                    tcdev: lt ? 'color:#0369a1;' : 'color:#38bdf8;',
                    tacomp: lt ? 'color:#6d28d9;' : 'color:#a78bfa;',
                    thBg: lt ? 'background:#e2e8f0;color:#1e293b;' : 'background:rgba(255,255,255,0.08);color:#e2e8f0;',
                    tdColor: lt ? 'color:#334155;' : 'color:#cbd5e1;',
                    trBorder: lt ? 'border-bottom:1px solid #e2e8f0;' : 'border-bottom:1px solid rgba(255,255,255,0.06);',
                    totBorder: lt ? 'border-top:2px solid #cbd5e1;' : 'border-top:2px solid rgba(255,255,255,0.15);',
                    areaClr: lt ? 'color:#0369a1;' : 'color:#38bdf8;',
                    iterClr: lt ? 'color:#7c3aed;' : 'color:#c084fc;',
                };
                const sz = 'font-size:0.7rem;';

                const childIds = (data.relations || [])
                    .filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward')
                    .map(r => r.url.split('/').pop());

                let children = [], allTasks = [];
                if (childIds.length > 0) {
                    children = await batchFetchWithRelations(childIds, [
                        'System.Id','System.Title','System.State','System.WorkItemType',
                        'System.AssignedTo','System.AreaPath','System.IterationPath','Microsoft.VSTS.Scheduling.Size',
                        'Casepoint.TFS.CustomFields.Status'
                    ]);
                    const taskIds = [];
                    const childTaskMap = {};
                    children.forEach(c => {
                        const tIds = (c.relations || [])
                            .filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward')
                            .map(r => r.url.split('/').pop());
                        childTaskMap[c.id] = tIds;
                        tIds.forEach(id => { if (!taskIds.includes(id)) taskIds.push(id); });
                    });
                    if (taskIds.length > 0) {
                        allTasks = await batchFetchWorkItems(taskIds, [
                            'System.Id','System.Title','System.State','System.WorkItemType',
                            'System.AssignedTo','System.AreaPath','System.IterationPath','System.Reason',
                            'Microsoft.VSTS.Common.Discipline','Microsoft.VSTS.Scheduling.OriginalEstimate',
                            'Microsoft.VSTS.Scheduling.RemainingWork','Microsoft.VSTS.Scheduling.CompletedWork',
                            'Casepoint.TFS.CustomFields.TaskExecutionType'
                        ]);
                        allTasks = allTasks.filter(t => t.fields['System.WorkItemType'] === 'Task');
                    }
                    const taskLookup = {};
                    allTasks.forEach(t => { taskLookup[t.id] = t; });

                    // Collect unique iteration leaf names from all tasks
                    const allIterNames = new Set();
                    allTasks.forEach(t => {
                        const ip = (t.fields['System.IterationPath'] || '').split('\\').pop().trim();
                        if (ip && ip.toLowerCase() !== 'casepointara') allIterNames.add(ip);
                    });

                    // Store data globally for re-rendering on filter change
                    window._flData = { featureId, f, featureAreaPath, stCls, statusVal, statusCls, lt, T, sz, children, childTaskMap, taskLookup, allIterNames: [...allIterNames].sort() };
                    window._flSort = { col: null, dir: 'asc' };

                    renderFeatureLookupResult('all');
                } else {
                    const discEff = f['Casepoint.TFS.CustomFields.DiscoveryEffort'] || 0;
                    const planned = f['Casepoint.TFS.CustomFields.PlannedHours'] || 0;
                    const lt2 = document.body.classList.contains('light-theme');
                    const T2 = {
                        card: lt2 ? 'background:#f8fafc;border:1px solid #e2e8f0;' : 'background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);',
                        h: lt2 ? 'color:#0f172a;' : 'color:#e2e8f0;',
                        sub: lt2 ? 'color:#475569;' : 'color:#94a3b8;'
                    };
                    const stCls2 = getStatePillClass(f['System.State']);
                    const statusVal2 = f['Casepoint.TFS.CustomFields.Status'] || '-';
                    const statusCls2 = getStatusPillClass(statusVal2);
                    resultDiv.innerHTML = `<div class="fl-card" style="${T2.card}border-radius:8px;padding:10px;margin-top:10px;font-size:0.7rem;">
                        <div style="${T2.h}font-weight:600;font-size:0.8rem;margin-bottom:6px;">
                            <a href="${tfsUrl}/${project}/_workitems/edit/${featureId}" target="_blank" class="wi-link">#${featureId}</a>: ${f['System.Title'] || ''}
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
                            <span class="fp-state-pill ${stCls2}">${f['System.State']}</span>
                            <span class="fp-status-pill ${statusCls2}">${statusVal2}</span>
                            <span style="${T2.sub}">Disc: <b>${fmtH(discEff)}h</b></span>
                            <span style="${T2.sub}">Planned: <b>${fmtH(planned)}h</b></span>
                        </div>
                        <div style="text-align:center;padding:8px;${T2.sub}">No child items found</div>
                    </div>`;
                }
            } catch (err) { resultDiv.innerHTML = `<div class="error" style="font-size:0.75rem;">❌ ${err.message}</div>`; }
        }

        function onFeatureLookupIterFilter() {
            const sel = document.getElementById('flIterFilter');
            if (sel) renderFeatureLookupResult(sel.value);
        }

        function sortFeatureLookup(col) {
            if (!window._flSort) window._flSort = { col: null, dir: 'asc' };
            if (window._flSort.col === col) {
                window._flSort.dir = window._flSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                window._flSort.col = col;
                window._flSort.dir = ['id','title','type','state','status','assigned','area','iteration'].includes(col) ? 'asc' : 'desc';
            }
            const sel = document.getElementById('flIterFilter');
            renderFeatureLookupResult(sel ? sel.value : 'all');
        }

        function getSortedFlChildren(children) {
            const s = window._flSort;
            if (!s || !s.col) return children;
            const dir = s.dir === 'asc' ? 1 : -1;
            const strCols = ['title','type','state','status','assigned','area','iteration'];
            return [...children].sort((a, b) => {
                let va, vb;
                const af = a.fields, bf = b.fields;
                switch (s.col) {
                    case 'id': va = a.id; vb = b.id; break;
                    case 'title': va = (af['System.Title']||'').toLowerCase(); vb = (bf['System.Title']||'').toLowerCase(); break;
                    case 'type': va = (af['System.WorkItemType']||'').toLowerCase(); vb = (bf['System.WorkItemType']||'').toLowerCase(); break;
                    case 'state': va = (af['System.State']||'').toLowerCase(); vb = (bf['System.State']||'').toLowerCase(); break;
                    case 'status': va = (af['Casepoint.TFS.CustomFields.Status']||'').toLowerCase(); vb = (bf['Casepoint.TFS.CustomFields.Status']||'').toLowerCase(); break;
                    case 'assigned': va = (af['System.AssignedTo']?.displayName||'').toLowerCase(); vb = (bf['System.AssignedTo']?.displayName||'').toLowerCase(); break;
                    case 'area': va = (af['System.AreaPath']||'').toLowerCase(); vb = (bf['System.AreaPath']||'').toLowerCase(); break;
                    case 'iteration': va = (af['System.IterationPath']||'').toLowerCase(); vb = (bf['System.IterationPath']||'').toLowerCase(); break;
                    case 'size': va = af['Microsoft.VSTS.Scheduling.Size']||0; vb = bf['Microsoft.VSTS.Scheduling.Size']||0; break;
                    case 'tasks': va = (a._taskIds||[]).length; vb = (b._taskIds||[]).length; break;
                    case 'origEst': va = a._origEst||0; vb = b._origEst||0; break;
                    case 'rem': va = a._remWork||0; vb = b._remWork||0; break;
                    case 'comp': va = a._compWork||0; vb = b._compWork||0; break;
                    case 'taskPlan': va = a._taskPlanned||0; vb = b._taskPlanned||0; break;
                    case 'taskCDev': va = a._taskCompDev||0; vb = b._taskCompDev||0; break;
                    case 'taskACmp': va = a._taskActual||0; vb = b._taskActual||0; break;
                    default: return 0;
                }
                if (strCols.includes(s.col)) return va < vb ? -dir : va > vb ? dir : 0;
                return ((va||0) - (vb||0)) * dir;
            });
        }

        function renderFeatureLookupResult(iterFilter) {
            const d = window._flData;
            if (!d) return;
            const { featureId, f, featureAreaPath, stCls, statusVal, statusCls, children, childTaskMap, taskLookup, allIterNames } = d;
            const resultDiv = document.getElementById('featureLookupResult');
            const lt = document.body.classList.contains('light-theme');
            const T = {
                card: lt ? 'background:#f8fafc;border:1px solid #e2e8f0;' : 'background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);',
                box: lt ? 'background:#f1f5f9;border:1px solid #e2e8f0;' : 'background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);',
                h: lt ? 'color:#0f172a;' : 'color:#e2e8f0;',
                sub: lt ? 'color:#475569;' : 'color:#94a3b8;',
                val: lt ? 'color:#1e293b;font-weight:700;' : 'color:#e2e8f0;font-weight:700;',
                lbl: lt ? 'color:#64748b;' : 'color:#64748b;',
                tpln: lt ? 'color:#c2410c;' : 'color:#f97316;',
                tcdev: lt ? 'color:#0369a1;' : 'color:#38bdf8;',
                tacomp: lt ? 'color:#6d28d9;' : 'color:#a78bfa;',
                thBg: lt ? 'background:#e2e8f0;color:#1e293b;' : 'background:rgba(255,255,255,0.08);color:#e2e8f0;',
                tdColor: lt ? 'color:#334155;' : 'color:#cbd5e1;',
                trBorder: lt ? 'border-bottom:1px solid #e2e8f0;' : 'border-bottom:1px solid rgba(255,255,255,0.06);',
                totBorder: lt ? 'border-top:2px solid #cbd5e1;' : 'border-top:2px solid rgba(255,255,255,0.15);',
                areaClr: lt ? 'color:#0369a1;' : 'color:#38bdf8;',
                iterClr: lt ? 'color:#7c3aed;' : 'color:#c084fc;',
            };
            const sz = 'font-size:0.7rem;';

            const excludedDisc = ['analysis', 'user experience', 'user education'];
            const excludedActual = ['user experience', 'user education'];
            const includedPlanned = ['development', 'analysis', 'test'];
            let totTaskPlanned = 0, totTaskCompDev = 0, totTaskActualComp = 0;
            let totOrigEst = 0, totRemWork = 0, totCompWork = 0;

            children.forEach(c => {
                const tIds = childTaskMap[c.id] || [];
                let cPlanned = 0, cCompDev = 0, cActual = 0, cOrig = 0, cRem = 0, cComp = 0;
                tIds.forEach(tid => {
                    const task = taskLookup[tid];
                    if (!task) return;
                    const disc = (task.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase().trim();
                    const iterPath = task.fields['System.IterationPath'] || '';
                    const reason = (task.fields['System.Reason'] || '').toLowerCase().trim();
                    const taskArea = (task.fields['System.AreaPath'] || '').toLowerCase().trim();
                    const iterLeaf = iterPath.split('\\').pop().trim();
                    const iterLeafLower = iterLeaf.toLowerCase();
                    const isRoot = iterLeafLower === 'casepointara';
                    const isRejected = reason === 'rejected';
                    // Apply iteration filter
                    if (iterFilter !== 'all' && iterLeaf !== iterFilter) return;
                    const orig = task.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                    const rem = task.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0;
                    const comp = task.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                    cOrig += orig; cRem += rem; cComp += comp;
                    if (!excludedActual.includes(disc) && !isRoot && !isRejected) cActual += comp;
                    if (includedPlanned.includes(disc) && !isRoot && !isRejected) {
                        cPlanned += orig;
                    }
                    if (!excludedDisc.includes(disc) && !isRoot && !isRejected) {
                        if (taskArea === featureAreaPath) cCompDev += comp;
                    }
                });
                c._taskPlanned = cPlanned; c._taskCompDev = cCompDev; c._taskActual = cActual;
                c._origEst = cOrig; c._remWork = cRem; c._compWork = cComp;
                c._taskIds = tIds;
                totTaskPlanned += cPlanned; totTaskCompDev += cCompDev; totTaskActualComp += cActual;
                totOrigEst += cOrig; totRemWork += cRem; totCompWork += cComp;
            });

            const discEff = f['Casepoint.TFS.CustomFields.DiscoveryEffort'] || 0;
            const compDisc = f['Casepoint.TFS.CustomFields.CompletedDiscoveryHours'] || 0;
            const planned = f['Casepoint.TFS.CustomFields.PlannedHours'] || 0;
            const compEff = f['Casepoint.TFS.CustomFields.CompletedEffort'] || 0;
            const actualComp = f['Casepoint.TFS.CustomFields.ActualCompletedHours'] || 0;
            const total = discEff + planned;
            const areaLeaf = (f['System.AreaPath']||'').split('\\').pop();
            const iterLeafF = (f['System.IterationPath']||'').split('\\').pop();

            // Build iteration filter dropdown
            let iterFilterHtml = '';
            if (allIterNames.length > 0) {
                iterFilterHtml = `<select id="flIterFilter" onchange="onFeatureLookupIterFilter()" style="background:${lt?'#ffffff':'rgba(0,0,0,0.3)'};color:${lt?'#1e293b':'#e2e8f0'};border:1px solid ${lt?'#cbd5e1':'rgba(99,102,241,0.4)'};border-radius:6px;padding:3px 8px;font-size:0.65rem;cursor:pointer;outline:none;">
                    <option value="all"${iterFilter === 'all' ? ' selected' : ''}>All Iterations</option>
                    ${allIterNames.map(n => `<option value="${n}"${iterFilter === n ? ' selected' : ''}>${n}</option>`).join('')}
                </select>`;
            }

            let html = `<div class="fl-card" style="${T.card}border-radius:8px;padding:10px;margin-top:10px;${sz}">
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;flex-wrap:wrap;">
                    <a href="${tfsUrl}/${project}/_workitems/edit/${featureId}" target="_blank" class="wi-link" style="font-size:0.8rem;font-weight:700;">#${featureId}</a>
                    <span style="${T.h}font-weight:600;font-size:0.8rem;">${f['System.Title'] || ''}</span>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
                    <span class="fp-state-pill ${stCls}">${f['System.State']}</span>
                    <span class="fp-status-pill ${statusCls}">${statusVal}</span>
                    <span style="${T.areaClr}${sz}font-weight:500;">📂 ${areaLeaf}</span>
                    <span style="${T.iterClr}${sz}font-weight:500;">📅 ${iterLeafF}</span>
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;">
                    <div style="${T.box}border-radius:6px;padding:5px 8px;flex:1;min-width:140px;">
                        <div style="${T.lbl}font-size:0.58rem;font-weight:600;margin-bottom:3px;">📊 TFS Feature Hours</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:0.65rem;">
                            <span style="${T.sub}">Disc: <b style="${T.val}">${fmtH(discEff)}h</b></span>
                            <span style="${T.sub}">CompDisc: <b style="${T.val}">${fmtH(compDisc)}h</b></span>
                            <span style="${T.sub}">Planned: <b style="${T.val}">${fmtH(planned)}h</b></span>
                            <span style="${T.sub}">CompEff: <b style="${T.val}">${fmtH(compEff)}h</b></span>
                            <span style="${T.sub}">ActComp: <b style="${T.val}">${fmtH(actualComp)}h</b></span>
                            <span style="${T.sub}">Total: <b style="${T.val}">${fmtH(total)}h</b></span>
                        </div>
                    </div>
                    <div style="${T.box}border-radius:6px;padding:5px 8px;flex:1;min-width:140px;">
                        <div style="${T.lbl}font-size:0.58rem;font-weight:600;margin-bottom:3px;">⚙️ Task-Level Calc${iterFilter !== 'all' ? ' <span style="color:#fbbf24;">('+iterFilter+')</span>' : ''}</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:0.65rem;">
                            <span style="${T.sub}">Planned: <b style="${T.tpln}font-weight:700;">${fmtH(totTaskPlanned)}h</b></span>
                            <span style="${T.sub}">CompDev: <b style="${T.tcdev}font-weight:700;">${fmtH(totTaskCompDev)}h</b></span>
                            <span style="${T.sub}">ActComp: <b style="${T.tacomp}font-weight:700;">${fmtH(totTaskActualComp)}h</b></span>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:0.65rem;margin-top:3px;">
                            <span style="${T.sub}">OrigEst: <b style="${T.val}">${fmtH(totOrigEst)}h</b></span>
                            <span style="${T.sub}">Rem: <b style="${T.val}">${fmtH(totRemWork)}h</b></span>
                            <span style="${T.sub}">Comp: <b style="${T.val}">${fmtH(totCompWork)}h</b></span>
                        </div>
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
                    <span style="${T.h}font-size:0.72rem;font-weight:600;">📋 Child Items (${children.length})</span>
                    ${iterFilterHtml}
                </div>`;

            if (children.length > 0) {
                const sc = window._flSort || {};
                const si = (col) => sc.col === col ? (sc.dir === 'asc' ? ' ▲' : ' ▼') : '';
                const thS = `padding:4px 3px;cursor:pointer;user-select:none;`;
                const sortedChildren = getSortedFlChildren(children);
                html += `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.6rem;table-layout:auto;">
                    <thead><tr style="${T.thBg}">
                        <th style="${thS}text-align:left;" onclick="sortFeatureLookup('id')">ID${si('id')}</th>
                        <th style="${thS}text-align:left;" onclick="sortFeatureLookup('title')">Title${si('title')}</th>
                        <th style="${thS}text-align:center;" onclick="sortFeatureLookup('type')">Type${si('type')}</th>
                        <th style="${thS}text-align:center;" onclick="sortFeatureLookup('state')">State${si('state')}</th>
                        <th style="${thS}text-align:center;" onclick="sortFeatureLookup('status')">Status${si('status')}</th>
                        <th style="${thS}text-align:left;" onclick="sortFeatureLookup('assigned')">Assigned${si('assigned')}</th>
                        <th style="${thS}text-align:left;" onclick="sortFeatureLookup('area')">Area${si('area')}</th>
                        <th style="${thS}text-align:left;" onclick="sortFeatureLookup('iteration')">Iteration${si('iteration')}</th>
                        <th style="${thS}text-align:right;" onclick="sortFeatureLookup('size')">Size${si('size')}</th>
                        <th style="${thS}text-align:center;" onclick="sortFeatureLookup('tasks')">Tasks${si('tasks')}</th>
                        <th style="${thS}text-align:right;" onclick="sortFeatureLookup('origEst')">Orig Est${si('origEst')}</th>
                        <th style="${thS}text-align:right;" onclick="sortFeatureLookup('rem')">Rem${si('rem')}</th>
                        <th style="${thS}text-align:right;" onclick="sortFeatureLookup('comp')">Comp${si('comp')}</th>
                        <th style="${thS}text-align:right;" onclick="sortFeatureLookup('taskPlan')">Task Plan${si('taskPlan')}</th>
                        <th style="${thS}text-align:right;" onclick="sortFeatureLookup('taskCDev')">Task CDev${si('taskCDev')}</th>
                        <th style="${thS}text-align:right;" onclick="sortFeatureLookup('taskACmp')">Task ACmp${si('taskACmp')}</th>
                    </tr></thead><tbody>`;
                sortedChildren.forEach(c => {
                    const cf = c.fields;
                    const tCount = (c._taskIds || []).length;
                    const cArea = (cf['System.AreaPath']||'').split('\\').pop();
                    const cIter = (cf['System.IterationPath']||'').split('\\').pop();
                    const cAssigned = cf['System.AssignedTo']?.displayName || '-';
                    const cStatus = cf['Casepoint.TFS.CustomFields.Status'] || '-';
                    const cStatusCls = getStatusPillClass(cStatus);
                    html += `<tr style="${T.trBorder}">
                        <td style="padding:3px;${T.tdColor}"><a href="${tfsUrl}/${project}/_workitems/edit/${c.id}" target="_blank" class="wi-link" style="font-size:0.6rem;">${c.id}</a></td>
                        <td style="padding:3px;${T.tdColor}max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${cf['System.Title']||''}">${cf['System.Title'] || ''}</td>
                        <td style="padding:3px;text-align:center;${T.tdColor}">${cf['System.WorkItemType'] || ''}</td>
                        <td style="padding:3px;text-align:center;"><span class="fp-state-pill" style="font-size:0.5rem;padding:1px 5px;">${cf['System.State'] || ''}</span></td>
                        <td style="padding:3px;text-align:center;"><span class="fp-status-pill ${cStatusCls}" style="font-size:0.5rem;padding:1px 5px;">${cStatus}</span></td>
                        <td style="padding:3px;${T.tdColor}max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${cAssigned}">${cAssigned}</td>
                        <td style="padding:3px;${T.areaClr}font-weight:500;" title="${cf['System.AreaPath']||''}">${cArea}</td>
                        <td style="padding:3px;${T.iterClr}font-weight:500;" title="${cf['System.IterationPath']||''}">${cIter}</td>
                        <td style="padding:3px;text-align:right;${T.tdColor}">${cf['Microsoft.VSTS.Scheduling.Size'] || 0}</td>
                        <td style="padding:3px;text-align:center;${T.tdColor}">${tCount}</td>
                        <td style="padding:3px;text-align:right;${T.val}">${fmtH(c._origEst)}h</td>
                        <td style="padding:3px;text-align:right;${T.val}">${fmtH(c._remWork)}h</td>
                        <td style="padding:3px;text-align:right;${T.val}">${fmtH(c._compWork)}h</td>
                        <td style="padding:3px;text-align:right;${T.tpln}font-weight:600;">${fmtH(c._taskPlanned)}h</td>
                        <td style="padding:3px;text-align:right;${T.tcdev}font-weight:600;">${fmtH(c._taskCompDev)}h</td>
                        <td style="padding:3px;text-align:right;${T.tacomp}font-weight:600;">${fmtH(c._taskActual)}h</td>
                    </tr>`;
                });
                html += `<tr style="${T.totBorder}font-weight:700;">
                    <td colspan="10" style="padding:4px 3px;text-align:right;${T.h}">Totals:</td>
                    <td style="padding:4px 3px;text-align:right;${T.val}">${fmtH(totOrigEst)}h</td>
                    <td style="padding:4px 3px;text-align:right;${T.val}">${fmtH(totRemWork)}h</td>
                    <td style="padding:4px 3px;text-align:right;${T.val}">${fmtH(totCompWork)}h</td>
                    <td style="padding:4px 3px;text-align:right;${T.tpln}">${fmtH(totTaskPlanned)}h</td>
                    <td style="padding:4px 3px;text-align:right;${T.tcdev}">${fmtH(totTaskCompDev)}h</td>
                    <td style="padding:4px 3px;text-align:right;${T.tacomp}">${fmtH(totTaskActualComp)}h</td>
                </tr></tbody></table></div>`;
            } else {
                html += '<div style="text-align:center;padding:8px;' + T.sub + 'font-size:0.7rem;">No child items found</div>';
            }
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        async function lookupRequirement() {
            const reqId = document.getElementById('reqIdInput').value.trim();
            const resultDiv = document.getElementById('reqLookupResult');
            if (!reqId) { resultDiv.innerHTML = '<div class="error" style="font-size:0.75rem;">Please enter a Requirement ID</div>'; return; }
            resultDiv.innerHTML = '<div style="color:#94a3b8;padding:8px;font-size:0.75rem;">🔄 Loading...</div>';
            try {
                const resp = await apiFetch(`${tfsUrl}/_apis/wit/workitems/${reqId}?$expand=relations&api-version=5.0`);
                if (!resp.ok) throw new Error(`Requirement ${reqId} not found`);
                const data = await resp.json();
                const f = data.fields;
                const lt = document.body.classList.contains('light-theme');
                const T = {
                    card: lt ? 'background:#f8fafc;border:1px solid #e2e8f0;' : 'background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);',
                    box: lt ? 'background:#f1f5f9;border:1px solid #e2e8f0;' : 'background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);',
                    h: lt ? 'color:#0f172a;' : 'color:#e2e8f0;',
                    sub: lt ? 'color:#475569;' : 'color:#94a3b8;',
                    val: lt ? 'color:#1e293b;font-weight:700;' : 'color:#e2e8f0;font-weight:700;',
                    lbl: lt ? 'color:#64748b;' : 'color:#64748b;',
                    thBg: lt ? 'background:#e2e8f0;color:#1e293b;' : 'background:rgba(255,255,255,0.08);color:#e2e8f0;',
                    tdColor: lt ? 'color:#334155;' : 'color:#cbd5e1;',
                    trBorder: lt ? 'border-bottom:1px solid #e2e8f0;' : 'border-bottom:1px solid rgba(255,255,255,0.06);',
                    areaClr: lt ? 'color:#0369a1;' : 'color:#38bdf8;',
                    iterClr: lt ? 'color:#7c3aed;' : 'color:#c084fc;',
                    disc: lt ? 'color:#6d28d9;' : 'color:#a78bfa;',
                    exec: lt ? 'color:#0e7490;' : 'color:#22d3ee;',
                    orig: lt ? 'color:#c2410c;' : 'color:#f97316;',
                    rem: lt ? 'color:#0369a1;' : 'color:#38bdf8;',
                    comp: lt ? 'color:#047857;' : 'color:#34d399;',
                };
                const sz = 'font-size:0.7rem;';
                const tags = f['System.Tags'] || '-';
                const tagsLower = tags.toLowerCase();
                let cat = tagsLower.includes('non-deliverable') ? 'Non-Deliverable' : tagsLower.includes('deliverable') ? 'Deliverable' : '-';
                const stCls = getStatePillClass(f['System.State'] || '');
                const areaLeaf = (f['System.AreaPath']||'').split('\\').pop();
                const iterLeaf = (f['System.IterationPath']||'').split('\\').pop();

                const taskIds = (data.relations || []).filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward').map(r => r.url.split('/').pop());
                let tasks = [];
                if (taskIds.length > 0) {
                    tasks = await batchFetchWorkItems(taskIds, ['System.Id','System.Title','System.State','System.AssignedTo','System.WorkItemType','System.Tags','Microsoft.VSTS.Scheduling.OriginalEstimate','Microsoft.VSTS.Scheduling.RemainingWork','Microsoft.VSTS.Scheduling.CompletedWork','Microsoft.VSTS.Common.Discipline','Casepoint.TFS.CustomFields.TaskExecutionType','System.IterationPath']);
                    tasks = tasks.filter(t => t.fields['System.WorkItemType'] === 'Task');
                }
                const totOrig = tasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                const totRem = tasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                const totComp = tasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);

                const thS = `${T.thBg}padding:3px 4px;${sz}text-align:left;white-space:nowrap;`;
                // Build tag badges
                const tagArr = tags !== '-' ? tags.split(';').map(t => t.trim()).filter(Boolean) : [];
                const tagBadges = tagArr.map(t => {
                    const tl = t.toLowerCase();
                    let bg, clr;
                    if (tl.includes('deliverable') && !tl.includes('non-')) { bg = lt ? 'rgba(16,185,129,0.15)' : 'rgba(16,185,129,0.3)'; clr = lt ? '#047857' : '#6ee7b7'; }
                    else if (tl.includes('non-deliverable')) { bg = lt ? 'rgba(236,72,153,0.15)' : 'rgba(236,72,153,0.3)'; clr = lt ? '#9d174d' : '#f9a8d4'; }
                    else if (tl.startsWith('week')) { bg = lt ? 'rgba(59,130,246,0.15)' : 'rgba(59,130,246,0.3)'; clr = lt ? '#1d4ed8' : '#93c5fd'; }
                    else { bg = lt ? 'rgba(100,116,139,0.12)' : 'rgba(100,116,139,0.3)'; clr = lt ? '#475569' : '#94a3b8'; }
                    return `<span style="background:${bg};color:${clr};padding:1px 5px;border-radius:3px;font-size:0.55rem;">${t}</span>`;
                }).join('');
                resultDiv.innerHTML = `<div style="${T.card}border-radius:8px;padding:8px;margin-top:8px;${sz}">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap;">
                        <a href="${tfsUrl}/${project}/_workitems/edit/${reqId}" target="_blank" class="wi-link" style="font-size:0.78rem;font-weight:700;">#${reqId}</a>
                        <span style="${T.h}font-weight:600;font-size:0.78rem;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${f['System.Title'] || ''}">${f['System.Title'] || ''}</span>
                        <span class="fp-state-pill ${stCls}" style="font-size:0.55rem;padding:1px 6px;">${f['System.State'] || '-'}</span>
                    </div>
                    <div style="display:flex;gap:5px;flex-wrap:wrap;align-items:center;margin-bottom:5px;">
                        <span style="${T.iterClr}font-size:0.62rem;font-weight:600;background:rgba(139,92,246,0.15);padding:1px 6px;border-radius:4px;">📅 ${iterLeaf}</span>
                        <span style="${T.areaClr}font-size:0.62rem;font-weight:500;">📂 ${areaLeaf}</span>
                        <span style="${T.sub}font-size:0.6rem;">Type: <b style="${T.val}font-size:0.6rem;">${f['System.WorkItemType'] || '-'}</b></span>
                        <span style="${T.sub}font-size:0.6rem;">Size: <b style="${T.val}font-size:0.6rem;">${f['Microsoft.VSTS.Scheduling.Size'] || 0}</b></span>
                        <span style="${T.sub}font-size:0.6rem;">Cat: <b style="${T.val}font-size:0.6rem;">${cat}</b></span>
                    </div>
                    ${tagArr.length > 0 ? `<div style="display:flex;gap:3px;flex-wrap:wrap;align-items:center;margin-bottom:5px;">
                        <span style="${T.lbl}font-size:0.55rem;font-weight:600;">🏷️</span>${tagBadges}
                    </div>` : ''}
                    <div style="${T.box}border-radius:5px;padding:4px 8px;margin-bottom:6px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
                        <span style="${T.lbl}font-size:0.6rem;font-weight:600;">📊 ${tasks.length} tasks</span>
                        <span style="${T.sub}font-size:0.62rem;">Orig: <b style="${T.orig}font-weight:700;">${fmtH(totOrig)}h</b></span>
                        <span style="${T.sub}font-size:0.62rem;">Rem: <b style="${T.rem}font-weight:700;">${fmtH(totRem)}h</b></span>
                        <span style="${T.sub}font-size:0.62rem;">Comp: <b style="${T.comp}font-weight:700;">${fmtH(totComp)}h</b></span>
                    </div>
                    ${tasks.length > 0 ? `<div style="overflow-x:auto;max-height:350px;overflow-y:auto;border:1px solid ${lt?'#e2e8f0':'rgba(255,255,255,0.08)'};border-radius:6px;">
                        <table style="width:100%;border-collapse:collapse;${sz}">
                            <thead style="position:sticky;top:0;z-index:1;"><tr>
                                <th style="${thS}">ID</th><th style="${thS}">Title</th><th style="${thS}">State</th><th style="${thS}">Assigned</th>
                                <th style="${thS}">Discipline</th><th style="${thS}">Exec Type</th><th style="${thS}">Iteration</th>
                                <th style="${thS}text-align:right;">Orig</th><th style="${thS}text-align:right;">Rem</th><th style="${thS}text-align:right;">Comp</th>
                            </tr></thead><tbody>${tasks.map(t => {
                                const tSt = getStatePillClass(t.fields['System.State'] || '');
                                const tIter = (t.fields['System.IterationPath']||'').split('\\').pop();
                                return `<tr style="${T.trBorder}">
                                    <td style="padding:3px 5px;${T.tdColor}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link" style="font-size:0.65rem;">${t.id}</a></td>
                                    <td style="padding:3px 5px;${T.tdColor}overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px;" title="${t.fields['System.Title']||''}">${t.fields['System.Title']||''}</td>
                                    <td style="padding:3px 5px;"><span class="fp-state-pill ${tSt}" style="font-size:0.5rem;padding:1px 4px;">${t.fields['System.State']||''}</span></td>
                                    <td style="padding:3px 5px;${T.tdColor}font-size:0.62rem;" title="${t.fields['System.AssignedTo']?.displayName||'-'}">${(t.fields['System.AssignedTo']?.displayName||'-').split(' ')[0]}</td>
                                    <td style="padding:3px 5px;${T.disc}font-size:0.62rem;">${t.fields['Microsoft.VSTS.Common.Discipline']||'-'}</td>
                                    <td style="padding:3px 5px;${T.exec}font-size:0.62rem;">${t.fields['Casepoint.TFS.CustomFields.TaskExecutionType']||'-'}</td>
                                    <td style="padding:3px 5px;${T.iterClr}font-size:0.62rem;">${tIter}</td>
                                    <td style="padding:3px 5px;text-align:right;${T.orig}font-weight:600;">${fmtH(t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate']||0)}h</td>
                                    <td style="padding:3px 5px;text-align:right;${T.rem}">${fmtH(t.fields['Microsoft.VSTS.Scheduling.RemainingWork']||0)}h</td>
                                    <td style="padding:3px 5px;text-align:right;${T.comp}">${fmtH(t.fields['Microsoft.VSTS.Scheduling.CompletedWork']||0)}h</td>
                                </tr>`;
                            }).join('')}</tbody></table></div>` : `<div style="text-align:center;padding:8px;${T.sub}">No tasks found</div>`}
                </div>`;
            } catch (err) { resultDiv.innerHTML = `<div class="error" style="font-size:0.75rem;">❌ ${err.message}</div>`; }
        }

        // ==================== ON-DEMAND CARD REFRESH FUNCTIONS ====================
        // Individual card refresh functions for dynamic updates without full-page reload

        async function refreshBlankSizeCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '⏳'; btn.disabled = true; }
            try {
                // Fetch fresh requirement data
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'Microsoft.VSTS.Scheduling.Size', 'System.WorkItemType']);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['Microsoft.VSTS.Scheduling.Size'] = fr.fields['Microsoft.VSTS.Scheduling.Size'];
                            existingReq.fields['System.WorkItemType'] = fr.fields['System.WorkItemType'];
                        }
                    });
                }
                // Filter: Deliverable/Non-Deliverable + Requirement/Change Request + Size 0 or blank
                const blankSizeReqs = requirements.filter(r => {
                    // Must be Deliverable or Non-Deliverable
                    if (r.category !== 'deliverable' && r.category !== 'nonDeliverable') return false;
                    // Must be Requirement or Change Request work item type
                    const workItemType = r.fields ? r.fields['System.WorkItemType'] : '';
                    if (workItemType !== 'Requirement' && workItemType !== 'Change Request') return false;
                    // Size must be 0, blank, null or undefined
                    const size = r.fields ? r.fields['Microsoft.VSTS.Scheduling.Size'] : undefined;
                    return size === undefined || size === null || size === '' || size === 0 || Number(size) === 0;
                });
                document.getElementById('blankSizeCount').textContent = blankSizeReqs.length;
                renderBlankSizeData(blankSizeReqs);
            } catch (err) { console.error('Error refreshing Blank Size:', err); }
            finally { if (btn) { btn.textContent = '🔄'; btn.disabled = false; } }
        }

        async function refreshBlankReleaseNoteCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '⏳'; btn.disabled = true; }
            try {
                // Fetch fresh requirement data
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'System.State', 'Casepoint.TFS.CustomFields.ReleaseNotes']);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['Casepoint.TFS.CustomFields.ReleaseNotes'] = fr.fields['Casepoint.TFS.CustomFields.ReleaseNotes'];
                            existingReq.fields['System.State'] = fr.fields['System.State'];
                        }
                    });
                }
                const classifiedReqs = requirements.filter(r => r.category === 'deliverable' || r.category === 'nonDeliverable');
                const blankReleaseNoteReqs = classifiedReqs.filter(r => {
                    const releaseNote = r.fields ? r.fields['Casepoint.TFS.CustomFields.ReleaseNotes'] : undefined;
                    return releaseNote === undefined || releaseNote === null || releaseNote === '' || (typeof releaseNote === 'string' && releaseNote.trim() === '');
                });
                document.getElementById('blankReleaseNoteCount').textContent = blankReleaseNoteReqs.length;
                const blankReleaseNoteBody = document.getElementById('blankReleaseNoteTableBody');
                if (blankReleaseNoteReqs.length > 0) {
                    document.getElementById('noBlankReleaseNoteData').style.display = 'none';
                    blankReleaseNoteBody.innerHTML = blankReleaseNoteReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        const state = r.fields ? (r.fields['System.State'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${state}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankReleaseNoteData').style.display = 'block'; blankReleaseNoteBody.innerHTML = ''; }
            } catch (err) { console.error('Error refreshing Blank Release Note:', err); }
            finally { if (btn) { btn.textContent = '🔄'; btn.disabled = false; } }
        }

        async function refreshNoParentCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '⏳'; btn.disabled = true; }
            try {
                // Fetch fresh parent relations
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWithRelations(reqIds);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.hasParent = fr.relations?.some(rel => rel.rel === 'System.LinkTypes.Hierarchy-Reverse') || false;
                        }
                    });
                }
                const classifiedReqs = requirements.filter(r => r.category === 'deliverable' || r.category === 'nonDeliverable');
                const noParentReqs = classifiedReqs.filter(r => !r.hasParent);
                document.getElementById('blankParentCount').textContent = noParentReqs.length;
                const blankParentBody = document.getElementById('blankParentTableBody');
                if (noParentReqs.length > 0) {
                    document.getElementById('noBlankParentData').style.display = 'none';
                    blankParentBody.innerHTML = noParentReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        const catLabel = r.category === 'deliverable' ? 'Del' : 'Non-Del';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${catLabel}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankParentData').style.display = 'block'; blankParentBody.innerHTML = ''; }
            } catch (err) { console.error('Error refreshing No Parent:', err); }
            finally { if (btn) { btn.textContent = '🔄'; btn.disabled = false; } }
        }

        async function refreshLastSprintOpenCard() {
            if (!storedSprintStartDate) return;
            const btn = event?.target;
            if (btn) { btn.textContent = '⏳'; btn.disabled = true; }
            try {
                await loadLastSprintOpenItems();
            } catch (err) { console.error('Error refreshing Last Sprint Open:', err); }
            finally { if (btn) { btn.textContent = '🔄'; btn.disabled = false; } }
        }

        async function refreshTagMissingCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '⏳'; btn.disabled = true; }
            try {
                // Fetch fresh task data
                const taskIds = tasks.map(t => t.id);
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'System.Title', 'System.AssignedTo', 'System.Tags', 'Microsoft.VSTS.Common.Discipline']);
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['System.Tags'] = ft.fields['System.Tags'];
                            existingTask.fields['System.AssignedTo'] = ft.fields['System.AssignedTo'];
                            existingTask.fields['Microsoft.VSTS.Common.Discipline'] = ft.fields['Microsoft.VSTS.Common.Discipline'];
                        }
                    });
                }
                renderTagMissingTasks();
            } catch (err) { console.error('Error refreshing Tag Missing:', err); }
            finally { if (btn) { btn.textContent = '🔄'; btn.disabled = false; } }
        }

        async function refreshBlankDisciplineCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '⏳'; btn.disabled = true; }
            try {
                // Fetch fresh task data
                const taskIds = tasks.map(t => t.id);
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'System.Title', 'System.AssignedTo', 'Microsoft.VSTS.Common.Discipline']);
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['Microsoft.VSTS.Common.Discipline'] = ft.fields['Microsoft.VSTS.Common.Discipline'];
                            existingTask.fields['System.AssignedTo'] = ft.fields['System.AssignedTo'];
                        }
                    });
                }
                renderBlankDisciplineTasks();
            } catch (err) { console.error('Error refreshing Blank Discipline:', err); }
            finally { if (btn) { btn.textContent = '🔄'; btn.disabled = false; } }
        }

        async function refreshOverEstTasksCard() {
            const btn = document.getElementById('refreshOverEstBtn');
            btn.textContent = '⏳';
            btn.disabled = true;
            try {
                // Fetch fresh task data from TFS
                const taskIds = tasks.map(t => t.id);
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'System.Title', 'Microsoft.VSTS.Scheduling.OriginalEstimate', 'System.AssignedTo']);
                    // Update local tasks cache with fresh data
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] = ft.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'];
                            existingTask.fields['System.Title'] = ft.fields['System.Title'];
                            existingTask.fields['System.AssignedTo'] = ft.fields['System.AssignedTo'];
                        }
                    });
                }
                // Re-render with fresh data
                const overEstTasks = tasks.filter(t => (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0) > 40);
                document.getElementById('overEstTaskCount').textContent = overEstTasks.length;
                const overEstTable = document.getElementById('overEstTasksTable').querySelector('tbody');
                if (overEstTasks.length > 0) {
                    document.getElementById('noOverEstTasks').style.display = 'none';
                    overEstTable.innerHTML = overEstTasks.map(t => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td><td>${t.fields['System.Title'] || ''}</td><td>${t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0}</td><td>${t.fields['System.AssignedTo']?.displayName || '-'}</td></tr>`).join('');
                } else {
                    document.getElementById('noOverEstTasks').style.display = 'block';
                    overEstTable.innerHTML = '';
                }
            } catch (err) {
                console.error('Error refreshing Over Est Tasks:', err);
            } finally {
                btn.textContent = '🔄';
                btn.disabled = false;
            }
        }

        async function refreshBlankDescCard() {
            const btn = document.getElementById('refreshBlankDescBtn');
            btn.textContent = '⏳';
            btn.disabled = true;
            try {
                // Fetch fresh requirement data from TFS
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'System.Description', 'System.State']);
                    // Update local requirements cache with fresh data
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['System.Description'] = fr.fields['System.Description'];
                            existingReq.fields['System.Title'] = fr.fields['System.Title'];
                            existingReq.fields['System.State'] = fr.fields['System.State'];
                        }
                    });
                }
                // Re-render with fresh data
                const blankDescReqs = requirements.filter(r => {
                    const desc = r.fields['System.Description'] || '';
                    return !desc || desc.trim() === '';
                });
                document.getElementById('blankDescCount').textContent = blankDescReqs.length;
                const blankDescTable = document.getElementById('blankDescTable').querySelector('tbody');
                if (blankDescReqs.length > 0) {
                    document.getElementById('noBlankDesc').style.display = 'none';
                    blankDescTable.innerHTML = blankDescReqs.map(r => {
                        const title = r.fields['System.Title'] || '';
                        const state = r.fields['System.State'] || '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${state}</td></tr>`;
                    }).join('');
                } else {
                    document.getElementById('noBlankDesc').style.display = 'block';
                    blankDescTable.innerHTML = '';
                }
            } catch (err) {
                console.error('Error refreshing Blank Desc:', err);
            } finally {
                btn.textContent = '🔄';
                btn.disabled = false;
            }
        }

        async function refreshTeamBCard() {
            const btn = document.getElementById('refreshTeamBBtn');
            if (btn) { btn.textContent = '⏳'; btn.disabled = true; }
            try {
                // Fetch fresh requirement and task data from TFS
                const reqIds = requirements.map(r => r.id);
                const taskIds = tasks.map(t => t.id);
                
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'System.State', 'Microsoft.VSTS.Scheduling.Size']);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['System.Title'] = fr.fields['System.Title'];
                            existingReq.fields['System.State'] = fr.fields['System.State'];
                            existingReq.fields['Microsoft.VSTS.Scheduling.Size'] = fr.fields['Microsoft.VSTS.Scheduling.Size'];
                        }
                    });
                }
                
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'Microsoft.VSTS.Scheduling.OriginalEstimate', 'Microsoft.VSTS.Scheduling.RemainingWork', 'Microsoft.VSTS.Scheduling.CompletedWork']);
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] = ft.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'];
                            existingTask.fields['Microsoft.VSTS.Scheduling.RemainingWork'] = ft.fields['Microsoft.VSTS.Scheduling.RemainingWork'];
                            existingTask.fields['Microsoft.VSTS.Scheduling.CompletedWork'] = ft.fields['Microsoft.VSTS.Scheduling.CompletedWork'];
                        }
                    });
                }
                
                // Re-calculate TEAM B data - filter by TITLE containing "ticket support" or "ticket handling"
                teamBData = { requirements: [], totalOrigEst: 0, totalSize: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
                requirements.filter(r => {
                    const title = (r.fields['System.Title'] || '').toLowerCase();
                    return title.includes('ticket support') || title.includes('ticket handling');
                }).forEach(req => {
                    const reqTasks = tasks.filter(t => taskParentMap[t.id] === req.id);
                    const origEst = reqTasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const remWork = reqTasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    const compWork = reqTasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    const size = req.fields['Microsoft.VSTS.Scheduling.Size'] || 0;
                    // Use same field names as initial: originalEstimate, remainingWork, completedWork
                    teamBData.requirements.push({ ...req, taskCount: reqTasks.length, originalEstimate: origEst, size: size, remainingWork: remWork, completedWork: compWork });
                    teamBData.totalOrigEst += origEst;
                    teamBData.totalSize += size;
                    teamBData.totalRemWork += remWork;
                    teamBData.totalCompWork += compWork;
                    teamBData.totalTasks += reqTasks.length;
                });
                
                // Update UI
                document.getElementById('teamBReqCount').textContent = teamBData.requirements.length;
                document.getElementById('teamBTaskCount').textContent = teamBData.totalTasks;
                document.getElementById('teamBTotalSize').textContent = teamBData.totalSize;
                document.getElementById('teamBTotalOrigEst').textContent = fmtH(teamBData.totalOrigEst) + 'h';
                document.getElementById('teamBTotalRemWork').textContent = fmtH(teamBData.totalRemWork) + 'h';
                const teamBTable = document.getElementById('teamBReqTable').querySelector('tbody');
                if (teamBData.requirements.length > 0) {
                    document.getElementById('noTeamBData').style.display = 'none';
                    teamBTable.innerHTML = teamBData.requirements.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td><td>${r.taskCount}</td><td style="color:#c084fc;">${r.size || 0}</td><td style="color:#fbbf24;">${fmtH(r.originalEstimate)}h</td><td style="color:#22d3ee;">${fmtH(r.remainingWork)}h</td></tr>`).join('');
                } else {
                    document.getElementById('noTeamBData').style.display = 'block';
                    teamBTable.innerHTML = '';
                }
            } catch (err) {
                console.error('Error refreshing TEAM B:', err);
            } finally {
                if (btn) { btn.textContent = '🔄'; btn.disabled = false; }
            }
        }

        // ==================== END ON-DEMAND CARD REFRESH ====================

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = '🔄 Refreshing...';
            try { await loadData(); } finally { btn.disabled = false; btn.textContent = '🔄 Refresh'; }
        }

        function showFilters() { document.getElementById('content').classList.remove('visible'); document.getElementById('filterPanel').classList.add('visible'); }
        function resetConnection() { 
            document.getElementById('filterPanel').classList.remove('visible'); 
            document.getElementById('content').classList.remove('visible'); 
            document.getElementById('configPanel').style.display = 'block';
            document.getElementById('projectCheckboxContainer').innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">-- Enter PAT to load projects --</div>';
            document.getElementById('projectStatus').textContent = '';
            document.getElementById('selectedProjects').innerHTML = '';
            document.getElementById('areaCheckboxContainer').innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">-- Loading areas --</div>';
            document.getElementById('selectedAreas').innerHTML = '';
            document.getElementById('iterationCheckboxContainer').innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">-- Loading iterations --</div>';
            document.getElementById('selectedIterations').innerHTML = '';
            selectedProjects = [];
            selectedAreaPaths = [];
            selectedIterationPaths = [];
            projectsFetched = false;
        }
        function showLoading(t) { document.getElementById('loadingText').textContent = t; document.getElementById('loading').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading').classList.remove('visible'); }
        function showError(m) { document.getElementById('errorMsg').innerHTML = `<div class="error">❌ ${m}</div>`; }
    
        function exportMismatchToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'Discipline - Manual Task Execution Type Mismatch\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            csv += 'ID,Title,State,Assigned To,Area Path,Discipline,Task Execution Type\n';
            
            mismatchAllData.forEach(t => {
                const title = (t.fields['System.Title'] || '').replace(/"/g, '""');
                const state = t.fields['System.State'] || '';
                const assigned = t.fields['System.AssignedTo']?.displayName || '';
                const areaPath = t.fields['System.AreaPath'] || '';
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                csv += `${t.id},"${title}",${state},"${assigned}","${areaPath}","${discipline}","${execType}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mismatch_Tasks_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportMismatchToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('mismatchTable');
            if (!table || !table.querySelector('tbody').innerHTML) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>Discipline Mismatch - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(239,68,68,0.4); }
    .header h1 { font-size: 1.1rem; color: #fca5a5; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    .header .criteria { font-size: 0.7rem; color: #60a5fa; margin-top: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #fca5a5; padding: 6px 5px; text-align: left; border-bottom: 2px solid rgba(239,68,68,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
</style></head><body>
<div class="header">
    <h1>🔀 Discipline - Manual Task Execution Type Mismatch (${mismatchAllData.length})</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
    <div class="criteria">Expected: Development → AI-Dev* | Test → AI-Test* | Closed/Resolved Tasks Only with AI Task Execution Type</div>
</div>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }

        function exportDisciplineVerificationToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('dvMismatchTable');
            if (!table) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const stats = {
                members: document.getElementById('dvMemberCount').textContent,
                total: document.getElementById('dvTotalTasks').textContent,
                matched: document.getElementById('dvMatchedCount').textContent,
                mismatched: document.getElementById('dvMismatchedCount').textContent,
                blank: document.getElementById('dvBlankDisciplineCount').textContent
            };
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>Discipline Verification - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(59,130,246,0.4); }
    .header h1 { font-size: 1.1rem; color: #93c5fd; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    .stats { display: flex; justify-content: center; gap: 20px; margin: 12px 0; font-size: 0.75rem; }
    .stat { text-align: center; padding: 8px 16px; border-radius: 6px; }
    .stat .val { font-size: 1.1rem; font-weight: 700; }
    .stat .lbl { font-size: 0.65rem; color: #94a3b8; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #93c5fd; padding: 6px 5px; text-align: left; border-bottom: 2px solid rgba(59,130,246,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
</style></head><body>
<div class="header">
    <h1>🔍 Discipline Verification Report</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
</div>
<div class="stats">
    <div class="stat" style="background:rgba(59,130,246,0.2);"><div class="val" style="color:#60a5fa;">${stats.members}</div><div class="lbl">Members</div></div>
    <div class="stat" style="background:rgba(148,163,184,0.2);"><div class="val" style="color:#94a3b8;">${stats.total}</div><div class="lbl">Total Tasks</div></div>
    <div class="stat" style="background:rgba(16,185,129,0.2);"><div class="val" style="color:#34d399;">${stats.matched}</div><div class="lbl">✅ Matched</div></div>
    <div class="stat" style="background:rgba(239,68,68,0.2);"><div class="val" style="color:#f87171;">${stats.mismatched}</div><div class="lbl">❌ Mismatched</div></div>
    <div class="stat" style="background:rgba(245,158,11,0.2);"><div class="val" style="color:#fbbf24;">${stats.blank}</div><div class="lbl">⚠️ Blank</div></div>
</div>
<h3 style="color:#f87171;font-size:0.85rem;margin:10px 0;">❌ Mismatched & ⚠️ Blank Discipline Tasks (${stats.mismatched} mismatched, ${stats.blank} blank)</h3>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }

        function exportOverallAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('overallAIAdoptionTable');
            if (!table) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>📊 AI-Enabled Disciplines - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(59,130,246,0.4); }
    .header h1 { font-size: 1.1rem; color: #93c5fd; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #93c5fd; padding: 6px 5px; text-align: center; border-bottom: 2px solid rgba(59,130,246,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    tfoot td { font-weight: 700; background: rgba(59,130,246,0.15); border-top: 2px solid rgba(59,130,246,0.3); }
</style></head><body>
<div class="header">
    <h1>📊 AI-Enabled Disciplines</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
</div>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }

        function exportExecTypeAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('execTypeAIAdoptionTable');
            if (!table) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>⚡ Task Execution Type AI Adoption - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(59,130,246,0.4); }
    .header h1 { font-size: 1.1rem; color: #93c5fd; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #93c5fd; padding: 6px 5px; text-align: center; border-bottom: 2px solid rgba(59,130,246,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    tfoot td { font-weight: 700; background: rgba(59,130,246,0.15); border-top: 2px solid rgba(59,130,246,0.3); }
</style></head><body>
<div class="header">
    <h1>⚡ Task Execution Type AI Adoption</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
</div>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }

    </script>
</body>
</html>
